---
title: État de session et d’application dans ASP.NET Core
author: rick-anderson
description: Aborde la conservation de l’état de session utilisateur et d’application entre chaque requête.
manager: wpickett
ms.author: riande
ms.custom: H1Hack27Feb2017
ms.date: 11/27/2017
ms.prod: asp.net-core
ms.technology: aspnet
ms.topic: article
uid: fundamentals/app-state
ms.openlocfilehash: 887aefdeaa45957f7b95bfe8df342eb34d267e3a
ms.sourcegitcommit: 3a893ae05f010656d99d6ddf55e82f1b5b6933bc
ms.translationtype: HT
ms.contentlocale: fr-FR
ms.lasthandoff: 05/18/2018
ms.locfileid: "34306645"
---
# <a name="session-and-application-state-in-aspnet-core"></a><span data-ttu-id="7b06c-103">État de session et d’application dans ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="7b06c-103">Session and application state in ASP.NET Core</span></span>

<span data-ttu-id="7b06c-104">Par [Rick Anderson](https://twitter.com/RickAndMSFT), [Steve Smith](https://ardalis.com/) et [Diana LaRose](https://github.com/DianaLaRose)</span><span class="sxs-lookup"><span data-stu-id="7b06c-104">By [Rick Anderson](https://twitter.com/RickAndMSFT), [Steve Smith](https://ardalis.com/), and [Diana LaRose](https://github.com/DianaLaRose)</span></span>

<span data-ttu-id="7b06c-105">HTTP est un protocole sans état.</span><span class="sxs-lookup"><span data-stu-id="7b06c-105">HTTP is a stateless protocol.</span></span> <span data-ttu-id="7b06c-106">Un serveur web traite chaque requête HTTP comme une requête indépendante et ne conserve pas les valeurs utilisateur des requêtes précédentes.</span><span class="sxs-lookup"><span data-stu-id="7b06c-106">A web server treats each HTTP request as an independent request and doesn't retain user values from previous requests.</span></span> <span data-ttu-id="7b06c-107">Cet article décrit différentes façons de conserver l’état de session et d’application d’une requête à l’autre.</span><span class="sxs-lookup"><span data-stu-id="7b06c-107">This article discusses different ways to preserve application and session state between requests.</span></span>

## <a name="session-state"></a><span data-ttu-id="7b06c-108">État de session</span><span class="sxs-lookup"><span data-stu-id="7b06c-108">Session state</span></span>

<span data-ttu-id="7b06c-109">L’état de session est une fonctionnalité ASP.NET Core que vous pouvez utiliser pour enregistrer et stocker des données utilisateur pendant que l’utilisateur navigue dans votre application web.</span><span class="sxs-lookup"><span data-stu-id="7b06c-109">Session state is a feature in ASP.NET Core that you can use to save and store user data while the user browses your web app.</span></span> <span data-ttu-id="7b06c-110">Constitué d’une table de hachage ou de dictionnaires sur le serveur, l’état de session conserve les données entre chaque requête reçue d’un navigateur.</span><span class="sxs-lookup"><span data-stu-id="7b06c-110">Consisting of a dictionary or hash table on the server, session state persists data across requests from a browser.</span></span> <span data-ttu-id="7b06c-111">Les données de session sont stockées dans un cache.</span><span class="sxs-lookup"><span data-stu-id="7b06c-111">The session data is backed by a cache.</span></span>

<span data-ttu-id="7b06c-112">ASP.NET Core conserve l’état de session en donnant au client un cookie qui contient l’ID de session envoyé au serveur avec chaque requête.</span><span class="sxs-lookup"><span data-stu-id="7b06c-112">ASP.NET Core maintains session state by giving the client a cookie that contains the session ID, which is sent to the server with each request.</span></span> <span data-ttu-id="7b06c-113">Le serveur utilise l’ID de session pour extraire les données de session.</span><span class="sxs-lookup"><span data-stu-id="7b06c-113">The server uses the session ID to fetch the session data.</span></span> <span data-ttu-id="7b06c-114">Étant donné que le cookie de session est spécifique au navigateur, vous ne peuvez pas partager des sessions dans les navigateurs.</span><span class="sxs-lookup"><span data-stu-id="7b06c-114">Because the session cookie is specific to the browser, you cannot share sessions across browsers.</span></span> <span data-ttu-id="7b06c-115">Les cookies de session sont supprimées uniquement lorsque la session se termine.</span><span class="sxs-lookup"><span data-stu-id="7b06c-115">Session cookies are deleted only when the browser session ends.</span></span> <span data-ttu-id="7b06c-116">Si un cookie est reçu pour une session qui a expiré, une session qui utilise le même cookie de session est créée.</span><span class="sxs-lookup"><span data-stu-id="7b06c-116">If a cookie is received for an expired session, a new session that uses the same session cookie is created.</span></span>

<span data-ttu-id="7b06c-117">Le serveur conserve une session pendant une période limitée après la dernière demande.</span><span class="sxs-lookup"><span data-stu-id="7b06c-117">The server retains a session for a limited time after the last request.</span></span> <span data-ttu-id="7b06c-118">Vous pouvez définir le délai d’expiration d'une session ou utiliser la valeur par défaut de 20 minutes.</span><span class="sxs-lookup"><span data-stu-id="7b06c-118">Either set the session timeout or use the default value of 20 minutes.</span></span> <span data-ttu-id="7b06c-119">L'état de session est idéal pour le stockage des données utilisateur qui sont spécifiques à une session particulière, mais ne doivent pas être persistantes de façon permanente.</span><span class="sxs-lookup"><span data-stu-id="7b06c-119">Session state is ideal for storing user data that's specific to a particular session but doesn't need to be persisted permanently.</span></span> <span data-ttu-id="7b06c-120">Les données sont supprimées du magasin de stockage lorsque vous appelez `Session.Clear` ou à l’expiration de la session dans le magasin de données.</span><span class="sxs-lookup"><span data-stu-id="7b06c-120">Data is deleted from the backing store either when calling `Session.Clear` or when the session expires in the data store.</span></span> <span data-ttu-id="7b06c-121">Le serveur ne peut pas déterminer quand le navigateur est fermé ou quand le cookie de session est supprimé.</span><span class="sxs-lookup"><span data-stu-id="7b06c-121">The server doesn't know when the browser is closed or when the session cookie is deleted.</span></span>

> [!WARNING]
> <span data-ttu-id="7b06c-122">Ne stockez pas de données sensibles dans une session.</span><span class="sxs-lookup"><span data-stu-id="7b06c-122">Don't store sensitive data in session.</span></span> <span data-ttu-id="7b06c-123">Le client risque de ne pas fermer le navigateur et de ne pas effacer le cookie de session (et certains navigateurs maintiennent les cookies de session actifs entre les fenêtres).</span><span class="sxs-lookup"><span data-stu-id="7b06c-123">The client might not close the browser and clear the session cookie (and some browsers keep session cookies alive across windows).</span></span> <span data-ttu-id="7b06c-124">De plus, une session n’est pas toujours limitée à un seul utilisateur ; l’utilisateur suivant risque donc de continuer avec la même session.</span><span class="sxs-lookup"><span data-stu-id="7b06c-124">Also, a session might not be restricted to a single user; the next user might continue with the same session.</span></span>

<span data-ttu-id="7b06c-125">Le fournisseur de session en mémoire stocke les données de session sur le serveur local.</span><span class="sxs-lookup"><span data-stu-id="7b06c-125">The in-memory session provider stores session data on the local server.</span></span> <span data-ttu-id="7b06c-126">Si vous envisagez d’exécuter votre application web sur une batterie de serveurs, vous devez utiliser des sessions rémanentes pour lier chaque session à un serveur spécifique.</span><span class="sxs-lookup"><span data-stu-id="7b06c-126">If you plan to run your web app on a server farm, you must use sticky sessions to tie each session to a specific server.</span></span> <span data-ttu-id="7b06c-127">La plateforme Sites Web Microsoft Azure utilise par défaut des sessions rémanentes (Application Request Routing ou ARR).</span><span class="sxs-lookup"><span data-stu-id="7b06c-127">The Windows Azure Web Sites platform defaults to sticky sessions (Application Request Routing or ARR).</span></span> <span data-ttu-id="7b06c-128">Toutefois, les sessions rémanentes peuvent impacter l’extensibilité et compliquer les mises à jour des applications web.</span><span class="sxs-lookup"><span data-stu-id="7b06c-128">However, sticky sessions can affect scalability and complicate web app updates.</span></span> <span data-ttu-id="7b06c-129">Une meilleure option consiste à utiliser les caches distribués Redis ou SQL Server, qui ne nécessitent pas de sessions rémanentes.</span><span class="sxs-lookup"><span data-stu-id="7b06c-129">A better option is to use the Redis or SQL Server distributed caches, which don't require sticky sessions.</span></span> <span data-ttu-id="7b06c-130">Pour plus d’informations, consultez [Utiliser un cache distribué](xref:performance/caching/distributed).</span><span class="sxs-lookup"><span data-stu-id="7b06c-130">For more information, see [Work with a Distributed Cache](xref:performance/caching/distributed).</span></span> <span data-ttu-id="7b06c-131">Pour plus d’informations sur la configuration des fournisseurs de services, consultez [Configuration de Session](#configuring-session), plus loin dans cet article.</span><span class="sxs-lookup"><span data-stu-id="7b06c-131">For details on setting up service providers, see [Configuring Session](#configuring-session) later in this article.</span></span>

## <a name="tempdata"></a><span data-ttu-id="7b06c-132">TempData</span><span class="sxs-lookup"><span data-stu-id="7b06c-132">TempData</span></span>

<span data-ttu-id="7b06c-133">ASP.NET Core MVC expose la propriété [TempData](/dotnet/api/microsoft.aspnetcore.mvc.controller.tempdata?view=aspnetcore-2.0#Microsoft_AspNetCore_Mvc_Controller_TempData) sur un [contrôleur](/dotnet/api/microsoft.aspnetcore.mvc.controller?view=aspnetcore-2.0).</span><span class="sxs-lookup"><span data-stu-id="7b06c-133">ASP.NET Core MVC exposes the [TempData](/dotnet/api/microsoft.aspnetcore.mvc.controller.tempdata?view=aspnetcore-2.0#Microsoft_AspNetCore_Mvc_Controller_TempData) property on a [controller](/dotnet/api/microsoft.aspnetcore.mvc.controller?view=aspnetcore-2.0).</span></span> <span data-ttu-id="7b06c-134">Cette propriété stocke les données jusqu’à ce qu’elles soient lues.</span><span class="sxs-lookup"><span data-stu-id="7b06c-134">This property stores data until it's read.</span></span> <span data-ttu-id="7b06c-135">Vous pouvez utiliser les méthodes `Keep` et `Peek` pour examiner les données sans suppression.</span><span class="sxs-lookup"><span data-stu-id="7b06c-135">The `Keep` and `Peek` methods can be used to examine the data without deletion.</span></span> <span data-ttu-id="7b06c-136">`TempData` est particulièrement utile pour la redirection, quand des données sont nécessaires pour plusieurs requêtes.</span><span class="sxs-lookup"><span data-stu-id="7b06c-136">`TempData` is particularly useful for redirection, when data is needed for more than a single request.</span></span> <span data-ttu-id="7b06c-137">`TempData` est implémenté par des fournisseurs TempData, par exemple, à l’aide de cookies ou de l’état de session.</span><span class="sxs-lookup"><span data-stu-id="7b06c-137">`TempData` is implemented by TempData providers, for example, using either cookies or session state.</span></span>

### <a name="tempdata-providers"></a><span data-ttu-id="7b06c-138">Fournisseurs TempData</span><span class="sxs-lookup"><span data-stu-id="7b06c-138">TempData providers</span></span>

# <a name="aspnet-core-2xtabaspnetcore2x"></a>[<span data-ttu-id="7b06c-139">ASP.NET Core 2.x</span><span class="sxs-lookup"><span data-stu-id="7b06c-139">ASP.NET Core 2.x</span></span>](#tab/aspnetcore2x)

<span data-ttu-id="7b06c-140">Dans ASP.NET Core 2.0 et les versions ultérieures, le fournisseur TempData basé sur les cookies est utilisé par défaut pour stocker TempData dans des cookies.</span><span class="sxs-lookup"><span data-stu-id="7b06c-140">In ASP.NET Core 2.0 and later, the cookie-based TempData provider is used by default to store TempData in cookies.</span></span>

<span data-ttu-id="7b06c-141">Les données de cookie sont chiffrées avec [IDataProtector](/dotnet/api/microsoft.aspnetcore.dataprotection.idataprotector), encodées avec [Base64UrlTextEncoder](/dotnet/api/microsoft.aspnetcore.webutilities.base64urltextencoder), puis mémorisées en bloc.</span><span class="sxs-lookup"><span data-stu-id="7b06c-141">The cookie data is encrypted using [IDataProtector](/dotnet/api/microsoft.aspnetcore.dataprotection.idataprotector), encoded with [Base64UrlTextEncoder](/dotnet/api/microsoft.aspnetcore.webutilities.base64urltextencoder), then chunked.</span></span> <span data-ttu-id="7b06c-142">Étant donné que le cookie est mémorisé en bloc, la limite de taille d’un cookie définie dans ASP.NET Core 1.x ne s’applique pas.</span><span class="sxs-lookup"><span data-stu-id="7b06c-142">Because the cookie is chunked, the single cookie size limit found in ASP.NET Core 1.x doesn't apply.</span></span> <span data-ttu-id="7b06c-143">Les données de cookie ne sont pas compressées, car la compression de données chiffrées peut entraîner des problèmes de sécurité, notamment des attaques [CRIME](https://wikipedia.org/wiki/CRIME_(security_exploit)) et [BREACH](https://wikipedia.org/wiki/BREACH_(security_exploit)).</span><span class="sxs-lookup"><span data-stu-id="7b06c-143">The cookie data isn't compressed because compressing encrypted data can lead to security problems such as the [CRIME](https://wikipedia.org/wiki/CRIME_(security_exploit)) and [BREACH](https://wikipedia.org/wiki/BREACH_(security_exploit)) attacks.</span></span> <span data-ttu-id="7b06c-144">Pour plus d’informations sur le fournisseur TempData basé sur les cookies, consultez [CookieTempDataProvider](https://github.com/aspnet/Mvc/blob/dev/src/Microsoft.AspNetCore.Mvc.ViewFeatures/ViewFeatures/CookieTempDataProvider.cs).</span><span class="sxs-lookup"><span data-stu-id="7b06c-144">For more information on the cookie-based TempData provider, see [CookieTempDataProvider](https://github.com/aspnet/Mvc/blob/dev/src/Microsoft.AspNetCore.Mvc.ViewFeatures/ViewFeatures/CookieTempDataProvider.cs).</span></span>

# <a name="aspnet-core-1xtabaspnetcore1x"></a>[<span data-ttu-id="7b06c-145">ASP.NET Core 1.x</span><span class="sxs-lookup"><span data-stu-id="7b06c-145">ASP.NET Core 1.x</span></span>](#tab/aspnetcore1x)

<span data-ttu-id="7b06c-146">Dans ASP.NET Core 1.0 et 1.1, le fournisseur TempData d’état de session est utilisé par défaut.</span><span class="sxs-lookup"><span data-stu-id="7b06c-146">In ASP.NET Core 1.0 and 1.1, the session state TempData provider is the default.</span></span>

---

### <a name="choosing-a-tempdata-provider"></a><span data-ttu-id="7b06c-147">Choix d’un fournisseur TempData</span><span class="sxs-lookup"><span data-stu-id="7b06c-147">Choosing a TempData provider</span></span>

<span data-ttu-id="7b06c-148">Pour choisir un fournisseur TempData, vous devez tenir compte de plusieurs points. Par exemple :</span><span class="sxs-lookup"><span data-stu-id="7b06c-148">Choosing a TempData provider involves several considerations, such as:</span></span>

1. <span data-ttu-id="7b06c-149">L’application utilise-t-elle déjà l’état de session à d’autres fins ?</span><span class="sxs-lookup"><span data-stu-id="7b06c-149">Does the application already use session state for other purposes?</span></span> <span data-ttu-id="7b06c-150">Si c’est le cas, l’utilisation du fournisseur TempData d’état de session n’entraîne pas de surcoût pour l’application (hormis la taille des données).</span><span class="sxs-lookup"><span data-stu-id="7b06c-150">If so, using the session state TempData provider has no additional cost to the application (aside from the size of the data).</span></span>
2. <span data-ttu-id="7b06c-151">L’application utilise-t-elle TempData seulement de façon ponctuelle, pour des quantités de données relativement petites (jusqu’à 500 octets) ?</span><span class="sxs-lookup"><span data-stu-id="7b06c-151">Does the application use TempData only sparingly, for relatively small amounts of data (up to 500 bytes)?</span></span> <span data-ttu-id="7b06c-152">Si c’est le cas, le fournisseur TempData de cookies ajoute un petit coût à chaque requête traitée par TempData.</span><span class="sxs-lookup"><span data-stu-id="7b06c-152">If so, the cookie TempData provider will add a small cost to each request that carries TempData.</span></span> <span data-ttu-id="7b06c-153">Si ce n’est pas le cas, le fournisseur TempData d’état de session peut être utile pour éviter l’aller-retour d’une grande quantité de données dans chaque requête jusqu’à ce que le TempData soit consommé.</span><span class="sxs-lookup"><span data-stu-id="7b06c-153">If not, the session state TempData provider can be beneficial to avoid round-tripping a large amount of data in each request until the TempData is consumed.</span></span>
3. <span data-ttu-id="7b06c-154">L’application s’exécute-t-elle dans une batterie de serveurs Web ?</span><span class="sxs-lookup"><span data-stu-id="7b06c-154">Does the application run in a web farm (multiple servers)?</span></span> <span data-ttu-id="7b06c-155">Si c’est le cas, aucune configuration supplémentaire n’est nécessaire pour utiliser le fournisseur TempData de cookies.</span><span class="sxs-lookup"><span data-stu-id="7b06c-155">If so, there's no additional configuration needed to use the cookie TempData provider.</span></span>

> [!NOTE]
> <span data-ttu-id="7b06c-156">La plupart des clients web (par exemple, les navigateurs web) appliquent des limites pour la taille maximale de chaque cookie et/ou le nombre total de cookies.</span><span class="sxs-lookup"><span data-stu-id="7b06c-156">Most web clients (such as web browsers) enforce limits on the maximum size of each cookie, the total number of cookies, or both.</span></span> <span data-ttu-id="7b06c-157">Par conséquent, lorsque vous utilisez le fournisseur TempData de cookies, vérifiez que l’application ne dépasse pas ces limites.</span><span class="sxs-lookup"><span data-stu-id="7b06c-157">Therefore, when using the cookie TempData provider, verify the app won't exceed these limits.</span></span> <span data-ttu-id="7b06c-158">Examinez la taille totale des données, en prenant en compte les surcharges de chiffrement et de mémorisation en bloc.</span><span class="sxs-lookup"><span data-stu-id="7b06c-158">Consider the total size of the data, accounting for the overheads of encryption and chunking.</span></span>

### <a name="configure-the-tempdata-provider"></a><span data-ttu-id="7b06c-159">Configuration du fournisseur TempData</span><span class="sxs-lookup"><span data-stu-id="7b06c-159">Configure the TempData provider</span></span>

# <a name="aspnet-core-2xtabaspnetcore2x"></a>[<span data-ttu-id="7b06c-160">ASP.NET Core 2.x</span><span class="sxs-lookup"><span data-stu-id="7b06c-160">ASP.NET Core 2.x</span></span>](#tab/aspnetcore2x/)

<span data-ttu-id="7b06c-161">Le fournisseur TempData basé sur les cookies est activé par défaut.</span><span class="sxs-lookup"><span data-stu-id="7b06c-161">The cookie-based TempData provider is enabled by default.</span></span> <span data-ttu-id="7b06c-162">Le code de classe `Startup` suivant configure le fournisseur TempData basé sur les sessions :</span><span class="sxs-lookup"><span data-stu-id="7b06c-162">The following `Startup` class code configures the session-based TempData provider:</span></span>

[!code-csharp[](app-state/sample/src/WebAppSessionDotNetCore2.0App/StartupTempDataSession.cs?name=snippet_TempDataSession&highlight=4,6,11)]

# <a name="aspnet-core-1xtabaspnetcore1x"></a>[<span data-ttu-id="7b06c-163">ASP.NET Core 1.x</span><span class="sxs-lookup"><span data-stu-id="7b06c-163">ASP.NET Core 1.x</span></span>](#tab/aspnetcore1x/)

<span data-ttu-id="7b06c-164">Le code de classe `Startup` suivant configure le fournisseur TempData basé sur les sessions :</span><span class="sxs-lookup"><span data-stu-id="7b06c-164">The following `Startup` class code configures the session-based TempData provider:</span></span>

[!code-csharp[](app-state/sample/src/WebAppSession/StartupTempDataSession.cs?name=snippet_TempDataSession&highlight=4,9)]

---

<span data-ttu-id="7b06c-165">L’ordre est essentiel pour les composants d’intergiciel (middleware).</span><span class="sxs-lookup"><span data-stu-id="7b06c-165">Ordering is critical for middleware components.</span></span> <span data-ttu-id="7b06c-166">Dans l’exemple précédent, une exception de type `InvalidOperationException` se produit quand `UseSession` est appelé après `UseMvcWithDefaultRoute`.</span><span class="sxs-lookup"><span data-stu-id="7b06c-166">In the preceding example, an exception of type `InvalidOperationException` occurs when `UseSession` is invoked after `UseMvcWithDefaultRoute`.</span></span> <span data-ttu-id="7b06c-167">Pour plus de détails, consultez [Ordre des intergiciels (middleware)](xref:fundamentals/middleware/index#ordering).</span><span class="sxs-lookup"><span data-stu-id="7b06c-167">See [Middleware Ordering](xref:fundamentals/middleware/index#ordering) for more detail.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="7b06c-168">Si vous ciblez .NET Framework et utilisez le fournisseur basé sur les sessions, ajoutez le package NuGet [Microsoft.AspNetCore.Session](https://www.nuget.org/packages/Microsoft.AspNetCore.Session) à votre projet.</span><span class="sxs-lookup"><span data-stu-id="7b06c-168">If targeting .NET Framework and using the session-based provider, add the [Microsoft.AspNetCore.Session](https://www.nuget.org/packages/Microsoft.AspNetCore.Session) NuGet package to your project.</span></span>

## <a name="query-strings"></a><span data-ttu-id="7b06c-169">Chaînes de requête</span><span class="sxs-lookup"><span data-stu-id="7b06c-169">Query strings</span></span>

<span data-ttu-id="7b06c-170">Vous pouvez passer une quantité limitée de données d’une requête à une autre en l’ajoutant à la chaîne de la nouvelle requête.</span><span class="sxs-lookup"><span data-stu-id="7b06c-170">You can pass a limited amount of data from one request to another by adding it to the new request's query string.</span></span> <span data-ttu-id="7b06c-171">Cela est utile pour capturer l’état de manière persistante et permettre ainsi le partage de liens avec état incorporé par e-mail ou sur les réseaux sociaux.</span><span class="sxs-lookup"><span data-stu-id="7b06c-171">This is useful for capturing state in a persistent manner that allows links with embedded state to be shared through email or social networks.</span></span> <span data-ttu-id="7b06c-172">Toutefois, pour cette raison même, n’utilisez jamais de chaînes de requête sur des données sensibles.</span><span class="sxs-lookup"><span data-stu-id="7b06c-172">However, for this reason, you should never use query strings for sensitive data.</span></span> <span data-ttu-id="7b06c-173">En plus de faciliter le partage des données, l’ajout de données dans des chaînes de requête peut favoriser les attaques par [falsification de requête intersites (CSRF)](https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)) et conduire des utilisateurs authentifiés à visiter des sites malveillants.</span><span class="sxs-lookup"><span data-stu-id="7b06c-173">In addition to being easily shared, including data in query strings can create opportunities for [Cross-Site Request Forgery (CSRF)](https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)) attacks, which can trick users into visiting malicious sites while authenticated.</span></span> <span data-ttu-id="7b06c-174">Les attaquants peuvent ensuite dérober des données utilisateur à partir de votre application ou effectuer des actions malveillantes en utilisant un compte d’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="7b06c-174">Attackers can then steal user data from your app or take malicious actions on behalf of the user.</span></span> <span data-ttu-id="7b06c-175">Chaque état de session ou d’application conservé doit garantir une protection contre les attaques CSRF.</span><span class="sxs-lookup"><span data-stu-id="7b06c-175">Any preserved application or session state must protect against CSRF attacks.</span></span> <span data-ttu-id="7b06c-176">Pour plus d’informations sur les attaques CSRF, consultez [Prévenir les attaques par falsification de requête intersites (XSRF/CSRF)](xref:security/anti-request-forgery).</span><span class="sxs-lookup"><span data-stu-id="7b06c-176">For more information on CSRF attacks, see [Prevent Cross-Site Request Forgery (XSRF/CSRF) attacks](xref:security/anti-request-forgery).</span></span>

## <a name="post-data-and-hidden-fields"></a><span data-ttu-id="7b06c-177">Publication de données et champs masqués</span><span class="sxs-lookup"><span data-stu-id="7b06c-177">Post data and hidden fields</span></span>

<span data-ttu-id="7b06c-178">Les données peuvent être enregistrées dans des champs de formulaire masqués et être republiées lors de la requête suivante.</span><span class="sxs-lookup"><span data-stu-id="7b06c-178">Data can be saved in hidden form fields and posted back on the next request.</span></span> <span data-ttu-id="7b06c-179">Cela est courant dans les formulaires de plusieurs pages.</span><span class="sxs-lookup"><span data-stu-id="7b06c-179">This is common in multi-page forms.</span></span> <span data-ttu-id="7b06c-180">Toutefois, comme le client peut potentiellement falsifier les données, le serveur doit toujours les revalider.</span><span class="sxs-lookup"><span data-stu-id="7b06c-180">However, because the client can potentially tamper with the data, the server must always revalidate it.</span></span>

## <a name="cookies"></a><span data-ttu-id="7b06c-181">Cookies</span><span class="sxs-lookup"><span data-stu-id="7b06c-181">Cookies</span></span>

<span data-ttu-id="7b06c-182">Les cookies sont un moyen de stocker des données utilisateur dans les applications web.</span><span class="sxs-lookup"><span data-stu-id="7b06c-182">Cookies provide a way to store user-specific data in web applications.</span></span> <span data-ttu-id="7b06c-183">Les cookies sont envoyés avec chaque requête. Il est donc essentiel de limiter leur taille au minimum.</span><span class="sxs-lookup"><span data-stu-id="7b06c-183">Because cookies are sent with every request, their size should be kept to a minimum.</span></span> <span data-ttu-id="7b06c-184">Dans l’idéal, un cookie doit uniquement stocker un identificateur et les données proprement dites qui sont stockées sur le serveur.</span><span class="sxs-lookup"><span data-stu-id="7b06c-184">Ideally, only an identifier should be stored in a cookie with the actual data stored on the server.</span></span> <span data-ttu-id="7b06c-185">La plupart des navigateurs limitent les cookies à 4 096 octets.</span><span class="sxs-lookup"><span data-stu-id="7b06c-185">Most browsers restrict cookies to 4096 bytes.</span></span> <span data-ttu-id="7b06c-186">De plus, seul un nombre limité de cookies est disponible pour chaque domaine.</span><span class="sxs-lookup"><span data-stu-id="7b06c-186">In addition, only a limited number of cookies are available for each domain.</span></span>

<span data-ttu-id="7b06c-187">Pour éviter les risques de falsification, les cookies doivent être validés sur le serveur.</span><span class="sxs-lookup"><span data-stu-id="7b06c-187">Because cookies are subject to tampering, they must be validated on the server.</span></span> <span data-ttu-id="7b06c-188">La durabilité des cookies sur un client dépend du délai d’expiration et de l’interaction de l’utilisateur, mais les cookies sont généralement la forme la plus durable de persistance des données sur le client.</span><span class="sxs-lookup"><span data-stu-id="7b06c-188">Although the durability of the cookie on a client is subject to user intervention and expiration, they're generally the most durable form of data persistence on the client.</span></span>

<span data-ttu-id="7b06c-189">Les cookies servent souvent à personnaliser le contenu pour un utilisateur connu.</span><span class="sxs-lookup"><span data-stu-id="7b06c-189">Cookies are often used for personalization, where content is customized for a known user.</span></span> <span data-ttu-id="7b06c-190">Dans la plupart des cas, l’utilisateur est identifié, mais pas authentifié. Vous pouvez généralement sécuriser un cookie en stockant le nom d’utilisateur, le nom de compte ou un ID d’utilisateur unique (par exemple, un GUID) dans le cookie.</span><span class="sxs-lookup"><span data-stu-id="7b06c-190">Because the user is only identified and not authenticated in most cases, you can typically secure a cookie by storing the user name, account name, or a unique user ID (such as a GUID) in the cookie.</span></span> <span data-ttu-id="7b06c-191">Vous pouvez ensuite utiliser le cookie pour accéder à l’infrastructure de personnalisation utilisateur d’un site.</span><span class="sxs-lookup"><span data-stu-id="7b06c-191">You can then use the cookie to access the user personalization infrastructure of a site.</span></span>

## <a name="httpcontextitems"></a><span data-ttu-id="7b06c-192">HttpContext.Items</span><span class="sxs-lookup"><span data-stu-id="7b06c-192">HttpContext.Items</span></span>

<span data-ttu-id="7b06c-193">La collection `Items` est un bon emplacement pour stocker des données qui sont nécessaires uniquement pendant le traitement d’une requête particulière.</span><span class="sxs-lookup"><span data-stu-id="7b06c-193">The `Items` collection is a good location to store data that's needed only while processing one particular request.</span></span> <span data-ttu-id="7b06c-194">Le contenu de la collection est supprimé après chaque requête.</span><span class="sxs-lookup"><span data-stu-id="7b06c-194">The collection's contents are discarded after each request.</span></span> <span data-ttu-id="7b06c-195">La collection `Items` est surtout utile pour permettre à des composants ou des intergiciels (middleware) de communiquer à différents moments de l’exécution d’une requête quand ils ne peuvent pas passer les paramètres de façon directe.</span><span class="sxs-lookup"><span data-stu-id="7b06c-195">The `Items` collection is best used as a way for components or middleware to communicate when they operate at different points in time during a request and have no direct way to pass parameters.</span></span> <span data-ttu-id="7b06c-196">Pour plus d’informations, consultez [Utiliser HttpContext.Items](#working-with-httpcontextitems) plus loin dans cet article.</span><span class="sxs-lookup"><span data-stu-id="7b06c-196">For more information, see [Work with HttpContext.Items](#working-with-httpcontextitems), later in this article.</span></span>

## <a name="cache"></a><span data-ttu-id="7b06c-197">d'instance/de clé</span><span class="sxs-lookup"><span data-stu-id="7b06c-197">Cache</span></span>

<span data-ttu-id="7b06c-198">La mise en cache est un moyen efficace de stocker et récupérer des données.</span><span class="sxs-lookup"><span data-stu-id="7b06c-198">Caching is an efficient way to store and retrieve data.</span></span> <span data-ttu-id="7b06c-199">Vous pouvez contrôler la durée de vie des éléments mis en cache en fonction de l’heure et d’autres critères.</span><span class="sxs-lookup"><span data-stu-id="7b06c-199">You can control the lifetime of cached items based on time and other considerations.</span></span> <span data-ttu-id="7b06c-200">Découvrez plus d’informations sur [la mise en cache](../performance/caching/index.md).</span><span class="sxs-lookup"><span data-stu-id="7b06c-200">Learn more about [how to cache](../performance/caching/index.md).</span></span>

## <a name="working-with-session-state"></a><span data-ttu-id="7b06c-201">Utilisation de l’état de session</span><span class="sxs-lookup"><span data-stu-id="7b06c-201">Working with Session State</span></span>

### <a name="configuring-session"></a><span data-ttu-id="7b06c-202">Configuration de Session</span><span class="sxs-lookup"><span data-stu-id="7b06c-202">Configuring Session</span></span>

<span data-ttu-id="7b06c-203">Le package `Microsoft.AspNetCore.Session` fournit un middleware pour gérer l’état de session.</span><span class="sxs-lookup"><span data-stu-id="7b06c-203">The `Microsoft.AspNetCore.Session` package provides middleware for managing session state.</span></span> <span data-ttu-id="7b06c-204">Pour activer le middleware Session, `Startup` doit contenir les éléments suivants :</span><span class="sxs-lookup"><span data-stu-id="7b06c-204">To enable the session middleware, `Startup` must contain:</span></span>

- <span data-ttu-id="7b06c-205">Un des caches mémoire [IDistributedCache](/dotnet/api/microsoft.extensions.caching.distributed.idistributedcache).</span><span class="sxs-lookup"><span data-stu-id="7b06c-205">Any of the [IDistributedCache](/dotnet/api/microsoft.extensions.caching.distributed.idistributedcache) memory caches.</span></span> <span data-ttu-id="7b06c-206">L’implémentation `IDistributedCache` est utilisée comme magasin de stockage pour la session.</span><span class="sxs-lookup"><span data-stu-id="7b06c-206">The `IDistributedCache` implementation is used as a backing store for session.</span></span>
- <span data-ttu-id="7b06c-207">Un appel [AddSession](/dotnet/api/microsoft.extensions.dependencyinjection.sessionservicecollectionextensions#Microsoft_Extensions_DependencyInjection_SessionServiceCollectionExtensions_AddSession_Microsoft_Extensions_DependencyInjection_IServiceCollection_), qui nécessite le package NuGet « Microsoft.AspNetCore.Session ».</span><span class="sxs-lookup"><span data-stu-id="7b06c-207">[AddSession](/dotnet/api/microsoft.extensions.dependencyinjection.sessionservicecollectionextensions#Microsoft_Extensions_DependencyInjection_SessionServiceCollectionExtensions_AddSession_Microsoft_Extensions_DependencyInjection_IServiceCollection_) call, which requires NuGet package "Microsoft.AspNetCore.Session".</span></span>
- <span data-ttu-id="7b06c-208">Un appel [UseSession](/dotnet/api/microsoft.aspnetcore.builder.sessionmiddlewareextensions#methods_).</span><span class="sxs-lookup"><span data-stu-id="7b06c-208">[UseSession](/dotnet/api/microsoft.aspnetcore.builder.sessionmiddlewareextensions#methods_) call.</span></span>

<span data-ttu-id="7b06c-209">Le code suivant montre comment configurer le fournisseur de session en mémoire.</span><span class="sxs-lookup"><span data-stu-id="7b06c-209">The following code shows how to set up the in-memory session provider.</span></span>

# <a name="aspnet-core-2xtabaspnetcore2x"></a>[<span data-ttu-id="7b06c-210">ASP.NET Core 2.x</span><span class="sxs-lookup"><span data-stu-id="7b06c-210">ASP.NET Core 2.x</span></span>](#tab/aspnetcore2x/)

[!code-csharp[](app-state/sample/src/WebAppSessionDotNetCore2.0App/Startup.cs?highlight=11-19,24)]

# <a name="aspnet-core-1xtabaspnetcore1x"></a>[<span data-ttu-id="7b06c-211">ASP.NET Core 1.x</span><span class="sxs-lookup"><span data-stu-id="7b06c-211">ASP.NET Core 1.x</span></span>](#tab/aspnetcore1x/)

[!code-csharp[](app-state/sample/src/WebAppSession/Startup.cs?highlight=11-19,24)]

---

<span data-ttu-id="7b06c-212">Vous pouvez faire référence à Session à partir de `HttpContext` une fois qu’il a été installé et configuré.</span><span class="sxs-lookup"><span data-stu-id="7b06c-212">You can reference Session from `HttpContext` once it's installed and configured.</span></span>

<span data-ttu-id="7b06c-213">Si vous essayez d’accéder à `Session` avant d’avoir appelé `UseSession`, l’exception `InvalidOperationException: Session has not been configured for this application or request` est levée.</span><span class="sxs-lookup"><span data-stu-id="7b06c-213">If you try to access `Session` before `UseSession` has been called, the exception `InvalidOperationException: Session has not been configured for this application or request` is thrown.</span></span>

<span data-ttu-id="7b06c-214">Si vous essayez de créer un `Session` (aucun cookie de session n’ayant encore été créé) après avoir commencé à écrire dans le flux `Response`, l’exception `InvalidOperationException: The session cannot be established after the response has started` est levée.</span><span class="sxs-lookup"><span data-stu-id="7b06c-214">If you try to create a new `Session` (that is, no session cookie has been created) after you have already begun writing to the `Response` stream, the exception `InvalidOperationException: The session cannot be established after the response has started` is thrown.</span></span> <span data-ttu-id="7b06c-215">L’exception est enregistrée dans le journal de serveur web, mais elle n’est pas affichée dans le navigateur.</span><span class="sxs-lookup"><span data-stu-id="7b06c-215">The exception can be found in the web server log; it will not be displayed in the browser.</span></span>

### <a name="loading-session-asynchronously"></a><span data-ttu-id="7b06c-216">Chargement asynchrone de Session</span><span class="sxs-lookup"><span data-stu-id="7b06c-216">Loading Session asynchronously</span></span>

<span data-ttu-id="7b06c-217">Le fournisseur de session par défaut dans ASP.NET Core charge l’enregistrement de session de façon asynchrone à partir du magasin sous-jacent [IDistributedCache](/dotnet/api/microsoft.extensions.caching.distributed.idistributedcache) uniquement si la méthode [ISession.LoadAsync](/dotnet/api/microsoft.aspnetcore.http.isession#Microsoft_AspNetCore_Http_ISession_LoadAsync) est appelée explicitement avant les méthodes `TryGetValue`, `Set` ou `Remove`.</span><span class="sxs-lookup"><span data-stu-id="7b06c-217">The default session provider in ASP.NET Core loads the session record from the underlying [IDistributedCache](/dotnet/api/microsoft.extensions.caching.distributed.idistributedcache) store asynchronously only if the [ISession.LoadAsync](/dotnet/api/microsoft.aspnetcore.http.isession#Microsoft_AspNetCore_Http_ISession_LoadAsync) method is explicitly called before  the `TryGetValue`, `Set`, or `Remove` methods.</span></span> <span data-ttu-id="7b06c-218">Si la méthode `LoadAsync` n’est pas appelée en premier, l’enregistrement de session sous-jacent est chargé de façon synchrone, ce qui peut impacter la capacité de mise à l’échelle de l’application.</span><span class="sxs-lookup"><span data-stu-id="7b06c-218">If `LoadAsync` isn't called first, the underlying session record is loaded synchronously, which could potentially impact the ability of the app to scale.</span></span>

<span data-ttu-id="7b06c-219">Pour forcer les applications à appliquer ce modèle, incluez les implémentations [DistributedSessionStore](/dotnet/api/microsoft.aspnetcore.session.distributedsessionstore) et [DistributedSession](/dotnet/api/microsoft.aspnetcore.session.distributedsession) dans un wrapper, avec des versions qui lèvent une exception si la méthode `LoadAsync` n’est pas appelée avant `TryGetValue`, `Set` ou `Remove`.</span><span class="sxs-lookup"><span data-stu-id="7b06c-219">To have applications enforce this pattern, wrap the [DistributedSessionStore](/dotnet/api/microsoft.aspnetcore.session.distributedsessionstore) and [DistributedSession](/dotnet/api/microsoft.aspnetcore.session.distributedsession) implementations with versions that throw an exception if the `LoadAsync` method isn't called before `TryGetValue`, `Set`, or `Remove`.</span></span> <span data-ttu-id="7b06c-220">Inscrivez ensuite les versions incluses dans le wrapper auprès du conteneur de services.</span><span class="sxs-lookup"><span data-stu-id="7b06c-220">Register the wrapped versions in the services container.</span></span>

### <a name="implementation-details"></a><span data-ttu-id="7b06c-221">Détails de l’implémentation</span><span class="sxs-lookup"><span data-stu-id="7b06c-221">Implementation details</span></span>

<span data-ttu-id="7b06c-222">Session utilise un cookie pour suivre et identifier les requêtes reçues d’un navigateur.</span><span class="sxs-lookup"><span data-stu-id="7b06c-222">Session uses a cookie to track and identify requests from a single browser.</span></span> <span data-ttu-id="7b06c-223">Par défaut, ce cookie est nommé « AspNet.Session » et utilise un chemin « / ».</span><span class="sxs-lookup"><span data-stu-id="7b06c-223">By default, this cookie is named ".AspNet.Session", and it uses a path of "/".</span></span> <span data-ttu-id="7b06c-224">Étant donné que le cookie par défaut ne spécifie pas de domaine, il n’est pas mis à disposition du script côté client dans la page (car `CookieHttpOnly` a la valeur `true` par défaut).</span><span class="sxs-lookup"><span data-stu-id="7b06c-224">Because the cookie default doesn't specify a domain, it's not made available to the client-side script on the page (because `CookieHttpOnly` defaults to `true`).</span></span>

<span data-ttu-id="7b06c-225">Pour substituer les valeurs de session par défaut, utilisez `SessionOptions` :</span><span class="sxs-lookup"><span data-stu-id="7b06c-225">To override session defaults, use `SessionOptions`:</span></span>

# <a name="aspnet-core-2xtabaspnetcore2x"></a>[<span data-ttu-id="7b06c-226">ASP.NET Core 2.x</span><span class="sxs-lookup"><span data-stu-id="7b06c-226">ASP.NET Core 2.x</span></span>](#tab/aspnetcore2x/)

[!code-csharp[](app-state/sample/src/WebAppSessionDotNetCore2.0App/StartupCopy.cs?name=snippet1&highlight=8-12)]

# <a name="aspnet-core-1xtabaspnetcore1x"></a>[<span data-ttu-id="7b06c-227">ASP.NET Core 1.x</span><span class="sxs-lookup"><span data-stu-id="7b06c-227">ASP.NET Core 1.x</span></span>](#tab/aspnetcore1x/)

[!code-csharp[](app-state/sample/src/WebAppSession/StartupCopy.cs?name=snippet1&highlight=8-12)]

---

<span data-ttu-id="7b06c-228">Le serveur utilise la propriété `IdleTimeout` pour déterminer la durée pendant laquelle une session peut rester inactive avant que son contenu soit abandonné.</span><span class="sxs-lookup"><span data-stu-id="7b06c-228">The server uses the `IdleTimeout` property to determine how long a session can be idle before its contents are abandoned.</span></span> <span data-ttu-id="7b06c-229">Cette propriété est indépendante du délai d’expiration du cookie.</span><span class="sxs-lookup"><span data-stu-id="7b06c-229">This property is independent of the cookie expiration.</span></span> <span data-ttu-id="7b06c-230">Chaque requête qui passe par le middleware Session (en lecture ou en écriture) réinitialise le délai d’expiration.</span><span class="sxs-lookup"><span data-stu-id="7b06c-230">Each request that passes through the Session middleware (read from or written to) resets the timeout.</span></span>

<span data-ttu-id="7b06c-231">Étant donné que `Session` *n’est pas bloquante*, si deux requêtes tentent de modifier le contenu de la session, la dernière se substitue à la première.</span><span class="sxs-lookup"><span data-stu-id="7b06c-231">Because `Session` is *non-locking*, if two requests both attempt to modify the contents of session, the last one overrides the first.</span></span> <span data-ttu-id="7b06c-232">`Session` est implémentée comme une *session cohérente*, ce qui signifie que tout le contenu est stocké au même emplacement.</span><span class="sxs-lookup"><span data-stu-id="7b06c-232">`Session` is implemented as a *coherent session*, which means that all the contents are stored together.</span></span> <span data-ttu-id="7b06c-233">Deux requêtes qui modifient des parties différentes de la session (clés différentes) peuvent toujours avoir un impact l’une sur l’autre.</span><span class="sxs-lookup"><span data-stu-id="7b06c-233">Two requests that are modifying different parts of the session (different keys) might still impact each other.</span></span>

### <a name="set-and-get-session-values"></a><span data-ttu-id="7b06c-234">Définir et obtenir des valeurs Session</span><span class="sxs-lookup"><span data-stu-id="7b06c-234">Set and get Session values</span></span>

<span data-ttu-id="7b06c-235">Session est accessible à partir d’une page Razor ou d’une vue avec `Context.Session` :</span><span class="sxs-lookup"><span data-stu-id="7b06c-235">Session is accessed from a Razor Page or view with `Context.Session`:</span></span>

[!code-cshtml[](app-state/sample/src/WebAppSessionDotNetCore2.0App/Views/Home/About.cshtml)]

<span data-ttu-id="7b06c-236">Session est accessible à partir d’une classe ou d’un contrôleur `PageModel` avec `HttpContext.Session`.</span><span class="sxs-lookup"><span data-stu-id="7b06c-236">Session is accessed from a `PageModel` class or controller with `HttpContext.Session`.</span></span> <span data-ttu-id="7b06c-237">Cette propriété est une implémentation [ISession](/dotnet/api/microsoft.aspnetcore.http.isession).</span><span class="sxs-lookup"><span data-stu-id="7b06c-237">This property is an [ISession](/dotnet/api/microsoft.aspnetcore.http.isession) implementation.</span></span>

<span data-ttu-id="7b06c-238">L’exemple suivant montre comment définir et obtenir une valeur int et une valeur string :</span><span class="sxs-lookup"><span data-stu-id="7b06c-238">The following example shows setting and getting an int and a string:</span></span>

[!code-csharp[](app-state/sample/src/WebAppSession/Controllers/HomeController.cs?range=8-27,49)]

<span data-ttu-id="7b06c-239">Si vous ajoutez les méthodes d’extension suivantes, vous pouvez définir et obtenir des objets sérialisables pour Session :</span><span class="sxs-lookup"><span data-stu-id="7b06c-239">If you add the following extension methods, you can set and get serializable objects to Session:</span></span>

[!code-csharp[](app-state/sample/src/WebAppSession/Extensions/SessionExtensions.cs)]

<span data-ttu-id="7b06c-240">L’exemple suivant montre comment définir et obtenir un objet sérialisable :</span><span class="sxs-lookup"><span data-stu-id="7b06c-240">The following sample shows how to set and get a serializable object:</span></span>

[!code-csharp[](app-state/sample/src/WebAppSession/Controllers/HomeController.cs?name=snippet2)]

## <a name="working-with-httpcontextitems"></a><span data-ttu-id="7b06c-241">Utilisation de la collection HttpContext.Items</span><span class="sxs-lookup"><span data-stu-id="7b06c-241">Working with HttpContext.Items</span></span>

<span data-ttu-id="7b06c-242">L’abstraction `HttpContext` fournit la prise en charge d’une collection de dictionnaires de type `IDictionary<object, object>`, appelée `Items`.</span><span class="sxs-lookup"><span data-stu-id="7b06c-242">The `HttpContext` abstraction provides support for a dictionary collection of type `IDictionary<object, object>`, called `Items`.</span></span> <span data-ttu-id="7b06c-243">Cette collection est disponible dès le début d’une requête *HttpRequest*, mais elle est supprimée à la fin de chaque requête.</span><span class="sxs-lookup"><span data-stu-id="7b06c-243">This collection is available from the start of an *HttpRequest* and is discarded at the end of each request.</span></span> <span data-ttu-id="7b06c-244">Vous pouvez y accéder en attribuant une valeur à une entrée de clé, ou en demandant la valeur d’une clé particulière.</span><span class="sxs-lookup"><span data-stu-id="7b06c-244">You can access it by  assigning a value to a keyed entry, or by requesting the value for a particular key.</span></span>

<span data-ttu-id="7b06c-245">Dans l’exemple suivant, le [middleware](xref:fundamentals/middleware/index) ajoute `isVerified` à la collection `Items`.</span><span class="sxs-lookup"><span data-stu-id="7b06c-245">In the following sample, [Middleware](xref:fundamentals/middleware/index) adds `isVerified` to the `Items` collection.</span></span>

```csharp
app.Use(async (context, next) =>
{
    // perform some verification
    context.Items["isVerified"] = true;
    await next.Invoke();
});
```

<span data-ttu-id="7b06c-246">Plus tard dans le pipeline, un autre middleware peut y accéder :</span><span class="sxs-lookup"><span data-stu-id="7b06c-246">Later in the pipeline, another middleware could access it:</span></span>

```csharp
app.Run(async (context) =>
{
    await context.Response.WriteAsync("Verified request? " +
        context.Items["isVerified"]);
});
```

<span data-ttu-id="7b06c-247">Si un middleware est destiné uniquement à l’usage d’une seule application, les clés `string` sont acceptables.</span><span class="sxs-lookup"><span data-stu-id="7b06c-247">For middleware that will only be used by a single app, `string` keys are acceptable.</span></span> <span data-ttu-id="7b06c-248">En revanche, un middleware devant être partagé entre plusieurs applications doit utiliser des clés d’objet uniques afin d’éviter tout risque de collision de clés.</span><span class="sxs-lookup"><span data-stu-id="7b06c-248">However, middleware that will be shared between applications should use unique object keys to avoid any chance of key collisions.</span></span> <span data-ttu-id="7b06c-249">Si vous concevez un middleware pour fonctionner sur plusieurs applications, utilisez une clé d’objet unique qui est définie dans la classe du middleware de la façon suivante :</span><span class="sxs-lookup"><span data-stu-id="7b06c-249">If you are developing middleware that must work across multiple applications, use a unique object key defined in your middleware class as shown below:</span></span>

```csharp
public class SampleMiddleware
{
    public static readonly object SampleKey = new Object();

    public async Task Invoke(HttpContext httpContext)
    {
        httpContext.Items[SampleKey] = "some value";
        // additional code omitted
    }
}
```

<span data-ttu-id="7b06c-250">Tout autre code peut accéder à la valeur stockée dans `HttpContext.Items` à l’aide de la clé exposée par la classe du middleware :</span><span class="sxs-lookup"><span data-stu-id="7b06c-250">Other code can access the value stored in `HttpContext.Items` using the key exposed by the middleware class:</span></span>

```csharp
public class HomeController : Controller
{
    public IActionResult Index()
    {
        string value = HttpContext.Items[SampleMiddleware.SampleKey];
    }
}
```

<span data-ttu-id="7b06c-251">Cette approche a également l’avantage d’éviter la répétition de « chaînes magiques » à plusieurs endroits dans le code.</span><span class="sxs-lookup"><span data-stu-id="7b06c-251">This approach also has the advantage of eliminating repetition of "magic strings" in multiple places in the code.</span></span>

## <a name="application-state-data"></a><span data-ttu-id="7b06c-252">Données d’état d’application</span><span class="sxs-lookup"><span data-stu-id="7b06c-252">Application state data</span></span>

<span data-ttu-id="7b06c-253">Utilisez [l’injection de dépendances](xref:fundamentals/dependency-injection) pour rendre les données accessibles à tous les utilisateurs :</span><span class="sxs-lookup"><span data-stu-id="7b06c-253">Use [Dependency Injection](xref:fundamentals/dependency-injection) to make data available to all users:</span></span>

1. <span data-ttu-id="7b06c-254">Définissez un service qui contient les données (par exemple, une classe nommée `MyAppData`).</span><span class="sxs-lookup"><span data-stu-id="7b06c-254">Define a service containing the data (for example, a class named `MyAppData`).</span></span>

    ```csharp
    public class MyAppData
    {
        // Declare properties/methods/etc.
    } 
    ```

2. <span data-ttu-id="7b06c-255">Ajoutez la classe de service `ConfigureServices` (par exemple `services.AddSingleton<MyAppData>();`).</span><span class="sxs-lookup"><span data-stu-id="7b06c-255">Add the service class to `ConfigureServices` (for example `services.AddSingleton<MyAppData>();`).</span></span>

3. <span data-ttu-id="7b06c-256">Consommez la classe de service de données dans chaque contrôleur :</span><span class="sxs-lookup"><span data-stu-id="7b06c-256">Consume the data service class in each controller:</span></span>

    ```csharp
    public class MyController : Controller
    {
        public MyController(MyAppData myService)
        {
            // Do something with the service (read some data from it, 
            // store it in a private field/property, etc.)
        }
    } 
    ```

## <a name="common-errors-when-working-with-session"></a><span data-ttu-id="7b06c-257">Erreurs courantes lors de l’utilisation de Session</span><span class="sxs-lookup"><span data-stu-id="7b06c-257">Common errors when working with session</span></span>

* <span data-ttu-id="7b06c-258">« Impossible de résoudre le service pour le type 'Microsoft.Extensions.Caching.Distributed.IDistributedCache' lors de la tentative d’activation de 'Microsoft.AspNetCore.Session.DistributedSessionStore'. »</span><span class="sxs-lookup"><span data-stu-id="7b06c-258">"Unable to resolve service for type 'Microsoft.Extensions.Caching.Distributed.IDistributedCache' while attempting to activate 'Microsoft.AspNetCore.Session.DistributedSessionStore'."</span></span>

  <span data-ttu-id="7b06c-259">Cette erreur est généralement due à un échec de configuration d’au moins une implémentation `IDistributedCache`.</span><span class="sxs-lookup"><span data-stu-id="7b06c-259">This is usually caused by failing to configure at least one `IDistributedCache` implementation.</span></span> <span data-ttu-id="7b06c-260">Pour plus d’informations, consultez [Utiliser un cache distribué](xref:performance/caching/distributed) et [Mise en cache en mémoire](xref:performance/caching/memory).</span><span class="sxs-lookup"><span data-stu-id="7b06c-260">For more information, see [Work with a Distributed Cache](xref:performance/caching/distributed) and [In memory caching](xref:performance/caching/memory).</span></span>

* <span data-ttu-id="7b06c-261">Dans le cas où le middleware Session ne parvient pas à rendre une session persistance (par exemple, si la base de données n’est pas disponible), il enregistre l’exception dans le journal et la supprime.</span><span class="sxs-lookup"><span data-stu-id="7b06c-261">In the event that the session middleware fails to persist a session (for example: if the database isn't available), it logs the exception and swallows it.</span></span> <span data-ttu-id="7b06c-262">La requête continue ensuite normalement, ce qui entraîne un comportement très imprévisible.</span><span class="sxs-lookup"><span data-stu-id="7b06c-262">The request will then continue normally, which leads to very unpredictable behavior.</span></span>

<span data-ttu-id="7b06c-263">Voici un exemple type :</span><span class="sxs-lookup"><span data-stu-id="7b06c-263">A typical example:</span></span>

<span data-ttu-id="7b06c-264">Un utilisateur stocke un panier d’achat dans la session.</span><span class="sxs-lookup"><span data-stu-id="7b06c-264">Someone stores a shopping basket in session.</span></span> <span data-ttu-id="7b06c-265">L’utilisateur ajoute un élément, mais la validation échoue.</span><span class="sxs-lookup"><span data-stu-id="7b06c-265">The user adds an item but the commit fails.</span></span> <span data-ttu-id="7b06c-266">L’application n’a pas connaissance de l’échec et affiche incorrectement un message du type « L’élément a été ajouté ».</span><span class="sxs-lookup"><span data-stu-id="7b06c-266">The app doesn't know about the failure so it reports the message "The item has been added", which isn't true.</span></span>

<span data-ttu-id="7b06c-267">La méthode recommandée pour rechercher les erreurs de ce type consiste à appeler `await feature.Session.CommitAsync();` à partir du code d’application quand vous avez terminé l’écriture dans Session.</span><span class="sxs-lookup"><span data-stu-id="7b06c-267">The recommended way to check for such errors is to call `await feature.Session.CommitAsync();` from app code when you're done writing to the session.</span></span> <span data-ttu-id="7b06c-268">Vous pouvez ensuite traiter l’erreur comme vous le souhaitez.</span><span class="sxs-lookup"><span data-stu-id="7b06c-268">Then you can do what you like with the error.</span></span> <span data-ttu-id="7b06c-269">Le processus est le même quand vous appelez `LoadAsync`.</span><span class="sxs-lookup"><span data-stu-id="7b06c-269">It works the same way when calling `LoadAsync`.</span></span>

### <a name="additional-resources"></a><span data-ttu-id="7b06c-270">Ressources supplémentaires</span><span class="sxs-lookup"><span data-stu-id="7b06c-270">Additional resources</span></span>

* [<span data-ttu-id="7b06c-271">ASP.NET Core 1.x : exemple de code utilisé dans ce document</span><span class="sxs-lookup"><span data-stu-id="7b06c-271">ASP.NET Core 1.x: Sample code used in this document</span></span>](https://github.com/aspnet/Docs/tree/master/aspnetcore/fundamentals/app-state/sample/src/WebAppSession)
* [<span data-ttu-id="7b06c-272">ASP.NET Core 2.x : exemple de code utilisé dans ce document</span><span class="sxs-lookup"><span data-stu-id="7b06c-272">ASP.NET Core 2.x: Sample code used in this document</span></span>](https://github.com/aspnet/Docs/tree/master/aspnetcore/fundamentals/app-state/sample/src/WebAppSessionDotNetCore2.0App)
