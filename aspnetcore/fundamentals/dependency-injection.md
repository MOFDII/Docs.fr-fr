---
title: Injection de dépendances dans ASP.NET Core
author: ardalis
description: Découvrez comment ASP.NET Core implémente l’injection de dépendances et comment l’utiliser.
manager: wpickett
ms.author: riande
ms.custom: H1Hack27Feb2017
ms.date: 10/14/2016
ms.prod: asp.net-core
ms.technology: aspnet
ms.topic: article
uid: fundamentals/dependency-injection
ms.openlocfilehash: 700ceb081b2067f932ce8ed08c45c62058775e33
ms.sourcegitcommit: 3d071fabaf90e32906df97b08a8d00e602db25c0
ms.translationtype: HT
ms.contentlocale: fr-FR
ms.lasthandoff: 05/10/2018
---
# <a name="dependency-injection-in-aspnet-core"></a><span data-ttu-id="07b98-103">Injection de dépendances dans ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="07b98-103">Dependency injection in ASP.NET Core</span></span>

<a name="fundamentals-dependency-injection"></a>

<span data-ttu-id="07b98-104">Par [Steve Smith](https://ardalis.com/) et [Scott Addie](https://scottaddie.com)</span><span class="sxs-lookup"><span data-stu-id="07b98-104">By [Steve Smith](https://ardalis.com/) and [Scott Addie](https://scottaddie.com)</span></span>

<span data-ttu-id="07b98-105">ASP.NET Core est conçu à la base pour prendre en charge et exploiter l’injection de dépendances.</span><span class="sxs-lookup"><span data-stu-id="07b98-105">ASP.NET Core is designed from the ground up to support and leverage dependency injection.</span></span> <span data-ttu-id="07b98-106">Les applications ASP.NET Core peuvent tirer parti des services de framework intégrés en les injectant dans des méthodes de la classe Startup et les services d’application peuvent également être configurés pour l’injection.</span><span class="sxs-lookup"><span data-stu-id="07b98-106">ASP.NET Core applications can leverage built-in framework services by having them injected into methods in the Startup class, and application services can be configured for injection as well.</span></span> <span data-ttu-id="07b98-107">Le conteneur de services par défaut fourni par ASP.NET Core offre un ensemble minimal de fonctionnalités et n’a pas vocation à remplacer d’autres conteneurs.</span><span class="sxs-lookup"><span data-stu-id="07b98-107">The default services container provided by ASP.NET Core provides a minimal feature set and isn't intended to replace other containers.</span></span>

<span data-ttu-id="07b98-108">[Affichez ou téléchargez l’exemple de code](https://github.com/aspnet/Docs/tree/master/aspnetcore/fundamentals/dependency-injection/sample) ([procédure de téléchargement](xref:tutorials/index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="07b98-108">[View or download sample code](https://github.com/aspnet/Docs/tree/master/aspnetcore/fundamentals/dependency-injection/sample) ([how to download](xref:tutorials/index#how-to-download-a-sample))</span></span>

## <a name="what-is-dependency-injection"></a><span data-ttu-id="07b98-109">Qu’est-ce que l’injection de dépendances ?</span><span class="sxs-lookup"><span data-stu-id="07b98-109">What is dependency injection?</span></span>

<span data-ttu-id="07b98-110">L’injection de dépendances est une technique de couplage faible entre des objets et leurs collaborateurs, ou dépendances.</span><span class="sxs-lookup"><span data-stu-id="07b98-110">Dependency injection (DI) is a technique for achieving loose coupling between objects and their collaborators, or dependencies.</span></span> <span data-ttu-id="07b98-111">Au lieu d’instancier directement des collaborateurs ou d’utiliser des références statiques, les objets dont a besoin une classe pour effectuer ses opérations sont fournis à la classe d’une certaine manière.</span><span class="sxs-lookup"><span data-stu-id="07b98-111">Rather than directly instantiating collaborators, or using static references, the objects a class needs in order to perform its actions are provided to the class in some fashion.</span></span> <span data-ttu-id="07b98-112">Le plus souvent, les classes déclarent leurs dépendances par le biais de leur constructeur, ce qui leur permet de suivre le [principe des dépendances explicites](http://deviq.com/explicit-dependencies-principle/).</span><span class="sxs-lookup"><span data-stu-id="07b98-112">Most often, classes will declare their dependencies via their constructor, allowing them to follow the [Explicit Dependencies Principle](http://deviq.com/explicit-dependencies-principle/).</span></span> <span data-ttu-id="07b98-113">Cette approche est appelée « injection de constructeurs ».</span><span class="sxs-lookup"><span data-stu-id="07b98-113">This approach is known as "constructor injection".</span></span>

<span data-ttu-id="07b98-114">Lorsque les classes sont conçues avec l’injection de dépendances à l’esprit, leur couplage est plus faible car elles n’ont de dépendances directes codées en dur vis-à-vis de leurs collaborateurs.</span><span class="sxs-lookup"><span data-stu-id="07b98-114">When classes are designed with DI in mind, they're more loosely coupled because they don't have direct, hard-coded dependencies on their collaborators.</span></span> <span data-ttu-id="07b98-115">Cette conception suit le [principe de l’inversion de dépendances](http://deviq.com/dependency-inversion-principle/), qui stipule que les *« modules de niveau supérieur ne doivent pas dépendre de modules de niveau inférieur ; tous doivent dépendre d’abstractions »*.</span><span class="sxs-lookup"><span data-stu-id="07b98-115">This follows the [Dependency Inversion Principle](http://deviq.com/dependency-inversion-principle/), which states that *"high level modules shouldn't depend on low level modules; both should depend on abstractions."*</span></span> <span data-ttu-id="07b98-116">Au lieu de référencer des implémentations spécifiques, les classes demandent des abstractions (généralement `interfaces`) qui leur sont fournies lors de la construction de la classe.</span><span class="sxs-lookup"><span data-stu-id="07b98-116">Instead of referencing specific implementations, classes request abstractions (typically `interfaces`) which are provided to them when the class is constructed.</span></span> <span data-ttu-id="07b98-117">L’extraction de dépendances dans des interfaces et la fourniture des implémentations de ces interfaces en tant que paramètres sont également des exemples du [modèle de conception de stratégie](http://deviq.com/strategy-design-pattern/).</span><span class="sxs-lookup"><span data-stu-id="07b98-117">Extracting dependencies into interfaces and providing implementations of these interfaces as parameters is also an example of the [Strategy design pattern](http://deviq.com/strategy-design-pattern/).</span></span>

<span data-ttu-id="07b98-118">Lorsqu’un système est conçu pour utiliser l’injection de dépendances, avec de nombreuses classes qui demandent leurs dépendances par le biais de leur constructeur (ou leurs propriétés), il est judicieux d’avoir une classe dédiée à la création de ces classes avec leurs dépendances associées.</span><span class="sxs-lookup"><span data-stu-id="07b98-118">When a system is designed to use DI, with many classes requesting their dependencies via their constructor (or properties), it's helpful to have a class dedicated to creating these classes with their associated dependencies.</span></span> <span data-ttu-id="07b98-119">Ces classes sont appelés des *conteneurs*, ou plus particulièrement, des conteneurs d’[inversion de contrôle](http://deviq.com/inversion-of-control/) ou des conteneurs d’injection de dépendances.</span><span class="sxs-lookup"><span data-stu-id="07b98-119">These classes are referred to as *containers*, or more specifically, [Inversion of Control (IoC)](http://deviq.com/inversion-of-control/) containers or Dependency Injection (DI) containers.</span></span> <span data-ttu-id="07b98-120">Un conteneur est grosso modo une fabrique chargée de fournir des instances de types demandées à partir d’elle-même.</span><span class="sxs-lookup"><span data-stu-id="07b98-120">A container is essentially a factory that's responsible for providing instances of types that are requested from it.</span></span> <span data-ttu-id="07b98-121">Si un type donné a déclaré qu’il possède des dépendances et que le conteneur a été configuré pour fournir les types de dépendances, il crée les dépendances dans le cadre de la création de l’instance demandée.</span><span class="sxs-lookup"><span data-stu-id="07b98-121">If a given type has declared that it has dependencies, and the container has been configured to provide the dependency types, it will create the dependencies as part of creating the requested instance.</span></span> <span data-ttu-id="07b98-122">De cette façon, des graphiques de dépendance complexes peuvent être fournis aux classes sans exiger de construction d’objet codé en dur.</span><span class="sxs-lookup"><span data-stu-id="07b98-122">In this way, complex dependency graphs can be provided to classes without the need for any hard-coded object construction.</span></span> <span data-ttu-id="07b98-123">En plus de créer des objets avec leurs dépendances, les conteneurs gèrent généralement les durées de vie des objets au sein de l’application.</span><span class="sxs-lookup"><span data-stu-id="07b98-123">In addition to creating objects with their dependencies, containers typically manage object lifetimes within the application.</span></span>

<span data-ttu-id="07b98-124">ASP.NET Core inclut un simple conteneur intégré (représenté par l’interface `IServiceProvider`) qui prend en charge l’injection de constructeurs par défaut, et ASP.NET rend certains services disponibles par le biais de l’injection de dépendances.</span><span class="sxs-lookup"><span data-stu-id="07b98-124">ASP.NET Core includes a simple built-in container (represented by the `IServiceProvider` interface) that supports constructor injection by default, and ASP.NET makes certain services available through DI.</span></span> <span data-ttu-id="07b98-125">Le conteneur d’ASP.NET fait référence aux types qu’il gère comme des *services*.</span><span class="sxs-lookup"><span data-stu-id="07b98-125">ASP.NET's container refers to the types it manages as *services*.</span></span> <span data-ttu-id="07b98-126">Dans le reste de cet article, les *services* font référence aux types gérés par le conteneur d’inversion de contrôle d’ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="07b98-126">Throughout the rest of this article, *services* will refer to types that are managed by ASP.NET Core's IoC container.</span></span> <span data-ttu-id="07b98-127">Vous configurez les services du conteneur intégré dans la méthode `ConfigureServices` de la classe `Startup` de votre application.</span><span class="sxs-lookup"><span data-stu-id="07b98-127">You configure the built-in container's services in the `ConfigureServices` method in your application's `Startup` class.</span></span>

> [!NOTE]
> <span data-ttu-id="07b98-128">Martin Fowler a écrit un article complet sur les [conteneurs d’inversion de contrôle et le modèle d’injection de dépendances](https://www.martinfowler.com/articles/injection.html).</span><span class="sxs-lookup"><span data-stu-id="07b98-128">Martin Fowler has written an extensive article on [Inversion of Control Containers and the Dependency Injection Pattern](https://www.martinfowler.com/articles/injection.html).</span></span> <span data-ttu-id="07b98-129">Le groupe Microsoft Patterns and Practices fait également une excellente description de l’[injection de dépendances](https://msdn.microsoft.com/library/hh323705.aspx).</span><span class="sxs-lookup"><span data-stu-id="07b98-129">Microsoft Patterns and Practices also has a great description of [Dependency Injection](https://msdn.microsoft.com/library/hh323705.aspx).</span></span>

> [!NOTE]
> <span data-ttu-id="07b98-130">Cet article traite de l’injection de dépendance telle qu’elle s’applique à toutes les applications ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="07b98-130">This article covers Dependency Injection as it applies to all ASP.NET applications.</span></span> <span data-ttu-id="07b98-131">L’injection de dépendances au sein des contrôleurs MVC est abordée dans [Injection de dépendances et contrôleurs](../mvc/controllers/dependency-injection.md).</span><span class="sxs-lookup"><span data-stu-id="07b98-131">Dependency Injection within MVC controllers is covered in [Dependency Injection and Controllers](../mvc/controllers/dependency-injection.md).</span></span>

### <a name="constructor-injection-behavior"></a><span data-ttu-id="07b98-132">Comportement d’injection de constructeurs</span><span class="sxs-lookup"><span data-stu-id="07b98-132">Constructor injection behavior</span></span>

<span data-ttu-id="07b98-133">L’injection de constructeurs exige que le constructeur en question soit *public*.</span><span class="sxs-lookup"><span data-stu-id="07b98-133">Constructor injection requires that the constructor in question be *public*.</span></span> <span data-ttu-id="07b98-134">Sinon, votre application lève une `InvalidOperationException` :</span><span class="sxs-lookup"><span data-stu-id="07b98-134">Otherwise, your app will throw an `InvalidOperationException`:</span></span>

> <span data-ttu-id="07b98-135">Impossible de trouver un constructeur approprié pour le type 'VotreType'.</span><span class="sxs-lookup"><span data-stu-id="07b98-135">A suitable constructor for type 'YourType' couldn't be located.</span></span> <span data-ttu-id="07b98-136">Vérifiez que le type est concret et que des services sont inscrits pour tous les paramètres d’un constructeur public.</span><span class="sxs-lookup"><span data-stu-id="07b98-136">Ensure the type is concrete and services are registered for all parameters of a public constructor.</span></span>

<span data-ttu-id="07b98-137">L’injection de constructeurs exige qu’un seul constructeur applicable existe.</span><span class="sxs-lookup"><span data-stu-id="07b98-137">Constructor injection requires that only one applicable constructor exist.</span></span> <span data-ttu-id="07b98-138">Les surcharges de constructeurs sont prises en charge, mais une seule peut exister dont les arguments peuvent tous être satisfaits par l’injection de dépendances.</span><span class="sxs-lookup"><span data-stu-id="07b98-138">Constructor overloads are supported, but only one overload can exist whose arguments can all be fulfilled by dependency injection.</span></span> <span data-ttu-id="07b98-139">S’il en existe plusieurs, votre application lève une `InvalidOperationException` :</span><span class="sxs-lookup"><span data-stu-id="07b98-139">If more than one exists, your app will throw an `InvalidOperationException`:</span></span>

> <span data-ttu-id="07b98-140">Plusieurs constructeurs acceptant tous les types d’argument donnés ont été trouvés dans le type 'VotreType'.</span><span class="sxs-lookup"><span data-stu-id="07b98-140">Multiple constructors accepting all given argument types have been found in type 'YourType'.</span></span> <span data-ttu-id="07b98-141">Il ne doit y avoir qu’un seul constructeur applicable.</span><span class="sxs-lookup"><span data-stu-id="07b98-141">There should only be one applicable constructor.</span></span>

<span data-ttu-id="07b98-142">Les constructeurs peuvent accepter des arguments qui ne sont pas fournis par l’injection de dépendances, mais ceux-ci doivent prendre en charge les valeurs par défaut.</span><span class="sxs-lookup"><span data-stu-id="07b98-142">Constructors can accept arguments that are not provided by dependency injection, but these must support default values.</span></span> <span data-ttu-id="07b98-143">Exemple :</span><span class="sxs-lookup"><span data-stu-id="07b98-143">For example:</span></span>

```csharp
// throws InvalidOperationException: Unable to resolve service for type 'System.String'...
public CharactersController(ICharacterRepository characterRepository, string title)
{
    _characterRepository = characterRepository;
    _title = title;
}

// runs without error
public CharactersController(ICharacterRepository characterRepository, string title = "Characters")
{
    _characterRepository = characterRepository;
    _title = title;
}
```

## <a name="using-framework-provided-services"></a><span data-ttu-id="07b98-144">Utilisation des services fournis par le framework</span><span class="sxs-lookup"><span data-stu-id="07b98-144">Using framework-provided services</span></span>

<span data-ttu-id="07b98-145">La méthode `ConfigureServices` dans la classe `Startup` est chargée de définir les services utilisés par l’application, notamment les fonctionnalités de plateforme comme Entity Framework Core et ASP.NET Core MVC.</span><span class="sxs-lookup"><span data-stu-id="07b98-145">The `ConfigureServices` method in the `Startup` class is responsible for defining the services the application will use, including platform features like Entity Framework Core and ASP.NET Core MVC.</span></span> <span data-ttu-id="07b98-146">Au départ, la valeur `IServiceCollection` fournie à `ConfigureServices` a les services suivants définis (en fonction de [la manière dont l’hôte a été configuré](xref:fundamentals/hosting)) :</span><span class="sxs-lookup"><span data-stu-id="07b98-146">Initially, the `IServiceCollection` provided to `ConfigureServices` has the following services defined (depending on [how the host was configured](xref:fundamentals/hosting)):</span></span>

| <span data-ttu-id="07b98-147">Type de service</span><span class="sxs-lookup"><span data-stu-id="07b98-147">Service Type</span></span> | <span data-ttu-id="07b98-148">Durée de vie</span><span class="sxs-lookup"><span data-stu-id="07b98-148">Lifetime</span></span> |
| ----- | ------- |
| [<span data-ttu-id="07b98-149">Microsoft.AspNetCore.Hosting.IHostingEnvironment</span><span class="sxs-lookup"><span data-stu-id="07b98-149">Microsoft.AspNetCore.Hosting.IHostingEnvironment</span></span>](/dotnet/api/microsoft.aspnetcore.hosting.ihostingenvironment) | <span data-ttu-id="07b98-150">Singleton</span><span class="sxs-lookup"><span data-stu-id="07b98-150">Singleton</span></span> |
| [<span data-ttu-id="07b98-151">Microsoft.Extensions.Logging.ILoggerFactory</span><span class="sxs-lookup"><span data-stu-id="07b98-151">Microsoft.Extensions.Logging.ILoggerFactory</span></span>](/dotnet/api/microsoft.extensions.logging.iloggerfactory) | <span data-ttu-id="07b98-152">Singleton</span><span class="sxs-lookup"><span data-stu-id="07b98-152">Singleton</span></span> |
| [<span data-ttu-id="07b98-153">Microsoft.Extensions.Logging.ILogger&lt;T&gt;</span><span class="sxs-lookup"><span data-stu-id="07b98-153">Microsoft.Extensions.Logging.ILogger&lt;T&gt;</span></span>](/dotnet/api/microsoft.extensions.logging.ilogger) | <span data-ttu-id="07b98-154">Singleton</span><span class="sxs-lookup"><span data-stu-id="07b98-154">Singleton</span></span> |
| [<span data-ttu-id="07b98-155">Microsoft.AspNetCore.Hosting.Builder.IApplicationBuilderFactory</span><span class="sxs-lookup"><span data-stu-id="07b98-155">Microsoft.AspNetCore.Hosting.Builder.IApplicationBuilderFactory</span></span>](/dotnet/api/microsoft.aspnetcore.hosting.builder.iapplicationbuilderfactory) | <span data-ttu-id="07b98-156">Temporaire</span><span class="sxs-lookup"><span data-stu-id="07b98-156">Transient</span></span> |
| [<span data-ttu-id="07b98-157">Microsoft.AspNetCore.Http.IHttpContextFactory</span><span class="sxs-lookup"><span data-stu-id="07b98-157">Microsoft.AspNetCore.Http.IHttpContextFactory</span></span>](/dotnet/api/microsoft.aspnetcore.http.ihttpcontextfactory) | <span data-ttu-id="07b98-158">Temporaire</span><span class="sxs-lookup"><span data-stu-id="07b98-158">Transient</span></span> |
| [<span data-ttu-id="07b98-159">Microsoft.Extensions.Options.IOptions&lt;T&gt;</span><span class="sxs-lookup"><span data-stu-id="07b98-159">Microsoft.Extensions.Options.IOptions&lt;T&gt;</span></span>](/dotnet/api/microsoft.extensions.options.ioptions-1) | <span data-ttu-id="07b98-160">Singleton</span><span class="sxs-lookup"><span data-stu-id="07b98-160">Singleton</span></span> |
| [<span data-ttu-id="07b98-161">System.Diagnostics.DiagnosticSource</span><span class="sxs-lookup"><span data-stu-id="07b98-161">System.Diagnostics.DiagnosticSource</span></span>](https://docs.microsoft.com/dotnet/core/api/system.diagnostics.diagnosticsource) | <span data-ttu-id="07b98-162">Singleton</span><span class="sxs-lookup"><span data-stu-id="07b98-162">Singleton</span></span> |
| [<span data-ttu-id="07b98-163">System.Diagnostics.DiagnosticListener</span><span class="sxs-lookup"><span data-stu-id="07b98-163">System.Diagnostics.DiagnosticListener</span></span>](https://docs.microsoft.com/dotnet/core/api/system.diagnostics.diagnosticlistener) | <span data-ttu-id="07b98-164">Singleton</span><span class="sxs-lookup"><span data-stu-id="07b98-164">Singleton</span></span> |
| [<span data-ttu-id="07b98-165">Microsoft.AspNetCore.Hosting.IStartupFilter</span><span class="sxs-lookup"><span data-stu-id="07b98-165">Microsoft.AspNetCore.Hosting.IStartupFilter</span></span>](/dotnet/api/microsoft.aspnetcore.hosting.istartupfilter) | <span data-ttu-id="07b98-166">Temporaire</span><span class="sxs-lookup"><span data-stu-id="07b98-166">Transient</span></span> |
| [<span data-ttu-id="07b98-167">Microsoft.Extensions.ObjectPool.ObjectPoolProvider</span><span class="sxs-lookup"><span data-stu-id="07b98-167">Microsoft.Extensions.ObjectPool.ObjectPoolProvider</span></span>](/dotnet/api/microsoft.extensions.objectpool.objectpoolprovider) | <span data-ttu-id="07b98-168">Singleton</span><span class="sxs-lookup"><span data-stu-id="07b98-168">Singleton</span></span> |
| [<span data-ttu-id="07b98-169">Microsoft.Extensions.Options.IConfigureOptions&lt;T&gt;</span><span class="sxs-lookup"><span data-stu-id="07b98-169">Microsoft.Extensions.Options.IConfigureOptions&lt;T&gt;</span></span>](/dotnet/api/microsoft.extensions.options.iconfigureoptions-1) | <span data-ttu-id="07b98-170">Temporaire</span><span class="sxs-lookup"><span data-stu-id="07b98-170">Transient</span></span> |
| [<span data-ttu-id="07b98-171">Microsoft.AspNetCore.Hosting.Server.IServer</span><span class="sxs-lookup"><span data-stu-id="07b98-171">Microsoft.AspNetCore.Hosting.Server.IServer</span></span>](/dotnet/api/microsoft.aspnetcore.hosting.server.iserver) | <span data-ttu-id="07b98-172">Singleton</span><span class="sxs-lookup"><span data-stu-id="07b98-172">Singleton</span></span> |
| [<span data-ttu-id="07b98-173">Microsoft.AspNetCore.Hosting.IStartup</span><span class="sxs-lookup"><span data-stu-id="07b98-173">Microsoft.AspNetCore.Hosting.IStartup</span></span>](/dotnet/api/microsoft.aspnetcore.hosting.istartup) | <span data-ttu-id="07b98-174">Singleton</span><span class="sxs-lookup"><span data-stu-id="07b98-174">Singleton</span></span> |
| [<span data-ttu-id="07b98-175">Microsoft.AspNetCore.Hosting.IApplicationLifetime</span><span class="sxs-lookup"><span data-stu-id="07b98-175">Microsoft.AspNetCore.Hosting.IApplicationLifetime</span></span>](/dotnet/api/microsoft.aspnetcore.hosting.iapplicationlifetime) | <span data-ttu-id="07b98-176">Singleton</span><span class="sxs-lookup"><span data-stu-id="07b98-176">Singleton</span></span> |

<span data-ttu-id="07b98-177">Voici un exemple qui montre comment ajouter des services supplémentaires au conteneur à l’aide de plusieurs méthodes d’extension comme `AddDbContext`, `AddIdentity` et `AddMvc`.</span><span class="sxs-lookup"><span data-stu-id="07b98-177">Below is an example of how to add additional services to the container using a number of extension methods like `AddDbContext`, `AddIdentity`, and `AddMvc`.</span></span>

[!code-csharp[](../common/samples/WebApplication1/Startup.cs?highlight=5-6,8-10,12&range=39-56)]

<span data-ttu-id="07b98-178">Les fonctionnalités et l’intergiciel (middleware) fournis par ASP.NET, comme MVC, respectent une convention visant à utiliser une seule méthode d’extension Add*ServiceName* pour inscrire tous les services requis par cette fonctionnalité.</span><span class="sxs-lookup"><span data-stu-id="07b98-178">The features and middleware provided by ASP.NET, such as MVC, follow a convention of using a single Add*ServiceName* extension method to register all of the services required by that feature.</span></span>

> [!TIP]
> <span data-ttu-id="07b98-179">Vous pouvez demander certains services fournis par le framework au sein des méthodes `Startup` par le biais de leurs listes de paramètres. Consultez [Démarrage d’une application](startup.md) pour plus d’informations.</span><span class="sxs-lookup"><span data-stu-id="07b98-179">You can request certain framework-provided services within `Startup` methods through their parameter lists - see [Application Startup](startup.md) for more details.</span></span>

## <a name="registering-services"></a><span data-ttu-id="07b98-180">Inscription de services</span><span class="sxs-lookup"><span data-stu-id="07b98-180">Registering services</span></span>

<span data-ttu-id="07b98-181">Vous pouvez inscrire vos propres services d’application comme suit.</span><span class="sxs-lookup"><span data-stu-id="07b98-181">You can register your own application services as follows.</span></span> <span data-ttu-id="07b98-182">Le premier type générique représente le type (en général une interface) demandé à partir du conteneur.</span><span class="sxs-lookup"><span data-stu-id="07b98-182">The first generic type represents the type (typically an interface) that will be requested from the container.</span></span> <span data-ttu-id="07b98-183">Le deuxième type générique représente le type concret instancié par le conteneur et utilisé pour répondre à de telles demandes.</span><span class="sxs-lookup"><span data-stu-id="07b98-183">The second generic type represents the concrete type that will be instantiated by the container and used to fulfill such requests.</span></span>

[!code-csharp[](../common/samples/WebApplication1/Startup.cs?range=53-54)]

> [!NOTE]
> <span data-ttu-id="07b98-184">Chaque méthode d’extension `services.Add<ServiceName>` ajoute (et éventuellement configure) des services.</span><span class="sxs-lookup"><span data-stu-id="07b98-184">Each `services.Add<ServiceName>` extension method adds (and potentially configures) services.</span></span> <span data-ttu-id="07b98-185">Par exemple, `services.AddMvc()` ajoute les services dont MVC a besoin.</span><span class="sxs-lookup"><span data-stu-id="07b98-185">For example, `services.AddMvc()` adds the services MVC requires.</span></span> <span data-ttu-id="07b98-186">Il est recommandé de suivre cette convention, en plaçant des méthodes d’extension dans l’espace de noms `Microsoft.Extensions.DependencyInjection`, pour encapsuler des groupes d’inscriptions de services.</span><span class="sxs-lookup"><span data-stu-id="07b98-186">It's recommended that you follow this convention, placing extension methods in the `Microsoft.Extensions.DependencyInjection` namespace, to encapsulate groups of service registrations.</span></span>

<span data-ttu-id="07b98-187">La méthode `AddTransient` est utilisée pour mapper des types abstraits sur des services concrets instanciés séparément pour chaque objet qui en a besoin.</span><span class="sxs-lookup"><span data-stu-id="07b98-187">The `AddTransient` method is used to map abstract types to concrete services that are instantiated separately for every object that requires it.</span></span> <span data-ttu-id="07b98-188">Il s’agit de la *durée de vie* du service. D’autres options de durée de vie sont décrites ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="07b98-188">This is known as the service's *lifetime*, and additional lifetime options are described below.</span></span> <span data-ttu-id="07b98-189">Il est important de choisir une durée de vie appropriée pour chacun des services que vous inscrivez.</span><span class="sxs-lookup"><span data-stu-id="07b98-189">It's important to choose an appropriate lifetime for each of the services you register.</span></span> <span data-ttu-id="07b98-190">Une nouvelle instance du service doit-elle être fournie à chaque classe qui le demande ?</span><span class="sxs-lookup"><span data-stu-id="07b98-190">Should a new instance of the service be provided to each class that requests it?</span></span> <span data-ttu-id="07b98-191">Une seule instance doit-elle être utilisée tout au long d’une requête web donnée ?</span><span class="sxs-lookup"><span data-stu-id="07b98-191">Should one instance be used throughout a given web request?</span></span> <span data-ttu-id="07b98-192">Ou une seule instance doit-elle être utilisée pendant la durée de vie de l’application ?</span><span class="sxs-lookup"><span data-stu-id="07b98-192">Or should a single instance be used for the lifetime of the application?</span></span>

<span data-ttu-id="07b98-193">Dans l’exemple de cet article, il existe un simple contrôleur qui affiche les noms des caractères, appelé `CharactersController`.</span><span class="sxs-lookup"><span data-stu-id="07b98-193">In the sample for this article, there's a simple controller that displays character names, called `CharactersController`.</span></span> <span data-ttu-id="07b98-194">Sa méthode `Index` affiche la liste actuelle des caractères stockés dans l’application et initialise la collection avec quelques caractères, s’il n’en existe aucun.</span><span class="sxs-lookup"><span data-stu-id="07b98-194">Its `Index` method displays the current list of characters that have been stored in the application, and initializes the collection with a handful of characters if none exist.</span></span> <span data-ttu-id="07b98-195">Notez que bien que cette application utilise Entity Framework Core et la classe `ApplicationDbContext` pour sa persistance, rien de tout cela n’apparaît dans le contrôleur.</span><span class="sxs-lookup"><span data-stu-id="07b98-195">Note that although this application uses Entity Framework Core and the `ApplicationDbContext` class for its persistence, none of that's apparent in the controller.</span></span> <span data-ttu-id="07b98-196">Au lieu de cela, le mécanisme d’accès aux données spécifique est rendu abstrait derrière une interface, `ICharacterRepository`, qui suit le [modèle de référentiel](http://deviq.com/repository-pattern/).</span><span class="sxs-lookup"><span data-stu-id="07b98-196">Instead, the specific data access mechanism has been abstracted behind an interface, `ICharacterRepository`, which follows the [repository pattern](http://deviq.com/repository-pattern/).</span></span> <span data-ttu-id="07b98-197">Une instance de `ICharacterRepository` est demandée via le constructeur et attribuée à un champ privé, qui est ensuite utilisé pour accéder aux caractères selon les besoins.</span><span class="sxs-lookup"><span data-stu-id="07b98-197">An instance of `ICharacterRepository` is requested via the constructor and assigned to a private field, which is then used to access characters as necessary.</span></span>

[!code-csharp[](../fundamentals/dependency-injection/sample/DependencyInjectionSample/Controllers/CharactersController.cs?highlight=3,5,6,7,8,14,21-27&range=8-36)]

<span data-ttu-id="07b98-198">`ICharacterRepository` définit les deux méthodes dont le contrôleur a besoin pour utiliser les instances de `Character`.</span><span class="sxs-lookup"><span data-stu-id="07b98-198">The `ICharacterRepository` defines the two methods the controller needs to work with `Character` instances.</span></span>

[!code-csharp[](../fundamentals/dependency-injection/sample/DependencyInjectionSample/Interfaces/ICharacterRepository.cs?highlight=8,9)]

<span data-ttu-id="07b98-199">Cette interface est à son tour implémentée par un type concret, `CharacterRepository`, qui est utilisé au moment de l’exécution.</span><span class="sxs-lookup"><span data-stu-id="07b98-199">This interface is in turn implemented by a concrete type, `CharacterRepository`, that's used at runtime.</span></span>

> [!NOTE]
> <span data-ttu-id="07b98-200">La façon dont l’injection de dépendances est utilisée avec la classe `CharacterRepository` est un modèle général que vous pouvez suivre pour tous vos services d’application, pas seulement dans les « référentiels » ou les classes d’accès aux données.</span><span class="sxs-lookup"><span data-stu-id="07b98-200">The way DI is used with the `CharacterRepository` class is a general model you can follow for all of your application services, not just in "repositories" or data access classes.</span></span>

[!code-csharp[](../fundamentals/dependency-injection/sample/DependencyInjectionSample/Models/CharacterRepository.cs?highlight=9,11,12,13,14)]

<span data-ttu-id="07b98-201">Notez que `CharacterRepository` exige un `ApplicationDbContext` dans son constructeur.</span><span class="sxs-lookup"><span data-stu-id="07b98-201">Note that `CharacterRepository` requests an `ApplicationDbContext` in its constructor.</span></span> <span data-ttu-id="07b98-202">Il n’est pas rare que l’injection de dépendances soit utilisée de manière chaînée comme cela, avec chaque dépendance demandée demandant à son tour ses propres dépendances.</span><span class="sxs-lookup"><span data-stu-id="07b98-202">It's not unusual for dependency injection to be used in a chained fashion like this, with each requested dependency in turn requesting its own dependencies.</span></span> <span data-ttu-id="07b98-203">Le conteneur est chargé de résoudre toutes les dépendances dans le graphique et de retourner le service entièrement résolu.</span><span class="sxs-lookup"><span data-stu-id="07b98-203">The container is responsible for resolving all of the dependencies in the graph and returning the fully resolved service.</span></span>

> [!NOTE]
> <span data-ttu-id="07b98-204">La création de l’objet demandé, et de tous les objets dont il a besoin, et de tous les objets dont ceux-ci ont besoin, est parfois appelée *graphique d’objet*.</span><span class="sxs-lookup"><span data-stu-id="07b98-204">Creating the requested object, and all of the objects it requires, and all of the objects those require, is sometimes referred to as an *object graph*.</span></span> <span data-ttu-id="07b98-205">De même, l’ensemble collectif de dépendances qui doivent être résolues est généralement appelé *arborescence des dépendances* ou *graphique de dépendance*.</span><span class="sxs-lookup"><span data-stu-id="07b98-205">Likewise, the collective set of dependencies that must be resolved is typically referred to as a *dependency tree* or *dependency graph*.</span></span>

<span data-ttu-id="07b98-206">Dans ce cas, à la fois `ICharacterRepository` et à son tour `ApplicationDbContext` doivent être inscrits auprès du conteneur de services dans `ConfigureServices` dans `Startup`.</span><span class="sxs-lookup"><span data-stu-id="07b98-206">In this case, both `ICharacterRepository` and in turn `ApplicationDbContext` must be registered with the services container in `ConfigureServices` in `Startup`.</span></span> <span data-ttu-id="07b98-207">`ApplicationDbContext` est configuré avec l’appel à la méthode d’extension `AddDbContext<T>`.</span><span class="sxs-lookup"><span data-stu-id="07b98-207">`ApplicationDbContext` is configured with the call to the extension method `AddDbContext<T>`.</span></span> <span data-ttu-id="07b98-208">Le code suivant illustre l’inscription du type `CharacterRepository`.</span><span class="sxs-lookup"><span data-stu-id="07b98-208">The following code shows the registration of the `CharacterRepository` type.</span></span>

[!code-csharp[](dependency-injection/sample/DependencyInjectionSample/Startup.cs?highlight=3-5,11&range=16-32)]

<span data-ttu-id="07b98-209">Vous devez ajouter des contextes Entity Framework au conteneur de services en utilisant la durée de vie `Scoped`.</span><span class="sxs-lookup"><span data-stu-id="07b98-209">Entity Framework contexts should be added to the services container using the `Scoped` lifetime.</span></span> <span data-ttu-id="07b98-210">Cet ajout est automatique si vous utilisez les méthodes d’assistance comme indiqué ci-dessus.</span><span class="sxs-lookup"><span data-stu-id="07b98-210">This is taken care of automatically if you use the helper methods as shown above.</span></span> <span data-ttu-id="07b98-211">Les référentiels qui utilisent Entity Framework doivent utiliser la même durée de vie.</span><span class="sxs-lookup"><span data-stu-id="07b98-211">Repositories that will make use of Entity Framework should use the same lifetime.</span></span>

> [!WARNING]
> <span data-ttu-id="07b98-212">Le principal danger à surveiller a trait à la résolution d’un service `Scoped` depuis un singleton.</span><span class="sxs-lookup"><span data-stu-id="07b98-212">The main danger to be wary of is resolving a `Scoped` service from a singleton.</span></span> <span data-ttu-id="07b98-213">Il est probable dans ce cas que l’état du service ne soit pas correct lors du traitement des requêtes suivantes.</span><span class="sxs-lookup"><span data-stu-id="07b98-213">It's likely in such a case that the service will have incorrect state when processing subsequent requests.</span></span>

<span data-ttu-id="07b98-214">Les services qui ont des dépendances doivent les inscrire dans le conteneur.</span><span class="sxs-lookup"><span data-stu-id="07b98-214">Services that have dependencies should register them in the container.</span></span> <span data-ttu-id="07b98-215">Si le constructeur d’un service exige une primitive, comme `string`, celle-ci peut être injectée à l’aide de la [configuration](xref:fundamentals/configuration/index) et du [modèle d’options](xref:fundamentals/configuration/options).</span><span class="sxs-lookup"><span data-stu-id="07b98-215">If a service's constructor requires a primitive, such as a `string`, this can be injected by using [configuration](xref:fundamentals/configuration/index) and the [options pattern](xref:fundamentals/configuration/options).</span></span>

## <a name="service-lifetimes-and-registration-options"></a><span data-ttu-id="07b98-216">Durée de vie du service et options d’inscription</span><span class="sxs-lookup"><span data-stu-id="07b98-216">Service lifetimes and registration options</span></span>

<span data-ttu-id="07b98-217">Vous pouvez configurer les services ASP.NET avec les durées de vie suivantes :</span><span class="sxs-lookup"><span data-stu-id="07b98-217">ASP.NET services can be configured with the following lifetimes:</span></span>

<span data-ttu-id="07b98-218">**Transient**</span><span class="sxs-lookup"><span data-stu-id="07b98-218">**Transient**</span></span>

<span data-ttu-id="07b98-219">Des services à durée de vie temporaire sont créés chaque fois qu’ils sont demandés.</span><span class="sxs-lookup"><span data-stu-id="07b98-219">Transient lifetime services are created each time they're requested.</span></span> <span data-ttu-id="07b98-220">Cette durée de vie convient parfaitement aux services légers et sans état.</span><span class="sxs-lookup"><span data-stu-id="07b98-220">This lifetime works best for lightweight, stateless services.</span></span>

<span data-ttu-id="07b98-221">**Scoped**</span><span class="sxs-lookup"><span data-stu-id="07b98-221">**Scoped**</span></span>

<span data-ttu-id="07b98-222">Les services à durée de vie délimitée sont créés une seule fois par requête.</span><span class="sxs-lookup"><span data-stu-id="07b98-222">Scoped lifetime services are created once per request.</span></span>

> [!WARNING]
> <span data-ttu-id="07b98-223">Si vous utilisez un service délimité dans un middleware, injectez le service dans la méthode `Invoke` ou `InvokeAsync`.</span><span class="sxs-lookup"><span data-stu-id="07b98-223">If you're using a scoped service in a middleware, inject the service into the `Invoke` or `InvokeAsync` method.</span></span> <span data-ttu-id="07b98-224">Ne faites pas l’injection via l’injection du constructeur, car elle force le service à se comporter comme un singleton.</span><span class="sxs-lookup"><span data-stu-id="07b98-224">Don't inject via constructor injection because it forces the service to behave like a singleton.</span></span>

<span data-ttu-id="07b98-225">**Singleton**</span><span class="sxs-lookup"><span data-stu-id="07b98-225">**Singleton**</span></span>

<span data-ttu-id="07b98-226">Les services à durée de vie singleton sont créés la première fois qu’ils sont demandés (ou lorsque `ConfigureServices` est exécuté si vous y spécifiez une instance), puis chaque requête suivante utilise la même instance.</span><span class="sxs-lookup"><span data-stu-id="07b98-226">Singleton lifetime services are created the first time they're requested (or when `ConfigureServices` is run if you specify an instance there) and then every subsequent request will use the same instance.</span></span> <span data-ttu-id="07b98-227">Si votre application exige un comportement singleton, il est recommandé d’autoriser le conteneur de services à gérer la durée de vie du service au lieu d’implémenter le modèle de conception singleton et de gérer la durée de vie de votre objet dans la classe vous-même.</span><span class="sxs-lookup"><span data-stu-id="07b98-227">If your application requires singleton behavior, allowing the services container to manage the service's lifetime is recommended instead of implementing the singleton design pattern and managing your object's lifetime in the class yourself.</span></span>

<span data-ttu-id="07b98-228">Vous pouvez inscrire des services auprès du conteneur de plusieurs façons.</span><span class="sxs-lookup"><span data-stu-id="07b98-228">Services can be registered with the container in several ways.</span></span> <span data-ttu-id="07b98-229">Nous avons déjà vu comment inscrire une implémentation de service avec un type donné en spécifiant le type concret à utiliser.</span><span class="sxs-lookup"><span data-stu-id="07b98-229">We have already seen how to register a service implementation with a given type by specifying the concrete type to use.</span></span> <span data-ttu-id="07b98-230">En outre, une fabrique peut être spécifiée. Elle est ensuite utilisée pour créer l’instance à la demande.</span><span class="sxs-lookup"><span data-stu-id="07b98-230">In addition, a factory can be specified, which will then be used to create the instance on demand.</span></span> <span data-ttu-id="07b98-231">La troisième méthode consiste à spécifier directement l’instance du type à utiliser, auquel cas le conteneur n’essaie jamais de créer une instance (ni d’en disposer).</span><span class="sxs-lookup"><span data-stu-id="07b98-231">The third approach is to directly specify the instance of the type to use, in which case the container will never attempt to create an instance (nor will it dispose of the instance).</span></span>

<span data-ttu-id="07b98-232">Pour illustrer la différence entre ces options de durée de vie et d’inscription, considérez une interface simple qui représente une ou plusieurs tâches en tant qu’*opération* avec un identificateur unique, `OperationId`.</span><span class="sxs-lookup"><span data-stu-id="07b98-232">To demonstrate the difference between these lifetime and registration options, consider a simple interface that represents one or more tasks as an *operation* with a unique identifier, `OperationId`.</span></span> <span data-ttu-id="07b98-233">Selon la façon dont nous configurons la durée de vie de ce service, le conteneur fournit les mêmes instances ou des instances différentes du service à la classe qui effectue la requête.</span><span class="sxs-lookup"><span data-stu-id="07b98-233">Depending on how we configure the lifetime for this service, the container will provide either the same or different instances of the service to the requesting class.</span></span> <span data-ttu-id="07b98-234">Pour indiquer clairement quelle durée de vie est demandée, nous allons créer un seul type par option de durée de vie :</span><span class="sxs-lookup"><span data-stu-id="07b98-234">To make it clear which lifetime is being requested, we will create one type per lifetime option:</span></span>

[!code-csharp[](../fundamentals/dependency-injection/sample/DependencyInjectionSample/Interfaces/IOperation.cs?highlight=5-8)]

<span data-ttu-id="07b98-235">Nous implémentons ces interfaces à l’aide d’une seule classe, `Operation`, qui accepte un `Guid` dans son constructeur ou utilise un nouveau `Guid` si aucun n’est fourni.</span><span class="sxs-lookup"><span data-stu-id="07b98-235">We implement these interfaces using a single class, `Operation`, that accepts a `Guid` in its constructor, or uses a new `Guid` if none is provided.</span></span>

<span data-ttu-id="07b98-236">Ensuite, dans `ConfigureServices`, chaque type est ajouté au conteneur en fonction de sa durée de vie nommée :</span><span class="sxs-lookup"><span data-stu-id="07b98-236">Next, in `ConfigureServices`, each type is added to the container according to its named lifetime:</span></span>

[!code-csharp[](dependency-injection/sample/DependencyInjectionSample/Startup.cs?range=26-32)]

<span data-ttu-id="07b98-237">Notez que le service `IOperationSingletonInstance` utilise une instance spécifique avec un ID connu de `Guid.Empty` pour que l’utilisation de ce type soit clairement indiquée (son GUID ne contient que des zéros).</span><span class="sxs-lookup"><span data-stu-id="07b98-237">Note that the `IOperationSingletonInstance` service is using a specific instance with a known ID of `Guid.Empty` so it will be clear when this type is in use (its Guid will be all zeroes).</span></span> <span data-ttu-id="07b98-238">Nous avons également inscrit un `OperationService` qui dépend de chacun des autres types `Operation`, pour qu’il soit clairement déterminé au sein d’une demande si ce service obtient la même instance que le contrôleur, ou une nouvelle, pour chaque type d’opération.</span><span class="sxs-lookup"><span data-stu-id="07b98-238">We have also registered an `OperationService` that depends on each of the other `Operation` types, so that it will be clear within a request whether this service is getting the same instance as the controller, or a new one, for each operation type.</span></span> <span data-ttu-id="07b98-239">Ce service se contente d’exposer ses dépendances comme des propriétés, afin de pouvoir les présenter dans l’affichage.</span><span class="sxs-lookup"><span data-stu-id="07b98-239">All this service does is expose its dependencies as properties, so they can be displayed in the view.</span></span>

[!code-csharp[](dependency-injection/sample/DependencyInjectionSample/Services/OperationService.cs)]

<span data-ttu-id="07b98-240">Pour illustrer les durées de vie des objets dans et entre les requêtes individuelles distinctes faites à l’application, l’exemple inclut un `OperationsController` qui demande chaque type `IOperation` ainsi qu’un `OperationService`.</span><span class="sxs-lookup"><span data-stu-id="07b98-240">To demonstrate the object lifetimes within and between separate individual requests to the application, the sample includes an `OperationsController` that requests each kind of `IOperation` type as well as an `OperationService`.</span></span> <span data-ttu-id="07b98-241">L’action `Index` affiche alors toutes les valeurs `OperationId` du contrôleur et du service.</span><span class="sxs-lookup"><span data-stu-id="07b98-241">The `Index` action then displays all of the controller's and service's `OperationId` values.</span></span>

[!code-csharp[](dependency-injection/sample/DependencyInjectionSample/Controllers/OperationsController.cs)]

<span data-ttu-id="07b98-242">Maintenant, deux requêtes distinctes sont effectuées auprès de cette action de contrôleur :</span><span class="sxs-lookup"><span data-stu-id="07b98-242">Now two separate requests are made to this controller action:</span></span>

![Affichage des opérations de l’exemple d’application web d’injection de dépendances en cours d’exécution dans Microsoft Edge présentant les valeurs d’ID d’opération (GUID) des opérations temporaires, délimitées, singleton du contrôleur d’instance et du service d’opération pour la première requête.](dependency-injection/_static/lifetimes_request1.png)

![Affichage des opérations montrant les valeurs d’ID d’opération pour une deuxième requête.](dependency-injection/_static/lifetimes_request2.png)

<span data-ttu-id="07b98-245">Observez les valeurs `OperationId` qui varient au sein d’une requête et entre les requêtes.</span><span class="sxs-lookup"><span data-stu-id="07b98-245">Observe which of the `OperationId` values vary within a request, and between requests.</span></span>

* <span data-ttu-id="07b98-246">Les objets *temporaires* sont toujours différents ; une nouvelle instance est fournie à chaque contrôleur et à chaque service.</span><span class="sxs-lookup"><span data-stu-id="07b98-246">*Transient* objects are always different; a new instance is provided to every controller and every service.</span></span>

* <span data-ttu-id="07b98-247">Les objets *délimités* sont les mêmes au sein d’une requête, mais ils diffèrent entre les différentes requêtes.</span><span class="sxs-lookup"><span data-stu-id="07b98-247">*Scoped* objects are the same within a request, but different across different requests</span></span>

* <span data-ttu-id="07b98-248">Les objets *singleton* sont les mêmes pour chaque objet et chaque requête (qu’une instance soit fournie dans `ConfigureServices` ou non).</span><span class="sxs-lookup"><span data-stu-id="07b98-248">*Singleton* objects are the same for every object and every request (regardless of whether an instance is provided in `ConfigureServices`)</span></span>

## <a name="resolve-a-scoped-service-within-the-application-scope"></a><span data-ttu-id="07b98-249">Résoudre un service délimité dans l’étendue de l’application</span><span class="sxs-lookup"><span data-stu-id="07b98-249">Resolve a scoped service within the application scope</span></span>

<span data-ttu-id="07b98-250">Créez un [IServiceScope](/dotnet/api/microsoft.extensions.dependencyinjection.iservicescope) avec [IServiceScopeFactory.CreateScope](/dotnet/api/microsoft.extensions.dependencyinjection.iservicescopefactory.createscope) pour résoudre un service délimité dans l’étendue de l’application.</span><span class="sxs-lookup"><span data-stu-id="07b98-250">Create an [IServiceScope](/dotnet/api/microsoft.extensions.dependencyinjection.iservicescope) with [IServiceScopeFactory.CreateScope](/dotnet/api/microsoft.extensions.dependencyinjection.iservicescopefactory.createscope) to resolve a scoped service within the app's scope.</span></span> <span data-ttu-id="07b98-251">Cette approche est pratique pour accéder à un service délimité au démarrage pour exécuter des tâches d’initialisation.</span><span class="sxs-lookup"><span data-stu-id="07b98-251">This approach is useful to access a scoped service at startup to run initialization tasks.</span></span> <span data-ttu-id="07b98-252">L’exemple suivant montre comment obtenir un contexte pour `MyScopedService` dans `Program.Main` :</span><span class="sxs-lookup"><span data-stu-id="07b98-252">The following example shows how to obtain a context for the `MyScopedService` in `Program.Main`:</span></span>

```csharp
public static void Main(string[] args)
{
    var host = BuildWebHost(args);

    using (var serviceScope = host.Services.CreateScope())
    {
        var services = serviceScope.ServiceProvider;

        try
        {
            var serviceContext = services.GetRequiredService<MyScopedService>();
            // Use the context here
        }
        catch (Exception ex)
        {
            var logger = services.GetRequiredService<ILogger<Program>>();
            logger.LogError(ex, "An error occurred.");
        }
    }

    host.Run();
}
```

## <a name="scope-validation"></a><span data-ttu-id="07b98-253">Validation de l’étendue</span><span class="sxs-lookup"><span data-stu-id="07b98-253">Scope validation</span></span>

<span data-ttu-id="07b98-254">Quand l’application s’exécute dans l’environnement de développement sur ASP.NET Core 2.0 ou ultérieur, le fournisseur de services par défaut effectue des contrôles pour vérifier que :</span><span class="sxs-lookup"><span data-stu-id="07b98-254">When the app is running in the Development environment on ASP.NET Core 2.0 or later, the default service provider performs checks to verify that:</span></span>

* <span data-ttu-id="07b98-255">Les services délimités ne sont pas résolus directement ou indirectement à partir du fournisseur de services racine.</span><span class="sxs-lookup"><span data-stu-id="07b98-255">Scoped services aren't directly or indirectly resolved from the root service provider.</span></span>
* <span data-ttu-id="07b98-256">Les services délimités ne sont pas directement ou indirectement injectés dans des singletons.</span><span class="sxs-lookup"><span data-stu-id="07b98-256">Scoped services aren't directly or indirectly injected into singletons.</span></span>

<span data-ttu-id="07b98-257">Le fournisseur de services racine est créé quand [BuildServiceProvider](/dotnet/api/microsoft.extensions.dependencyinjection.servicecollectioncontainerbuilderextensions.buildserviceprovider) est appelé.</span><span class="sxs-lookup"><span data-stu-id="07b98-257">The root service provider is created when [BuildServiceProvider](/dotnet/api/microsoft.extensions.dependencyinjection.servicecollectioncontainerbuilderextensions.buildserviceprovider) is called.</span></span> <span data-ttu-id="07b98-258">La durée de vie du fournisseur de services racine correspond à la durée de vie de l’application/du serveur quand le fournisseur démarre avec l’application et qu’il est supprimé quand l’application s’arrête.</span><span class="sxs-lookup"><span data-stu-id="07b98-258">The root service provider's lifetime corresponds to the app/server's lifetime when the provider starts with the app and is disposed when the app shuts down.</span></span>

<span data-ttu-id="07b98-259">Les services délimités sont supprimés par le conteneur qui les a créés.</span><span class="sxs-lookup"><span data-stu-id="07b98-259">Scoped services are disposed by the container that created them.</span></span> <span data-ttu-id="07b98-260">Si un service délimité est créé dans le conteneur racine, la durée de vie du service est promue en singleton, car elle est supprimée par le conteneur racine seulement quand l’application/le serveur est arrêté.</span><span class="sxs-lookup"><span data-stu-id="07b98-260">If a scoped service is created in the root container, the service's lifetime is effectively promoted to singleton because it's only disposed by the root container when app/server is shut down.</span></span> <span data-ttu-id="07b98-261">La validation des étendues du service permet de traiter ces situations quand `BuildServiceProvider` est appelé.</span><span class="sxs-lookup"><span data-stu-id="07b98-261">Validating service scopes catches these situations when `BuildServiceProvider` is called.</span></span>

<span data-ttu-id="07b98-262">Pour plus d’informations, consultez [Validation des étendues dans la rubrique Hébergement](xref:fundamentals/hosting#scope-validation).</span><span class="sxs-lookup"><span data-stu-id="07b98-262">For more information, see [Scope validation in the Hosting topic](xref:fundamentals/hosting#scope-validation).</span></span>

## <a name="request-services"></a><span data-ttu-id="07b98-263">Services de requête</span><span class="sxs-lookup"><span data-stu-id="07b98-263">Request Services</span></span>

<span data-ttu-id="07b98-264">Les services disponibles au sein d’une requête ASP.NET à partir de `HttpContext` sont exposés par le biais de la collection `RequestServices`.</span><span class="sxs-lookup"><span data-stu-id="07b98-264">The services available within an ASP.NET request from `HttpContext` are exposed through the `RequestServices` collection.</span></span>

![Boîte de dialogue contextuelle Intellisense des services de requête HttpContext indiquant que les services de requête obtiennent ou définissent la valeur IServiceProvider qui fournit l’accès au conteneur de services de la requête.](dependency-injection/_static/request-services.png)

<span data-ttu-id="07b98-266">Les services de requête représentent les services que vous configurez et demandez dans le cadre de votre application.</span><span class="sxs-lookup"><span data-stu-id="07b98-266">Request Services represent the services you configure and request as part of your application.</span></span> <span data-ttu-id="07b98-267">Lorsque vos objets spécifient des dépendances, ceux-ci sont satisfaits par les types trouvés dans `RequestServices`, pas dans `ApplicationServices`.</span><span class="sxs-lookup"><span data-stu-id="07b98-267">When your objects specify dependencies, these are satisfied by the types found in `RequestServices`, not `ApplicationServices`.</span></span>

<span data-ttu-id="07b98-268">En règle générale, vous ne devez pas utiliser ces propriétés directement, mais plutôt préférer demander les types dont vos classes ont besoin par le biais du constructeur de votre classe et laisser le framework injecter ces dépendances.</span><span class="sxs-lookup"><span data-stu-id="07b98-268">Generally, you shouldn't use these properties directly, preferring instead to request the types your classes you require via your class's constructor, and letting the framework inject these dependencies.</span></span> <span data-ttu-id="07b98-269">Vous obtenez ainsi des classes plus faciles à tester (consultez [Tester et déboguer](../testing/index.md)) et plus faiblement couplées.</span><span class="sxs-lookup"><span data-stu-id="07b98-269">This yields classes that are easier to test (see [Test and debug](../testing/index.md)) and are more loosely coupled.</span></span>

> [!NOTE]
> <span data-ttu-id="07b98-270">Préférez demander des dépendances en tant que paramètres de constructeur plutôt qu’accéder à la collection `RequestServices`.</span><span class="sxs-lookup"><span data-stu-id="07b98-270">Prefer requesting dependencies as constructor parameters to accessing the `RequestServices` collection.</span></span>

## <a name="designing-services-for-dependency-injection"></a><span data-ttu-id="07b98-271">Conception de services pour l’injection de dépendances</span><span class="sxs-lookup"><span data-stu-id="07b98-271">Designing services for dependency injection</span></span>

<span data-ttu-id="07b98-272">Vous devez concevoir vos services pour qu’ils utilisent l’injection de dépendances afin d’obtenir leurs collaborateurs.</span><span class="sxs-lookup"><span data-stu-id="07b98-272">You should design your services to use dependency injection to get their collaborators.</span></span> <span data-ttu-id="07b98-273">Cela signifie que vous devez éviter d’utiliser des appels de méthode statique avec état (qui entraînent un « code smell » appelé « [static cling](http://deviq.com/static-cling/) ») et d’instancier directement des classes dépendantes au sein de vos services.</span><span class="sxs-lookup"><span data-stu-id="07b98-273">This means avoiding the use of stateful static method calls (which result in a code smell known as [static cling](http://deviq.com/static-cling/)) and the direct instantiation of dependent classes within your services.</span></span> <span data-ttu-id="07b98-274">Cela peut vous aider de mémoriser l’expression « [New is Glue](https://ardalis.com/new-is-glue) », quand vous choisissez d’instancier ou non un type ou de le demander par le biais de l’injection de dépendances.</span><span class="sxs-lookup"><span data-stu-id="07b98-274">It may help to remember the phrase, [New is Glue](https://ardalis.com/new-is-glue), when choosing whether to instantiate a type or to request it via dependency injection.</span></span> <span data-ttu-id="07b98-275">En suivant les [principes SOLID de conception orientée objet](http://deviq.com/solid/), vos classes ont naturellement tendance à être petites, bien factorisées et facilement testées.</span><span class="sxs-lookup"><span data-stu-id="07b98-275">By following the [SOLID Principles of Object Oriented Design](http://deviq.com/solid/), your classes will naturally tend to be small, well-factored, and easily tested.</span></span>

<span data-ttu-id="07b98-276">Que se passe-t-il si vous trouvez que vos classes ont tendance à avoir trop de dépendances injectées ?</span><span class="sxs-lookup"><span data-stu-id="07b98-276">What if you find that your classes tend to have way too many dependencies being injected?</span></span> <span data-ttu-id="07b98-277">C’est généralement le signe que votre classe essaie d’en faire trop et qu’elle enfreint probablement le [principe de responsabilité unique](http://deviq.com/single-responsibility-principle/).</span><span class="sxs-lookup"><span data-stu-id="07b98-277">This is generally a sign that your class is trying to do too much, and is probably violating SRP - the [Single Responsibility Principle](http://deviq.com/single-responsibility-principle/).</span></span> <span data-ttu-id="07b98-278">Essayez de refactoriser la classe en déplaçant certaines de ses responsabilités dans une nouvelle classe.</span><span class="sxs-lookup"><span data-stu-id="07b98-278">See if you can refactor the class by moving some of its responsibilities into a new class.</span></span> <span data-ttu-id="07b98-279">N’oubliez pas que vos classes `Controller` doivent se concentrer sur les préoccupations de l’interface utilisateur, donc les règles d’entreprise et les détails d’implémentation de l’accès aux données doivent être conservés dans les classes appropriées à ces [préoccupations distinctes](http://deviq.com/separation-of-concerns/).</span><span class="sxs-lookup"><span data-stu-id="07b98-279">Keep in mind that your `Controller` classes should be focused on UI concerns, so business rules and data access implementation details should be kept in classes appropriate to these [separate concerns](http://deviq.com/separation-of-concerns/).</span></span>

<span data-ttu-id="07b98-280">En ce qui concerne l’accès aux données en particulier, vous pouvez injecter `DbContext` dans vos contrôleurs (en supposant que vous ayez ajouté EF au conteneur de services dans `ConfigureServices`).</span><span class="sxs-lookup"><span data-stu-id="07b98-280">With regards to data access specifically, you can inject the `DbContext` into your controllers (assuming you've added EF to the services container in `ConfigureServices`).</span></span> <span data-ttu-id="07b98-281">Certains développeurs préfèrent utiliser une interface de référentiel pour la base de données plutôt que d’injecter directement `DbContext`.</span><span class="sxs-lookup"><span data-stu-id="07b98-281">Some developers prefer to use a repository interface to the database rather than injecting the `DbContext` directly.</span></span> <span data-ttu-id="07b98-282">L’utilisation d’une interface pour encapsuler la logique d’accès aux données à un seul emplacement permet de réduire le nombre d’emplacements à modifier quand votre base de données évolue.</span><span class="sxs-lookup"><span data-stu-id="07b98-282">Using an interface to encapsulate the data access logic in one place can minimize how many places you will have to change when your database changes.</span></span>

### <a name="disposing-of-services"></a><span data-ttu-id="07b98-283">Mise à disposition des services</span><span class="sxs-lookup"><span data-stu-id="07b98-283">Disposing of services</span></span>

<span data-ttu-id="07b98-284">Le conteneur appelle `Dispose` pour les types `IDisposable` qu’il crée.</span><span class="sxs-lookup"><span data-stu-id="07b98-284">The container will call `Dispose` for `IDisposable` types it creates.</span></span> <span data-ttu-id="07b98-285">Toutefois, si vous ajoutez une instance au conteneur vous-même, elle n’est pas mise à disposition.</span><span class="sxs-lookup"><span data-stu-id="07b98-285">However, if you add an instance to the container yourself, it will not be disposed.</span></span>

<span data-ttu-id="07b98-286">Exemple :</span><span class="sxs-lookup"><span data-stu-id="07b98-286">Example:</span></span>

```csharp
// Services implement IDisposable:
public class Service1 : IDisposable {}
public class Service2 : IDisposable {}
public class Service3 : IDisposable {}

public interface ISomeService {}
public class SomeServiceImplementation : ISomeService, IDisposable {}


public void ConfigureServices(IServiceCollection services)
{
    // container will create the instance(s) of these types and will dispose them
    services.AddScoped<Service1>();
    services.AddSingleton<Service2>();
    services.AddSingleton<ISomeService>(sp => new SomeServiceImplementation());

    // container didn't create instance so it will NOT dispose it
    services.AddSingleton<Service3>(new Service3());
    services.AddSingleton(new Service3());
}
```

> [!NOTE]
> <span data-ttu-id="07b98-287">Dans la version 1.0, le conteneur appelé dispose de *tous* les objets `IDisposable`, y compris de ceux qu’il n’a pas créés.</span><span class="sxs-lookup"><span data-stu-id="07b98-287">In version 1.0, the container called dispose on *all* `IDisposable` objects, including those it didn't create.</span></span>

## <a name="replacing-the-default-services-container"></a><span data-ttu-id="07b98-288">Remplacement du conteneur de services par défaut</span><span class="sxs-lookup"><span data-stu-id="07b98-288">Replacing the default services container</span></span>

<span data-ttu-id="07b98-289">Le conteneur de services intégré a vocation à répondre aux besoins élémentaires du framework et de la plupart des applications consommatrices qui s’appuient sur ce dernier.</span><span class="sxs-lookup"><span data-stu-id="07b98-289">The built-in services container is meant to serve the basic needs of the framework and most consumer applications built on it.</span></span> <span data-ttu-id="07b98-290">Toutefois, les développeurs peuvent remplacer le conteneur intégré par leur conteneur préféré.</span><span class="sxs-lookup"><span data-stu-id="07b98-290">However, developers can replace the built-in container with their preferred container.</span></span> <span data-ttu-id="07b98-291">La méthode `ConfigureServices` retourne généralement `void`, mais si sa signature est modifiée afin de retourner `IServiceProvider`, un autre conteneur peut être configuré et retourné.</span><span class="sxs-lookup"><span data-stu-id="07b98-291">The `ConfigureServices` method typically returns `void`, but if its signature is changed to return `IServiceProvider`, a different container can be configured and returned.</span></span> <span data-ttu-id="07b98-292">Il existe de nombreux conteneurs d’inversion de contrôle disponibles pour .NET.</span><span class="sxs-lookup"><span data-stu-id="07b98-292">There are many IOC containers available for .NET.</span></span> <span data-ttu-id="07b98-293">Dans cet exemple, le package [Autofac](https://autofac.org/) est utilisé.</span><span class="sxs-lookup"><span data-stu-id="07b98-293">In this example, the [Autofac](https://autofac.org/) package is used.</span></span>

<span data-ttu-id="07b98-294">Tout d’abord, installez les packages de conteneurs appropriés :</span><span class="sxs-lookup"><span data-stu-id="07b98-294">First, install the appropriate container package(s):</span></span>

* `Autofac`
* `Autofac.Extensions.DependencyInjection`

<span data-ttu-id="07b98-295">Ensuite, configurez le conteneur dans `ConfigureServices` et retournez un `IServiceProvider` :</span><span class="sxs-lookup"><span data-stu-id="07b98-295">Next, configure the container in `ConfigureServices` and return an `IServiceProvider`:</span></span>

```csharp
public IServiceProvider ConfigureServices(IServiceCollection services)
{
    services.AddMvc();
    // Add other framework services

    // Add Autofac
    var containerBuilder = new ContainerBuilder();
    containerBuilder.RegisterModule<DefaultModule>();
    containerBuilder.Populate(services);
    var container = containerBuilder.Build();
    return new AutofacServiceProvider(container);
}
```

> [!NOTE]
> <span data-ttu-id="07b98-296">Lorsque vous utilisez un conteneur d’injection de dépendances tiers, vous devez modifier `ConfigureServices` afin de retourner `IServiceProvider` au lieu de `void`.</span><span class="sxs-lookup"><span data-stu-id="07b98-296">When using a third-party DI container, you must change `ConfigureServices` so that it returns `IServiceProvider` instead of `void`.</span></span>

<span data-ttu-id="07b98-297">Enfin, configurez Autofac normalement dans `DefaultModule` :</span><span class="sxs-lookup"><span data-stu-id="07b98-297">Finally, configure Autofac as normal in `DefaultModule`:</span></span>

```csharp
public class DefaultModule : Module
{
    protected override void Load(ContainerBuilder builder)
    {
        builder.RegisterType<CharacterRepository>().As<ICharacterRepository>();
    }
}
```

<span data-ttu-id="07b98-298">Au moment de l’exécution, Autofac est utilisé pour résoudre les types et injecter des dépendances.</span><span class="sxs-lookup"><span data-stu-id="07b98-298">At runtime, Autofac will be used to resolve types and inject dependencies.</span></span> <span data-ttu-id="07b98-299">[En savoir plus sur l’utilisation d’Autofac et d’ASP.NET Core](http://docs.autofac.org/en/latest/integration/aspnetcore.html).</span><span class="sxs-lookup"><span data-stu-id="07b98-299">[Learn more about using Autofac and ASP.NET Core](http://docs.autofac.org/en/latest/integration/aspnetcore.html).</span></span>

### <a name="thread-safety"></a><span data-ttu-id="07b98-300">Sécurité des threads</span><span class="sxs-lookup"><span data-stu-id="07b98-300">Thread safety</span></span>

<span data-ttu-id="07b98-301">Les services singleton doivent être thread-safe.</span><span class="sxs-lookup"><span data-stu-id="07b98-301">Singleton services need to be thread safe.</span></span> <span data-ttu-id="07b98-302">Si un service singleton a une dépendance vis-à-vis d’un service temporaire, ce dernier peut également avoir besoin d’être thread-safe selon la manière dont il est utilisé par le singleton.</span><span class="sxs-lookup"><span data-stu-id="07b98-302">If a singleton service has a dependency on a transient service, the transient service may also need to be thread safe depending how it's used by the singleton.</span></span>

## <a name="recommendations"></a><span data-ttu-id="07b98-303">Recommandations</span><span class="sxs-lookup"><span data-stu-id="07b98-303">Recommendations</span></span>

<span data-ttu-id="07b98-304">Lorsque vous utilisez l’injection de dépendances, gardez à l’esprit les recommandations suivantes :</span><span class="sxs-lookup"><span data-stu-id="07b98-304">When working with dependency injection, keep the following recommendations in mind:</span></span>

* <span data-ttu-id="07b98-305">L’injection de dépendances est destinée aux objets qui ont des dépendances complexes.</span><span class="sxs-lookup"><span data-stu-id="07b98-305">DI is for objects that have complex dependencies.</span></span> <span data-ttu-id="07b98-306">Les contrôleurs, les services, les adaptateurs et les référentiels sont tous des exemples d’objets susceptibles d’être ajoutés à l’injection de dépendances.</span><span class="sxs-lookup"><span data-stu-id="07b98-306">Controllers, services, adapters, and repositories are all examples of objects that might be added to DI.</span></span>

* <span data-ttu-id="07b98-307">Évitez de stocker des données et des configurations directement dans l’injection de dépendances.</span><span class="sxs-lookup"><span data-stu-id="07b98-307">Avoid storing data and configuration directly in DI.</span></span> <span data-ttu-id="07b98-308">Par exemple, le panier d’achat d’un utilisateur ne doit en général pas être ajouté au conteneur de services.</span><span class="sxs-lookup"><span data-stu-id="07b98-308">For example, a user's shopping cart shouldn't typically be added to the services container.</span></span> <span data-ttu-id="07b98-309">La configuration doit utiliser le [modèle d’options](xref:fundamentals/configuration/options).</span><span class="sxs-lookup"><span data-stu-id="07b98-309">Configuration should use the [options pattern](xref:fundamentals/configuration/options).</span></span> <span data-ttu-id="07b98-310">De même, évitez les objets « conteneurs de données » qui n’existent que pour autoriser l’accès à un autre objet.</span><span class="sxs-lookup"><span data-stu-id="07b98-310">Similarly, avoid "data holder" objects that only exist to allow access to some other object.</span></span> <span data-ttu-id="07b98-311">Il est préférable de demander l’élément réel dont vous avez besoin par le biais de l’injection de dépendances, si possible.</span><span class="sxs-lookup"><span data-stu-id="07b98-311">It's better to request the actual item needed via DI, if possible.</span></span>

* <span data-ttu-id="07b98-312">Évitez l’accès statique aux services.</span><span class="sxs-lookup"><span data-stu-id="07b98-312">Avoid static access to services.</span></span>

* <span data-ttu-id="07b98-313">Évitez l’emplacement du service dans votre code d’application.</span><span class="sxs-lookup"><span data-stu-id="07b98-313">Avoid service location in your application code.</span></span>

* <span data-ttu-id="07b98-314">Évitez l’accès statique à `HttpContext`.</span><span class="sxs-lookup"><span data-stu-id="07b98-314">Avoid static access to `HttpContext`.</span></span>

<span data-ttu-id="07b98-315">Comme pour toutes les recommandations, vous pouvez vous trouver dans des situations où il est nécessaire d’en ignorer une.</span><span class="sxs-lookup"><span data-stu-id="07b98-315">Like all sets of recommendations, you may encounter situations where ignoring one is required.</span></span> <span data-ttu-id="07b98-316">À notre sens, ces exceptions sont rares. Elles concernent principalement des cas très spéciaux au sein du framework lui-même.</span><span class="sxs-lookup"><span data-stu-id="07b98-316">We have found exceptions to be rare -- mostly very special cases within the framework itself.</span></span>

<span data-ttu-id="07b98-317">L’injection de dépendances constitue une *alternative* aux modèles d’accès aux objets statiques/globaux.</span><span class="sxs-lookup"><span data-stu-id="07b98-317">Dependency injection is an *alternative* to static/global object access patterns.</span></span> <span data-ttu-id="07b98-318">Il est possible que vous ne bénéficiez pas des avantages de l’injection de dépendances si vous la combinez avec l’accès aux objets statiques.</span><span class="sxs-lookup"><span data-stu-id="07b98-318">You may not be able to realize the benefits of DI if you mix it with static object access.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="07b98-319">Ressources supplémentaires</span><span class="sxs-lookup"><span data-stu-id="07b98-319">Additional resources</span></span>

* [<span data-ttu-id="07b98-320">Injection de dépendances dans les vues</span><span class="sxs-lookup"><span data-stu-id="07b98-320">Dependency injection into views</span></span>](xref:mvc/views/dependency-injection)
* [<span data-ttu-id="07b98-321">Injection de dépendances dans les contrôleurs</span><span class="sxs-lookup"><span data-stu-id="07b98-321">Dependency injection into controllers</span></span>](xref:mvc/controllers/dependency-injection)
* [<span data-ttu-id="07b98-322">Injection de dépendances dans les gestionnaires d’exigences</span><span class="sxs-lookup"><span data-stu-id="07b98-322">Dependency injection in requirement handlers</span></span>](xref:security/authorization/dependencyinjection)
* [<span data-ttu-id="07b98-323">Démarrage d’une application</span><span class="sxs-lookup"><span data-stu-id="07b98-323">Application Startup</span></span>](xref:fundamentals/startup)
* [<span data-ttu-id="07b98-324">Test et débogage</span><span class="sxs-lookup"><span data-stu-id="07b98-324">Test and debug</span></span>](xref:testing/index)
* [<span data-ttu-id="07b98-325">Activation d’intergiciel (middleware) basée sur une fabrique</span><span class="sxs-lookup"><span data-stu-id="07b98-325">Factory-based middleware activation</span></span>](xref:fundamentals/middleware/extensibility)
* [<span data-ttu-id="07b98-326">Écrire un code clair dans ASP.NET Core avec l’injection de dépendance (MSDN)</span><span class="sxs-lookup"><span data-stu-id="07b98-326">Writing Clean Code in ASP.NET Core with Dependency Injection (MSDN)</span></span>](https://msdn.microsoft.com/magazine/mt703433.aspx)
* [<span data-ttu-id="07b98-327">Prélude à la conception d’une application gérée par conteneur : à qui appartient le conteneur ?</span><span class="sxs-lookup"><span data-stu-id="07b98-327">Container-Managed Application Design, Prelude: Where does the Container Belong?</span></span>](https://blogs.msdn.microsoft.com/nblumhardt/2008/12/26/container-managed-application-design-prelude-where-does-the-container-belong/)
* [<span data-ttu-id="07b98-328">Principe des dépendances explicites</span><span class="sxs-lookup"><span data-stu-id="07b98-328">Explicit Dependencies Principle</span></span>](http://deviq.com/explicit-dependencies-principle/)
* <span data-ttu-id="07b98-329">[Conteneurs d’inversion de contrôle et modèle d’injection de dépendances](https://www.martinfowler.com/articles/injection.html) (Fowler)</span><span class="sxs-lookup"><span data-stu-id="07b98-329">[Inversion of Control Containers and the Dependency Injection Pattern](https://www.martinfowler.com/articles/injection.html) (Fowler)</span></span>
