---
title: Tester la logique des contrôleurs dans ASP.NET Core
author: ardalis
description: Découvrez plus d’informations sur le test de la logique des contrôleurs dans ASP.NET Core avec Moq et xUnit.
manager: wpickett
ms.author: riande
ms.date: 10/14/2016
ms.prod: asp.net-core
ms.technology: aspnet
ms.topic: article
uid: mvc/controllers/testing
ms.openlocfilehash: a0073e4de361c37a6854ceaf54ffd9eaea4837d4
ms.sourcegitcommit: 43bd79667bbdc8a07bd39fb4cd6f7ad3e70212fb
ms.translationtype: HT
ms.contentlocale: fr-FR
ms.lasthandoff: 06/04/2018
ms.locfileid: "34567047"
---
# <a name="test-controller-logic-in-aspnet-core"></a><span data-ttu-id="f1f97-103">Tester la logique des contrôleurs dans ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="f1f97-103">Test controller logic in ASP.NET Core</span></span>

<span data-ttu-id="f1f97-104">Par [Steve Smith](https://ardalis.com/)</span><span class="sxs-lookup"><span data-stu-id="f1f97-104">By [Steve Smith](https://ardalis.com/)</span></span>

<span data-ttu-id="f1f97-105">Les contrôleurs dans les applications ASP.NET MVC doivent être de petite taille et dédiés aux problèmes de l’interface utilisateur.</span><span class="sxs-lookup"><span data-stu-id="f1f97-105">Controllers in ASP.NET MVC apps should be small and focused on user-interface concerns.</span></span> <span data-ttu-id="f1f97-106">Les contrôleurs de grande taille qui traitent de problèmes autres que ceux de l’interface utilisateur sont plus difficiles à tester et à maintenir.</span><span class="sxs-lookup"><span data-stu-id="f1f97-106">Large controllers that deal with non-UI concerns are more difficult to test and maintain.</span></span>

<span data-ttu-id="f1f97-107">[Affichez ou téléchargez un exemple depuis GitHub](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/testing/sample).</span><span class="sxs-lookup"><span data-stu-id="f1f97-107">[View or download sample from GitHub](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/testing/sample)</span></span>

## <a name="testing-controllers"></a><span data-ttu-id="f1f97-108">Test des contrôleurs</span><span class="sxs-lookup"><span data-stu-id="f1f97-108">Testing controllers</span></span>

<span data-ttu-id="f1f97-109">Les contrôleurs sont une partie centrale des applications ASP.NET Core MVC.</span><span class="sxs-lookup"><span data-stu-id="f1f97-109">Controllers are a central part of any ASP.NET Core MVC application.</span></span> <span data-ttu-id="f1f97-110">Par conséquent, vous devez avoir entièrement confiance dans le fait qu’ils se comportent comme prévu pour votre application.</span><span class="sxs-lookup"><span data-stu-id="f1f97-110">As such, you should have confidence they behave as intended for your app.</span></span> <span data-ttu-id="f1f97-111">Les tests automatisés peuvent vous donner cette confiance et détecter des erreurs avant la mise en production.</span><span class="sxs-lookup"><span data-stu-id="f1f97-111">Automated tests can provide you with this confidence and can detect errors before they reach production.</span></span> <span data-ttu-id="f1f97-112">Il est important d’éviter de donner des responsabilités inutiles à vos contrôleurs et de faire en sorte que vos tests portent seulement sur les responsabilités du contrôleur.</span><span class="sxs-lookup"><span data-stu-id="f1f97-112">It's important to avoid placing unnecessary responsibilities within your controllers and ensure your tests focus only on controller responsibilities.</span></span>

<span data-ttu-id="f1f97-113">La logique d’un contrôleur doit être minimale et ne pas porter sur la logique métier ni sur les problèmes d’infrastructure (par exemple l’accès aux données).</span><span class="sxs-lookup"><span data-stu-id="f1f97-113">Controller logic should be minimal and not be focused on business logic or infrastructure concerns (for example, data access).</span></span> <span data-ttu-id="f1f97-114">Testez la logique du contrôleur et non pas le framework.</span><span class="sxs-lookup"><span data-stu-id="f1f97-114">Test controller logic, not the framework.</span></span> <span data-ttu-id="f1f97-115">Testez la façon dont le contrôleur *se comporte* en fonction d’entrées valides et non valides.</span><span class="sxs-lookup"><span data-stu-id="f1f97-115">Test how the controller *behaves* based on valid or invalid inputs.</span></span> <span data-ttu-id="f1f97-116">Testez les réponses du contrôleur sur la base du résultat de l’opération métier qu’il effectue.</span><span class="sxs-lookup"><span data-stu-id="f1f97-116">Test controller responses based on the result of the business operation it performs.</span></span>

<span data-ttu-id="f1f97-117">Voici les responsabilités classiques d’un contrôleur :</span><span class="sxs-lookup"><span data-stu-id="f1f97-117">Typical controller responsibilities:</span></span>

* <span data-ttu-id="f1f97-118">Vérifier `ModelState.IsValid`</span><span class="sxs-lookup"><span data-stu-id="f1f97-118">Verify `ModelState.IsValid`.</span></span>
* <span data-ttu-id="f1f97-119">Retourner une réponse d’erreur si `ModelState` n’est pas valide</span><span class="sxs-lookup"><span data-stu-id="f1f97-119">Return an error response if `ModelState` is invalid.</span></span>
* <span data-ttu-id="f1f97-120">Extraire une entité métier de son stockage.</span><span class="sxs-lookup"><span data-stu-id="f1f97-120">Retrieve a business entity from persistence.</span></span>
* <span data-ttu-id="f1f97-121">Effectuer une action sur l’entité métier.</span><span class="sxs-lookup"><span data-stu-id="f1f97-121">Perform an action on the business entity.</span></span>
* <span data-ttu-id="f1f97-122">Enregistrer l’entité métier dans un stockage.</span><span class="sxs-lookup"><span data-stu-id="f1f97-122">Save the business entity to persistence.</span></span>
* <span data-ttu-id="f1f97-123">Retourner un `IActionResult` approprié.</span><span class="sxs-lookup"><span data-stu-id="f1f97-123">Return an appropriate `IActionResult`.</span></span>

## <a name="unit-testing"></a><span data-ttu-id="f1f97-124">Test unitaire</span><span class="sxs-lookup"><span data-stu-id="f1f97-124">Unit testing</span></span>

<span data-ttu-id="f1f97-125">Les [tests unitaires](/dotnet/articles/core/testing/unit-testing-with-dotnet-test) impliquent le test d’une partie d’une application de façon isolée par rapport à son infrastructure et à ses dépendances.</span><span class="sxs-lookup"><span data-stu-id="f1f97-125">[Unit testing](/dotnet/articles/core/testing/unit-testing-with-dotnet-test) involves testing a part of an app in isolation from its infrastructure and dependencies.</span></span> <span data-ttu-id="f1f97-126">Lors du test de la logique d’un contrôleur, seul le contenu d’une action est testé, et non pas le comportement de ses dépendances ou du framework lui-même.</span><span class="sxs-lookup"><span data-stu-id="f1f97-126">When unit testing controller logic, only the contents of a single action is tested, not the behavior of its dependencies or of the framework itself.</span></span> <span data-ttu-id="f1f97-127">Quand vous procédez à des tests unitaires des actions de votre contrôleur, pensez à vous concentrer seulement sur son comportement.</span><span class="sxs-lookup"><span data-stu-id="f1f97-127">As you unit test your controller actions, make sure you focus only on its behavior.</span></span> <span data-ttu-id="f1f97-128">Les tests unitaires d’un contrôleur évitent les éléments tels que les [filtres](filters.md), le [routage](../../fundamentals/routing.md) ou la [liaison de modèle](../models/model-binding.md).</span><span class="sxs-lookup"><span data-stu-id="f1f97-128">A controller unit test avoids things like [filters](filters.md), [routing](../../fundamentals/routing.md), or [model binding](../models/model-binding.md).</span></span> <span data-ttu-id="f1f97-129">Étant consacrés au test d’une seule chose, les tests unitaires sont généralement simples à écrire et rapides à exécuter.</span><span class="sxs-lookup"><span data-stu-id="f1f97-129">By focusing on testing just one thing, unit tests are generally simple to write and quick to run.</span></span> <span data-ttu-id="f1f97-130">Un ensemble de tests unitaires bien écrits peut être exécuté fréquemment sans engendrer une surcharge importante.</span><span class="sxs-lookup"><span data-stu-id="f1f97-130">A well-written set of unit tests can be run frequently without much overhead.</span></span> <span data-ttu-id="f1f97-131">Cependant, les tests unitaires ne détectent pas les problèmes d’interaction entre les composants, qui sont l’objet des [tests d’intégration](xref:mvc/controllers/testing#integration-testing).</span><span class="sxs-lookup"><span data-stu-id="f1f97-131">However, unit tests don't detect issues in the interaction between components, which is the purpose of [integration tests](xref:mvc/controllers/testing#integration-testing).</span></span>

<span data-ttu-id="f1f97-132">Si vous écrivez par exemple des filtres ou des routes personnalisés, vous devez leur appliquer des tests unitaires, mais pas dans le cadre de vos tests sur une action spécifique d’un contrôleur.</span><span class="sxs-lookup"><span data-stu-id="f1f97-132">If you're writing custom filters, routes, etc, you should unit test them, but not as part of your tests on a particular controller action.</span></span> <span data-ttu-id="f1f97-133">Ils doivent être testés de façon isolée.</span><span class="sxs-lookup"><span data-stu-id="f1f97-133">They should be tested in isolation.</span></span>

> [!TIP]
> <span data-ttu-id="f1f97-134">[Créer et exécuter des tests unitaires avec Visual Studio](/visualstudio/test/unit-test-your-code)</span><span class="sxs-lookup"><span data-stu-id="f1f97-134">[Create and run unit tests with Visual Studio](/visualstudio/test/unit-test-your-code).</span></span>

<span data-ttu-id="f1f97-135">Pour voir ce que sont les tests unitaires, commencez par examiner le contrôleur suivant.</span><span class="sxs-lookup"><span data-stu-id="f1f97-135">To demonstrate unit testing, review the following controller.</span></span> <span data-ttu-id="f1f97-136">Il affiche une liste de sessions de brainstorming et permet la création de nouvelles sessions avec une requête POST :</span><span class="sxs-lookup"><span data-stu-id="f1f97-136">It displays a list of brainstorming sessions and allows new brainstorming sessions to be created with a POST:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Controllers/HomeController.cs?highlight=12,16,21,42,43)]

<span data-ttu-id="f1f97-137">Le contrôleur suit le [principe des dépendances explicites](http://deviq.com/explicit-dependencies-principle/), attendant qu’une injection de dépendances lui fournisse une instance de `IBrainstormSessionRepository`.</span><span class="sxs-lookup"><span data-stu-id="f1f97-137">The controller is following the [explicit dependencies principle](http://deviq.com/explicit-dependencies-principle/), expecting dependency injection to provide it with an instance of `IBrainstormSessionRepository`.</span></span> <span data-ttu-id="f1f97-138">Ceci le rend relativement facile à tester avec un framework d’objets fictifs, comme [Moq](https://www.nuget.org/packages/Moq/).</span><span class="sxs-lookup"><span data-stu-id="f1f97-138">This makes it fairly easy to test using a mock object framework, like [Moq](https://www.nuget.org/packages/Moq/).</span></span> <span data-ttu-id="f1f97-139">La méthode `HTTP GET Index` n’a pas de boucle ni de branchement, et elle appelle seulement une méthode.</span><span class="sxs-lookup"><span data-stu-id="f1f97-139">The `HTTP GET Index` method has no looping or branching and only calls one method.</span></span> <span data-ttu-id="f1f97-140">Pour tester cette méthode `Index`, nous devons vérifier qu’un `ViewResult` est retourné, avec un `ViewModel` provenant de la méthode `List` du référentiel.</span><span class="sxs-lookup"><span data-stu-id="f1f97-140">To test this `Index` method, we need to verify that a `ViewResult` is returned, with a `ViewModel` from the repository's `List` method.</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/HomeControllerTests.cs?highlight=17-18&range=1-33,76-95)]

<span data-ttu-id="f1f97-141">La méthode `HomeController` `HTTP POST Index` (montrée ci-dessus) doit vérifier :</span><span class="sxs-lookup"><span data-stu-id="f1f97-141">The `HomeController` `HTTP POST Index` method (shown above) should verify:</span></span>

* <span data-ttu-id="f1f97-142">La méthode d’action retourne une erreur Demande incorrecte : `ViewResult`, avec les données appropriées quand `ModelState.IsValid` est défini sur `false`</span><span class="sxs-lookup"><span data-stu-id="f1f97-142">The action method returns a Bad Request `ViewResult` with the appropriate data when `ModelState.IsValid` is `false`</span></span>

* <span data-ttu-id="f1f97-143">La méthode `Add` sur le référentiel est appelée et un `RedirectToActionResult` est retourné avec les arguments corrects quand `ModelState.IsValid` est défini sur true.</span><span class="sxs-lookup"><span data-stu-id="f1f97-143">The `Add` method on the repository is called and a `RedirectToActionResult` is returned with the correct arguments when `ModelState.IsValid` is true.</span></span>

<span data-ttu-id="f1f97-144">Un état de modèle non valide peut être testé en ajoutant des erreurs avec `AddModelError`, comme le montre le premier test ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="f1f97-144">Invalid model state can be tested by adding errors using `AddModelError` as shown in the first test below.</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/HomeControllerTests.cs?highlight=8,15-16,37-39&range=35-75)]

<span data-ttu-id="f1f97-145">Le premier test vérifie que quand `ModelState` n’est pas valide, le même `ViewResult` est retourné, comme pour une requête `GET`.</span><span class="sxs-lookup"><span data-stu-id="f1f97-145">The first test confirms when `ModelState` isn't valid, the same `ViewResult` is returned as for a `GET` request.</span></span> <span data-ttu-id="f1f97-146">Notez que le test ne tente pas de passer un modèle non valide.</span><span class="sxs-lookup"><span data-stu-id="f1f97-146">Note that the test doesn't attempt to pass in an invalid model.</span></span> <span data-ttu-id="f1f97-147">Ceci ne fonctionnerait de toute façon pas, car la liaison de modèle n’est pas en cours d’exécution (même si un [test d’intégration](xref:mvc/controllers/testing#integration-testing) utiliserait une liaison de modèle de test).</span><span class="sxs-lookup"><span data-stu-id="f1f97-147">That wouldn't work anyway since model binding isn't running (though an [integration test](xref:mvc/controllers/testing#integration-testing) would use exercise model binding).</span></span> <span data-ttu-id="f1f97-148">Dans ce cas, la liaison de modèle n’est pas testée.</span><span class="sxs-lookup"><span data-stu-id="f1f97-148">In this case, model binding isn't being tested.</span></span> <span data-ttu-id="f1f97-149">Ces tests unitaires testent seulement ce que fait le code dans la méthode d’action.</span><span class="sxs-lookup"><span data-stu-id="f1f97-149">These unit tests are only testing what the code in the action method does.</span></span>

<span data-ttu-id="f1f97-150">Le second test vérifie que quand `ModelState` est valide, une nouvelle `BrainstormSession` est ajoutée (via le référentiel), et que la méthode retourne un `RedirectToActionResult` avec les propriétés attendues.</span><span class="sxs-lookup"><span data-stu-id="f1f97-150">The second test verifies that when `ModelState` is valid, a new `BrainstormSession` is added (via the repository), and the method returns a `RedirectToActionResult` with the expected properties.</span></span> <span data-ttu-id="f1f97-151">Les appels fictifs qui ne sont pas appelés sont normalement ignorés, mais l’appel de `Verifiable` à la fin de l’appel de configuration lui permet d’être vérifié dans le test.</span><span class="sxs-lookup"><span data-stu-id="f1f97-151">Mocked calls that aren't called are normally ignored, but calling `Verifiable` at the end of the setup call allows it to be verified in the test.</span></span> <span data-ttu-id="f1f97-152">Ceci se fait avec l’appel à `mockRepo.Verify`, qui échoue au test si la méthode attendue n’a pas été appelée.</span><span class="sxs-lookup"><span data-stu-id="f1f97-152">This is done with the call to `mockRepo.Verify`, which will fail the test if the expected method wasn't called.</span></span>

> [!NOTE]
> <span data-ttu-id="f1f97-153">La bibliothèque Moq utilisée dans cet exemple facilite la combinaison d’éléments fictifs vérifiables (ou « stricts ») avec des éléments fictifs non vérifiables (également appelés éléments ou stubs « lâches»).</span><span class="sxs-lookup"><span data-stu-id="f1f97-153">The Moq library used in this sample makes it easy to mix verifiable, or "strict", mocks with non-verifiable mocks (also called "loose" mocks or stubs).</span></span> <span data-ttu-id="f1f97-154">Découvrez plus d’informations sur la [personnalisation des éléments fictifs avec Moq](https://github.com/Moq/moq4/wiki/Quickstart#customizing-mock-behavior).</span><span class="sxs-lookup"><span data-stu-id="f1f97-154">Learn more about [customizing Mock behavior with Moq](https://github.com/Moq/moq4/wiki/Quickstart#customizing-mock-behavior).</span></span>

<span data-ttu-id="f1f97-155">Un autre contrôleur de l’application affiche les informations relatives à une session de brainstorming particulière.</span><span class="sxs-lookup"><span data-stu-id="f1f97-155">Another controller in the app displays information related to a particular brainstorming session.</span></span> <span data-ttu-id="f1f97-156">Il inclut une logique pour traiter les valeurs d’ID non valides :</span><span class="sxs-lookup"><span data-stu-id="f1f97-156">It includes some logic to deal with invalid id values:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Controllers/SessionController.cs?highlight=19,20,21,22,25,26,27,28)]

<span data-ttu-id="f1f97-157">L’action du contrôleur a trois cas à tester, une pour chaque instruction `return` :</span><span class="sxs-lookup"><span data-stu-id="f1f97-157">The controller action has three cases to test, one for each `return` statement:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/SessionControllerTests.cs?highlight=27,28,29,46,47,64,65,66,67,68)]

<span data-ttu-id="f1f97-158">L’application expose des fonctionnalités comme une API web (une liste d’idées associées à une session de brainstorming et une méthode pour ajouter de nouvelles idées à une session) :</span><span class="sxs-lookup"><span data-stu-id="f1f97-158">The app exposes functionality as a web API (a list of ideas associated with a brainstorming session and a method for adding new ideas to a session):</span></span>

<a name="ideas-controller"></a>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Api/IdeasController.cs?highlight=21,22,27,30,31,32,33,34,35,36,41,42,46,52,65)]

<span data-ttu-id="f1f97-159">La méthode `ForSession` retourne une liste de types `IdeaDTO`.</span><span class="sxs-lookup"><span data-stu-id="f1f97-159">The `ForSession` method returns a list of `IdeaDTO` types.</span></span> <span data-ttu-id="f1f97-160">Évitez de retourner vos entités du domaine métier directement via des appels d’API, car ils incluent souvent plus de données que ce dont le client de l’API a besoin, et ils couplent inutilement le modèle du domaine interne de votre application avec l’API que vous exposez en externe.</span><span class="sxs-lookup"><span data-stu-id="f1f97-160">Avoid returning your business domain entities directly via API calls, since frequently they include more data than the API client requires, and they unnecessarily couple your app's internal domain model with the API you expose externally.</span></span> <span data-ttu-id="f1f97-161">Le mappage entre les entités de domaine et les types que vous retournez sur le fil peut être effectué manuellement (avec une requête LINQ `Select` comme indiqué ici) ou en utilisant une bibliothèque comme [AutoMapper](https://github.com/AutoMapper/AutoMapper)</span><span class="sxs-lookup"><span data-stu-id="f1f97-161">Mapping between domain entities and the types you will return over the wire can be done manually (using a LINQ `Select` as shown here) or using a library like [AutoMapper](https://github.com/AutoMapper/AutoMapper)</span></span>

<span data-ttu-id="f1f97-162">Les tests unitaires pour les méthodes d’API `Create` et `ForSession` :</span><span class="sxs-lookup"><span data-stu-id="f1f97-162">The unit tests for the `Create` and `ForSession` API methods:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/ApiIdeasControllerTests.cs?highlight=18,23,29,33,38-39,43,50,58-59,68-70,76-78&range=1-83,121-135)]

<span data-ttu-id="f1f97-163">Comme indiqué précédemment, pour tester le comportement de la méthode quand `ModelState` n’est pas valide, ajoutez une erreur de modèle au contrôleur dans le cadre du test.</span><span class="sxs-lookup"><span data-stu-id="f1f97-163">As stated previously, to test the behavior of the method when `ModelState` is invalid, add a model error to the controller as part of the test.</span></span> <span data-ttu-id="f1f97-164">N’essayez pas de tester la validation de modèle ou la liaison de modèle dans vos tests unitaires : testez simplement le comportement de votre méthode d’action quand elle est confrontée à une valeur de `ModelState` particulière.</span><span class="sxs-lookup"><span data-stu-id="f1f97-164">Don't try to test model validation or model binding in your unit tests - just test your action method's behavior when confronted with a particular `ModelState` value.</span></span>

<span data-ttu-id="f1f97-165">Le deuxième test dépend du retour d’une valeur null par le référentiel : le référentiel fictif est donc configuré pour retourner une valeur null.</span><span class="sxs-lookup"><span data-stu-id="f1f97-165">The second test depends on the repository returning null, so the mock repository is configured to return null.</span></span> <span data-ttu-id="f1f97-166">Il est inutile de créer une base de données de test (dans la mémoire ou ailleurs) et de construire une requête qui retourne ce résultat : ceci peut se faire en une seule instruction, comme vous pouvez le voir.</span><span class="sxs-lookup"><span data-stu-id="f1f97-166">There's no need to create a test database (in memory or otherwise) and construct a query that will return this result - it can be done in a single statement as shown.</span></span>

<span data-ttu-id="f1f97-167">Le dernier test vérifie que la méthode `Update` du référentiel est appelée.</span><span class="sxs-lookup"><span data-stu-id="f1f97-167">The last test verifies that the repository's `Update` method is called.</span></span> <span data-ttu-id="f1f97-168">Comme nous l’avons fait précédemment, l’élément fictif est appelé avec `Verifiable`, puis la méthode `Verify` du référentiel fictif est appelée pour vérifier que la méthode vérifiable a été exécutée.</span><span class="sxs-lookup"><span data-stu-id="f1f97-168">As we did previously, the mock is called with `Verifiable` and then the mocked repository's `Verify` method is called to confirm the verifiable method was executed.</span></span> <span data-ttu-id="f1f97-169">Il n’est pas de la responsabilité d’un test unitaire de garantir que la méthode `Update` a enregistré les données ; ceci peut être vérifié avec un test d’intégration.</span><span class="sxs-lookup"><span data-stu-id="f1f97-169">It's not a unit test responsibility to ensure that the `Update` method saved the data; that can be done with an integration test.</span></span>

## <a name="integration-testing"></a><span data-ttu-id="f1f97-170">Tests d’intégration</span><span class="sxs-lookup"><span data-stu-id="f1f97-170">Integration testing</span></span>

<span data-ttu-id="f1f97-171">Les [tests d’intégration](xref:test/integration-tests) sont réalisés pour vérifier que les modules distincts de votre application fonctionnent correctement ensemble.</span><span class="sxs-lookup"><span data-stu-id="f1f97-171">[Integration tests](xref:test/integration-tests) is done to ensure separate modules within your app work correctly together.</span></span> <span data-ttu-id="f1f97-172">En règle générale, tout ce que vous pouvez tester avec un test unitaire, vous pouvez également le tester avec un test d’intégration, alors que l’inverse n’est pas vrai.</span><span class="sxs-lookup"><span data-stu-id="f1f97-172">Generally, anything you can test with a unit test, you can also test with an integration test, but the reverse isn't true.</span></span> <span data-ttu-id="f1f97-173">Cependant, les tests d’intégration tendent à être beaucoup plus lents que les tests unitaires.</span><span class="sxs-lookup"><span data-stu-id="f1f97-173">However, integration tests tend to be much slower than unit tests.</span></span> <span data-ttu-id="f1f97-174">Par conséquent, il est préférable de tester tout ce que vous pouvez avec des tests unitaires, et d’utiliser des tests d’intégration pour les scénarios qui impliquent plusieurs collaborateurs.</span><span class="sxs-lookup"><span data-stu-id="f1f97-174">Thus, it's best to test whatever you can with unit tests, and use integration tests for scenarios that involve multiple collaborators.</span></span>

<span data-ttu-id="f1f97-175">Bien qu’ils puissent toujours être utiles, les objets fictifs sont rarement utilisées dans les tests d’intégration.</span><span class="sxs-lookup"><span data-stu-id="f1f97-175">Although they may still be useful, mock objects are rarely used in integration tests.</span></span> <span data-ttu-id="f1f97-176">Dans les tests unitaires, les objets fictifs sont un moyen efficace de contrôler comment les collaborateurs qui se trouvent en dehors de l’unité testée doivent se comporter pour les besoins du test.</span><span class="sxs-lookup"><span data-stu-id="f1f97-176">In unit testing, mock objects are an effective way to control how collaborators outside of the unit being tested should behave for the purposes of the test.</span></span> <span data-ttu-id="f1f97-177">Dans un test d’intégration, des collaborateurs réels sont utilisés pour vérifier que tout le sous-système fonctionne correctement.</span><span class="sxs-lookup"><span data-stu-id="f1f97-177">In an integration test, real collaborators are used to confirm the whole subsystem works together correctly.</span></span>

### <a name="application-state"></a><span data-ttu-id="f1f97-178">État de l’application</span><span class="sxs-lookup"><span data-stu-id="f1f97-178">Application state</span></span>

<span data-ttu-id="f1f97-179">Quand vous effectuez des tests d’intégration, il est important de considérer comment définir l’état de votre application.</span><span class="sxs-lookup"><span data-stu-id="f1f97-179">One important consideration when performing integration testing is how to set your app's state.</span></span> <span data-ttu-id="f1f97-180">Les tests doivent être exécutés indépendamment les uns des autres, et chaque test doit donc démarrer avec l’application dans un état connu.</span><span class="sxs-lookup"><span data-stu-id="f1f97-180">Tests need to run independent of one another, and so each test should start with the app in a known state.</span></span> <span data-ttu-id="f1f97-181">Si votre application n’utilise pas une base de données ou si elle n’a aucun stockage persistant, ceci peut ne pas être un problème.</span><span class="sxs-lookup"><span data-stu-id="f1f97-181">If your app doesn't use a database or have any persistence, this may not be an issue.</span></span> <span data-ttu-id="f1f97-182">Cependant, la plupart des applications réelles conservent leur état dans un magasin de données : toutes les modifications apportées par un test peuvent impacter un autre test, à moins que le magasin de données soit réinitialisé.</span><span class="sxs-lookup"><span data-stu-id="f1f97-182">However, most real-world apps persist their state to some kind of data store, so any modifications made by one test could impact another test unless the data store is reset.</span></span> <span data-ttu-id="f1f97-183">Avec le `TestServer` intégré, il est très simple d’héberger des applications ASP.NET Core dans nos tests d’intégration, mais cela n’accorde pas nécessairement l’accès aux données qu’il doit utiliser.</span><span class="sxs-lookup"><span data-stu-id="f1f97-183">Using the built-in `TestServer`, it's very straightforward to host ASP.NET Core apps within our integration tests, but that doesn't necessarily grant access to the data it will use.</span></span> <span data-ttu-id="f1f97-184">Si vous utilisez une base de données réelle, une approche consiste à ce que l’application se connecte à une base de données de test à laquelle vos tests peuvent accéder, et à vérifier qu’elle est réinitialisée à un état connu avant l’exécution de chaque test.</span><span class="sxs-lookup"><span data-stu-id="f1f97-184">If you're using an actual database, one approach is to have the app connect to a test database, which your tests can access and ensure is reset to a known state before each test executes.</span></span>

<span data-ttu-id="f1f97-185">Dans cet exemple d’application, j’utilise la prise en charge d’InMemoryDatabase par Entity Framework Core : je peux donc simplement m’y connecter à partir de mon projet de test.</span><span class="sxs-lookup"><span data-stu-id="f1f97-185">In this sample application, I'm using Entity Framework Core's InMemoryDatabase support, so I can't just connect to it from my test project.</span></span> <span data-ttu-id="f1f97-186">Au lieu de cela, j’expose une méthode `InitializeDatabase` depuis la classe `Startup` de l’application, que j’appelle au démarrage de l’application si elle se trouve dans l’environnement `Development`.</span><span class="sxs-lookup"><span data-stu-id="f1f97-186">Instead, I expose an `InitializeDatabase` method from the app's `Startup` class, which I call when the app starts up if it's in the `Development` environment.</span></span> <span data-ttu-id="f1f97-187">Mes tests d’intégration en bénéficient automatiquement tant qu’ils définissent l’environnement sur `Development`.</span><span class="sxs-lookup"><span data-stu-id="f1f97-187">My integration tests automatically benefit from this as long as they set the environment to `Development`.</span></span> <span data-ttu-id="f1f97-188">Je n’ai pas à me soucier de la réinitialisation de la base de données, car la base de données InMemoryDatabase est réinitialisée chaque fois que l’application redémarre.</span><span class="sxs-lookup"><span data-stu-id="f1f97-188">I don't have to worry about resetting the database, since the InMemoryDatabase is reset each time the app restarts.</span></span>

<span data-ttu-id="f1f97-189">La classe `Startup` :</span><span class="sxs-lookup"><span data-stu-id="f1f97-189">The `Startup` class:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Startup.cs?highlight=19,20,34,35,43,52)]

<span data-ttu-id="f1f97-190">La méthode `GetTestSession` est fréquemment utilisée dans les tests d’intégration ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="f1f97-190">You'll see the `GetTestSession` method used frequently in the integration tests below.</span></span>

### <a name="accessing-views"></a><span data-ttu-id="f1f97-191">Accès aux vues</span><span class="sxs-lookup"><span data-stu-id="f1f97-191">Accessing views</span></span>

<span data-ttu-id="f1f97-192">Chaque classe de test d’intégration configure le `TestServer` qui doit exécuter l’application ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="f1f97-192">Each integration test class configures the `TestServer` that will run the ASP.NET Core app.</span></span> <span data-ttu-id="f1f97-193">Par défaut, `TestServer` héberge l’application web dans le dossier où elle s’exécute : dans ce cas, il s’agit du dossier du projet de test.</span><span class="sxs-lookup"><span data-stu-id="f1f97-193">By default, `TestServer` hosts the web app in the folder where it's running - in this case, the test project folder.</span></span> <span data-ttu-id="f1f97-194">Ainsi, quand vous essayez de tester les actions du contrôleur qui retournent `ViewResult`, vous pouvez recevoir cette erreur :</span><span class="sxs-lookup"><span data-stu-id="f1f97-194">Thus, when you attempt to test controller actions that return `ViewResult`, you may see this error:</span></span>

```
The view 'Index' wasn't found. The following locations were searched:
(list of locations)
```

<span data-ttu-id="f1f97-195">Pour corriger ce problème, vous devez configurer la racine du contenu du serveur, pour qu’il puisse localiser les vues pour le projet à tester.</span><span class="sxs-lookup"><span data-stu-id="f1f97-195">To correct this issue, you need to configure the server's content root, so it can locate the views for the project being tested.</span></span> <span data-ttu-id="f1f97-196">Vous faites cela via un appel à `UseContentRoot` dans la classe `TestFixture`, comme illustré ci-dessous :</span><span class="sxs-lookup"><span data-stu-id="f1f97-196">This is done by a call to `UseContentRoot` in the `TestFixture` class, shown below:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/IntegrationTests/TestFixture.cs?highlight=30,33)]

<span data-ttu-id="f1f97-197">La classe `TestFixture` est responsable de la configuration et de la création du `TestServer`, et de la configuration d’un `HttpClient` pour communiquer avec le `TestServer`.</span><span class="sxs-lookup"><span data-stu-id="f1f97-197">The `TestFixture` class is responsible for configuring and creating the `TestServer`, setting up an `HttpClient` to communicate with the `TestServer`.</span></span> <span data-ttu-id="f1f97-198">Chacun des tests d’intégration utilise la propriété `Client` pour se connecter au serveur de test et pour faire une requête.</span><span class="sxs-lookup"><span data-stu-id="f1f97-198">Each of the integration tests uses the `Client` property to connect to the test server and make a request.</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/IntegrationTests/HomeControllerTests.cs?highlight=20,26,29,30,31,35,38,39,40,41,44,47,48)]

<span data-ttu-id="f1f97-199">Dans le premier test ci-dessus, `responseString` contient le HTML rendu de la vue, qui peut être examinée pour vérifier qu’elle contient les résultats attendus.</span><span class="sxs-lookup"><span data-stu-id="f1f97-199">In the first test above, the `responseString` holds the actual rendered HTML from the View, which can be inspected to confirm it contains expected results.</span></span>

<span data-ttu-id="f1f97-200">Le deuxième test construit une requête POST de formulaire avec un nom de session unique et l’envoie à l’application, puis vérifie que la redirection attendue est retournée.</span><span class="sxs-lookup"><span data-stu-id="f1f97-200">The second test constructs a form POST with a unique session name and POSTs it to the app, then verifies that the expected redirect is returned.</span></span>

### <a name="api-methods"></a><span data-ttu-id="f1f97-201">Méthodes d’API</span><span class="sxs-lookup"><span data-stu-id="f1f97-201">API methods</span></span>

<span data-ttu-id="f1f97-202">Si votre application expose des API web, il est judicieux de vérifier par des tests automatisés qu’elles s’exécutent comme attendu.</span><span class="sxs-lookup"><span data-stu-id="f1f97-202">If your app exposes web APIs, it's a good idea to have automated tests confirm they execute as expected.</span></span> <span data-ttu-id="f1f97-203">Le `TestServer` intégré facilite le test des API web.</span><span class="sxs-lookup"><span data-stu-id="f1f97-203">The built-in `TestServer` makes it easy to test web APIs.</span></span> <span data-ttu-id="f1f97-204">Si vos méthodes d’API utilisent la liaison de modèle, vous devez toujours vérifier `ModelState.IsValid` et déterminer si les tests d’intégration sont le bon endroit pour vérifier que la validation de votre modèle fonctionne correctement.</span><span class="sxs-lookup"><span data-stu-id="f1f97-204">If your API methods are using model binding, you should always check `ModelState.IsValid`, and integration tests are the right place to confirm that your model validation is working properly.</span></span>

<span data-ttu-id="f1f97-205">L’ensemble de tests suivant cible la méthode `Create` de la classe [IdeasController](xref:mvc/controllers/testing#ideas-controller) montrée ci-dessus :</span><span class="sxs-lookup"><span data-stu-id="f1f97-205">The following set of tests target the `Create` method in the [IdeasController](xref:mvc/controllers/testing#ideas-controller) class shown above:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/IntegrationTests/ApiIdeasControllerTests.cs)]

<span data-ttu-id="f1f97-206">Contrairement aux tests d’intégration des actions qui retournent des vues HTML, les méthodes d’API web qui retournent des résultats peuvent généralement être désérialisées en tant qu’objets fortement typés, comme le montre le dernier test ci-dessus.</span><span class="sxs-lookup"><span data-stu-id="f1f97-206">Unlike integration tests of actions that returns HTML views, web API methods that return results can usually be deserialized as strongly typed objects, as the last test above shows.</span></span> <span data-ttu-id="f1f97-207">Dans ce cas, le test désérialise le résultat en une instance de `BrainstormSession` et vérifie que l’idée a été correctement ajoutée à la collection d’idées.</span><span class="sxs-lookup"><span data-stu-id="f1f97-207">In this case, the test deserializes the result to a `BrainstormSession` instance, and confirms that the idea was correctly added to its collection of ideas.</span></span>

<span data-ttu-id="f1f97-208">Vous pouvez trouver d’autres exemples de tests d’intégration dans [l’exemple de projet](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/testing/sample) de cet article.</span><span class="sxs-lookup"><span data-stu-id="f1f97-208">You'll find additional examples of integration tests in this article's [sample project](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/testing/sample).</span></span>
