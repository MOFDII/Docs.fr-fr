---
title: Tester la logique des contrôleurs dans ASP.NET Core
author: ardalis
description: Découvrez plus d’informations sur le test de la logique des contrôleurs dans ASP.NET Core avec Moq et xUnit.
ms.author: riande
ms.date: 10/14/2016
uid: mvc/controllers/testing
ms.openlocfilehash: d0b2a25d00187c088671be147844aa892f824c6e
ms.sourcegitcommit: 64c2ca86fff445944b155635918126165ee0f8aa
ms.translationtype: HT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/18/2018
ms.locfileid: "41751752"
---
# <a name="test-controller-logic-in-aspnet-core"></a><span data-ttu-id="944ed-103">Tester la logique des contrôleurs dans ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="944ed-103">Test controller logic in ASP.NET Core</span></span>

<span data-ttu-id="944ed-104">Par [Steve Smith](https://ardalis.com/)</span><span class="sxs-lookup"><span data-stu-id="944ed-104">By [Steve Smith](https://ardalis.com/)</span></span>

<span data-ttu-id="944ed-105">Les contrôleurs sont une partie centrale des applications ASP.NET Core MVC.</span><span class="sxs-lookup"><span data-stu-id="944ed-105">Controllers are a central part of any ASP.NET Core MVC application.</span></span> <span data-ttu-id="944ed-106">Par conséquent, vous devez avoir entièrement confiance dans le fait qu’ils se comportent comme prévu pour votre application.</span><span class="sxs-lookup"><span data-stu-id="944ed-106">As such, you should have confidence they behave as intended for your app.</span></span> <span data-ttu-id="944ed-107">Les tests automatisés peuvent vous donner cette confiance et détecter des erreurs avant la mise en production.</span><span class="sxs-lookup"><span data-stu-id="944ed-107">Automated tests can provide you with this confidence and can detect errors before they reach production.</span></span> <span data-ttu-id="944ed-108">Il est important d’éviter de donner des responsabilités inutiles à vos contrôleurs et de faire en sorte que vos tests portent seulement sur les responsabilités du contrôleur.</span><span class="sxs-lookup"><span data-stu-id="944ed-108">It's important to avoid placing unnecessary responsibilities within your controllers and ensure your tests focus only on controller responsibilities.</span></span>

<span data-ttu-id="944ed-109">La logique d’un contrôleur doit être minimale et ne pas porter sur la logique métier ni sur les problèmes d’infrastructure (par exemple l’accès aux données).</span><span class="sxs-lookup"><span data-stu-id="944ed-109">Controller logic should be minimal and not be focused on business logic or infrastructure concerns (for example, data access).</span></span> <span data-ttu-id="944ed-110">Testez la logique du contrôleur et non pas le framework.</span><span class="sxs-lookup"><span data-stu-id="944ed-110">Test controller logic, not the framework.</span></span> <span data-ttu-id="944ed-111">Testez la façon dont le contrôleur *se comporte* en fonction d’entrées valides et non valides.</span><span class="sxs-lookup"><span data-stu-id="944ed-111">Test how the controller *behaves* based on valid or invalid inputs.</span></span> <span data-ttu-id="944ed-112">Testez les réponses du contrôleur sur la base du résultat de l’opération métier qu’il effectue.</span><span class="sxs-lookup"><span data-stu-id="944ed-112">Test controller responses based on the result of the business operation it performs.</span></span>

<span data-ttu-id="944ed-113">Voici les responsabilités classiques d’un contrôleur :</span><span class="sxs-lookup"><span data-stu-id="944ed-113">Typical controller responsibilities:</span></span>

* <span data-ttu-id="944ed-114">Vérifier `ModelState.IsValid`</span><span class="sxs-lookup"><span data-stu-id="944ed-114">Verify `ModelState.IsValid`.</span></span>
* <span data-ttu-id="944ed-115">Retourner une réponse d’erreur si `ModelState` n’est pas valide</span><span class="sxs-lookup"><span data-stu-id="944ed-115">Return an error response if `ModelState` is invalid.</span></span>
* <span data-ttu-id="944ed-116">Extraire une entité métier de son stockage.</span><span class="sxs-lookup"><span data-stu-id="944ed-116">Retrieve a business entity from persistence.</span></span>
* <span data-ttu-id="944ed-117">Effectuer une action sur l’entité métier.</span><span class="sxs-lookup"><span data-stu-id="944ed-117">Perform an action on the business entity.</span></span>
* <span data-ttu-id="944ed-118">Enregistrer l’entité métier dans un stockage.</span><span class="sxs-lookup"><span data-stu-id="944ed-118">Save the business entity to persistence.</span></span>
* <span data-ttu-id="944ed-119">Retourner un `IActionResult` approprié.</span><span class="sxs-lookup"><span data-stu-id="944ed-119">Return an appropriate `IActionResult`.</span></span>

<span data-ttu-id="944ed-120">[Affichez ou téléchargez l’exemple de code](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/testing/sample) ([procédure de téléchargement](xref:tutorials/index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="944ed-120">[View or download sample code](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/testing/sample) ([how to download](xref:tutorials/index#how-to-download-a-sample))</span></span>

## <a name="unit-tests-of-controller-logic"></a><span data-ttu-id="944ed-121">Tests unitaires de la logique de contrôleur</span><span class="sxs-lookup"><span data-stu-id="944ed-121">Unit tests of controller logic</span></span>

<span data-ttu-id="944ed-122">Les [tests unitaires](/dotnet/articles/core/testing/unit-testing-with-dotnet-test) impliquent le test d’une partie d’une application de façon isolée par rapport à son infrastructure et à ses dépendances.</span><span class="sxs-lookup"><span data-stu-id="944ed-122">[Unit tests](/dotnet/articles/core/testing/unit-testing-with-dotnet-test) involve testing a part of an app in isolation from its infrastructure and dependencies.</span></span> <span data-ttu-id="944ed-123">Lors du test de la logique d’un contrôleur, seul le contenu d’une action est testé, et non pas le comportement de ses dépendances ou du framework lui-même.</span><span class="sxs-lookup"><span data-stu-id="944ed-123">When unit testing controller logic, only the contents of a single action is tested, not the behavior of its dependencies or of the framework itself.</span></span> <span data-ttu-id="944ed-124">Quand vous procédez à des tests unitaires des actions de votre contrôleur, pensez à vous concentrer seulement sur son comportement.</span><span class="sxs-lookup"><span data-stu-id="944ed-124">As you unit test your controller actions, make sure you focus only on its behavior.</span></span> <span data-ttu-id="944ed-125">Les tests unitaires d’un contrôleur évitent les éléments tels que les [filtres](xref:mvc/controllers/filters), le [routage](xref:fundamentals/routing) ou la [liaison de modèle](xref:mvc/models/model-binding).</span><span class="sxs-lookup"><span data-stu-id="944ed-125">A controller unit test avoids things like [filters](xref:mvc/controllers/filters), [routing](xref:fundamentals/routing), or [model binding](xref:mvc/models/model-binding).</span></span> <span data-ttu-id="944ed-126">Étant consacrés au test d’une seule chose, les tests unitaires sont généralement simples à écrire et rapides à exécuter.</span><span class="sxs-lookup"><span data-stu-id="944ed-126">By focusing on testing just one thing, unit tests are generally simple to write and quick to run.</span></span> <span data-ttu-id="944ed-127">Un ensemble de tests unitaires bien écrits peut être exécuté fréquemment sans engendrer une surcharge importante.</span><span class="sxs-lookup"><span data-stu-id="944ed-127">A well-written set of unit tests can be run frequently without much overhead.</span></span> <span data-ttu-id="944ed-128">Cependant, les tests unitaires ne détectent pas les problèmes d’interaction entre les composants, qui sont l’objet des [tests d’intégration](xref:test/integration-tests).</span><span class="sxs-lookup"><span data-stu-id="944ed-128">However, unit tests don't detect issues in the interaction between components, which is the purpose of [integration tests](xref:test/integration-tests).</span></span>

<span data-ttu-id="944ed-129">Si vous écrivez des routes et des filtres personnalisés, vous devez exécuter sur eux des tests unitaires de manière isolée, et non dans le cadre de vos tests sur une action spécifique d’un contrôleur.</span><span class="sxs-lookup"><span data-stu-id="944ed-129">If you're writing custom filters and routes, you should unit test them in isolation, not as part of your tests on a particular controller action.</span></span>

> [!TIP]
> <span data-ttu-id="944ed-130">[Créer et exécuter des tests unitaires avec Visual Studio](/visualstudio/test/unit-test-your-code)</span><span class="sxs-lookup"><span data-stu-id="944ed-130">[Create and run unit tests with Visual Studio](/visualstudio/test/unit-test-your-code).</span></span>

<span data-ttu-id="944ed-131">Pour voir ce que sont les tests unitaires, commencez par examiner le contrôleur suivant.</span><span class="sxs-lookup"><span data-stu-id="944ed-131">To demonstrate unit testing, review the following controller.</span></span> <span data-ttu-id="944ed-132">Il affiche une liste de sessions de brainstorming et permet la création de nouvelles sessions avec une requête POST :</span><span class="sxs-lookup"><span data-stu-id="944ed-132">It displays a list of brainstorming sessions and allows new brainstorming sessions to be created with a POST:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Controllers/HomeController.cs?highlight=12,16,21,42,43)]

<span data-ttu-id="944ed-133">Le contrôleur suit le [principe des dépendances explicites](http://deviq.com/explicit-dependencies-principle/), attendant qu’une injection de dépendances lui fournisse une instance de `IBrainstormSessionRepository`.</span><span class="sxs-lookup"><span data-stu-id="944ed-133">The controller is following the [explicit dependencies principle](http://deviq.com/explicit-dependencies-principle/), expecting dependency injection to provide it with an instance of `IBrainstormSessionRepository`.</span></span> <span data-ttu-id="944ed-134">Ceci le rend relativement facile à tester avec un framework d’objets fictifs, comme [Moq](https://www.nuget.org/packages/Moq/).</span><span class="sxs-lookup"><span data-stu-id="944ed-134">This makes it fairly easy to test using a mock object framework, like [Moq](https://www.nuget.org/packages/Moq/).</span></span> <span data-ttu-id="944ed-135">La méthode `HTTP GET Index` n’a pas de boucle ni de branchement, et elle appelle seulement une méthode.</span><span class="sxs-lookup"><span data-stu-id="944ed-135">The `HTTP GET Index` method has no looping or branching and only calls one method.</span></span> <span data-ttu-id="944ed-136">Pour tester cette méthode `Index`, nous devons vérifier qu’un `ViewResult` est retourné, avec un `ViewModel` provenant de la méthode `List` du référentiel.</span><span class="sxs-lookup"><span data-stu-id="944ed-136">To test this `Index` method, we need to verify that a `ViewResult` is returned, with a `ViewModel` from the repository's `List` method.</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/HomeControllerTests.cs?highlight=17-18&range=1-33,76-95)]

<span data-ttu-id="944ed-137">La méthode `HomeController` `HTTP POST Index` (montrée ci-dessus) doit vérifier :</span><span class="sxs-lookup"><span data-stu-id="944ed-137">The `HomeController` `HTTP POST Index` method (shown above) should verify:</span></span>

* <span data-ttu-id="944ed-138">La méthode d’action retourne une erreur Demande incorrecte : `ViewResult`, avec les données appropriées quand `ModelState.IsValid` est a la valeur `false`.</span><span class="sxs-lookup"><span data-stu-id="944ed-138">The action method returns a Bad Request `ViewResult` with the appropriate data when `ModelState.IsValid` is `false`.</span></span>

* <span data-ttu-id="944ed-139">La méthode `Add` sur le référentiel est appelée et un `RedirectToActionResult` est retourné avec les arguments corrects quand `ModelState.IsValid` est défini sur true.</span><span class="sxs-lookup"><span data-stu-id="944ed-139">The `Add` method on the repository is called and a `RedirectToActionResult` is returned with the correct arguments when `ModelState.IsValid` is true.</span></span>

<span data-ttu-id="944ed-140">Un état de modèle non valide peut être testé en ajoutant des erreurs avec `AddModelError`, comme le montre le premier test ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="944ed-140">Invalid model state can be tested by adding errors using `AddModelError` as shown in the first test below.</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/HomeControllerTests.cs?highlight=8,15-16,37-39&range=35-75)]

<span data-ttu-id="944ed-141">Le premier test vérifie que quand `ModelState` n’est pas valide, le même `ViewResult` est retourné, comme pour une requête `GET`.</span><span class="sxs-lookup"><span data-stu-id="944ed-141">The first test confirms when `ModelState` isn't valid, the same `ViewResult` is returned as for a `GET` request.</span></span> <span data-ttu-id="944ed-142">Notez que le test ne tente pas de passer un modèle non valide.</span><span class="sxs-lookup"><span data-stu-id="944ed-142">Note that the test doesn't attempt to pass in an invalid model.</span></span> <span data-ttu-id="944ed-143">Ceci ne fonctionnerait de toute façon pas, car la liaison de modèle n’est pas en cours d’exécution (même si un [test d’intégration](xref:test/integration-tests) utiliserait une liaison de modèle de test).</span><span class="sxs-lookup"><span data-stu-id="944ed-143">That wouldn't work anyway since model binding isn't running (though an [integration test](xref:test/integration-tests) would use exercise model binding).</span></span> <span data-ttu-id="944ed-144">Dans ce cas, la liaison de modèle n’est pas testée.</span><span class="sxs-lookup"><span data-stu-id="944ed-144">In this case, model binding isn't being tested.</span></span> <span data-ttu-id="944ed-145">Ces tests unitaires testent seulement ce que fait le code dans la méthode d’action.</span><span class="sxs-lookup"><span data-stu-id="944ed-145">These unit tests are only testing what the code in the action method does.</span></span>

<span data-ttu-id="944ed-146">Le second test vérifie que quand `ModelState` est valide, une nouvelle `BrainstormSession` est ajoutée (via le référentiel), et que la méthode retourne un `RedirectToActionResult` avec les propriétés attendues.</span><span class="sxs-lookup"><span data-stu-id="944ed-146">The second test verifies that when `ModelState` is valid, a new `BrainstormSession` is added (via the repository), and the method returns a `RedirectToActionResult` with the expected properties.</span></span> <span data-ttu-id="944ed-147">Les appels fictifs qui ne sont pas appelés sont normalement ignorés, mais l’appel de `Verifiable` à la fin de l’appel de configuration lui permet d’être vérifié dans le test.</span><span class="sxs-lookup"><span data-stu-id="944ed-147">Mocked calls that aren't called are normally ignored, but calling `Verifiable` at the end of the setup call allows it to be verified in the test.</span></span> <span data-ttu-id="944ed-148">Ceci se fait avec l’appel à `mockRepo.Verify`, qui échoue au test si la méthode attendue n’a pas été appelée.</span><span class="sxs-lookup"><span data-stu-id="944ed-148">This is done with the call to `mockRepo.Verify`, which will fail the test if the expected method wasn't called.</span></span>

> [!NOTE]
> <span data-ttu-id="944ed-149">La bibliothèque Moq utilisée dans cet exemple facilite la combinaison d’éléments fictifs vérifiables (ou « stricts ») avec des éléments fictifs non vérifiables (également appelés éléments ou stubs « lâches»).</span><span class="sxs-lookup"><span data-stu-id="944ed-149">The Moq library used in this sample makes it easy to mix verifiable, or "strict", mocks with non-verifiable mocks (also called "loose" mocks or stubs).</span></span> <span data-ttu-id="944ed-150">Découvrez plus d’informations sur la [personnalisation des éléments fictifs avec Moq](https://github.com/Moq/moq4/wiki/Quickstart#customizing-mock-behavior).</span><span class="sxs-lookup"><span data-stu-id="944ed-150">Learn more about [customizing Mock behavior with Moq](https://github.com/Moq/moq4/wiki/Quickstart#customizing-mock-behavior).</span></span>

<span data-ttu-id="944ed-151">Un autre contrôleur de l’application affiche les informations relatives à une session de brainstorming particulière.</span><span class="sxs-lookup"><span data-stu-id="944ed-151">Another controller in the app displays information related to a particular brainstorming session.</span></span> <span data-ttu-id="944ed-152">Il inclut une logique pour traiter les valeurs d’ID non valides :</span><span class="sxs-lookup"><span data-stu-id="944ed-152">It includes some logic to deal with invalid id values:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Controllers/SessionController.cs?highlight=19,20,21,22,25,26,27,28)]

<span data-ttu-id="944ed-153">L’action du contrôleur a trois cas à tester, une pour chaque instruction `return` :</span><span class="sxs-lookup"><span data-stu-id="944ed-153">The controller action has three cases to test, one for each `return` statement:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/SessionControllerTests.cs?highlight=27,28,29,46,47,64,65,66,67,68)]

<span data-ttu-id="944ed-154">L’application expose des fonctionnalités comme une API web (une liste d’idées associées à une session de brainstorming et une méthode pour ajouter de nouvelles idées à une session) :</span><span class="sxs-lookup"><span data-stu-id="944ed-154">The app exposes functionality as a web API (a list of ideas associated with a brainstorming session and a method for adding new ideas to a session):</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Api/IdeasController.cs?highlight=21,22,27,30,31,32,33,34,35,36,41,42,46,52,65)]

<span data-ttu-id="944ed-155">La méthode `ForSession` retourne une liste de types `IdeaDTO`.</span><span class="sxs-lookup"><span data-stu-id="944ed-155">The `ForSession` method returns a list of `IdeaDTO` types.</span></span> <span data-ttu-id="944ed-156">Évitez de retourner vos entités du domaine métier directement via des appels d’API, car ils incluent souvent plus de données que ce dont le client de l’API a besoin, et ils couplent inutilement le modèle du domaine interne de votre application avec l’API que vous exposez en externe.</span><span class="sxs-lookup"><span data-stu-id="944ed-156">Avoid returning your business domain entities directly via API calls, since frequently they include more data than the API client requires, and they unnecessarily couple your app's internal domain model with the API you expose externally.</span></span> <span data-ttu-id="944ed-157">Le mappage entre les entités de domaine et les types que vous retournez sur le fil peut être effectué manuellement (avec une requête LINQ `Select` comme indiqué ici) ou en utilisant une bibliothèque comme [AutoMapper](https://github.com/AutoMapper/AutoMapper).</span><span class="sxs-lookup"><span data-stu-id="944ed-157">Mapping between domain entities and the types you will return over the wire can be done manually (using a LINQ `Select` as shown here) or using a library like [AutoMapper](https://github.com/AutoMapper/AutoMapper).</span></span>

<span data-ttu-id="944ed-158">Les tests unitaires pour les méthodes d’API `Create` et `ForSession` :</span><span class="sxs-lookup"><span data-stu-id="944ed-158">The unit tests for the `Create` and `ForSession` API methods:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/ApiIdeasControllerTests.cs?highlight=18,23,29,33,38-39,43,50,58-59,68-70,76-78&range=1-83,121-135)]

<span data-ttu-id="944ed-159">Comme indiqué précédemment, pour tester le comportement de la méthode quand `ModelState` n’est pas valide, ajoutez une erreur de modèle au contrôleur dans le cadre du test.</span><span class="sxs-lookup"><span data-stu-id="944ed-159">As stated previously, to test the behavior of the method when `ModelState` is invalid, add a model error to the controller as part of the test.</span></span> <span data-ttu-id="944ed-160">N’essayez pas de tester la validation de modèle ou la liaison de modèle dans vos tests unitaires : testez simplement le comportement de votre méthode d’action quand elle est confrontée à une valeur de `ModelState` particulière.</span><span class="sxs-lookup"><span data-stu-id="944ed-160">Don't try to test model validation or model binding in your unit tests - just test your action method's behavior when confronted with a particular `ModelState` value.</span></span>

<span data-ttu-id="944ed-161">Le deuxième test dépend du retour d’une valeur null par le référentiel : le référentiel fictif est donc configuré pour retourner une valeur null.</span><span class="sxs-lookup"><span data-stu-id="944ed-161">The second test depends on the repository returning null, so the mock repository is configured to return null.</span></span> <span data-ttu-id="944ed-162">Il est inutile de créer une base de données de test (dans la mémoire ou ailleurs) et de construire une requête qui retourne ce résultat : ceci peut se faire en une seule instruction, comme vous pouvez le voir.</span><span class="sxs-lookup"><span data-stu-id="944ed-162">There's no need to create a test database (in memory or otherwise) and construct a query that will return this result - it can be done in a single statement as shown.</span></span>

<span data-ttu-id="944ed-163">Le dernier test vérifie que la méthode `Update` du référentiel est appelée.</span><span class="sxs-lookup"><span data-stu-id="944ed-163">The last test verifies that the repository's `Update` method is called.</span></span> <span data-ttu-id="944ed-164">Comme nous l’avons fait précédemment, l’élément fictif est appelé avec `Verifiable`, puis la méthode `Verify` du référentiel fictif est appelée pour vérifier que la méthode vérifiable a été exécutée.</span><span class="sxs-lookup"><span data-stu-id="944ed-164">As we did previously, the mock is called with `Verifiable` and then the mocked repository's `Verify` method is called to confirm the verifiable method was executed.</span></span> <span data-ttu-id="944ed-165">Il n’est pas de la responsabilité d’un test unitaire de garantir que la méthode `Update` a enregistré les données ; ceci peut être vérifié avec un test d’intégration.</span><span class="sxs-lookup"><span data-stu-id="944ed-165">It's not a unit test responsibility to ensure that the `Update` method saved the data; that can be done with an integration test.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="944ed-166">Ressources supplémentaires</span><span class="sxs-lookup"><span data-stu-id="944ed-166">Additional resources</span></span>

* <xref:test/integration-tests>
