---
title: "Gestion de clés"
author: rick-anderson
description: "Ce document décrit les détails d’implémentation de la gestion de clés d’ASP.NET Core données protection API."
ms.author: riande
manager: wpickett
ms.date: 10/14/2016
ms.topic: article
ms.technology: aspnet
ms.prod: asp.net-core
uid: security/data-protection/implementation/key-management
ms.openlocfilehash: 53adb067751917a9539a310bb7d91e599696f213
ms.sourcegitcommit: 3e303620a125325bb9abd4b2d315c106fb8c47fd
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/19/2018
---
# <a name="key-management"></a><span data-ttu-id="39f31-103">Gestion de clés</span><span class="sxs-lookup"><span data-stu-id="39f31-103">Key Management</span></span>

<a name="data-protection-implementation-key-management"></a>

<span data-ttu-id="39f31-104">Le système de protection de données gère automatiquement la durée de vie des clés principales utilisées pour protéger et déprotéger les charges utiles.</span><span class="sxs-lookup"><span data-stu-id="39f31-104">The data protection system automatically manages the lifetime of master keys used to protect and unprotect payloads.</span></span> <span data-ttu-id="39f31-105">Chaque clé peut exister dans un des quatre étapes :</span><span class="sxs-lookup"><span data-stu-id="39f31-105">Each key can exist in one of four stages:</span></span>

* <span data-ttu-id="39f31-106">Créé - la clé existe dans l’anneau de clé, mais n’a pas encore été activée.</span><span class="sxs-lookup"><span data-stu-id="39f31-106">Created - the key exists in the key ring but has not yet been activated.</span></span> <span data-ttu-id="39f31-107">La clé ne doit pas être utilisée pour les nouvelles opérations de protéger jusqu'à ce que suffisamment de temps écoulé que la clé a eu l’occasion de se propager à tous les ordinateurs qui utilisent cette boucle de clé.</span><span class="sxs-lookup"><span data-stu-id="39f31-107">The key shouldn't be used for new Protect operations until sufficient time has elapsed that the key has had a chance to propagate to all machines that are consuming this key ring.</span></span>

* <span data-ttu-id="39f31-108">Active : la clé existe dans l’anneau de clé et doit être utilisé pour toutes les opérations de protéger de nouveau.</span><span class="sxs-lookup"><span data-stu-id="39f31-108">Active - the key exists in the key ring and should be used for all new Protect operations.</span></span>

* <span data-ttu-id="39f31-109">Expiré - la clé a été exécuté sa durée de vie naturelle et ne doit plus être utilisée pour les nouvelles opérations de protection.</span><span class="sxs-lookup"><span data-stu-id="39f31-109">Expired - the key has run its natural lifetime and should no longer be used for new Protect operations.</span></span>

* <span data-ttu-id="39f31-110">Révoqué - la clé est compromise et ne doit pas être utilisée pour les nouvelles opérations de protection.</span><span class="sxs-lookup"><span data-stu-id="39f31-110">Revoked - the key is compromised and must not be used for new Protect operations.</span></span>

<span data-ttu-id="39f31-111">Clés créées, actifs et expirés peuvent utilisés pour la protection des charges utiles entrants.</span><span class="sxs-lookup"><span data-stu-id="39f31-111">Created, active, and expired keys may all be used to unprotect incoming payloads.</span></span> <span data-ttu-id="39f31-112">Clés révoqués par défaut ne sont pas utilisable pour ôter la protection des charges utiles, mais le développeur d’applications peut [remplacer ce comportement](../consumer-apis/dangerous-unprotect.md#data-protection-consumer-apis-dangerous-unprotect) si nécessaire.</span><span class="sxs-lookup"><span data-stu-id="39f31-112">Revoked keys by default may not be used to unprotect payloads, but the application developer can [override this behavior](../consumer-apis/dangerous-unprotect.md#data-protection-consumer-apis-dangerous-unprotect) if necessary.</span></span>

>[!WARNING]
> <span data-ttu-id="39f31-113">Le développeur peut être tenté de supprimer une clé à partir de l’anneau de clé (par exemple, en supprimant le fichier correspondant du système de fichiers).</span><span class="sxs-lookup"><span data-stu-id="39f31-113">The developer might be tempted to delete a key from the key ring (e.g., by deleting the corresponding file from the file system).</span></span> <span data-ttu-id="39f31-114">À ce stade, toutes les données protégées par la clé est définitivement indéchiffrables et aucun remplacement en cas d’urgence, comme avec des clés révoqués.</span><span class="sxs-lookup"><span data-stu-id="39f31-114">At that point, all data protected by the key is permanently undecipherable, and there is no emergency override like there is with revoked keys.</span></span> <span data-ttu-id="39f31-115">Suppression d’une clé est comportement destructeur réellement et, par conséquent, le système de protection de données n’expose aucune API de première classe pour effectuer cette opération.</span><span class="sxs-lookup"><span data-stu-id="39f31-115">Deleting a key is truly destructive behavior, and consequently the data protection system exposes no first-class API for performing this operation.</span></span>

## <a name="default-key-selection"></a><span data-ttu-id="39f31-116">Sélection de la clé par défaut</span><span class="sxs-lookup"><span data-stu-id="39f31-116">Default key selection</span></span>

<span data-ttu-id="39f31-117">Lorsque le système de protection de données lit l’anneau de clé à partir du référentiel de stockage, il va tenter de rechercher une clé « default » à partir de l’anneau de clé.</span><span class="sxs-lookup"><span data-stu-id="39f31-117">When the data protection system reads the key ring from the backing repository, it will attempt to locate a "default" key from the key ring.</span></span> <span data-ttu-id="39f31-118">La clé par défaut est utilisée pour les nouvelles opérations de protection.</span><span class="sxs-lookup"><span data-stu-id="39f31-118">The default key is used for new Protect operations.</span></span>

<span data-ttu-id="39f31-119">L’heuristique générale est que le système de protection de données choisit la clé avec la dernière date d’activation en tant que la clé par défaut.</span><span class="sxs-lookup"><span data-stu-id="39f31-119">The general heuristic is that the data protection system chooses the key with the most recent activation date as the default key.</span></span> <span data-ttu-id="39f31-120">(Il existe un petit manœuvre pour autoriser l’inclinaison d’horloge de serveur à serveur.) Si la clé est expirée ou révoquée, et si l’application n’a pas désactivé automatique de génération de clé, une nouvelle clé est générée avec l’activation immédiate par le [d’expiration et la restauration de clé](xref:security/data-protection/implementation/key-management#data-protection-implementation-key-management-expiration) stratégie ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="39f31-120">(There's a small fudge factor to allow for server-to-server clock skew.) If the key is expired or revoked, and if the application has not disabled automatic key generation, then a new key will be generated with immediate activation per the [key expiration and rolling](xref:security/data-protection/implementation/key-management#data-protection-implementation-key-management-expiration) policy below.</span></span>

<span data-ttu-id="39f31-121">La raison pour laquelle le système de protection de données génère une nouvelle clé immédiatement au lieu de revenir à une autre clé est qu’une nouvelle génération de clé doit être traitée comme un délai d’expiration implicite de toutes les clés qui ont été activés avant la nouvelle clé.</span><span class="sxs-lookup"><span data-stu-id="39f31-121">The reason the data protection system generates a new key immediately rather than falling back to a different key is that new key generation should be treated as an implicit expiration of all keys that were activated prior to the new key.</span></span> <span data-ttu-id="39f31-122">L’idée générale est que les nouvelles clés ont été configurés avec des algorithmes différents ou de mécanismes de chiffrement au repos que les anciennes clés, et le système doit préférer le retour de la configuration actuelle.</span><span class="sxs-lookup"><span data-stu-id="39f31-122">The general idea is that new keys may have been configured with different algorithms or encryption-at-rest mechanisms than old keys, and the system should prefer the current configuration over falling back.</span></span>

<span data-ttu-id="39f31-123">Il existe une exception.</span><span class="sxs-lookup"><span data-stu-id="39f31-123">There is an exception.</span></span> <span data-ttu-id="39f31-124">Si le développeur a [désactivé la génération automatique de clés](xref:security/data-protection/configuration/overview#disableautomatickeygeneration), le système de protection des données doit choisir un élément en tant que la clé par défaut.</span><span class="sxs-lookup"><span data-stu-id="39f31-124">If the application developer has [disabled automatic key generation](xref:security/data-protection/configuration/overview#disableautomatickeygeneration), then the data protection system must choose something as the default key.</span></span> <span data-ttu-id="39f31-125">Dans ce scénario de secours, le système choisira la clé non révoqué avec la dernière date d’activation, de préférence vers les clés qui ont eu le temps de se propager à d’autres ordinateurs du cluster.</span><span class="sxs-lookup"><span data-stu-id="39f31-125">In this fallback scenario, the system will choose the non-revoked key with the most recent activation date, with preference given to keys that have had time to propagate to other machines in the cluster.</span></span> <span data-ttu-id="39f31-126">Le système de secours peut se retrouver en choisissant une clé par défaut a expiré en conséquence.</span><span class="sxs-lookup"><span data-stu-id="39f31-126">The fallback system may end up choosing an expired default key as a result.</span></span> <span data-ttu-id="39f31-127">Le système de secours ne sera jamais choisir une clé révoquée en tant que la clé par défaut, et si l’anneau de clé est vide ou chaque clé a été révoqué le système produira une erreur lors de l’initialisation.</span><span class="sxs-lookup"><span data-stu-id="39f31-127">The fallback system will never choose a revoked key as the default key, and if the key ring is empty or every key has been revoked then the system will produce an error upon initialization.</span></span>

<a name="data-protection-implementation-key-management-expiration"></a>

## <a name="key-expiration-and-rolling"></a><span data-ttu-id="39f31-128">Expiration de clés et de restauration</span><span class="sxs-lookup"><span data-stu-id="39f31-128">Key expiration and rolling</span></span>

<span data-ttu-id="39f31-129">Lorsqu’une clé est créée, elle reçoit automatiquement une date d’activation {now + 2 jours} et une date d’expiration de {now + 90 jours}.</span><span class="sxs-lookup"><span data-stu-id="39f31-129">When a key is created, it is automatically given an activation date of { now + 2 days } and an expiration date of { now + 90 days }.</span></span> <span data-ttu-id="39f31-130">Le délai de 2 jours avant l’activation donne le temps clé se propagent dans le système.</span><span class="sxs-lookup"><span data-stu-id="39f31-130">The 2-day delay before activation gives the key time to propagate through the system.</span></span> <span data-ttu-id="39f31-131">Autrement dit, il permet aux autres applications pointant vers le magasin de stockage observer la clé à leur prochaine période d’actualisation automatique, optimisant ainsi le risque que lorsque la clé anneau active fait deviennent s’il est propagée à toutes les applications devront peut-être l’utiliser.</span><span class="sxs-lookup"><span data-stu-id="39f31-131">That is, it allows other applications pointing at the backing store to observe the key at their next auto-refresh period, thus maximizing the chances that when the key ring does become active it has propagated to all applications that might need to use it.</span></span>

<span data-ttu-id="39f31-132">Si la clé par défaut va expirer dans les 2 jours, et si la boucle de clé n’a pas déjà une clé qui sera active lors de l’expiration de la clé par défaut, le système de protection des données est conservées automatiquement une nouvelle clé dans l’anneau de clé.</span><span class="sxs-lookup"><span data-stu-id="39f31-132">If the default key will expire within 2 days and if the key ring does not already have a key that will be active upon expiration of the default key, then the data protection system will automatically persist a new key to the key ring.</span></span> <span data-ttu-id="39f31-133">Cette nouvelle clé a une date d’activation {date d’expiration de la clé par défaut} et une date d’expiration de {now + 90 jours}.</span><span class="sxs-lookup"><span data-stu-id="39f31-133">This new key has an activation date of { default key's expiration date } and an expiration date of { now + 90 days }.</span></span> <span data-ttu-id="39f31-134">Ainsi, le système restaurer automatiquement les clés sur une base régulière sans aucune interruption de service.</span><span class="sxs-lookup"><span data-stu-id="39f31-134">This allows the system to automatically roll keys on a regular basis with no interruption of service.</span></span>

<span data-ttu-id="39f31-135">Il peut y avoir des circonstances où une clé sera créée avec l’activation immédiate.</span><span class="sxs-lookup"><span data-stu-id="39f31-135">There might be circumstances where a key will be created with immediate activation.</span></span> <span data-ttu-id="39f31-136">Un exemple serait lorsque l’application n’a pas exécuté pendant une période et toutes les clés dans l’anneau de clé ont expiré.</span><span class="sxs-lookup"><span data-stu-id="39f31-136">One example would be when the application hasn't run for a time and all keys in the key ring are expired.</span></span> <span data-ttu-id="39f31-137">Dans ce cas, la clé reçoit une date d’activation de {maintenant} sans le délai d’activation de 2 jours normal.</span><span class="sxs-lookup"><span data-stu-id="39f31-137">When this happens, the key is given an activation date of { now } without the normal 2-day activation delay.</span></span>

<span data-ttu-id="39f31-138">La durée de vie de clé par défaut est 90 jours, mais ce n’est configurable dans l’exemple suivant.</span><span class="sxs-lookup"><span data-stu-id="39f31-138">The default key lifetime is 90 days, though this is configurable as in the following example.</span></span>

```csharp
services.AddDataProtection()
       // use 14-day lifetime instead of 90-day lifetime
       .SetDefaultKeyLifetime(TimeSpan.FromDays(14));
```

<span data-ttu-id="39f31-139">Un administrateur peut également modifier la valeur par défaut au niveau du système, si un appel explicite à `SetDefaultKeyLifetime` remplace toute stratégie à l’échelle du système.</span><span class="sxs-lookup"><span data-stu-id="39f31-139">An administrator can also change the default system-wide, though an explicit call to `SetDefaultKeyLifetime` will override any system-wide policy.</span></span> <span data-ttu-id="39f31-140">La durée de vie de clé par défaut ne peut pas être inférieure à 7 jours.</span><span class="sxs-lookup"><span data-stu-id="39f31-140">The default key lifetime cannot be shorter than 7 days.</span></span>

## <a name="automatic-key-ring-refresh"></a><span data-ttu-id="39f31-141">Actualisation de l’anneau de clé automatique</span><span class="sxs-lookup"><span data-stu-id="39f31-141">Automatic key ring refresh</span></span>

<span data-ttu-id="39f31-142">Lorsque le système de protection des données s’initialise, il lit l’anneau de clé à partir du référentiel sous-jacent et met en cache en mémoire.</span><span class="sxs-lookup"><span data-stu-id="39f31-142">When the data protection system initializes, it reads the key ring from the underlying repository and caches it in memory.</span></span> <span data-ttu-id="39f31-143">Ce cache permet les opérations de protection et de suppression de la protection continuer sans atteindre le magasin de stockage.</span><span class="sxs-lookup"><span data-stu-id="39f31-143">This cache allows Protect and Unprotect operations to proceed without hitting the backing store.</span></span> <span data-ttu-id="39f31-144">Le système vérifie automatiquement le magasin de stockage pour les modifications environ toutes les 24 heures ou de l’expiration de la clé par défaut en cours, selon ce qui se produit en premier.</span><span class="sxs-lookup"><span data-stu-id="39f31-144">The system will automatically check the backing store for changes approximately every 24 hours or when the current default key expires, whichever comes first.</span></span>

>[!WARNING]
> <span data-ttu-id="39f31-145">Les développeurs doivent rarement (le cas échéant) à utiliser directement les API de gestion des clés.</span><span class="sxs-lookup"><span data-stu-id="39f31-145">Developers should very rarely (if ever) need to use the key management APIs directly.</span></span> <span data-ttu-id="39f31-146">Le système de protection de données effectue la gestion automatique des clés comme décrit ci-dessus.</span><span class="sxs-lookup"><span data-stu-id="39f31-146">The data protection system will perform automatic key management as described above.</span></span>

<span data-ttu-id="39f31-147">Le système de protection de données expose une interface `IKeyManager` qui peut être utilisé pour inspecter et apporter des modifications à l’anneau de clé.</span><span class="sxs-lookup"><span data-stu-id="39f31-147">The data protection system exposes an interface `IKeyManager` that can be used to inspect and make changes to the key ring.</span></span> <span data-ttu-id="39f31-148">Le système DI qui a fourni l’instance de `IDataProtectionProvider` peut également fournir une instance de `IKeyManager` pour votre consommation.</span><span class="sxs-lookup"><span data-stu-id="39f31-148">The DI system that provided the instance of `IDataProtectionProvider` can also provide an instance of `IKeyManager` for your consumption.</span></span> <span data-ttu-id="39f31-149">Ou bien, vous pouvez extraire le `IKeyManager` directement à partir de la `IServiceProvider` comme dans l’exemple ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="39f31-149">Alternatively, you can pull the `IKeyManager` straight from the `IServiceProvider` as in the example below.</span></span>

<span data-ttu-id="39f31-150">Toute opération qui modifie l’anneau de clé (création d’une nouvelle clé explicitement ou effectuer une révocation) invalide le cache en mémoire.</span><span class="sxs-lookup"><span data-stu-id="39f31-150">Any operation which modifies the key ring (creating a new key explicitly or performing a revocation) will invalidate the in-memory cache.</span></span> <span data-ttu-id="39f31-151">L’appel suivant à `Protect` ou `Unprotect` entraîne le système de protection des données à relire l’anneau de clé et à recréer le cache.</span><span class="sxs-lookup"><span data-stu-id="39f31-151">The next call to `Protect` or `Unprotect` will cause the data protection system to reread the key ring and recreate the cache.</span></span>

<span data-ttu-id="39f31-152">L’exemple ci-dessous montre comment utiliser le `IKeyManager` interface pour inspecter et de manipuler l’anneau de clé, y compris la révocation existant de clés et de la génération d’une nouvelle clé manuellement.</span><span class="sxs-lookup"><span data-stu-id="39f31-152">The sample below demonstrates using the `IKeyManager` interface to inspect and manipulate the key ring, including revoking existing keys and generating a new key manually.</span></span>

[!code-csharp[Main](key-management/samples/key-management.cs)]

## <a name="key-storage"></a><span data-ttu-id="39f31-153">Stockage de clés</span><span class="sxs-lookup"><span data-stu-id="39f31-153">Key storage</span></span>

<span data-ttu-id="39f31-154">Le système de protection de données a une heuristique dans laquelle il essaie automatiquement de déduire un emplacement de stockage de clé approprié et le chiffrement au mécanisme de rest.</span><span class="sxs-lookup"><span data-stu-id="39f31-154">The data protection system has a heuristic whereby it tries to deduce an appropriate key storage location and encryption at rest mechanism automatically.</span></span> <span data-ttu-id="39f31-155">Cela est également configurable par le développeur de l’application.</span><span class="sxs-lookup"><span data-stu-id="39f31-155">This is also configurable by the app developer.</span></span> <span data-ttu-id="39f31-156">Les documents suivants décrivent les implémentations de boîte aux lettres de ces mécanismes :</span><span class="sxs-lookup"><span data-stu-id="39f31-156">The following documents discuss the in-box implementations of these mechanisms:</span></span>

* [<span data-ttu-id="39f31-157">Fournisseurs de stockage de clés de boîte aux lettres</span><span class="sxs-lookup"><span data-stu-id="39f31-157">In-box key storage providers</span></span>](key-storage-providers.md#data-protection-implementation-key-storage-providers)

* [<span data-ttu-id="39f31-158">Boîte de chiffrement à clé auprès des fournisseurs de rest</span><span class="sxs-lookup"><span data-stu-id="39f31-158">In-box key encryption at rest providers</span></span>](key-encryption-at-rest.md#data-protection-implementation-key-encryption-at-rest-providers)
