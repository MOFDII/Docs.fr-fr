---
title: Fournisseur de configuration Azure Key Vault dans ASP.NET Core
author: guardrex
description: Découvrez comment utiliser le fournisseur de Configuration de coffre de clés Azure pour configurer une application à l’aide de paires nom-valeur chargées pendant l’exécution.
monikerRange: '>= aspnetcore-1.1'
ms.author: riande
ms.custom: mvc
ms.date: 10/24/2018
uid: security/key-vault-configuration
ms.openlocfilehash: c6dc8b9c462841351b3ada72deeae727da356a6c
ms.sourcegitcommit: 375e9a67f5e1f7b0faaa056b4b46294cc70f55b7
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 10/29/2018
ms.locfileid: "50207886"
---
# <a name="azure-key-vault-configuration-provider-in-aspnet-core"></a><span data-ttu-id="76cf6-103">Fournisseur de configuration Azure Key Vault dans ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="76cf6-103">Azure Key Vault configuration provider in ASP.NET Core</span></span>

<span data-ttu-id="76cf6-104">Par [Luke Latham](https://github.com/guardrex) et [Andrew Stanton-Nurse](https://github.com/anurse)</span><span class="sxs-lookup"><span data-stu-id="76cf6-104">By [Luke Latham](https://github.com/guardrex) and [Andrew Stanton-Nurse](https://github.com/anurse)</span></span>

<span data-ttu-id="76cf6-105">Ce document explique comment utiliser le [Microsoft Azure Key Vault](https://azure.microsoft.com/services/key-vault/) fournisseur de configuration à charger des valeurs de configuration d’application de secrets Azure Key Vault.</span><span class="sxs-lookup"><span data-stu-id="76cf6-105">This document explains how to use the [Microsoft Azure Key Vault](https://azure.microsoft.com/services/key-vault/) configuration provider to load app configuration values from Azure Key Vault secrets.</span></span> <span data-ttu-id="76cf6-106">Azure Key Vault est un service cloud qui vous aident à protéger les clés de chiffrement et les secrets utilisés par les applications et services.</span><span class="sxs-lookup"><span data-stu-id="76cf6-106">Azure Key Vault is a cloud-based service that helps you safeguard cryptographic keys and secrets used by apps and services.</span></span> <span data-ttu-id="76cf6-107">Les scénarios courants incluent le contrôle d’accès aux données de configuration sensibles et répondre aux exigences de la norme FIPS 140-2 niveau 2 validé par les Modules de sécurité matériel (HSM) lors du stockage des données de configuration.</span><span class="sxs-lookup"><span data-stu-id="76cf6-107">Common scenarios include controlling access to sensitive configuration data and meeting the requirement for FIPS 140-2 Level 2 validated Hardware Security Modules (HSM's) when storing configuration data.</span></span> <span data-ttu-id="76cf6-108">Cette fonctionnalité est disponible pour les applications qui ciblent ASP.NET Core 1.1 ou version ultérieure.</span><span class="sxs-lookup"><span data-stu-id="76cf6-108">This feature is available for apps that target ASP.NET Core 1.1 or higher.</span></span>

<span data-ttu-id="76cf6-109">[Affichez ou téléchargez l’exemple de code](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples) ([procédure de téléchargement](xref:index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="76cf6-109">[View or download sample code](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples) ([how to download](xref:index#how-to-download-a-sample))</span></span>

## <a name="package"></a><span data-ttu-id="76cf6-110">Package</span><span class="sxs-lookup"><span data-stu-id="76cf6-110">Package</span></span>

<span data-ttu-id="76cf6-111">Pour utiliser le fournisseur, ajouter la référence au package Nuget [Microsoft.Extensions.Configuration.AzureKeyVault](https://www.nuget.org/packages/Microsoft.Extensions.Configuration.AzureKeyVault/).</span><span class="sxs-lookup"><span data-stu-id="76cf6-111">To use the provider, add a reference to the [Microsoft.Extensions.Configuration.AzureKeyVault](https://www.nuget.org/packages/Microsoft.Extensions.Configuration.AzureKeyVault/) package.</span></span>

## <a name="app-configuration"></a><span data-ttu-id="76cf6-112">Configuration de l’application</span><span class="sxs-lookup"><span data-stu-id="76cf6-112">App configuration</span></span>

<span data-ttu-id="76cf6-113">Vous pouvez explorer le fournisseur avec les [exemples d’applications](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples).</span><span class="sxs-lookup"><span data-stu-id="76cf6-113">You can explore the provider with the [sample apps](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples).</span></span> <span data-ttu-id="76cf6-114">Une fois que vous établissez un coffre de clés et créez des clés secrètes dans le coffre, les exemples d’applications chargent en toute sécurité les valeurs de secret dans leurs configurations et les affichent dans les pages Web.</span><span class="sxs-lookup"><span data-stu-id="76cf6-114">Once you establish a key vault and create secrets in the vault, the sample apps securely load the secret values into their configurations and display them in webpages.</span></span>

<span data-ttu-id="76cf6-115">Le fournisseur est ajouté à la configuration d’application avec le `AddAzureKeyVault` extension.</span><span class="sxs-lookup"><span data-stu-id="76cf6-115">The provider is added to the app's configuration with the `AddAzureKeyVault` extension.</span></span> <span data-ttu-id="76cf6-116">Dans les exemples d’applications, l’extension utilise trois valeurs de configuration chargées à partir du fichier *appsettings.json*.</span><span class="sxs-lookup"><span data-stu-id="76cf6-116">In the sample apps, the extension uses three configuration values loaded from the *appsettings.json* file.</span></span>

| <span data-ttu-id="76cf6-117">Paramètre d’application</span><span class="sxs-lookup"><span data-stu-id="76cf6-117">App Setting</span></span>    | <span data-ttu-id="76cf6-118">Description</span><span class="sxs-lookup"><span data-stu-id="76cf6-118">Description</span></span>                    | <span data-ttu-id="76cf6-119">Exemple</span><span class="sxs-lookup"><span data-stu-id="76cf6-119">Example</span></span>                                      |
| -------------- | ------------------------------ | -------------------------------------------- |
| `Vault`        | <span data-ttu-id="76cf6-120">Nom du coffre de clés Azure</span><span class="sxs-lookup"><span data-stu-id="76cf6-120">Azure Key Vault name</span></span>           | <span data-ttu-id="76cf6-121">contosovault</span><span class="sxs-lookup"><span data-stu-id="76cf6-121">contosovault</span></span>                                 |
| `ClientId`     | <span data-ttu-id="76cf6-122">Id d’application Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="76cf6-122">Azure Active Directory App Id</span></span>  | <span data-ttu-id="76cf6-123">627e911e-43cc-61d4-992e-12db9c81b413</span><span class="sxs-lookup"><span data-stu-id="76cf6-123">627e911e-43cc-61d4-992e-12db9c81b413</span></span>         |
| `ClientSecret` | <span data-ttu-id="76cf6-124">Clé d’application Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="76cf6-124">Azure Active Directory App Key</span></span> | <span data-ttu-id="76cf6-125">g58K3dtg59o1Pa+e59v2Tx829w6VxTB2yv9sv/101di=</span><span class="sxs-lookup"><span data-stu-id="76cf6-125">g58K3dtg59o1Pa+e59v2Tx829w6VxTB2yv9sv/101di=</span></span> |

[!code-csharp[Program](key-vault-configuration/samples/basic-sample/2.x/Program.cs?name=snippet1)]

## <a name="create-key-vault-secrets-and-load-configuration-values-basic-sample"></a><span data-ttu-id="76cf6-126">Créer des secrets de coffre de clés et charger des valeurs de configuration (exemple de base)</span><span class="sxs-lookup"><span data-stu-id="76cf6-126">Create key vault secrets and load configuration values (basic-sample)</span></span>

1. <span data-ttu-id="76cf6-127">Créer un coffre de clés et configurer Azure Active Directory (Azure AD) pour l’application en suivant les instructions de [prise en main Azure Key Vault](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span><span class="sxs-lookup"><span data-stu-id="76cf6-127">Create a key vault and set up Azure Active Directory (Azure AD) for the app following the guidance in [Get started with Azure Key Vault](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span></span>
   * <span data-ttu-id="76cf6-128">Ajoutez des clés secrètes au coffre de clés à l’aide du [Module PowerShell Azure Resource Manager Key Vault](/powershell/module/azurerm.keyvault) disponible à partir de disponible dans [Gallery PowerShell](https://www.powershellgallery.com/packages/AzureRM.KeyVault), l'[API REST du coffre de clés Azure Key Vault](/rest/api/keyvault/), ou le [Portail azure](https://portal.azure.com/).</span><span class="sxs-lookup"><span data-stu-id="76cf6-128">Add secrets to the key vault using the [AzureRM Key Vault PowerShell Module](/powershell/module/azurerm.keyvault) available from the [PowerShell Gallery](https://www.powershellgallery.com/packages/AzureRM.KeyVault), the [Azure Key Vault REST API](/rest/api/keyvault/), or the [Azure Portal](https://portal.azure.com/).</span></span> <span data-ttu-id="76cf6-129">Les clés secrètes créées sont de type *Manual* ou *Certificate*.</span><span class="sxs-lookup"><span data-stu-id="76cf6-129">Secrets are created as either *Manual* or *Certificate* secrets.</span></span> <span data-ttu-id="76cf6-130">Les clés secrètes *Certificate* sont des certificats pour les applications et les services, mais elles ne sont pas prises en charge par le fournisseur de configuration.</span><span class="sxs-lookup"><span data-stu-id="76cf6-130">*Certificate* secrets are certificates for use by apps and services but are not supported by the configuration provider.</span></span> <span data-ttu-id="76cf6-131">Vous devez utiliser l'option *Manual* afin de créer des clés secrètes de paire nom-valeur pour le fournisseur de configuration.</span><span class="sxs-lookup"><span data-stu-id="76cf6-131">You should use the *Manual* option to create name-value pair secrets for use with the configuration provider.</span></span>
     * <span data-ttu-id="76cf6-132">Secrets simples sont créés en tant que paires nom-valeur.</span><span class="sxs-lookup"><span data-stu-id="76cf6-132">Simple secrets are created as name-value pairs.</span></span> <span data-ttu-id="76cf6-133">Les noms de secrets Azure Key Vault sont limités à des caractères alphanumériques et des tirets.</span><span class="sxs-lookup"><span data-stu-id="76cf6-133">Azure Key Vault secret names are limited to alphanumeric characters and dashes.</span></span>
     * <span data-ttu-id="76cf6-134">Les valeurs hiérarchiques (sections de configuration) utilisent `--` (deux tirets) comme séparateur dans l’exemple.</span><span class="sxs-lookup"><span data-stu-id="76cf6-134">Hierarchical values (configuration sections) use `--` (two dashes) as a separator in the sample.</span></span> <span data-ttu-id="76cf6-135">Les deux points `:`, normalement utilisés pour délimiter une section de sous-clé dans [configuration d’ASP.NET Core](xref:fundamentals/configuration/index), ne sont pas autorisés dans les noms de clés secrètes.</span><span class="sxs-lookup"><span data-stu-id="76cf6-135">Colons, which are normally used to delimit a section from a subkey in [ASP.NET Core configuration](xref:fundamentals/configuration/index), aren't allowed in secret names.</span></span> <span data-ttu-id="76cf6-136">Par conséquent, les deux tirets sont remplacés par deux points lorsque les clés secrètes sont chargées dans la configuration de l’application.</span><span class="sxs-lookup"><span data-stu-id="76cf6-136">Therefore, two dashes are used and swapped for a colon when the secrets are loaded into the app's configuration.</span></span>
     * <span data-ttu-id="76cf6-137">Créez deux clés secrètes *Manual* avec les paires nom-valeur suivantes :</span><span class="sxs-lookup"><span data-stu-id="76cf6-137">Create two *Manual* secrets with the following name-value pairs.</span></span> <span data-ttu-id="76cf6-138">la première clé secrète est une simple paire nom-valeur, et la seconde crée une valeur de clé secrète avec une section et une sous-clé dans le nom de la clé secrète :</span><span class="sxs-lookup"><span data-stu-id="76cf6-138">The first secret is a simple name and value, and the second secret creates a secret value with a section and subkey in the secret name:</span></span>
       * <span data-ttu-id="76cf6-139">`SecretName`: `secret_value_1`</span><span class="sxs-lookup"><span data-stu-id="76cf6-139">`SecretName`: `secret_value_1`</span></span>
       * <span data-ttu-id="76cf6-140">`Section--SecretName`: `secret_value_2`</span><span class="sxs-lookup"><span data-stu-id="76cf6-140">`Section--SecretName`: `secret_value_2`</span></span>
   * <span data-ttu-id="76cf6-141">Inscrire l’exemple d’application dans Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="76cf6-141">Register the sample app with Azure Active Directory.</span></span>
   * <span data-ttu-id="76cf6-142">Autoriser l’application à accéder au coffre de clés.</span><span class="sxs-lookup"><span data-stu-id="76cf6-142">Authorize the app to access the key vault.</span></span> <span data-ttu-id="76cf6-143">Lorsque vous utilisez l’applet de commande PowerShell `Set-AzureRmKeyVaultAccessPolicy` pour autoriser l’application à accéder au coffre de clés, vous pouvez obtenir la liste des clés secrètes avec `List` et `Get` avec `-PermissionsToSecrets list,get`.</span><span class="sxs-lookup"><span data-stu-id="76cf6-143">When you use the `Set-AzureRmKeyVaultAccessPolicy` PowerShell cmdlet to authorize the app to access the key vault, provide `List` and `Get` access to secrets with `-PermissionsToSecrets list,get`.</span></span>

2. <span data-ttu-id="76cf6-144">Mettre à jour le fichier *appsettings.json* de l’application avec les valeurs de `Vault`, `ClientId`, et `ClientSecret`.</span><span class="sxs-lookup"><span data-stu-id="76cf6-144">Update the app's *appsettings.json* file with the values of `Vault`, `ClientId`, and `ClientSecret`.</span></span>
3. <span data-ttu-id="76cf6-145">Exécutez l’exemple d’application, qui obtient ses valeurs de configuration à partir de `IConfigurationRoot` avec le même nom que le nom de secret.</span><span class="sxs-lookup"><span data-stu-id="76cf6-145">Run the sample app, which obtains its configuration values from `IConfigurationRoot` with the same name as the secret name.</span></span>
   * <span data-ttu-id="76cf6-146">Valeurs non hiérarchique : la valeur de `SecretName` est obtenu avec `config["SecretName"]`.</span><span class="sxs-lookup"><span data-stu-id="76cf6-146">Non-hierarchical values: The value for `SecretName` is obtained with `config["SecretName"]`.</span></span>
   * <span data-ttu-id="76cf6-147">Valeurs hiérarchiques (sections) : utilisez la notation `:` (deux points) ou la méthode d’extension `GetSection`.</span><span class="sxs-lookup"><span data-stu-id="76cf6-147">Hierarchical values (sections): Use `:` (colon) notation or the `GetSection` extension method.</span></span> <span data-ttu-id="76cf6-148">Utilisez une des ces approches pour obtenir la valeur de configuration, :</span><span class="sxs-lookup"><span data-stu-id="76cf6-148">Use either of these approaches to obtain the configuration value:</span></span>
     * `config["Section:SecretName"]`
     * `config.GetSection("Section")["SecretName"]`

<span data-ttu-id="76cf6-149">Lorsque vous exécutez l’application, une page Web affiche les valeurs de secret chargés :</span><span class="sxs-lookup"><span data-stu-id="76cf6-149">When you run the app, a webpage shows the loaded secret values:</span></span>

![Fenêtre de navigateur montrant les valeurs secrètes chargée via le fournisseur de Configuration de coffre de clés Azure](key-vault-configuration/_static/sample1.png)

## <a name="bind-an-array-to-a-class"></a><span data-ttu-id="76cf6-151">Lier un tableau à une classe</span><span class="sxs-lookup"><span data-stu-id="76cf6-151">Bind an array to a class</span></span>

<span data-ttu-id="76cf6-152">Le fournisseur est capable de lire les valeurs de configuration dans un tableau pour la liaison à un tableau POCO.</span><span class="sxs-lookup"><span data-stu-id="76cf6-152">The provider is capable of reading configuration values into an array for binding to a POCO array.</span></span>

<span data-ttu-id="76cf6-153">Lors de la lecture à partir d’une source de configuration qui permet des clés contenir le signe deux-points (`:`) séparateurs, un segment de clé numérique est utilisé pour distinguer les clés qui composent un tableau (`:0:`, `:1:`,...</span><span class="sxs-lookup"><span data-stu-id="76cf6-153">When reading from a configuration source that allows keys to contain colon (`:`) separators, a numeric key segment is used to distinguish the keys that make up an array (`:0:`, `:1:`, …</span></span> <span data-ttu-id="76cf6-154">`:{n}:`).</span><span class="sxs-lookup"><span data-stu-id="76cf6-154">`:{n}:`).</span></span> <span data-ttu-id="76cf6-155">Pour plus d’informations, consultez [Configuration : lier un tableau à une classe](xref:fundamentals/configuration/index#bind-an-array-to-a-class).</span><span class="sxs-lookup"><span data-stu-id="76cf6-155">For more information, see [Configuration: Bind an array to a class](xref:fundamentals/configuration/index#bind-an-array-to-a-class).</span></span>

<span data-ttu-id="76cf6-156">Clés d’Azure Key Vault ne peut pas utiliser un signe deux-points comme séparateur.</span><span class="sxs-lookup"><span data-stu-id="76cf6-156">Azure Key Vault keys can't use a colon as a separator.</span></span> <span data-ttu-id="76cf6-157">L’approche décrite dans cette rubrique utilise les doubles tirets (`--`) comme séparateur pour les valeurs hiérarchiques (sections).</span><span class="sxs-lookup"><span data-stu-id="76cf6-157">The approach described in this topic uses double dashes (`--`) as a separator for hierarchical values (sections).</span></span> <span data-ttu-id="76cf6-158">Clés de tableau sont stockées dans Azure Key Vault avec double des tirets et des segments de clé numériques (`--0--`, `--1--`,...</span><span class="sxs-lookup"><span data-stu-id="76cf6-158">Array keys are stored in Azure Key Vault with double dashes and numeric key segments (`--0--`, `--1--`, …</span></span> <span data-ttu-id="76cf6-159">`--{n}--`).</span><span class="sxs-lookup"><span data-stu-id="76cf6-159">`--{n}--`).</span></span>

<span data-ttu-id="76cf6-160">Examinez les éléments suivants [Serilog](https://serilog.net/) configuration du fournisseur fournie par un fichier JSON de journalisation.</span><span class="sxs-lookup"><span data-stu-id="76cf6-160">Examine the following [Serilog](https://serilog.net/) logging provider configuration provided by a JSON file.</span></span> <span data-ttu-id="76cf6-161">Il existe deux objets littéraux définis dans le `WriteTo` tableau qui reflètent les deux Serilog *récepteurs*, qui décrivent des destinations pour la sortie de journalisation :</span><span class="sxs-lookup"><span data-stu-id="76cf6-161">There are two object literals defined in the `WriteTo` array that reflect two Serilog *sinks*, which describe destinations for logging output:</span></span>

```json
"Serilog": {
  "WriteTo": [
    {
      "Name": "AzureTableStorage",
      "Args": {
        "storageTableName": "logs",
        "connectionString": "DefaultEnd...ountKey=Eby8...GMGw=="
      }
    },
    {
      "Name": "AzureDocumentDB",
      "Args": {
        "endpointUrl": "https://contoso.documents.azure.com:443",
        "authorizationKey": "Eby8...GMGw=="
      }
    }
  ]
}
```

<span data-ttu-id="76cf6-162">La configuration représentée dans le fichier JSON précédent est stockée dans Azure Key Vault à l’aide de double tiret (`--`) segments numériques et de notation :</span><span class="sxs-lookup"><span data-stu-id="76cf6-162">The configuration shown in the preceding JSON file is stored in Azure Key Vault using double dash (`--`) notation and numeric segments:</span></span>

| <span data-ttu-id="76cf6-163">Touche</span><span class="sxs-lookup"><span data-stu-id="76cf6-163">Key</span></span> | <span data-ttu-id="76cf6-164">Value</span><span class="sxs-lookup"><span data-stu-id="76cf6-164">Value</span></span> |
| --- | ----- |
| `Serilog--WriteTo--0--Name` | `AzureTableStorage` |
| `Serilog--WriteTo--0--Args--storageTableName` | `logs` |
| `Serilog--WriteTo--0--Args--connectionString` | `DefaultEnd...ountKey=Eby8...GMGw==` |
| `Serilog--WriteTo--1--Name` | `AzureDocumentDB` |
| `Serilog--WriteTo--1--Args--endpointUrl` | `https://contoso.documents.azure.com:443` |
| `Serilog--WriteTo--1--Args--authorizationKey` | `Eby8...GMGw==` |

## <a name="create-prefixed-key-vault-secrets-and-load-configuration-values-key-name-prefix-sample"></a><span data-ttu-id="76cf6-165">Créer des secrets de coffre de clés préfixée et charger des valeurs de configuration (clé-nom-préfixe-sample)</span><span class="sxs-lookup"><span data-stu-id="76cf6-165">Create prefixed key vault secrets and load configuration values (key-name-prefix-sample)</span></span>

<span data-ttu-id="76cf6-166">`AddAzureKeyVault` offre également une surcharge qui accepte une implémentation de `IKeyVaultSecretManager`, ce qui permet de choisir comment les secrets du coffre de clés sont convertis en clés de configuration.</span><span class="sxs-lookup"><span data-stu-id="76cf6-166">`AddAzureKeyVault` also provides an overload that accepts an implementation of `IKeyVaultSecretManager`, which allows you to control how key vault secrets are converted into configuration keys.</span></span> <span data-ttu-id="76cf6-167">Par exemple, vous pouvez implémenter l’interface pour charger les valeurs des secrets selon une valeur de préfixe que vous indiquez au démarrage de l’application.</span><span class="sxs-lookup"><span data-stu-id="76cf6-167">For example, you can implement the interface to load secret values based on a prefix value you provide at app startup.</span></span> <span data-ttu-id="76cf6-168">Cela vous permet, par exemple, de charger des secrets en fonction de la version de l’application.</span><span class="sxs-lookup"><span data-stu-id="76cf6-168">This allows you, for example, to load secrets based on the version of the app.</span></span>

> [!WARNING]
> <span data-ttu-id="76cf6-169">N’utilisez pas de préfixes sur les secrets de coffre de clés pour placer les secrets de plusieurs applications dans le même coffre de clés ou pour placer des secrets d'environnement (par exemple, des secrets de *développement* / de *production*) dans le même coffre.</span><span class="sxs-lookup"><span data-stu-id="76cf6-169">Don't use prefixes on key vault secrets to place secrets for multiple apps into the same key vault or to place environmental secrets (for example, *development* versus *production* secrets) into the same vault.</span></span> <span data-ttu-id="76cf6-170">Nous recommandons d'utiliser un coffre de clés distinct pour chaque application et chaque environnement de développement/production afin d’isoler les environnements d’application et ainsi de garantir le niveau de sécurité le plus élevé possible.</span><span class="sxs-lookup"><span data-stu-id="76cf6-170">We recommend that different apps and development/production environments use separate key vaults to isolate app environments for the highest level of security.</span></span>

<span data-ttu-id="76cf6-171">À l’aide du deuxième exemple d’application, vous créez une clé secrète dans le coffre de clés pour `5000-AppSecret` (les points ne sont pas autorisés dans le nom des secrets du coffre de clés), représentant le secret de la version 5.0.0.0 de votre application.</span><span class="sxs-lookup"><span data-stu-id="76cf6-171">Using the second sample app, you create a secret in the key vault for `5000-AppSecret` (periods aren't allowed in key vault secret names) representing an app secret for version 5.0.0.0 of your app.</span></span> <span data-ttu-id="76cf6-172">Dans le cas d’une autre version, 5.1.0.0, vous créez un secret pour `5100-AppSecret`.</span><span class="sxs-lookup"><span data-stu-id="76cf6-172">For another version, 5.1.0.0, you create a secret for `5100-AppSecret`.</span></span> <span data-ttu-id="76cf6-173">Chaque version de l’application charge sa propre valeur de secret dans sa configuration en tant que `AppSecret`, en extrayant la version lors du chargement du secret.</span><span class="sxs-lookup"><span data-stu-id="76cf6-173">Each app version loads its own secret value into its configuration as `AppSecret`, stripping off the version as it loads the secret.</span></span> <span data-ttu-id="76cf6-174">L'implémentation de l’exemple est illustrée ci-dessous :</span><span class="sxs-lookup"><span data-stu-id="76cf6-174">The sample's implementation is shown below:</span></span>

[!code-csharp[Configuration builder](key-vault-configuration/samples/key-name-prefix-sample/2.x/Program.cs?name=snippet1&highlight=18)]

[!code-csharp[PrefixKeyVaultSecretManager](key-vault-configuration/samples/key-name-prefix-sample/2.x/Startup.cs?name=snippet1)]

<span data-ttu-id="76cf6-175">La méthode `Load` est appelée par un algorithme de fourniture qui effectue une itération dans les secrets du coffre pour trouver ceux qui comportent le préfixe de la version.</span><span class="sxs-lookup"><span data-stu-id="76cf6-175">The `Load` method is called by a provider algorithm that iterates through the vault secrets to find the ones that have the version prefix.</span></span> <span data-ttu-id="76cf6-176">Quand un préfixe de version a été trouvé avec la méthode `Load`, l’algorithme utilise la méthode `GetKey` pour retourner le nom de configuration du nom du secret.</span><span class="sxs-lookup"><span data-stu-id="76cf6-176">When a version prefix is found with `Load`, the algorithm uses the `GetKey` method to return the configuration name of the secret name.</span></span> <span data-ttu-id="76cf6-177">Il supprime le préfixe de version du nom du secret et retourne le reste du nom du secret pour le charger dans les paires nom-valeur de configuration de l’application.</span><span class="sxs-lookup"><span data-stu-id="76cf6-177">It strips off the version prefix from the secret's name and returns the rest of the secret name for loading into the app's configuration name-value pairs.</span></span>

<span data-ttu-id="76cf6-178">Lorsque vous implémentez cette approche :</span><span class="sxs-lookup"><span data-stu-id="76cf6-178">When you implement this approach:</span></span>

1. <span data-ttu-id="76cf6-179">Les clés secrètes du coffre de clés sont chargées.</span><span class="sxs-lookup"><span data-stu-id="76cf6-179">The key vault secrets are loaded.</span></span>
2. <span data-ttu-id="76cf6-180">Le secret de chaîne pour `5000-AppSecret` est mis en correspondance.</span><span class="sxs-lookup"><span data-stu-id="76cf6-180">The string secret for `5000-AppSecret` is matched.</span></span>
3. <span data-ttu-id="76cf6-181">La version, `5000` (avec le tiret), est supprimé sur le nom de clé en laissant `AppSecret` pour charger avec la valeur du secret dans la configuration d’application.</span><span class="sxs-lookup"><span data-stu-id="76cf6-181">The version, `5000` (with the dash), is stripped off of the key name leaving `AppSecret` to load with the secret value into the app's configuration.</span></span>

> [!NOTE]
> <span data-ttu-id="76cf6-182">Vous pouvez également fournir votre propre implémentation `KeyVaultClient` à `AddAzureKeyVault`.</span><span class="sxs-lookup"><span data-stu-id="76cf6-182">You can also provide your own `KeyVaultClient` implementation to `AddAzureKeyVault`.</span></span> <span data-ttu-id="76cf6-183">Fournir un client personnalisé permet de partager une seule instance du client entre le fournisseur de configuration et d’autres parties de l’application.</span><span class="sxs-lookup"><span data-stu-id="76cf6-183">Supplying a custom client allows you to share a single instance of the client between the configuration provider and other parts of your app.</span></span>

1. <span data-ttu-id="76cf6-184">Créer un coffre de clés et configurer Azure Active Directory (Azure AD) pour l’application en suivant les instructions de [prise en main Azure Key Vault](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span><span class="sxs-lookup"><span data-stu-id="76cf6-184">Create a key vault and set up Azure Active Directory (Azure AD) for the app following the guidance in [Get started with Azure Key Vault](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span></span>
   * <span data-ttu-id="76cf6-185">Ajoutez des clés secrètes au coffre de clés à l’aide du [Module PowerShell Azure Resource Manager Key Vault](/powershell/module/azurerm.keyvault) disponible à partir de disponible dans [Gallery PowerShell](https://www.powershellgallery.com/packages/AzureRM.KeyVault), l'[API REST du coffre de clés Azure Key Vault](/rest/api/keyvault/), ou le [Portail azure](https://portal.azure.com/).</span><span class="sxs-lookup"><span data-stu-id="76cf6-185">Add secrets to the key vault using the [AzureRM Key Vault PowerShell Module](/powershell/module/azurerm.keyvault) available from the [PowerShell Gallery](https://www.powershellgallery.com/packages/AzureRM.KeyVault), the [Azure Key Vault REST API](/rest/api/keyvault/), or the [Azure Portal](https://portal.azure.com/).</span></span> <span data-ttu-id="76cf6-186">Les clés secrètes créées sont de type *Manual* ou *Certificate*.</span><span class="sxs-lookup"><span data-stu-id="76cf6-186">Secrets are created as either *Manual* or *Certificate* secrets.</span></span> <span data-ttu-id="76cf6-187">Les clés secrètes *Certificate* sont des certificats pour les applications et les services, mais elles ne sont pas prises en charge par le fournisseur de configuration.</span><span class="sxs-lookup"><span data-stu-id="76cf6-187">*Certificate* secrets are certificates for use by apps and services but are not supported by the configuration provider.</span></span> <span data-ttu-id="76cf6-188">Vous devez utiliser l'option *Manual* afin de créer des clés secrètes de paire nom-valeur pour le fournisseur de configuration.</span><span class="sxs-lookup"><span data-stu-id="76cf6-188">You should use the *Manual* option to create name-value pair secrets for use with the configuration provider.</span></span>
     * <span data-ttu-id="76cf6-189">Pour des valeurs hiérarchiques (sections de configuration), utilisez `--` (deux tirets) comme séparateur.</span><span class="sxs-lookup"><span data-stu-id="76cf6-189">Hierarchical values (configuration sections) use `--` (two dashes) as a separator.</span></span>
     * <span data-ttu-id="76cf6-190">Créez deux secrets de type *manuel* avec les paires nom-valeur suivantes :</span><span class="sxs-lookup"><span data-stu-id="76cf6-190">Create two *Manual* secrets with the following name-value pairs:</span></span>
       * <span data-ttu-id="76cf6-191">`5000-AppSecret`: `5.0.0.0_secret_value`</span><span class="sxs-lookup"><span data-stu-id="76cf6-191">`5000-AppSecret`: `5.0.0.0_secret_value`</span></span>
       * <span data-ttu-id="76cf6-192">`5100-AppSecret`: `5.1.0.0_secret_value`</span><span class="sxs-lookup"><span data-stu-id="76cf6-192">`5100-AppSecret`: `5.1.0.0_secret_value`</span></span>
   * <span data-ttu-id="76cf6-193">Inscrire l’exemple d’application dans Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="76cf6-193">Register the sample app with Azure Active Directory.</span></span>
   * <span data-ttu-id="76cf6-194">Autoriser l’application à accéder au coffre de clés.</span><span class="sxs-lookup"><span data-stu-id="76cf6-194">Authorize the app to access the key vault.</span></span> <span data-ttu-id="76cf6-195">Lorsque vous utilisez l’applet de commande PowerShell `Set-AzureRmKeyVaultAccessPolicy` pour autoriser l’application à accéder au coffre de clés, vous pouvez obtenir la liste des clés secrètes avec `List` et `Get` avec `-PermissionsToSecrets list,get`.</span><span class="sxs-lookup"><span data-stu-id="76cf6-195">When you use the `Set-AzureRmKeyVaultAccessPolicy` PowerShell cmdlet to authorize the app to access the key vault, provide `List` and `Get` access to secrets with `-PermissionsToSecrets list,get`.</span></span>

2. <span data-ttu-id="76cf6-196">Mettre à jour le fichier *appsettings.json* de l’application avec les valeurs de `Vault`, `ClientId`, et `ClientSecret`.</span><span class="sxs-lookup"><span data-stu-id="76cf6-196">Update the app's *appsettings.json* file with the values of `Vault`, `ClientId`, and `ClientSecret`.</span></span>
3. <span data-ttu-id="76cf6-197">Exécutez l’exemple d’application, qui obtient ses valeurs de configuration à partir de `IConfigurationRoot` avec le même nom que le nom secret.</span><span class="sxs-lookup"><span data-stu-id="76cf6-197">Run the sample app, which obtains its configuration values from `IConfigurationRoot` with the same name as the prefixed secret name.</span></span> <span data-ttu-id="76cf6-198">Dans cet exemple, le préfixe est la version de l’application que vous avez fournie pour `PrefixKeyVaultSecretManager` quand vous avez ajouté le fournisseur de configuration du coffre de clés Azure.</span><span class="sxs-lookup"><span data-stu-id="76cf6-198">In this sample, the prefix is the app's version, which you provided to the `PrefixKeyVaultSecretManager` when you added the Azure Key Vault configuration provider.</span></span> <span data-ttu-id="76cf6-199">La valeur de `AppSecret` est obtenu avec `config["AppSecret"]`.</span><span class="sxs-lookup"><span data-stu-id="76cf6-199">The value for `AppSecret` is obtained with `config["AppSecret"]`.</span></span> <span data-ttu-id="76cf6-200">La page Web générée par l’application affiche la valeur chargée :</span><span class="sxs-lookup"><span data-stu-id="76cf6-200">The webpage generated by the app shows the loaded value:</span></span>

   ![Fenêtre de navigateur montrant une valeur secrète chargée via le fournisseur de Configuration de coffre de clés Azure lors de la version de l’application est 5.0.0.0](key-vault-configuration/_static/sample2-1.png)

4. <span data-ttu-id="76cf6-202">Modifier la version de l’assembly d’application dans le fichier de projet à partir de `5.0.0.0` à `5.1.0.0` et réexécutez l’application.</span><span class="sxs-lookup"><span data-stu-id="76cf6-202">Change the version of the app assembly in the project file from `5.0.0.0` to `5.1.0.0` and run the app again.</span></span> <span data-ttu-id="76cf6-203">Cette fois, la valeur du secret renvoyée est `5.1.0.0_secret_value`.</span><span class="sxs-lookup"><span data-stu-id="76cf6-203">This time, the secret value returned is `5.1.0.0_secret_value`.</span></span> <span data-ttu-id="76cf6-204">La page Web générée par l’application affiche la valeur chargée :</span><span class="sxs-lookup"><span data-stu-id="76cf6-204">The webpage generated by the app shows the loaded value:</span></span>

   ![Fenêtre de navigateur montrant une valeur secrète chargée via le fournisseur de Configuration de coffre de clés Azure lors de la version de l’application est 5.1.0.0](key-vault-configuration/_static/sample2-2.png)

## <a name="control-access-to-the-clientsecret"></a><span data-ttu-id="76cf6-206">Contrôler l’accès à la ClientSecret</span><span class="sxs-lookup"><span data-stu-id="76cf6-206">Control access to the ClientSecret</span></span>

<span data-ttu-id="76cf6-207">Utilisez le [Gestionnaire Secret](xref:security/app-secrets) pour maintenir le `ClientSecret` en dehors de l’arborescence du code source de votre projet.</span><span class="sxs-lookup"><span data-stu-id="76cf6-207">Use the [Secret Manager tool](xref:security/app-secrets) to maintain the `ClientSecret` outside of your project source tree.</span></span> <span data-ttu-id="76cf6-208">Avec le Gestionnaire de clé secrète, vous associez des secrets de l’application à un projet spécifique et les partagez entre plusieurs projets.</span><span class="sxs-lookup"><span data-stu-id="76cf6-208">With Secret Manager, you associate app secrets with a specific project and share them across multiple projects.</span></span>

<span data-ttu-id="76cf6-209">Lorsque vous développez une application avec le Framework .NET dans un environnement qui prend en charge les certificats, vous pouvez vous authentifier à Azure Key Vault avec un certificat X.509.</span><span class="sxs-lookup"><span data-stu-id="76cf6-209">When developing a .NET Framework app in an environment that supports certificates, you can authenticate to Azure Key Vault with an X.509 certificate.</span></span> <span data-ttu-id="76cf6-210">La clé privée du certificat X.509 est gérée par le système d’exploitation.</span><span class="sxs-lookup"><span data-stu-id="76cf6-210">The X.509 certificate's private key is managed by the OS.</span></span> <span data-ttu-id="76cf6-211">Pour plus d’informations, consultez [authentifier avec un certificat au lieu d’une clé secrète Client](/azure/key-vault/key-vault-use-from-web-application#authenticate-with-a-certificate-instead-of-a-client-secret).</span><span class="sxs-lookup"><span data-stu-id="76cf6-211">For more information, see [Authenticate with a Certificate instead of a Client Secret](/azure/key-vault/key-vault-use-from-web-application#authenticate-with-a-certificate-instead-of-a-client-secret).</span></span> <span data-ttu-id="76cf6-212">Utilisez le `AddAzureKeyVault` surcharge qui accepte un `X509Certificate2` (`_env` dans l’exemple suivant :</span><span class="sxs-lookup"><span data-stu-id="76cf6-212">Use the `AddAzureKeyVault` overload that accepts an `X509Certificate2` (`_env` in the following example :</span></span>

```csharp
var builtConfig = config.Build();

var store = new X509Store(StoreLocation.CurrentUser);
store.Open(OpenFlags.ReadOnly);
var cert = store.Certificates
    .Find(X509FindType.FindByThumbprint, 
        config["CertificateThumbprint"], false);

config.AddAzureKeyVault(
    builtConfig["Vault"],
    builtConfig["ClientId"],
    cert.OfType<X509Certificate2>().Single(),
    new EnvironmentSecretManager(context.HostingEnvironment.ApplicationName));

store.Close();
```

## <a name="reload-secrets"></a><span data-ttu-id="76cf6-213">Recharger les secrets</span><span class="sxs-lookup"><span data-stu-id="76cf6-213">Reload secrets</span></span>

<span data-ttu-id="76cf6-214">Les secrets sont mis en cache jusqu'à ce que la méthode `IConfigurationRoot.Reload()` soit appelée.</span><span class="sxs-lookup"><span data-stu-id="76cf6-214">Secrets are cached until `IConfigurationRoot.Reload()` is called.</span></span> <span data-ttu-id="76cf6-215">Arrivé à expiration, désactivé, et les secrets mis à jour dans le coffre de clés ne sont pas respectées par l’application jusqu'à ce que `Reload` est exécutée.</span><span class="sxs-lookup"><span data-stu-id="76cf6-215">Expired, disabled, and updated secrets in the key vault are not respected by the app until `Reload` is executed.</span></span>

```csharp
Configuration.Reload();
```

## <a name="disabled-and-expired-secrets"></a><span data-ttu-id="76cf6-216">Secrets désactivés et expirés</span><span class="sxs-lookup"><span data-stu-id="76cf6-216">Disabled and expired secrets</span></span>

<span data-ttu-id="76cf6-217">Les secrets désactivés et expirés lèvent une exception `KeyVaultClientException`.</span><span class="sxs-lookup"><span data-stu-id="76cf6-217">Disabled and expired secrets throw a `KeyVaultClientException`.</span></span> <span data-ttu-id="76cf6-218">Pour empêcher votre application de lever cette exception, remplacez votre application ou mettez à jour le secret désactivé/expiré.</span><span class="sxs-lookup"><span data-stu-id="76cf6-218">To prevent your app from throwing, replace your app or update the disabled/expired secret.</span></span>

## <a name="troubleshoot"></a><span data-ttu-id="76cf6-219">Résoudre les problèmes</span><span class="sxs-lookup"><span data-stu-id="76cf6-219">Troubleshoot</span></span>

<span data-ttu-id="76cf6-220">Lorsque l’application ne parvient pas à charger la configuration de l’utilisation du fournisseur, un message d’erreur est écrite à la [infrastructure de journalisation ASP.NET Core](xref:fundamentals/logging/index).</span><span class="sxs-lookup"><span data-stu-id="76cf6-220">When the app fails to load configuration using the provider, an error message is written to the [ASP.NET Core Logging infrastructure](xref:fundamentals/logging/index).</span></span> <span data-ttu-id="76cf6-221">Les conditions suivantes empêchent le chargement de la configuration :</span><span class="sxs-lookup"><span data-stu-id="76cf6-221">The following conditions will prevent configuration from loading:</span></span>

* <span data-ttu-id="76cf6-222">L’application n’est pas configurée correctement dans Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="76cf6-222">The app isn't configured correctly in Azure Active Directory.</span></span>
* <span data-ttu-id="76cf6-223">Le coffre de clés n’existe pas dans Azure Key Vault.</span><span class="sxs-lookup"><span data-stu-id="76cf6-223">The key vault doesn't exist in Azure Key Vault.</span></span>
* <span data-ttu-id="76cf6-224">L’application n’est pas autorisée à accéder au coffre de clés.</span><span class="sxs-lookup"><span data-stu-id="76cf6-224">The app isn't authorized to access the key vault.</span></span>
* <span data-ttu-id="76cf6-225">La stratégie d’accès n’inclut pas les autorisations `Get` et `List`.</span><span class="sxs-lookup"><span data-stu-id="76cf6-225">The access policy doesn't include `Get` and `List` permissions.</span></span>
* <span data-ttu-id="76cf6-226">Dans le coffre de clés, les données de configuration (paire nom-valeur) sont manquantes, désactivées, expirées ou incorrectement nommées.</span><span class="sxs-lookup"><span data-stu-id="76cf6-226">In the key vault, the configuration data (name-value pair) is incorrectly named, missing, disabled, or expired.</span></span>
* <span data-ttu-id="76cf6-227">L’application a le nom de coffre de clés incorrect (`Vault`), Id d’application Azure AD (`ClientId`), ou la clé Azure AD (`ClientSecret`).</span><span class="sxs-lookup"><span data-stu-id="76cf6-227">The app has the wrong key vault name (`Vault`), Azure AD App Id (`ClientId`), or Azure AD Key (`ClientSecret`).</span></span>
* <span data-ttu-id="76cf6-228">La clé d’Azure AD (`ClientSecret`) a expiré.</span><span class="sxs-lookup"><span data-stu-id="76cf6-228">The Azure AD Key (`ClientSecret`) is expired.</span></span>
* <span data-ttu-id="76cf6-229">La clé de configuration (nom) est incorrecte dans l’application pour la valeur que vous tentez de charger.</span><span class="sxs-lookup"><span data-stu-id="76cf6-229">The configuration key (name) is incorrect in the app for the value you're trying to load.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="76cf6-230">Ressources supplémentaires</span><span class="sxs-lookup"><span data-stu-id="76cf6-230">Additional resources</span></span>

* <xref:fundamentals/configuration/index>
* [<span data-ttu-id="76cf6-231">Microsoft Azure : Coffre de clés</span><span class="sxs-lookup"><span data-stu-id="76cf6-231">Microsoft Azure: Key Vault</span></span>](https://azure.microsoft.com/services/key-vault/)
* [<span data-ttu-id="76cf6-232">Microsoft Azure : Documentation de coffre de clés</span><span class="sxs-lookup"><span data-stu-id="76cf6-232">Microsoft Azure: Key Vault Documentation</span></span>](/azure/key-vault/)
* [<span data-ttu-id="76cf6-233">Pour générer et transférer protégée par HSM de clés pour Azure Key Vault</span><span class="sxs-lookup"><span data-stu-id="76cf6-233">How to generate and transfer HSM-protected keys for Azure Key Vault</span></span>](/azure/key-vault/key-vault-hsm-protected-keys)
* [<span data-ttu-id="76cf6-234">Classe de KeyVaultClient</span><span class="sxs-lookup"><span data-stu-id="76cf6-234">KeyVaultClient Class</span></span>](/dotnet/api/microsoft.azure.keyvault.keyvaultclient)
