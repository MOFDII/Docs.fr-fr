---
title: "Fournisseur de configuration du coffre de clés Azure"
author: guardrex
description: "Découvrez comment utiliser le fournisseur de Configuration du coffre de clé Azure pour configurer une application à l’aide de paires nom-valeur chargées pendant l’exécution."
manager: wpickett
ms.author: riande
ms.date: 08/09/2017
ms.prod: asp.net-core
ms.topic: article
uid: security/key-vault-configuration
ms.openlocfilehash: 1a91a87fb90d4d4651e07f32415e4364c8e2d993
ms.sourcegitcommit: b83a5f731a9c02bdb1cc1e3f9a8bf273eb5b33e0
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 02/11/2018
---
# <a name="azure-key-vault-configuration-provider"></a><span data-ttu-id="f1887-103">Fournisseur de configuration du coffre de clés Azure</span><span class="sxs-lookup"><span data-stu-id="f1887-103">Azure Key Vault configuration provider</span></span>

<span data-ttu-id="f1887-104">Par [Luke Latham](https://github.com/guardrex) et [Andrew Stanton-infirmière](https://github.com/anurse)</span><span class="sxs-lookup"><span data-stu-id="f1887-104">By [Luke Latham](https://github.com/guardrex) and [Andrew Stanton-Nurse](https://github.com/anurse)</span></span>

# <a name="aspnet-core-2xtabaspnetcore2x"></a>[<span data-ttu-id="f1887-105">ASP.NET Core 2.x</span><span class="sxs-lookup"><span data-stu-id="f1887-105">ASP.NET Core 2.x</span></span>](#tab/aspnetcore2x)

<span data-ttu-id="f1887-106">Afficher ou télécharger l’exemple de code pour 2.x :</span><span class="sxs-lookup"><span data-stu-id="f1887-106">View or download sample code for 2.x:</span></span>

* <span data-ttu-id="f1887-107">[Exemple de base](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/basic-sample/2.x) ([comment télécharger](xref:tutorials/index#how-to-download-a-sample))-lit les valeurs des secrets dans une application.</span><span class="sxs-lookup"><span data-stu-id="f1887-107">[Basic sample](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/basic-sample/2.x) ([how to download](xref:tutorials/index#how-to-download-a-sample)) - Reads secret values into an app.</span></span>
* <span data-ttu-id="f1887-108">[Exemple de préfixe de nom de la clé](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/key-name-prefix-sample/2.x) ([comment télécharger](xref:tutorials/index#how-to-download-a-sample)) - lit les valeurs des secrets à l’aide d’un préfixe de nom de la clé qui représente la version d’une application, ce qui vous permet de charger un ensemble différent de valeurs de clé secrètes pour chaque version de l’application.</span><span class="sxs-lookup"><span data-stu-id="f1887-108">[Key name prefix sample](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/key-name-prefix-sample/2.x) ([how to download](xref:tutorials/index#how-to-download-a-sample)) - Reads secret values using a key name prefix that represents the version of an app, which allows you to load a different set of secret values for each app version.</span></span>

# <a name="aspnet-core-1xtabaspnetcore1x"></a>[<span data-ttu-id="f1887-109">ASP.NET Core 1.x</span><span class="sxs-lookup"><span data-stu-id="f1887-109">ASP.NET Core 1.x</span></span>](#tab/aspnetcore1x)

<span data-ttu-id="f1887-110">Afficher ou télécharger l’exemple de code pour 1.x :</span><span class="sxs-lookup"><span data-stu-id="f1887-110">View or download sample code for 1.x:</span></span>

* <span data-ttu-id="f1887-111">[Exemple de base](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/basic-sample/1.x) ([comment télécharger](xref:tutorials/index#how-to-download-a-sample))-lit les valeurs des secrets dans une application.</span><span class="sxs-lookup"><span data-stu-id="f1887-111">[Basic sample](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/basic-sample/1.x) ([how to download](xref:tutorials/index#how-to-download-a-sample)) - Reads secret values into an app.</span></span>
* <span data-ttu-id="f1887-112">[Exemple de préfixe de nom de la clé](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/key-name-prefix-sample/1.x) ([comment télécharger](xref:tutorials/index#how-to-download-a-sample)) - lit les valeurs des secrets à l’aide d’un préfixe de nom de la clé qui représente la version d’une application, ce qui vous permet de charger un ensemble différent de valeurs de clé secrètes pour chaque version de l’application.</span><span class="sxs-lookup"><span data-stu-id="f1887-112">[Key name prefix sample](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/key-name-prefix-sample/1.x) ([how to download](xref:tutorials/index#how-to-download-a-sample)) - Reads secret values using a key name prefix that represents the version of an app, which allows you to load a different set of secret values for each app version.</span></span> 

---

<span data-ttu-id="f1887-113">Ce document explique comment utiliser le [Microsoft Azure Key Vault](https://azure.microsoft.com/services/key-vault/) fournisseur de configuration à charger des valeurs de configuration d’application de secrets de coffre de clés Azure.</span><span class="sxs-lookup"><span data-stu-id="f1887-113">This document explains how to use the [Microsoft Azure Key Vault](https://azure.microsoft.com/services/key-vault/) configuration provider to load application configuration values from Azure Key Vault secrets.</span></span> <span data-ttu-id="f1887-114">Coffre de clés Azure est un service cloud qui vous aident à protéger les clés de chiffrement et les secrets utilisés par les applications et services.</span><span class="sxs-lookup"><span data-stu-id="f1887-114">Azure Key Vault is a cloud-based service that helps you safeguard cryptographic keys and secrets used by apps and services.</span></span> <span data-ttu-id="f1887-115">Scénarios courants incluent le contrôle d’accès aux données de configuration sensibles et répondre aux exigences de la norme FIPS 140-2 niveau 2 validé les Modules de sécurité matériel (HSM) lors du stockage des données de configuration.</span><span class="sxs-lookup"><span data-stu-id="f1887-115">Common scenarios include controlling access to sensitive configuration data and meeting the requirement for FIPS 140-2 Level 2 validated Hardware Security Modules (HSM's) when storing configuration data.</span></span> <span data-ttu-id="f1887-116">Cette fonctionnalité est disponible pour les applications qui ciblent ASP.NET Core 1.1 ou ultérieure.</span><span class="sxs-lookup"><span data-stu-id="f1887-116">This feature is available for applications that target ASP.NET Core 1.1 or higher.</span></span>

## <a name="package"></a><span data-ttu-id="f1887-117">Package</span><span class="sxs-lookup"><span data-stu-id="f1887-117">Package</span></span>
<span data-ttu-id="f1887-118">Pour utiliser le fournisseur, ajouter une référence à la [Microsoft.Extensions.Configuration.AzureKeyVault](https://www.nuget.org/packages/Microsoft.Extensions.Configuration.AzureKeyVault/) package.</span><span class="sxs-lookup"><span data-stu-id="f1887-118">To use the provider, add a reference to the [Microsoft.Extensions.Configuration.AzureKeyVault](https://www.nuget.org/packages/Microsoft.Extensions.Configuration.AzureKeyVault/) package.</span></span>

## <a name="application-configuration"></a><span data-ttu-id="f1887-119">Configuration d’application</span><span class="sxs-lookup"><span data-stu-id="f1887-119">Application configuration</span></span>
<span data-ttu-id="f1887-120">Vous pouvez explorer le fournisseur avec le [exemples d’applications](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples).</span><span class="sxs-lookup"><span data-stu-id="f1887-120">You can explore the provider with the [sample apps](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples).</span></span> <span data-ttu-id="f1887-121">Une fois que vous établissez un coffre de clés et créez des clés secrètes dans le coffre, les exemples d’applications en toute sécurité par chargement les valeurs de secret principal dans leurs configurations et les affichent dans les pages Web.</span><span class="sxs-lookup"><span data-stu-id="f1887-121">Once you establish a key vault and create secrets in the vault, the sample apps securely load the secret values into their configurations and display them in webpages.</span></span>

<span data-ttu-id="f1887-122">Le fournisseur est ajouté à la `ConfigurationBuilder` avec le `AddAzureKeyVault` extension.</span><span class="sxs-lookup"><span data-stu-id="f1887-122">The provider is added to the `ConfigurationBuilder` with the `AddAzureKeyVault` extension.</span></span> <span data-ttu-id="f1887-123">Dans les exemples d’applications, l’extension utilise trois valeurs de configuration chargés à partir de la *appsettings.json* fichier.</span><span class="sxs-lookup"><span data-stu-id="f1887-123">In the sample apps, the extension uses three configuration values loaded from the *appsettings.json* file.</span></span>

| <span data-ttu-id="f1887-124">Paramètre d’application</span><span class="sxs-lookup"><span data-stu-id="f1887-124">App Setting</span></span>    | <span data-ttu-id="f1887-125">Description</span><span class="sxs-lookup"><span data-stu-id="f1887-125">Description</span></span>                    | <span data-ttu-id="f1887-126">Exemple</span><span class="sxs-lookup"><span data-stu-id="f1887-126">Example</span></span>                                      |
| -------------- | ------------------------------ | -------------------------------------------- |
| `Vault`        | <span data-ttu-id="f1887-127">Nom de coffre de clés Azure</span><span class="sxs-lookup"><span data-stu-id="f1887-127">Azure Key Vault name</span></span>           | <span data-ttu-id="f1887-128">contosovault</span><span class="sxs-lookup"><span data-stu-id="f1887-128">contosovault</span></span>                                 |
| `ClientId`     | <span data-ttu-id="f1887-129">Id d’application Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="f1887-129">Azure Active Directory App Id</span></span>  | <span data-ttu-id="f1887-130">627e911e-43cc-61d4-992e-12db9c81b413</span><span class="sxs-lookup"><span data-stu-id="f1887-130">627e911e-43cc-61d4-992e-12db9c81b413</span></span>         |
| `ClientSecret` | <span data-ttu-id="f1887-131">Clé de l’application Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="f1887-131">Azure Active Directory App Key</span></span> | <span data-ttu-id="f1887-132">g58K3dtg59o1Pa+e59v2Tx829w6VxTB2yv9sv/101di=</span><span class="sxs-lookup"><span data-stu-id="f1887-132">g58K3dtg59o1Pa+e59v2Tx829w6VxTB2yv9sv/101di=</span></span> |

[!code-csharp[Program](key-vault-configuration/samples/basic-sample/2.x/Program.cs?name=snippet1&highlight=2,7-10)]

## <a name="creating-key-vault-secrets-and-loading-configuration-values-basic-sample"></a><span data-ttu-id="f1887-133">Création des clés secrètes de coffre de clés et du chargement des valeurs de configuration (exemple de base)</span><span class="sxs-lookup"><span data-stu-id="f1887-133">Creating key vault secrets and loading configuration values (basic-sample)</span></span>
1. <span data-ttu-id="f1887-134">Créer un coffre de clés et configurer Azure Active Directory (Azure AD) pour l’application en suivant les instructions de [prise en main d’Azure Key Vault](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span><span class="sxs-lookup"><span data-stu-id="f1887-134">Create a key vault and set up Azure Active Directory (Azure AD) for the application following the guidance in [Get started with Azure Key Vault](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span></span>
  * <span data-ttu-id="f1887-135">Ajouter les clés secrètes au coffre de clés à l’aide la [PowerShell Module d’Azure Resource Manager clé de coffre](/powershell/module/azurerm.keyvault) disponible à partir de la [PowerShell Gallery](https://www.powershellgallery.com/packages/AzureRM.KeyVault), le [API REST de coffre de clés Azure](/rest/api/keyvault/), ou le [Portail azure](https://portal.azure.com/).</span><span class="sxs-lookup"><span data-stu-id="f1887-135">Add secrets to the key vault using the [AzureRM Key Vault PowerShell Module](/powershell/module/azurerm.keyvault) available from the [PowerShell Gallery](https://www.powershellgallery.com/packages/AzureRM.KeyVault), the [Azure Key Vault REST API](/rest/api/keyvault/), or the [Azure Portal](https://portal.azure.com/).</span></span> <span data-ttu-id="f1887-136">Les secrets sont créés en tant que *manuel* ou *certificat* secrets.</span><span class="sxs-lookup"><span data-stu-id="f1887-136">Secrets are created as either *Manual* or *Certificate* secrets.</span></span> <span data-ttu-id="f1887-137">*Certificat* secrets sont des certificats pour les applications et services, mais ne sont pas pris en charge par le fournisseur de configuration.</span><span class="sxs-lookup"><span data-stu-id="f1887-137">*Certificate* secrets are certificates for use by apps and services but are not supported by the configuration provider.</span></span> <span data-ttu-id="f1887-138">Vous devez utiliser le *manuel* option permettant de créer des clés secrètes de paire nom-valeur pour une utilisation avec le fournisseur de configuration.</span><span class="sxs-lookup"><span data-stu-id="f1887-138">You should use the *Manual* option to create name-value pair secrets for use with the configuration provider.</span></span>
    * <span data-ttu-id="f1887-139">Les secrets simples sont créées en tant que paires nom-valeur.</span><span class="sxs-lookup"><span data-stu-id="f1887-139">Simple secrets are created as name-value pairs.</span></span> <span data-ttu-id="f1887-140">Les noms de secret de coffre de clés Azure sont limités à des caractères alphanumériques et des tirets.</span><span class="sxs-lookup"><span data-stu-id="f1887-140">Azure Key Vault secret names are limited to alphanumeric characters and dashes.</span></span>
    * <span data-ttu-id="f1887-141">Utilisent des valeurs hiérarchiques (sections de configuration) `--` (deux tirets) comme séparateur dans l’exemple.</span><span class="sxs-lookup"><span data-stu-id="f1887-141">Hierarchical values (configuration sections) use `--` (two dashes) as a separator in the sample.</span></span> <span data-ttu-id="f1887-142">Signes deux-points, qui sont normalement utilisés pour délimiter une section à partir d’une sous-clé dans [configuration d’ASP.NET Core](xref:fundamentals/configuration/index), ne sont pas autorisés dans les noms de secret principal.</span><span class="sxs-lookup"><span data-stu-id="f1887-142">Colons, which are normally used to delimit a section from a subkey in [ASP.NET Core configuration](xref:fundamentals/configuration/index), aren't allowed in secret names.</span></span> <span data-ttu-id="f1887-143">Par conséquent, les deux tirets sont utilisés et échangés avec un signe deux-points, lorsque les clés secrètes sont chargés dans la configuration de l’application.</span><span class="sxs-lookup"><span data-stu-id="f1887-143">Therefore, two dashes are used and swapped for a colon when the secrets are loaded into the app's configuration.</span></span>
    * <span data-ttu-id="f1887-144">Créez deux *manuel* secrets avec les paires nom-valeur suivantes.</span><span class="sxs-lookup"><span data-stu-id="f1887-144">Create two *Manual* secrets with the following name-value pairs.</span></span> <span data-ttu-id="f1887-145">La question secrète du premier est une valeur et le nom simple, et la question secrète du deuxième crée une valeur de secret principal avec une section et le sous-clé dans le nom de clé secrète :</span><span class="sxs-lookup"><span data-stu-id="f1887-145">The first secret is a simple name and value, and the second secret creates a secret value with a section and subkey in the secret name:</span></span>
      * <span data-ttu-id="f1887-146">`SecretName`: `secret_value_1`</span><span class="sxs-lookup"><span data-stu-id="f1887-146">`SecretName`: `secret_value_1`</span></span>
      * <span data-ttu-id="f1887-147">`Section--SecretName`: `secret_value_2`</span><span class="sxs-lookup"><span data-stu-id="f1887-147">`Section--SecretName`: `secret_value_2`</span></span>
  * <span data-ttu-id="f1887-148">Inscrire l’exemple d’application avec Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="f1887-148">Register the sample app with Azure Active Directory.</span></span>
  * <span data-ttu-id="f1887-149">Autoriser l’application à accéder au coffre de clés.</span><span class="sxs-lookup"><span data-stu-id="f1887-149">Authorize the app to access the key vault.</span></span> <span data-ttu-id="f1887-150">Lorsque vous utilisez la `Set-AzureRmKeyVaultAccessPolicy` fournissent de l’applet de commande PowerShell pour autoriser l’application à accéder au coffre de clés, `List` et `Get` accès aux clés secrètes avec `-PermissionsToSecrets list,get`.</span><span class="sxs-lookup"><span data-stu-id="f1887-150">When you use the `Set-AzureRmKeyVaultAccessPolicy` PowerShell cmdlet to authorize the app to access the key vault, provide `List` and `Get` access to secrets with `-PermissionsToSecrets list,get`.</span></span>
2. <span data-ttu-id="f1887-151">Mettre à jour de l’application *appsettings.json* fichier avec les valeurs de `Vault`, `ClientId`, et `ClientSecret`.</span><span class="sxs-lookup"><span data-stu-id="f1887-151">Update the app's *appsettings.json* file with the values of `Vault`, `ClientId`, and `ClientSecret`.</span></span>
3. <span data-ttu-id="f1887-152">Exécutez l’exemple d’application, qui obtient ses valeurs de configuration à partir de `IConfigurationRoot` avec le même nom que le nom secret.</span><span class="sxs-lookup"><span data-stu-id="f1887-152">Run the sample app, which obtains its configuration values from `IConfigurationRoot` with the same name as the secret name.</span></span>
  * <span data-ttu-id="f1887-153">Valeurs non hiérarchique : la valeur de `SecretName` est obtenu avec `config["SecretName"]`.</span><span class="sxs-lookup"><span data-stu-id="f1887-153">Non-hierarchical values: The value for `SecretName` is obtained with `config["SecretName"]`.</span></span>
  * <span data-ttu-id="f1887-154">Valeurs hiérarchiques (sections) : utilisez `:` la notation (deux-points) ou le `GetSection` méthode d’extension.</span><span class="sxs-lookup"><span data-stu-id="f1887-154">Hierarchical values (sections): Use `:` (colon) notation or the `GetSection` extension method.</span></span> <span data-ttu-id="f1887-155">Pour obtenir la valeur de configuration, utilisez une des ces approches :</span><span class="sxs-lookup"><span data-stu-id="f1887-155">Use either of these approaches to obtain the configuration value:</span></span>
    * `config["Section:SecretName"]`
    * `config.GetSection("Section")["SecretName"]`

<span data-ttu-id="f1887-156">Lorsque vous exécutez l’application, une page Web affiche les valeurs de secret principal chargés :</span><span class="sxs-lookup"><span data-stu-id="f1887-156">When you run the app, a webpage shows the loaded secret values:</span></span>

![Fenêtre de navigateur affichant les valeurs des secrets chargée via le fournisseur de Configuration Azure Key Vault](key-vault-configuration/_static/sample1.png)

## <a name="creating-prefixed-key-vault-secrets-and-loading-configuration-values-key-name-prefix-sample"></a><span data-ttu-id="f1887-158">Création des clés secrètes de coffre de clés avec préfixe et du chargement des valeurs de configuration (touche-nom-préfixe-exemple)</span><span class="sxs-lookup"><span data-stu-id="f1887-158">Creating prefixed key vault secrets and loading configuration values (key-name-prefix-sample)</span></span>
<span data-ttu-id="f1887-159">`AddAzureKeyVault`fournit également une surcharge qui accepte une implémentation de `IKeyVaultSecretManager`, qui vous permet de contrôler comment les secrets de coffre sont convertis en clés de configuration.</span><span class="sxs-lookup"><span data-stu-id="f1887-159">`AddAzureKeyVault` also provides an overload that accepts an implementation of `IKeyVaultSecretManager`, which allows you to control how key vault secrets are converted into configuration keys.</span></span> <span data-ttu-id="f1887-160">Par exemple, vous pouvez implémenter l’interface pour charger les valeurs des secrets selon une valeur de préfixe que vous fournissez au démarrage de l’application.</span><span class="sxs-lookup"><span data-stu-id="f1887-160">For example, you can implement the interface to load secret values based on a prefix value you provide at app startup.</span></span> <span data-ttu-id="f1887-161">Cela vous permet, par exemple, pour charger des secrets selon la version de l’application.</span><span class="sxs-lookup"><span data-stu-id="f1887-161">This allows you, for example, to load secrets based on the version of the app.</span></span>

> [!WARNING]
> <span data-ttu-id="f1887-162">N’utilisez pas de préfixes sur les secrets de coffre de clés pour placer des secrets pour plusieurs applications dans le coffre de clés même ou à l’environnement de secrets (par exemple, *développement* et *production* secrets) dans le même coffre.</span><span class="sxs-lookup"><span data-stu-id="f1887-162">Don't use prefixes on key vault secrets to place secrets for multiple apps into the same key vault or to place environmental secrets (for example, *development* versus *production* secrets) into the same vault.</span></span> <span data-ttu-id="f1887-163">Nous conseillons différentes applications et environnements de développement/production des coffres de clés distinctes pour isoler les environnements d’application pour le niveau le plus élevé de sécurité.</span><span class="sxs-lookup"><span data-stu-id="f1887-163">We recommend that different apps and development/production environments use separate key vaults to isolate app environments for the highest level of security.</span></span>

<span data-ttu-id="f1887-164">À l’aide de la deuxième exemple d’application, vous créez une clé secrète dans le coffre de clés pour `5000-AppSecret` (périodes ne sont pas autorisés dans les noms de coffre de clés secrètes) représentant un secret d’application pour la version 5.0.0.0 de votre application.</span><span class="sxs-lookup"><span data-stu-id="f1887-164">Using the second sample app, you create a secret in the key vault for `5000-AppSecret` (periods aren't allowed in key vault secret names) representing an app secret for version 5.0.0.0 of your app.</span></span> <span data-ttu-id="f1887-165">Pour une autre version, 5.1.0.0, vous créez une clé secrète pour `5100-AppSecret`.</span><span class="sxs-lookup"><span data-stu-id="f1887-165">For another version, 5.1.0.0, you create a secret for `5100-AppSecret`.</span></span> <span data-ttu-id="f1887-166">Chaque version de l’application charge sa propre valeur secrète dans sa configuration en tant que `AppSecret`, extraction, la version tandis qu’il charge la clé secrète.</span><span class="sxs-lookup"><span data-stu-id="f1887-166">Each app version loads its own secret value into its configuration as `AppSecret`, stripping off the version as it loads the secret.</span></span> <span data-ttu-id="f1887-167">Implémentation de l’exemple est illustrée ci-dessous :</span><span class="sxs-lookup"><span data-stu-id="f1887-167">The sample's implementation is shown below:</span></span>

[!code-csharp[Configuration builder](key-vault-configuration/samples/key-name-prefix-sample/2.x/Program.cs?name=snippet1&highlight=12)]

[!code-csharp[PrefixKeyVaultSecretManager](key-vault-configuration/samples/key-name-prefix-sample/2.x/Startup.cs?name=snippet1)]

<span data-ttu-id="f1887-168">Le `Load` méthode est appelée par un fournisseur d’algorithme qui effectue une itération dans les clés secrètes de coffre pour trouver celles qui ont le préfixe de la version.</span><span class="sxs-lookup"><span data-stu-id="f1887-168">The `Load` method is called by a provider algorithm that iterates through the vault secrets to find the ones that have the version prefix.</span></span> <span data-ttu-id="f1887-169">Quand un préfixe de version a été trouvé avec `Load`, l’algorithme utilise le `GetKey` méthode pour retourner le nom de la configuration du nom du secret principal.</span><span class="sxs-lookup"><span data-stu-id="f1887-169">When a version prefix is found with `Load`, the algorithm uses the `GetKey` method to return the configuration name of the secret name.</span></span> <span data-ttu-id="f1887-170">Il supprime le préfixe de la version du nom de la clé secrète et retourne le reste du nom du secret principal pour le chargement dans la configuration de l’application de paires nom-valeur.</span><span class="sxs-lookup"><span data-stu-id="f1887-170">It strips off the version prefix from the secret's name and returns the rest of the secret name for loading into the app's configuration name-value pairs.</span></span>

<span data-ttu-id="f1887-171">Lorsque vous implémentez cette approche :</span><span class="sxs-lookup"><span data-stu-id="f1887-171">When you implement this approach:</span></span>

1. <span data-ttu-id="f1887-172">Les clés secrètes du coffre de clés sont chargés.</span><span class="sxs-lookup"><span data-stu-id="f1887-172">The key vault secrets are loaded.</span></span>
2. <span data-ttu-id="f1887-173">Le secret de chaîne pour `5000-AppSecret` est mis en correspondance.</span><span class="sxs-lookup"><span data-stu-id="f1887-173">The string secret for `5000-AppSecret` is matched.</span></span>
3. <span data-ttu-id="f1887-174">La version, `5000` (avec le tiret), est supprimé sur le nom de clé en laissant `AppSecret` pour charger avec la valeur de secret principal dans la configuration de l’application.</span><span class="sxs-lookup"><span data-stu-id="f1887-174">The version, `5000` (with the dash), is stripped off of the key name leaving `AppSecret` to load with the secret value into the app's configuration.</span></span>

> [!NOTE]
> <span data-ttu-id="f1887-175">Vous pouvez également fournir votre propre `KeyVaultClient` implémentation à `AddAzureKeyVault`.</span><span class="sxs-lookup"><span data-stu-id="f1887-175">You can also provide your own `KeyVaultClient` implementation to `AddAzureKeyVault`.</span></span> <span data-ttu-id="f1887-176">En fournissant un client personnalisé vous permet de partager une seule instance du client entre le fournisseur de configuration et d’autres parties de votre application.</span><span class="sxs-lookup"><span data-stu-id="f1887-176">Supplying a custom client allows you to share a single instance of the client between the configuration provider and other parts of your app.</span></span>

1. <span data-ttu-id="f1887-177">Créer un coffre de clés et configurer Azure Active Directory (Azure AD) pour l’application en suivant les instructions de [prise en main d’Azure Key Vault](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span><span class="sxs-lookup"><span data-stu-id="f1887-177">Create a key vault and set up Azure Active Directory (Azure AD) for the application following the guidance in [Get started with Azure Key Vault](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span></span>
  * <span data-ttu-id="f1887-178">Ajouter les clés secrètes au coffre de clés à l’aide la [PowerShell Module d’Azure Resource Manager clé de coffre](/powershell/module/azurerm.keyvault) disponible à partir de la [PowerShell Gallery](https://www.powershellgallery.com/packages/AzureRM.KeyVault), le [API REST de coffre de clés Azure](/rest/api/keyvault/), ou le [Portail azure](https://portal.azure.com/).</span><span class="sxs-lookup"><span data-stu-id="f1887-178">Add secrets to the key vault using the [AzureRM Key Vault PowerShell Module](/powershell/module/azurerm.keyvault) available from the [PowerShell Gallery](https://www.powershellgallery.com/packages/AzureRM.KeyVault), the [Azure Key Vault REST API](/rest/api/keyvault/), or the [Azure Portal](https://portal.azure.com/).</span></span> <span data-ttu-id="f1887-179">Les secrets sont créés en tant que *manuel* ou *certificat* secrets.</span><span class="sxs-lookup"><span data-stu-id="f1887-179">Secrets are created as either *Manual* or *Certificate* secrets.</span></span> <span data-ttu-id="f1887-180">*Certificat* secrets sont des certificats pour les applications et services, mais ne sont pas pris en charge par le fournisseur de configuration.</span><span class="sxs-lookup"><span data-stu-id="f1887-180">*Certificate* secrets are certificates for use by apps and services but are not supported by the configuration provider.</span></span> <span data-ttu-id="f1887-181">Vous devez utiliser le *manuel* option permettant de créer des clés secrètes de paire nom-valeur pour une utilisation avec le fournisseur de configuration.</span><span class="sxs-lookup"><span data-stu-id="f1887-181">You should use the *Manual* option to create name-value pair secrets for use with the configuration provider.</span></span>
    * <span data-ttu-id="f1887-182">Utilisent des valeurs hiérarchiques (sections de configuration) `--` (deux tirets) comme séparateur.</span><span class="sxs-lookup"><span data-stu-id="f1887-182">Hierarchical values (configuration sections) use `--` (two dashes) as a separator.</span></span>
    * <span data-ttu-id="f1887-183">Créez deux *manuel* secrets avec les paires nom-valeur suivantes :</span><span class="sxs-lookup"><span data-stu-id="f1887-183">Create two *Manual* secrets with the following name-value pairs:</span></span>
      * <span data-ttu-id="f1887-184">`5000-AppSecret`: `5.0.0.0_secret_value`</span><span class="sxs-lookup"><span data-stu-id="f1887-184">`5000-AppSecret`: `5.0.0.0_secret_value`</span></span>
      * <span data-ttu-id="f1887-185">`5100-AppSecret`: `5.1.0.0_secret_value`</span><span class="sxs-lookup"><span data-stu-id="f1887-185">`5100-AppSecret`: `5.1.0.0_secret_value`</span></span>
  * <span data-ttu-id="f1887-186">Inscrire l’exemple d’application avec Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="f1887-186">Register the sample app with Azure Active Directory.</span></span>
  * <span data-ttu-id="f1887-187">Autoriser l’application à accéder au coffre de clés.</span><span class="sxs-lookup"><span data-stu-id="f1887-187">Authorize the app to access the key vault.</span></span> <span data-ttu-id="f1887-188">Lorsque vous utilisez la `Set-AzureRmKeyVaultAccessPolicy` fournissent de l’applet de commande PowerShell pour autoriser l’application à accéder au coffre de clés, `List` et `Get` accès aux clés secrètes avec `-PermissionsToSecrets list,get`.</span><span class="sxs-lookup"><span data-stu-id="f1887-188">When you use the `Set-AzureRmKeyVaultAccessPolicy` PowerShell cmdlet to authorize the app to access the key vault, provide `List` and `Get` access to secrets with `-PermissionsToSecrets list,get`.</span></span>
2. <span data-ttu-id="f1887-189">Mettre à jour de l’application *appsettings.json* fichier avec les valeurs de `Vault`, `ClientId`, et `ClientSecret`.</span><span class="sxs-lookup"><span data-stu-id="f1887-189">Update the app's *appsettings.json* file with the values of `Vault`, `ClientId`, and `ClientSecret`.</span></span>
3. <span data-ttu-id="f1887-190">Exécutez l’exemple d’application, qui obtient ses valeurs de configuration à partir de `IConfigurationRoot` avec le même nom que le nom secret avec préfixe.</span><span class="sxs-lookup"><span data-stu-id="f1887-190">Run the sample app, which obtains its configuration values from `IConfigurationRoot` with the same name as the prefixed secret name.</span></span> <span data-ttu-id="f1887-191">Dans cet exemple, le préfixe est la version de l’application que vous avez fournies pour les `PrefixKeyVaultSecretManager` quand vous avez ajouté le fournisseur de configuration du coffre de clés Azure.</span><span class="sxs-lookup"><span data-stu-id="f1887-191">In this sample, the prefix is the app's version, which you provided to the `PrefixKeyVaultSecretManager` when you added the Azure Key Vault configuration provider.</span></span> <span data-ttu-id="f1887-192">La valeur de `AppSecret` est obtenu avec `config["AppSecret"]`.</span><span class="sxs-lookup"><span data-stu-id="f1887-192">The value for `AppSecret` is obtained with `config["AppSecret"]`.</span></span> <span data-ttu-id="f1887-193">La page Web générée par l’application affiche la valeur chargée :</span><span class="sxs-lookup"><span data-stu-id="f1887-193">The webpage generated by the app shows the loaded value:</span></span>

   ![Fenêtre de navigateur indiquant une valeur secrète chargée via le fournisseur de Configuration Azure Key Vault lors de la version de l’application est 5.0.0.0](key-vault-configuration/_static/sample2-1.png)

4. <span data-ttu-id="f1887-195">Modifier la version de l’assembly de l’application dans le fichier de projet à partir de `5.0.0.0` à `5.1.0.0` et réexécutez l’application.</span><span class="sxs-lookup"><span data-stu-id="f1887-195">Change the version of the app assembly in the project file from `5.0.0.0` to `5.1.0.0` and run the app again.</span></span> <span data-ttu-id="f1887-196">Cette fois, la valeur secrète retournée est `5.1.0.0_secret_value`.</span><span class="sxs-lookup"><span data-stu-id="f1887-196">This time, the secret value returned is `5.1.0.0_secret_value`.</span></span> <span data-ttu-id="f1887-197">La page Web générée par l’application affiche la valeur chargée :</span><span class="sxs-lookup"><span data-stu-id="f1887-197">The webpage generated by the app shows the loaded value:</span></span>

   ![Fenêtre de navigateur indiquant une valeur secrète chargée via le fournisseur de Configuration Azure Key Vault lors de la version de l’application est 5.1.0.0](key-vault-configuration/_static/sample2-2.png)

## <a name="controlling-access-to-the-clientsecret"></a><span data-ttu-id="f1887-199">Contrôle l’accès à la ClientSecret</span><span class="sxs-lookup"><span data-stu-id="f1887-199">Controlling access to the ClientSecret</span></span>
<span data-ttu-id="f1887-200">Utilisez le [Secret gestionnaire](xref:security/app-secrets) pour maintenir le `ClientSecret` en dehors de votre arborescence source du projet.</span><span class="sxs-lookup"><span data-stu-id="f1887-200">Use the [Secret Manager tool](xref:security/app-secrets) to maintain the `ClientSecret` outside of your project source tree.</span></span> <span data-ttu-id="f1887-201">Avec le Gestionnaire de clé secrète, associer des secrets de l’application à un projet spécifique, les partager entre plusieurs projets.</span><span class="sxs-lookup"><span data-stu-id="f1887-201">With Secret Manager, you associate app secrets with a specific project and share them across multiple projects.</span></span>

<span data-ttu-id="f1887-202">Lorsque vous développez une application .NET Framework dans un environnement qui prend en charge les certificats, vous pouvez vous authentifier à Azure Key Vault avec un certificat X.509.</span><span class="sxs-lookup"><span data-stu-id="f1887-202">When developing a .NET Framework app in an environment that supports certificates, you can authenticate to Azure Key Vault with an X.509 certificate.</span></span> <span data-ttu-id="f1887-203">Les clé privée du certificat X.509 sont gérée par le système d’exploitation.</span><span class="sxs-lookup"><span data-stu-id="f1887-203">The X.509 certificate's private key is managed by the OS.</span></span> <span data-ttu-id="f1887-204">Pour plus d’informations, consultez [authentifier avec un certificat au lieu d’une clé secrète Client](https://docs.microsoft.com/azure/key-vault/key-vault-use-from-web-application#authenticate-with-a-certificate-instead-of-a-client-secret).</span><span class="sxs-lookup"><span data-stu-id="f1887-204">For more information, see [Authenticate with a Certificate instead of a Client Secret](https://docs.microsoft.com/azure/key-vault/key-vault-use-from-web-application#authenticate-with-a-certificate-instead-of-a-client-secret).</span></span> <span data-ttu-id="f1887-205">Utilisez le `AddAzureKeyVault` surcharge qui accepte un `X509Certificate2`.</span><span class="sxs-lookup"><span data-stu-id="f1887-205">Use the `AddAzureKeyVault` overload that accepts an `X509Certificate2`.</span></span>

```csharp
var store = new X509Store(StoreLocation.CurrentUser);
store.Open(OpenFlags.ReadOnly);
var cert = store.Certificates.Find(X509FindType.FindByThumbprint, config["CertificateThumbprint"], false);

builder.AddAzureKeyVault(
    config["Vault"],
    config["ClientId"],
    cert.OfType<X509Certificate2>().Single(),
    new EnvironmentSecretManager(env.ApplicationName));
store.Close();

Configuration = builder.Build();
```

## <a name="reloading-secrets"></a><span data-ttu-id="f1887-206">Rechargement des clés secrètes</span><span class="sxs-lookup"><span data-stu-id="f1887-206">Reloading secrets</span></span>
<span data-ttu-id="f1887-207">Les secrets sont mis en cache jusqu'à ce que `IConfigurationRoot.Reload()` est appelée.</span><span class="sxs-lookup"><span data-stu-id="f1887-207">Secrets are cached until `IConfigurationRoot.Reload()` is called.</span></span> <span data-ttu-id="f1887-208">Expiré, désactivé, et les secrets mis à jour dans le coffre de clés ne sont pas respectées par l’application tant que `Reload` est exécutée.</span><span class="sxs-lookup"><span data-stu-id="f1887-208">Expired, disabled, and updated secrets in the key vault are not respected by the application until `Reload` is executed.</span></span>

```csharp
Configuration.Reload();
```

## <a name="disabled-and-expired-secrets"></a><span data-ttu-id="f1887-209">Secrets désactivés et expirés</span><span class="sxs-lookup"><span data-stu-id="f1887-209">Disabled and expired secrets</span></span>
<span data-ttu-id="f1887-210">Secrets désactivés et expirées lever un `KeyVaultClientException`.</span><span class="sxs-lookup"><span data-stu-id="f1887-210">Disabled and expired secrets throw a `KeyVaultClientException`.</span></span> <span data-ttu-id="f1887-211">Pour empêcher votre application de lever, remplacez votre application, ou mettre à jour le secret désactivé/expiré.</span><span class="sxs-lookup"><span data-stu-id="f1887-211">To prevent your app from throwing, replace your app or update the disabled/expired secret.</span></span>

## <a name="troubleshooting"></a><span data-ttu-id="f1887-212">Résolution des problèmes</span><span class="sxs-lookup"><span data-stu-id="f1887-212">Troubleshooting</span></span>
<span data-ttu-id="f1887-213">Lorsque l’application ne parvient pas à charger la configuration de l’utilisation du fournisseur, un message d’erreur est écrit pour le [infrastructure de journalisation d’ASP.NET](xref:fundamentals/logging/index).</span><span class="sxs-lookup"><span data-stu-id="f1887-213">When the application fails to load configuration using the provider, an error message is written to the [ASP.NET Logging infrastructure](xref:fundamentals/logging/index).</span></span> <span data-ttu-id="f1887-214">Les conditions suivantes empêchent de se charger :</span><span class="sxs-lookup"><span data-stu-id="f1887-214">The following conditions will prevent configuration from loading:</span></span>
* <span data-ttu-id="f1887-215">L’application n’est pas configurée correctement dans Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="f1887-215">The app isn't configured correctly in Azure Active Directory.</span></span>
* <span data-ttu-id="f1887-216">Le coffre de clés n’existe pas dans le coffre de clés Azure.</span><span class="sxs-lookup"><span data-stu-id="f1887-216">The key vault doesn't exist in Azure Key Vault.</span></span>
* <span data-ttu-id="f1887-217">L’application n’est pas autorisée à accéder au coffre de clés.</span><span class="sxs-lookup"><span data-stu-id="f1887-217">The app isn't authorized to access the key vault.</span></span>
* <span data-ttu-id="f1887-218">N’inclut pas la stratégie d’accès `Get` et `List` autorisations.</span><span class="sxs-lookup"><span data-stu-id="f1887-218">The access policy doesn't include `Get` and `List` permissions.</span></span>
* <span data-ttu-id="f1887-219">Dans le coffre de clés, les données de configuration (paire nom-valeur) sont correctement nommées, manquant, désactivé ou expiré.</span><span class="sxs-lookup"><span data-stu-id="f1887-219">In the key vault, the configuration data (name-value pair) is incorrectly named, missing, disabled, or expired.</span></span>
* <span data-ttu-id="f1887-220">L’application a le nom de coffre de clés incorrect (`Vault`), Id d’application Azure AD (`ClientId`), ou la clé Azure AD (`ClientSecret`).</span><span class="sxs-lookup"><span data-stu-id="f1887-220">The app has the wrong key vault name (`Vault`), Azure AD App Id (`ClientId`), or Azure AD Key (`ClientSecret`).</span></span>
* <span data-ttu-id="f1887-221">La clé d’Azure AD (`ClientSecret`) a expiré.</span><span class="sxs-lookup"><span data-stu-id="f1887-221">The Azure AD Key (`ClientSecret`) is expired.</span></span>
* <span data-ttu-id="f1887-222">La clé de configuration (nom) est incorrecte dans l’application pour la valeur que vous essayez de charger.</span><span class="sxs-lookup"><span data-stu-id="f1887-222">The configuration key (name) is incorrect in the app for the value you're trying to load.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="f1887-223">Ressources supplémentaires</span><span class="sxs-lookup"><span data-stu-id="f1887-223">Additional resources</span></span>
* [<span data-ttu-id="f1887-224">Configuration</span><span class="sxs-lookup"><span data-stu-id="f1887-224">Configuration</span></span>](xref:fundamentals/configuration/index)
* [<span data-ttu-id="f1887-225">Microsoft Azure : Coffre de clés</span><span class="sxs-lookup"><span data-stu-id="f1887-225">Microsoft Azure: Key Vault</span></span>](https://azure.microsoft.com/services/key-vault/)
* [<span data-ttu-id="f1887-226">Microsoft Azure : Documentation de coffre de clés</span><span class="sxs-lookup"><span data-stu-id="f1887-226">Microsoft Azure: Key Vault Documentation</span></span>](https://docs.microsoft.com/azure/key-vault/)
* [<span data-ttu-id="f1887-227">Comment générer et transférer protégée par HSM clés pour le coffre de clés Azure</span><span class="sxs-lookup"><span data-stu-id="f1887-227">How to generate and transfer HSM-protected keys for Azure Key Vault</span></span>](https://docs.microsoft.com/azure/key-vault/key-vault-hsm-protected-keys)
* [<span data-ttu-id="f1887-228">Classe de KeyVaultClient</span><span class="sxs-lookup"><span data-stu-id="f1887-228">KeyVaultClient Class</span></span>](https://docs.microsoft.com/dotnet/api/microsoft.azure.keyvault.keyvaultclient)
