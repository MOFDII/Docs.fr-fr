---
title: Configurez ASP.NET Core pour travailler avec des serveurs proxy et des équilibrages de charge
author: guardrex
description: En savoir plus sur la configuration pour les applications hébergées derrière des serveurs proxy et les équilibreurs de charge, souvent masquent important demandent des informations.
manager: wpickett
ms.author: riande
ms.custom: mvc
ms.date: 03/26/2018
ms.prod: asp.net-core
ms.technology: aspnet
ms.topic: article
uid: host-and-deploy/proxy-load-balancer
ms.openlocfilehash: b153a7406ae1b31a2aa453135c6bd0e5ce0b2997
ms.sourcegitcommit: d45d766504c2c5aad2453f01f089bc6b696b5576
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 03/30/2018
---
# <a name="configure-aspnet-core-to-work-with-proxy-servers-and-load-balancers"></a><span data-ttu-id="6b7ac-103">Configurez ASP.NET Core pour travailler avec des serveurs proxy et des équilibrages de charge</span><span class="sxs-lookup"><span data-stu-id="6b7ac-103">Configure ASP.NET Core to work with proxy servers and load balancers</span></span>

<span data-ttu-id="6b7ac-104">Par [Luke Latham](https://github.com/guardrex) et [Ross de Chris](https://github.com/Tratcher)</span><span class="sxs-lookup"><span data-stu-id="6b7ac-104">By [Luke Latham](https://github.com/guardrex) and [Chris Ross](https://github.com/Tratcher)</span></span>

<span data-ttu-id="6b7ac-105">Dans la configuration recommandée pour ASP.NET Core, l’application est hébergée à l’aide du Module de base IIS/ASP.NET, Nginx ou Apache.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-105">In the recommended configuration for ASP.NET Core, the app is hosted using IIS/ASP.NET Core Module, Nginx, or Apache.</span></span> <span data-ttu-id="6b7ac-106">Serveurs proxy, les équilibreurs de charge et autres dispositifs réseau souvent masquent les informations sur la demande avant d’atteindre l’application :</span><span class="sxs-lookup"><span data-stu-id="6b7ac-106">Proxy servers, load balancers, and other network appliances often obscure information about the request before it reaches the app:</span></span>

* <span data-ttu-id="6b7ac-107">Lorsque les requêtes HTTPS sont transmis via HTTP, le schéma d’origine (HTTPS) est perdu et doit être transmis dans un en-tête.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-107">When HTTPS requests are proxied over HTTP, the original scheme (HTTPS) is lost and must be forwarded in a header.</span></span>
* <span data-ttu-id="6b7ac-108">Car une application reçoit une demande le proxy et pas sa source true sur Internet ou au réseau d’entreprise, l’adresse IP du client d’origine doit également être transféré dans un en-tête.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-108">Because an app receives a request from the proxy and not its true source on the Internet or corporate network, the originating client IP address must also be forwarded in a header.</span></span>

<span data-ttu-id="6b7ac-109">Ces informations peuvent être importantes dans le traitement de requêtes, par exemple dans les redirections, l’authentification, génération de lien, évaluation de la stratégie et geoloation du client.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-109">This information may be important in request processing, for example in redirects, authentication, link generation, policy evaluation, and client geoloation.</span></span>

## <a name="forwarded-headers"></a><span data-ttu-id="6b7ac-110">En-têtes transférés</span><span class="sxs-lookup"><span data-stu-id="6b7ac-110">Forwarded headers</span></span>

<span data-ttu-id="6b7ac-111">Par convention, proxy transférer des informations dans les en-têtes HTTP.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-111">By convention, proxies forward information in HTTP headers.</span></span>

| <span data-ttu-id="6b7ac-112">Header</span><span class="sxs-lookup"><span data-stu-id="6b7ac-112">Header</span></span> | <span data-ttu-id="6b7ac-113">Description</span><span class="sxs-lookup"><span data-stu-id="6b7ac-113">Description</span></span> |
| ------ | ----------- |
| <span data-ttu-id="6b7ac-114">X transmis pour</span><span class="sxs-lookup"><span data-stu-id="6b7ac-114">X-Forwarded-For</span></span> | <span data-ttu-id="6b7ac-115">Contient des informations sur le client qui a initié la demande et les proxys suivantes dans une chaîne de proxys.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-115">Holds information about the client that initiated the request and subsequent proxies in a chain of proxies.</span></span> <span data-ttu-id="6b7ac-116">Ce paramètre peut contenir IP adresses (et, éventuellement, les numéros de port).</span><span class="sxs-lookup"><span data-stu-id="6b7ac-116">This parameter may contain IP addresses (and, optionally, port numbers).</span></span> <span data-ttu-id="6b7ac-117">Dans une chaîne de serveurs proxy, le premier paramètre indique le client sur lequel la demande a été effectuée pour la première fois.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-117">In a chain of proxy servers, the first parameter indicates the client where the request was first made.</span></span> <span data-ttu-id="6b7ac-118">Les identificateurs suivants proxy suivre.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-118">Subsequent proxy identifiers follow.</span></span> <span data-ttu-id="6b7ac-119">Le proxy du dernier dans la chaîne n’est pas dans la liste des paramètres.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-119">The last proxy in the chain isn't in the list of parameters.</span></span> <span data-ttu-id="6b7ac-120">Adresse IP du proxy de la dernière et éventuellement un numéro de port sont disponibles en tant que l’adresse IP distante au niveau de la couche de transport.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-120">The last proxy's IP address, and optionally a port number, are available as the remote IP address at the transport layer.</span></span> |
| <span data-ttu-id="6b7ac-121">Proto transféré X</span><span class="sxs-lookup"><span data-stu-id="6b7ac-121">X-Forwarded-Proto</span></span> | <span data-ttu-id="6b7ac-122">La valeur de la méthode d’origine (HTTP/HTTPS).</span><span class="sxs-lookup"><span data-stu-id="6b7ac-122">The value of the originating scheme (HTTP/HTTPS).</span></span> <span data-ttu-id="6b7ac-123">La valeur peut également être une liste de jeux si la demande a parcouru plusieurs serveurs proxy.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-123">The value may also be a list of schemes if the request has traversed multiple proxies.</span></span> |
| <span data-ttu-id="6b7ac-124">Hôte X transmis</span><span class="sxs-lookup"><span data-stu-id="6b7ac-124">X-Forwarded-Host</span></span> | <span data-ttu-id="6b7ac-125">La valeur d’origine du champ d’en-tête hôte.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-125">The original value of the Host header field.</span></span> <span data-ttu-id="6b7ac-126">En règle générale, proxys ne modifiez pas l’en-tête d’hôte.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-126">Usually, proxies don't modify the Host header.</span></span> <span data-ttu-id="6b7ac-127">Consultez [Microsoft Security Advisory CVE-2018-0787](https://github.com/aspnet/Announcements/issues/295) pour plus d’informations sur une vulnérabilité d’élévation de privilèges qui affecte les systèmes où le proxy ne valide pas ou les en-têtes d’hôtes restict aux valeurs corrects connus.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-127">See [Microsoft Security Advisory CVE-2018-0787](https://github.com/aspnet/Announcements/issues/295) for information on an elevation-of-privileges vulnerability that affects systems where the proxy doesn't validate or restict Host headers to known good values.</span></span> |

<span data-ttu-id="6b7ac-128">L’intergiciel en-têtes transférés, à partir de la [Microsoft.AspNetCore.HttpOverrides](https://www.nuget.org/packages/Microsoft.AspNetCore.HttpOverrides/) du package, lit ces en-têtes et renseigne les champs associés sur [HttpContext](/dotnet/api/microsoft.aspnetcore.http.httpcontext).</span><span class="sxs-lookup"><span data-stu-id="6b7ac-128">The Forwarded Headers Middleware, from the [Microsoft.AspNetCore.HttpOverrides](https://www.nuget.org/packages/Microsoft.AspNetCore.HttpOverrides/) package, reads these headers and fills in the associated fields on [HttpContext](/dotnet/api/microsoft.aspnetcore.http.httpcontext).</span></span> 

<span data-ttu-id="6b7ac-129">Les mises à jour de l’intergiciel (middleware) :</span><span class="sxs-lookup"><span data-stu-id="6b7ac-129">The middleware updates:</span></span>

* <span data-ttu-id="6b7ac-130">[HttpContext.Connection.RemoteIpAddress](/dotnet/api/microsoft.aspnetcore.http.connectioninfo.remoteipaddress) &ndash; à l’aide de la `X-Forwarded-For` valeur d’en-tête.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-130">[HttpContext.Connection.RemoteIpAddress](/dotnet/api/microsoft.aspnetcore.http.connectioninfo.remoteipaddress) &ndash; Set using the `X-Forwarded-For` header value.</span></span> <span data-ttu-id="6b7ac-131">Comment l’intergiciel (middleware) définit les paramètres supplémentaires influencent `RemoteIpAddress`.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-131">Additional settings influence how the middleware sets `RemoteIpAddress`.</span></span> <span data-ttu-id="6b7ac-132">Pour plus d’informations, consultez la [transféré intergiciel (middleware) en-têtes options](#forwarded-headers-middleware-options).</span><span class="sxs-lookup"><span data-stu-id="6b7ac-132">For details, see the [Forwarded Headers Middleware options](#forwarded-headers-middleware-options).</span></span>
* <span data-ttu-id="6b7ac-133">[HttpContext.Request.Scheme](/dotnet/api/microsoft.aspnetcore.http.httprequest.scheme) &ndash; à l’aide de la `X-Forwarded-Proto` valeur d’en-tête.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-133">[HttpContext.Request.Scheme](/dotnet/api/microsoft.aspnetcore.http.httprequest.scheme) &ndash; Set using the `X-Forwarded-Proto` header value.</span></span>
* <span data-ttu-id="6b7ac-134">[HttpContext.Request.Host](/dotnet/api/microsoft.aspnetcore.http.httprequest.host) &ndash; à l’aide de la `X-Forwarded-Host` valeur d’en-tête.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-134">[HttpContext.Request.Host](/dotnet/api/microsoft.aspnetcore.http.httprequest.host) &ndash; Set using the `X-Forwarded-Host` header value.</span></span>

<span data-ttu-id="6b7ac-135">Notez que pas tous les dispositifs réseau ajouter la `X-Forwarded-For` et `X-Forwarded-Proto` en-têtes sans configuration supplémentaire.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-135">Note that not all network appliances add the `X-Forwarded-For` and `X-Forwarded-Proto` headers without additional configuration.</span></span> <span data-ttu-id="6b7ac-136">Consultez les instructions du fabricant de votre matériel si les demandes traitées ne contiennent pas ces en-têtes lorsqu’ils atteignent l’application.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-136">Consult your appliance manufacturer's guidance if the proxied requests don't contain these headers when they reach the app.</span></span>

<span data-ttu-id="6b7ac-137">Transféré en-têtes intergiciel (middleware) [paramètres par défaut](#forwarded-headers-middleware-options) peuvent être configurés.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-137">Forwarded Headers Middleware [default settings](#forwarded-headers-middleware-options) can be configured.</span></span> <span data-ttu-id="6b7ac-138">Les paramètres par défaut sont :</span><span class="sxs-lookup"><span data-stu-id="6b7ac-138">The default settings are:</span></span>

* <span data-ttu-id="6b7ac-139">Il est uniquement *un proxy* entre l’application et la source des requêtes.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-139">There is only *one proxy* between the app and the source of the requests.</span></span>
* <span data-ttu-id="6b7ac-140">Seules les adresses de bouclage sont configurés pour proxys connus et connus de réseaux.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-140">Only loopback addresses are configured for known proxies and known networks.</span></span>

## <a name="iisiis-express-and-aspnet-core-module"></a><span data-ttu-id="6b7ac-141">IIS/IIS Express et Module ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="6b7ac-141">IIS/IIS Express and ASP.NET Core Module</span></span>

<span data-ttu-id="6b7ac-142">Transféré en-têtes intergiciel (middleware) est activé par défaut par un intergiciel (middleware) intégration de IIS lors de l’exécution de l’application IIS et le Module de base ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-142">Forwarded Headers Middleware is enabled by default by IIS Integration Middleware when the app is run behind IIS and the ASP.NET Core Module.</span></span> <span data-ttu-id="6b7ac-143">Transféré en-têtes intergiciel (middleware) est activée pour l’exécuter en premier dans le pipeline de l’intergiciel (middleware) avec une configuration limitée spécifique pour le Module de base ASP.NET en raison des problèmes d’approbation avec les en-têtes transférés (par exemple, [usurpation d’adresse IP](https://www.iplocation.net/ip-spoofing)).</span><span class="sxs-lookup"><span data-stu-id="6b7ac-143">Forwarded Headers Middleware is activated to run first in the middleware pipeline with a restricted configuration specific to the ASP.NET Core Module due to trust concerns with forwarded headers (for example, [IP spoofing](https://www.iplocation.net/ip-spoofing)).</span></span> <span data-ttu-id="6b7ac-144">L’intergiciel (middleware) est configuré pour transmettre le `X-Forwarded-For` et `X-Forwarded-Proto` en-têtes et est limitée à un serveur proxy unique localhost.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-144">The middleware is configured to forward the `X-Forwarded-For` and `X-Forwarded-Proto` headers and is restricted to a single localhost proxy.</span></span> <span data-ttu-id="6b7ac-145">Si une configuration supplémentaire est requise, consultez le [transféré intergiciel (middleware) en-têtes options](#forwarded-headers-middleware-options).</span><span class="sxs-lookup"><span data-stu-id="6b7ac-145">If additional configuration is required, see the [Forwarded Headers Middleware options](#forwarded-headers-middleware-options).</span></span>

## <a name="other-proxy-server-and-load-balancer-scenarios"></a><span data-ttu-id="6b7ac-146">Autres scénarios d’équilibrage de charge et du serveur proxy</span><span class="sxs-lookup"><span data-stu-id="6b7ac-146">Other proxy server and load balancer scenarios</span></span>

<span data-ttu-id="6b7ac-147">En dehors d’à l’aide d’intergiciel (middleware) intégration de IIS, transféré intergiciel (middleware) en-têtes n’est pas activé par défaut.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-147">Outside of using IIS Integration Middleware, Forwarded Headers Middleware isn't enabled by default.</span></span> <span data-ttu-id="6b7ac-148">Transféré en-têtes intergiciel (middleware) doit être activé pour une application aux en-têtes de processus transmis avec [UseForwardedHeaders](/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersextensions.useforwardedheaders).</span><span class="sxs-lookup"><span data-stu-id="6b7ac-148">Forwarded Headers Middleware must be enabled for an app to process forwarded headers with [UseForwardedHeaders](/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersextensions.useforwardedheaders).</span></span> <span data-ttu-id="6b7ac-149">Après l’activation de l’intergiciel (middleware) si aucun [ForwardedHeadersOptions](/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersoptions) sont spécifiés à l’intergiciel (middleware), la valeur par défaut [ForwardedHeadersOptions.ForwardedHeaders](/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersoptions.forwardedheaders) sont [ForwardedHeaders.None ](/dotnet/api/microsoft.aspnetcore.httpoverrides.forwardedheaders).</span><span class="sxs-lookup"><span data-stu-id="6b7ac-149">After enabling the middleware if no [ForwardedHeadersOptions](/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersoptions) are specified to the middleware, the default [ForwardedHeadersOptions.ForwardedHeaders](/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersoptions.forwardedheaders) are [ForwardedHeaders.None](/dotnet/api/microsoft.aspnetcore.httpoverrides.forwardedheaders).</span></span>

<span data-ttu-id="6b7ac-150">Configurer l’intergiciel (middleware) avec [ForwardedHeadersOptions](/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersoptions) pour transférer le `X-Forwarded-For` et `X-Forwarded-Proto` en-têtes dans `Startup.ConfigureServices`.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-150">Configure the middleware with [ForwardedHeadersOptions](/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersoptions) to forward the `X-Forwarded-For` and `X-Forwarded-Proto` headers in `Startup.ConfigureServices`.</span></span> <span data-ttu-id="6b7ac-151">Appeler le [UseForwardedHeaders](/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersextensions.useforwardedheaders) méthode `Startup.Configure` avant d’appeler d’autres intergiciel (middleware) :</span><span class="sxs-lookup"><span data-stu-id="6b7ac-151">Invoke the [UseForwardedHeaders](/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersextensions.useforwardedheaders) method in `Startup.Configure` before calling other middleware:</span></span>

```csharp
public void ConfigureServices(IServiceCollection services)
{
    services.AddMvc();
    
    services.Configure<ForwardedHeadersOptions>(options =>
    {
        options.ForwardedHeaders = 
            ForwardedHeaders.XForwardedFor | ForwardedHeaders.XForwardedProto;
    });
}

public void Configure(IApplicationBuilder app, IHostingEnvironment env)
{
    app.UseForwardedHeaders();

    if (env.IsDevelopment())
    {
        app.UseDeveloperExceptionPage();
    }
    else
    {
        app.UseExceptionHandler("/Home/Error");
    }

    app.UseStaticFiles();
    // In ASP.NET Core 1.x, replace the following line with: app.UseIdentity();
    app.UseAuthentication();
    app.UseMvc();
}
```

> [!NOTE]
> <span data-ttu-id="6b7ac-152">Si aucun [ForwardedHeadersOptions](/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersoptions) sont spécifiés dans `Startup.ConfigureServices` ou directement à la méthode d’extension avec [UseForwardedHeaders (IApplicationBuilder, ForwardedHeadersOptions)](/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersextensions.useforwardedheaders?view=aspnetcore-2.0#Microsoft_AspNetCore_Builder_ForwardedHeadersExtensions_UseForwardedHeaders_Microsoft_AspNetCore_Builder_IApplicationBuilder_Microsoft_AspNetCore_Builder_ForwardedHeadersOptions_), la valeur par défaut pour transférer les en-têtes sont [ForwardedHeaders.None](/dotnet/api/microsoft.aspnetcore.httpoverrides.forwardedheaders).</span><span class="sxs-lookup"><span data-stu-id="6b7ac-152">If no [ForwardedHeadersOptions](/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersoptions) are specified in `Startup.ConfigureServices` or directly to the extension method with [UseForwardedHeaders(IApplicationBuilder, ForwardedHeadersOptions)](/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersextensions.useforwardedheaders?view=aspnetcore-2.0#Microsoft_AspNetCore_Builder_ForwardedHeadersExtensions_UseForwardedHeaders_Microsoft_AspNetCore_Builder_IApplicationBuilder_Microsoft_AspNetCore_Builder_ForwardedHeadersOptions_), the default headers to forward are [ForwardedHeaders.None](/dotnet/api/microsoft.aspnetcore.httpoverrides.forwardedheaders).</span></span> <span data-ttu-id="6b7ac-153">Le [ForwardedHeadersOptions.ForwardedHeaders](/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersoptions.forwardedheaders) propriété doit être configurée avec les en-têtes à transférer.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-153">The [ForwardedHeadersOptions.ForwardedHeaders](/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersoptions.forwardedheaders) property must be configured with the headers to forward.</span></span>

## <a name="forwarded-headers-middleware-options"></a><span data-ttu-id="6b7ac-154">Options d’en-têtes intergiciel (middleware) transmises</span><span class="sxs-lookup"><span data-stu-id="6b7ac-154">Forwarded Headers Middleware options</span></span>

<span data-ttu-id="6b7ac-155">[ForwardedHeadersOptions](/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersoptions) contrôler le comportement de l’intergiciel (middleware) en-têtes transféré :</span><span class="sxs-lookup"><span data-stu-id="6b7ac-155">[ForwardedHeadersOptions](/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersoptions) control the behavior of the Forwarded Headers Middleware:</span></span>

```csharp
services.Configure<ForwardedHeadersOptions>(options =>
{
    options.ForwardLimit = 2;
    options.KnownProxies.Add(IPAddress.Parse("127.0.10.1"));
    options.ForwardedForHeaderName = "X-Forwarded-For-Custom-Header-Name";
});
```

| <span data-ttu-id="6b7ac-156">Option</span><span class="sxs-lookup"><span data-stu-id="6b7ac-156">Option</span></span> | <span data-ttu-id="6b7ac-157">Description</span><span class="sxs-lookup"><span data-stu-id="6b7ac-157">Description</span></span> |
| ------ | ----------- |
| [<span data-ttu-id="6b7ac-158">ForwardedForHeaderName</span><span class="sxs-lookup"><span data-stu-id="6b7ac-158">ForwardedForHeaderName</span></span>](/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersoptions.forwardedforheadername) | <span data-ttu-id="6b7ac-159">Utiliser l’en-tête spécifié par cette propriété à la place de celui spécifié par [ForwardedHeadersDefaults.XForwardedForHeaderName](/dotnet/api/microsoft.aspnetcore.httpoverrides.forwardedheadersdefaults.xforwardedforheadername).</span><span class="sxs-lookup"><span data-stu-id="6b7ac-159">Use the header specified by this property instead of the one specified by [ForwardedHeadersDefaults.XForwardedForHeaderName](/dotnet/api/microsoft.aspnetcore.httpoverrides.forwardedheadersdefaults.xforwardedforheadername).</span></span><br><br><span data-ttu-id="6b7ac-160">La valeur par défaut est `X-Forwarded-For`.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-160">The default is `X-Forwarded-For`.</span></span> |
| [<span data-ttu-id="6b7ac-161">ForwardedHeaders</span><span class="sxs-lookup"><span data-stu-id="6b7ac-161">ForwardedHeaders</span></span>](/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersoptions.forwardedheaders) | <span data-ttu-id="6b7ac-162">Identifie les redirecteurs doivent être traités.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-162">Identifies which forwarders should be processed.</span></span> <span data-ttu-id="6b7ac-163">Consultez le [ForwardedHeaders Enum](/dotnet/api/microsoft.aspnetcore.httpoverrides.forwardedheaders) pour obtenir la liste des champs qui s’appliquent.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-163">See the [ForwardedHeaders Enum](/dotnet/api/microsoft.aspnetcore.httpoverrides.forwardedheaders) for the list of fields that apply.</span></span> <span data-ttu-id="6b7ac-164">Les valeurs par défaut affectés à cette propriété sont <code>ForwardedHeaders.XForwardedFor &#124; ForwardedHeaders.XForwardedProto</code>.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-164">Typical values assigned to this property are <code>ForwardedHeaders.XForwardedFor &#124; ForwardedHeaders.XForwardedProto</code>.</span></span><br><br><span data-ttu-id="6b7ac-165">La valeur par défaut est [ForwardedHeaders.None](/dotnet/api/microsoft.aspnetcore.httpoverrides.forwardedheaders).</span><span class="sxs-lookup"><span data-stu-id="6b7ac-165">The default value is [ForwardedHeaders.None](/dotnet/api/microsoft.aspnetcore.httpoverrides.forwardedheaders).</span></span> |
| [<span data-ttu-id="6b7ac-166">ForwardedHostHeaderName</span><span class="sxs-lookup"><span data-stu-id="6b7ac-166">ForwardedHostHeaderName</span></span>](/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersoptions.forwardedhostheadername) | <span data-ttu-id="6b7ac-167">Utiliser l’en-tête spécifié par cette propriété à la place de celui spécifié par [ForwardedHeadersDefaults.XForwardedHostHeaderName](/dotnet/api/microsoft.aspnetcore.httpoverrides.forwardedheadersdefaults.xforwardedhostheadername).</span><span class="sxs-lookup"><span data-stu-id="6b7ac-167">Use the header specified by this property instead of the one specified by [ForwardedHeadersDefaults.XForwardedHostHeaderName](/dotnet/api/microsoft.aspnetcore.httpoverrides.forwardedheadersdefaults.xforwardedhostheadername).</span></span><br><br><span data-ttu-id="6b7ac-168">La valeur par défaut est `X-Forwarded-Host`.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-168">The default is `X-Forwarded-Host`.</span></span> |
| [<span data-ttu-id="6b7ac-169">ForwardedProtoHeaderName</span><span class="sxs-lookup"><span data-stu-id="6b7ac-169">ForwardedProtoHeaderName</span></span>](/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersoptions.forwardedprotoheadername) | <span data-ttu-id="6b7ac-170">Utiliser l’en-tête spécifié par cette propriété à la place de celui spécifié par [ForwardedHeadersDefaults.XForwardedProtoHeaderName](/dotnet/api/microsoft.aspnetcore.httpoverrides.forwardedheadersdefaults.xforwardedprotoheadername).</span><span class="sxs-lookup"><span data-stu-id="6b7ac-170">Use the header specified by this property instead of the one specified by [ForwardedHeadersDefaults.XForwardedProtoHeaderName](/dotnet/api/microsoft.aspnetcore.httpoverrides.forwardedheadersdefaults.xforwardedprotoheadername).</span></span><br><br><span data-ttu-id="6b7ac-171">La valeur par défaut est `X-Forwarded-Proto`.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-171">The default is `X-Forwarded-Proto`.</span></span> |
| [<span data-ttu-id="6b7ac-172">ForwardLimit</span><span class="sxs-lookup"><span data-stu-id="6b7ac-172">ForwardLimit</span></span>](/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersoptions.forwardlimit) | <span data-ttu-id="6b7ac-173">Limite le nombre d’entrées dans les en-têtes qui sont traités.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-173">Limits the number of entries in the headers that are processed.</span></span> <span data-ttu-id="6b7ac-174">La valeur `null` pour désactiver la limite, mais cela ne doit être effectuée si `KnownProxies` ou `KnownNetworks` sont configurés.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-174">Set to `null` to disable the limit, but this should only be done if `KnownProxies` or `KnownNetworks` are configured.</span></span><br><br><span data-ttu-id="6b7ac-175">La valeur par défaut est 1.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-175">The default is 1.</span></span> |
| [<span data-ttu-id="6b7ac-176">KnownNetworks</span><span class="sxs-lookup"><span data-stu-id="6b7ac-176">KnownNetworks</span></span>](/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersoptions.knownnetworks) | <span data-ttu-id="6b7ac-177">Plages de proxys connus pour accepter les en-têtes transférés à partir d’adresses.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-177">Address ranges of known proxies to accept forwarded headers from.</span></span> <span data-ttu-id="6b7ac-178">Fournir des plages IP à l’aide de la notation de routage inter-domaines sans classe (CIDR).</span><span class="sxs-lookup"><span data-stu-id="6b7ac-178">Provide IP ranges using Classless Interdomain Routing (CIDR) notation.</span></span><br><br><span data-ttu-id="6b7ac-179">La valeur par défaut est une [IList](/dotnet/api/system.collections.generic.ilist-1)\<[réseau IP](/dotnet/api/microsoft.aspnetcore.httpoverrides.ipnetwork)> contenant une seule entrée pour `IPAddress.Loopback`.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-179">The default is an [IList](/dotnet/api/system.collections.generic.ilist-1)\<[IPNetwork](/dotnet/api/microsoft.aspnetcore.httpoverrides.ipnetwork)> containing a single entry for `IPAddress.Loopback`.</span></span> |
| [<span data-ttu-id="6b7ac-180">KnownProxies</span><span class="sxs-lookup"><span data-stu-id="6b7ac-180">KnownProxies</span></span>](/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersoptions.knownproxies) | <span data-ttu-id="6b7ac-181">Adresses de proxy connus pour accepter les en-têtes transférés à partir de.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-181">Addresses of known proxies to accept forwarded headers from.</span></span> <span data-ttu-id="6b7ac-182">Utilisez `KnownProxies` pour spécifier l’adresse IP exacte des correspondances.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-182">Use `KnownProxies` to specify exact IP address matches.</span></span><br><br><span data-ttu-id="6b7ac-183">La valeur par défaut est une [IList](/dotnet/api/system.collections.generic.ilist-1)\<[IPAddress](/dotnet/api/system.net.ipaddress)> contenant une seule entrée pour `IPAddress.IPv6Loopback`.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-183">The default is an [IList](/dotnet/api/system.collections.generic.ilist-1)\<[IPAddress](/dotnet/api/system.net.ipaddress)> containing a single entry for `IPAddress.IPv6Loopback`.</span></span> |
| [<span data-ttu-id="6b7ac-184">OriginalForHeaderName</span><span class="sxs-lookup"><span data-stu-id="6b7ac-184">OriginalForHeaderName</span></span>](/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersoptions.originalforheadername) | <span data-ttu-id="6b7ac-185">Utiliser l’en-tête spécifié par cette propriété à la place de celui spécifié par [ForwardedHeadersDefaults.XOriginalForHeaderName](/dotnet/api/microsoft.aspnetcore.httpoverrides.forwardedheadersdefaults.xoriginalforheadername).</span><span class="sxs-lookup"><span data-stu-id="6b7ac-185">Use the header specified by this property instead of the one specified by [ForwardedHeadersDefaults.XOriginalForHeaderName](/dotnet/api/microsoft.aspnetcore.httpoverrides.forwardedheadersdefaults.xoriginalforheadername).</span></span><br><br><span data-ttu-id="6b7ac-186">La valeur par défaut est `X-Original-For`.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-186">The default is `X-Original-For`.</span></span> |
| [<span data-ttu-id="6b7ac-187">OriginalHostHeaderName</span><span class="sxs-lookup"><span data-stu-id="6b7ac-187">OriginalHostHeaderName</span></span>](/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersoptions.originalhostheadername) | <span data-ttu-id="6b7ac-188">Utiliser l’en-tête spécifié par cette propriété à la place de celui spécifié par [ForwardedHeadersDefaults.XOriginalHostHeaderName](/dotnet/api/microsoft.aspnetcore.httpoverrides.forwardedheadersdefaults.xoriginalhostheadername).</span><span class="sxs-lookup"><span data-stu-id="6b7ac-188">Use the header specified by this property instead of the one specified by [ForwardedHeadersDefaults.XOriginalHostHeaderName](/dotnet/api/microsoft.aspnetcore.httpoverrides.forwardedheadersdefaults.xoriginalhostheadername).</span></span><br><br><span data-ttu-id="6b7ac-189">La valeur par défaut est `X-Original-Host`.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-189">The default is `X-Original-Host`.</span></span> |
| [<span data-ttu-id="6b7ac-190">OriginalProtoHeaderName</span><span class="sxs-lookup"><span data-stu-id="6b7ac-190">OriginalProtoHeaderName</span></span>](/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersoptions.originalprotoheadername) | <span data-ttu-id="6b7ac-191">Utiliser l’en-tête spécifié par cette propriété à la place de celui spécifié par [ForwardedHeadersDefaults.XOriginalProtoHeaderName](/dotnet/api/microsoft.aspnetcore.httpoverrides.forwardedheadersdefaults.xoriginalprotoheadername).</span><span class="sxs-lookup"><span data-stu-id="6b7ac-191">Use the header specified by this property instead of the one specified by [ForwardedHeadersDefaults.XOriginalProtoHeaderName](/dotnet/api/microsoft.aspnetcore.httpoverrides.forwardedheadersdefaults.xoriginalprotoheadername).</span></span><br><br><span data-ttu-id="6b7ac-192">La valeur par défaut est `X-Original-Proto`.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-192">The default is `X-Original-Proto`.</span></span> |
| [<span data-ttu-id="6b7ac-193">RequireHeaderSymmetry</span><span class="sxs-lookup"><span data-stu-id="6b7ac-193">RequireHeaderSymmetry</span></span>](/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersoptions.requireheadersymmetry) | <span data-ttu-id="6b7ac-194">Nécessitent le nombre de valeurs d’en-tête à une synchronisation entre le [ForwardedHeadersOptions.ForwardedHeaders](/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersoptions.forwardedheaders) en cours de traitement.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-194">Require the number of header values to be in sync between the [ForwardedHeadersOptions.ForwardedHeaders](/dotnet/api/microsoft.aspnetcore.builder.forwardedheadersoptions.forwardedheaders) being processed.</span></span><br><br><span data-ttu-id="6b7ac-195">La valeur par défaut dans ASP.NET Core 1.x est `true`.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-195">The default in ASP.NET Core 1.x is `true`.</span></span> <span data-ttu-id="6b7ac-196">La valeur par défaut dans ASP.NET Core 2.0 ou version ultérieure est `false`.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-196">The default in ASP.NET Core 2.0 or later is `false`.</span></span> |

## <a name="scenarios-and-use-cases"></a><span data-ttu-id="6b7ac-197">Scénarios et cas d’usage</span><span class="sxs-lookup"><span data-stu-id="6b7ac-197">Scenarios and use cases</span></span>

### <a name="when-it-isnt-possible-to-add-forwarded-headers-and-all-requests-are-secure"></a><span data-ttu-id="6b7ac-198">Lorsqu’il n’est pas possible d’ajouter transféré les en-têtes et toutes les demandes sont sécurisées</span><span class="sxs-lookup"><span data-stu-id="6b7ac-198">When it isn't possible to add forwarded headers and all requests are secure</span></span>

<span data-ttu-id="6b7ac-199">Dans certains cas, il ne peut pas être possible d’ajouter des en-têtes transférés aux requêtes traitées à l’application.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-199">In some cases, it might not be possible to add forwarded headers to the requests proxied to the app.</span></span> <span data-ttu-id="6b7ac-200">Si le proxy en œuvre que toutes les demandes externes publiques sont de type HTTPS, le modèle peut être défini manuellement `Startup.Configure` avant d’utiliser n’importe quel type d’intergiciel (middleware) :</span><span class="sxs-lookup"><span data-stu-id="6b7ac-200">If the proxy is enforcing that all public external requests are HTTPS, the scheme can be manually set in `Startup.Configure` before using any type of middleware:</span></span>

```csharp
app.Use((context, next) =>
{
    context.Request.Scheme = "https";
    return next();
});
```

<span data-ttu-id="6b7ac-201">Ce code peut être désactivé avec une variable d’environnement ou un autre paramètre de configuration dans un environnement intermédiaire ou de développement.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-201">This code can be disabled with an environment variable or other configuration setting in a development or staging environment.</span></span>

### <a name="deal-with-path-base-and-proxies-that-change-the-request-path"></a><span data-ttu-id="6b7ac-202">Traitent de chemin d’accès de base et les proxys de modifier le chemin d’accès de la demande</span><span class="sxs-lookup"><span data-stu-id="6b7ac-202">Deal with path base and proxies that change the request path</span></span>

<span data-ttu-id="6b7ac-203">Certains proxys passer le chemin d’accès intact, mais avec une application chemin d’accès de base qui doit être supprimée pour que le routage fonctionne correctement.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-203">Some proxies pass the path intact but with an app base path that should be removed so that routing works properly.</span></span> <span data-ttu-id="6b7ac-204">[UsePathBaseExtensions.UsePathBase](/dotnet/api/microsoft.aspnetcore.builder.usepathbaseextensions.usepathbase) intergiciel (middleware) fractionne le chemin d’accès dans [HttpRequest.Path](/dotnet/api/microsoft.aspnetcore.http.httprequest.path) et le chemin de base d’application dans [HttpRequest.PathBase](/dotnet/api/microsoft.aspnetcore.http.httprequest.pathbase).</span><span class="sxs-lookup"><span data-stu-id="6b7ac-204">[UsePathBaseExtensions.UsePathBase](/dotnet/api/microsoft.aspnetcore.builder.usepathbaseextensions.usepathbase) middleware splits the path into [HttpRequest.Path](/dotnet/api/microsoft.aspnetcore.http.httprequest.path) and the app base path into [HttpRequest.PathBase](/dotnet/api/microsoft.aspnetcore.http.httprequest.pathbase).</span></span>

<span data-ttu-id="6b7ac-205">Si `/foo` est le chemin de base d’application pour un chemin d’accès au proxy passée en tant que `/foo/api/1`, les jeux d’intergiciel (middleware) `Request.PathBase` à `/foo` et `Request.Path` à `/api/1` avec la commande suivante :</span><span class="sxs-lookup"><span data-stu-id="6b7ac-205">If `/foo` is the app base path for a proxy path passed as `/foo/api/1`, the middleware sets `Request.PathBase` to `/foo` and `Request.Path` to `/api/1` with the following command:</span></span>

```csharp
app.UsePathBase("/foo");
```

<span data-ttu-id="6b7ac-206">Le chemin d’accès et le chemin d’accès de base d’origine sont réappliquées lors de l’intergiciel (middleware) est de nouveau appelée dans l’ordre inverse.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-206">The original path and path base are reapplied when the middleware is called again in reverse.</span></span> <span data-ttu-id="6b7ac-207">Pour plus d’informations sur le traitement des commandes intergiciel (middleware), consultez [intergiciel (middleware)](xref:fundamentals/middleware/index).</span><span class="sxs-lookup"><span data-stu-id="6b7ac-207">For more information on middleware order processing, see [Middleware](xref:fundamentals/middleware/index).</span></span>

<span data-ttu-id="6b7ac-208">Si le serveur proxy supprime le chemin d’accès (par exemple, transfert `/foo/api/1` à `/api/1`), correctif redirige et des liens en définissant la demande [PathBase](/dotnet/api/microsoft.aspnetcore.http.httprequest.pathbase) propriété :</span><span class="sxs-lookup"><span data-stu-id="6b7ac-208">If the proxy trims the path (for example, forwarding `/foo/api/1` to `/api/1`), fix redirects and links by setting the request's [PathBase](/dotnet/api/microsoft.aspnetcore.http.httprequest.pathbase) property:</span></span>

```csharp
app.Use((context, next) =>
{
    context.Request.PathBase = new PathString("/foo");
    return next();
});
```

<span data-ttu-id="6b7ac-209">Si le proxy ajoute des données de chemin d’accès, ignorer la partie du chemin d’accès à la résolution des redirections et les liens à l’aide de [StartsWithSegments (PathString, PathString)](/dotnet/api/microsoft.aspnetcore.http.pathstring.startswithsegments#Microsoft_AspNetCore_Http_PathString_StartsWithSegments_Microsoft_AspNetCore_Http_PathString_Microsoft_AspNetCore_Http_PathString__) et en attribuant à la [chemin d’accès](/dotnet/api/microsoft.aspnetcore.http.httprequest.path) propriété :</span><span class="sxs-lookup"><span data-stu-id="6b7ac-209">If the proxy is adding path data, discard part of the path to fix redirects and links by using [StartsWithSegments(PathString, PathString)](/dotnet/api/microsoft.aspnetcore.http.pathstring.startswithsegments#Microsoft_AspNetCore_Http_PathString_StartsWithSegments_Microsoft_AspNetCore_Http_PathString_Microsoft_AspNetCore_Http_PathString__) and assigning to the [Path](/dotnet/api/microsoft.aspnetcore.http.httprequest.path) property:</span></span>

```csharp
app.Use((context, next) =>
{
    if (context.Request.Path.StartsWithSegments("/foo", out var remainder))
    {
        context.Request.Path = remainder;
    }

    return next();
});
```

## <a name="troubleshoot"></a><span data-ttu-id="6b7ac-210">Résoudre les problèmes</span><span class="sxs-lookup"><span data-stu-id="6b7ac-210">Troubleshoot</span></span>

<span data-ttu-id="6b7ac-211">Lorsque les en-têtes ne sont pas transférés comme prévu, activer [journalisation](xref:fundamentals/logging/index).</span><span class="sxs-lookup"><span data-stu-id="6b7ac-211">When headers aren't forwarded as expected, enable [logging](xref:fundamentals/logging/index).</span></span> <span data-ttu-id="6b7ac-212">Si les journaux ne fournissent pas d’informations suffisantes pour résoudre le problème, permet d’énumérer les en-têtes de demande reçus par le serveur.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-212">If the logs don't provide sufficient information to troubleshoot the problem, enumerate the request headers received by the server.</span></span> <span data-ttu-id="6b7ac-213">Les en-têtes peuvent être écrites dans une réponse de l’application à l’aide d’intergiciel (middleware) inline :</span><span class="sxs-lookup"><span data-stu-id="6b7ac-213">The headers can be written to an app response using inline middleware:</span></span>

```csharp
public void Configure(IApplicationBuilder app, ILoggerFactory loggerfactory)
{
    app.Run(async (context) =>
    {
        context.Response.ContentType = "text/plain";

        // Request method, scheme, and path
        await context.Response.WriteAsync(
            $"Request Method: {context.Request.Method}{Environment.NewLine}");
        await context.Response.WriteAsync(
            $"Request Scheme: {context.Request.Scheme}{Environment.NewLine}");
        await context.Response.WriteAsync(
            $"Request Path: {context.Request.Path}{Environment.NewLine}");

        // Headers
        await context.Response.WriteAsync($"Request Headers:{Environment.NewLine}");

        foreach (var header in context.Request.Headers)
        {
            await context.Response.WriteAsync($"{header.Key}: " +
                $"{header.Value}{Environment.NewLine}");
        }

        await context.Response.WriteAsync(Environment.NewLine);

        // Connection: RemoteIp
        await context.Response.WriteAsync(
            $"Request RemoteIp: {context.Connection.RemoteIpAddress}");
    }
}
```

<span data-ttu-id="6b7ac-214">Vérifiez que le X - transféré-\* en-têtes sont reçus par le serveur avec les valeurs attendues.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-214">Ensure that the X-Forwarded-\* headers are received by the server with the expected values.</span></span> <span data-ttu-id="6b7ac-215">S’il existe plusieurs valeurs dans un en-tête donné, notez l’intergiciel (middleware) de transféré en-têtes des en-têtes de processus dans l’ordre inverse de droite à gauche.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-215">If there are multiple values in a given header, note Forwarded Headers Middleware processes headers in reverse order from right to left.</span></span>

<span data-ttu-id="6b7ac-216">Adresse IP distante d’origine à la demande doit correspondre à une entrée dans le `KnownProxies` ou `KnownNetworks` répertorie avant X transmis pour le traitement.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-216">The request's original remote IP must match an entry in the `KnownProxies` or `KnownNetworks` lists before X-Forwarded-For is processed.</span></span> <span data-ttu-id="6b7ac-217">Cela limite l’usurpation d’identité d’en-tête en n’acceptant ne pas de redirecteurs de proxys non approuvés.</span><span class="sxs-lookup"><span data-stu-id="6b7ac-217">This limits header spoofing by not accepting forwarders from untrusted proxies.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="6b7ac-218">Ressources supplémentaires</span><span class="sxs-lookup"><span data-stu-id="6b7ac-218">Additional resources</span></span>

* [<span data-ttu-id="6b7ac-219">Microsoft Security Advisory CVE-2018-0787 : ASP.NET Core vulnérabilité d’élévation de privilèges</span><span class="sxs-lookup"><span data-stu-id="6b7ac-219">Microsoft Security Advisory CVE-2018-0787: ASP.NET Core Elevation Of Privilege Vulnerability</span></span>](https://github.com/aspnet/Announcements/issues/295)
