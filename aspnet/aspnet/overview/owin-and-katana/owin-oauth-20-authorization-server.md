---
uid: aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server
title: Serveur de d’autorisation OAuth 2.0 OWIN | Documents Microsoft
author: hongyes
description: Ce didacticiel vous guide sur l’implémentation d’un serveur d’autorisation OAuth 2.0 à l’aide d’intergiciel (middleware) OWIN OAuth. Ceci est un didacticiel avancé que seule Group...
ms.author: aspnetcontent
manager: wpickett
ms.date: 03/20/2014
ms.topic: article
ms.assetid: 20acee16-c70c-41e9-b38f-92bfcf9a4c1c
ms.technology: ''
ms.prod: .net-framework
msc.legacyurl: /aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server
msc.type: authoredcontent
ms.openlocfilehash: e5968f8d19191c3f44e9bd58f8e22a39d8d8faff
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 04/06/2018
ms.locfileid: "30876551"
---
<a name="owin-oauth-20-authorization-server"></a><span data-ttu-id="b023d-104">Serveur de d’autorisation OAuth 2.0 OWIN</span><span class="sxs-lookup"><span data-stu-id="b023d-104">OWIN OAuth 2.0 Authorization Server</span></span>
====================
<span data-ttu-id="b023d-105">par [Hongye Sun](https://github.com/hongyes), [Praburaj Thiagarajan](https://github.com/Praburaj), [Rick Anderson](https://github.com/Rick-Anderson)</span><span class="sxs-lookup"><span data-stu-id="b023d-105">by [Hongye Sun](https://github.com/hongyes), [Praburaj Thiagarajan](https://github.com/Praburaj), [Rick Anderson](https://github.com/Rick-Anderson)</span></span>

> <span data-ttu-id="b023d-106">Ce didacticiel vous guide sur l’implémentation d’un serveur d’autorisation OAuth 2.0 à l’aide d’intergiciel (middleware) OWIN OAuth.</span><span class="sxs-lookup"><span data-stu-id="b023d-106">This tutorial will guide you on how to implement an OAuth 2.0 Authorization Server using OWIN OAuth middleware.</span></span> <span data-ttu-id="b023d-107">Il s’agit d’un didacticiel avancé qui ne présente les étapes pour créer un serveur d’autorisation de OWIN OAuth 2.0.</span><span class="sxs-lookup"><span data-stu-id="b023d-107">This is an advanced tutorial that only outlines the steps to create an OWIN OAuth 2.0 Authorization Server.</span></span> <span data-ttu-id="b023d-108">Ce n’est pas un didacticiel pas à pas.</span><span class="sxs-lookup"><span data-stu-id="b023d-108">This is not a step by step tutorial.</span></span> <span data-ttu-id="b023d-109">[Télécharger l’exemple de code](https://code.msdn.microsoft.com/OWIN-OAuth-20-Authorization-ba2b8783/file/114932/1/AuthorizationServer.zip).</span><span class="sxs-lookup"><span data-stu-id="b023d-109">[Download the sample code](https://code.msdn.microsoft.com/OWIN-OAuth-20-Authorization-ba2b8783/file/114932/1/AuthorizationServer.zip).</span></span>
> 
> > [!NOTE]
> > <span data-ttu-id="b023d-110">Ce contour ne doit pas être destiné à être utilisée pour la création d’une application de production sécurisé.</span><span class="sxs-lookup"><span data-stu-id="b023d-110">This outline should not be intended to be used for creating a secure production app.</span></span> <span data-ttu-id="b023d-111">Ce didacticiel est destiné à fournir uniquement un plan sur l’implémentation d’un serveur d’autorisation OAuth 2.0 à l’aide d’intergiciel (middleware) OWIN OAuth.</span><span class="sxs-lookup"><span data-stu-id="b023d-111">This tutorial is intended to provide only an outline on how to implement an OAuth 2.0 Authorization Server using OWIN OAuth middleware.</span></span>
> 
> 
> ## <a name="software-versions"></a><span data-ttu-id="b023d-112">Versions du logiciel</span><span class="sxs-lookup"><span data-stu-id="b023d-112">Software versions</span></span>
> 
> | <span data-ttu-id="b023d-113">**Le didacticiel**</span><span class="sxs-lookup"><span data-stu-id="b023d-113">**Shown in the tutorial**</span></span> | <span data-ttu-id="b023d-114">**Fonctionne également avec**</span><span class="sxs-lookup"><span data-stu-id="b023d-114">**Also works with**</span></span> |
> | --- | --- |
> | <span data-ttu-id="b023d-115">Windows 8.1</span><span class="sxs-lookup"><span data-stu-id="b023d-115">Windows 8.1</span></span> | <span data-ttu-id="b023d-116">Windows 8, Windows 7</span><span class="sxs-lookup"><span data-stu-id="b023d-116">Windows 8, Windows 7</span></span> |
> | [<span data-ttu-id="b023d-117">Visual Studio 2013</span><span class="sxs-lookup"><span data-stu-id="b023d-117">Visual Studio 2013</span></span>](https://www.microsoft.com/visualstudio/eng/2013-downloads) | <span data-ttu-id="b023d-118">[Visual Studio 2013 Express pour Desktop](https://www.microsoft.com/visualstudio/eng/2013-downloads#d-2013-express).</span><span class="sxs-lookup"><span data-stu-id="b023d-118">[Visual Studio 2013 Express for Desktop](https://www.microsoft.com/visualstudio/eng/2013-downloads#d-2013-express).</span></span> <span data-ttu-id="b023d-119">Visual Studio 2012 avec la dernière mise à jour doit fonctionner, mais le didacticiel n’a pas été testé avec lui, et certaines boîtes de dialogue et les sélections de menu sont différentes.</span><span class="sxs-lookup"><span data-stu-id="b023d-119">Visual Studio 2012 with the latest update should work, but the tutorial has not been tested with it, and some menu selections and dialog boxes are different.</span></span> |
> | <span data-ttu-id="b023d-120">.NET 4.5</span><span class="sxs-lookup"><span data-stu-id="b023d-120">.NET 4.5</span></span> |  |
> 
> ## <a name="questions-and-comments"></a><span data-ttu-id="b023d-121">Questions et des commentaires</span><span class="sxs-lookup"><span data-stu-id="b023d-121">Questions and Comments</span></span>
> 
> <span data-ttu-id="b023d-122">Si vous avez des questions qui ne sont pas directement liées à ce didacticiel, vous pouvez les valider à [projet Katana sur GitHub](https://github.com/aspnet/AspNetKatana/).</span><span class="sxs-lookup"><span data-stu-id="b023d-122">If you have questions that are not directly related to the tutorial, you can post them at [Katana Project on GitHub](https://github.com/aspnet/AspNetKatana/).</span></span> <span data-ttu-id="b023d-123">Pour des questions et des commentaires concernant le didacticiel lui-même, consultez la section commentaires au bas de la page.</span><span class="sxs-lookup"><span data-stu-id="b023d-123">For questions and comments regarding the tutorial itself, see the comments section at the bottom of the page.</span></span>


<span data-ttu-id="b023d-124">Le [OAuth 2.0 framework](http://tools.ietf.org/html/rfc6749) permet à une application tierce obtenir un accès limité à un service HTTP.</span><span class="sxs-lookup"><span data-stu-id="b023d-124">The [OAuth 2.0 framework](http://tools.ietf.org/html/rfc6749) enables a third-party app to obtain limited access to an HTTP service.</span></span> <span data-ttu-id="b023d-125">Au lieu d’utiliser les informations d’identification du propriétaire de la ressource pour accéder à une ressource protégée, le client obtient un jeton d’accès (qui est une chaîne indiquant une étendue spécifique, durée de vie et d’autres attributs d’accès).</span><span class="sxs-lookup"><span data-stu-id="b023d-125">Instead of using the resource owner's credentials to access a protected resource, the client obtains an access token (which is a string denoting a specific scope, lifetime, and other access attributes).</span></span> <span data-ttu-id="b023d-126">Les jetons d’accès sont émis vers des clients tiers par un serveur d’autorisation avec l’approbation du propriétaire de la ressource.</span><span class="sxs-lookup"><span data-stu-id="b023d-126">Access tokens are issued to third-party clients by an authorization server with the approval of the resource owner.</span></span>

<span data-ttu-id="b023d-127">Ce didacticiel couvre :</span><span class="sxs-lookup"><span data-stu-id="b023d-127">This tutorial will cover:</span></span>

- <span data-ttu-id="b023d-128">Comment créer un serveur d’autorisation pour prendre en charge d’autorisation quatre types d’accès et jetons d’actualisation :</span><span class="sxs-lookup"><span data-stu-id="b023d-128">How to create an authorization server to support four authorization grant types and refresh tokens:</span></span>
    - <span data-ttu-id="b023d-129">Octroi d’un code d’autorisation</span><span class="sxs-lookup"><span data-stu-id="b023d-129">Authorization code grant</span></span>
    - <span data-ttu-id="b023d-130">Implicit Grant</span><span class="sxs-lookup"><span data-stu-id="b023d-130">Implicit Grant</span></span>
    - <span data-ttu-id="b023d-131">Informations d’identification de mot de passe de propriétaire de la ressource Grant</span><span class="sxs-lookup"><span data-stu-id="b023d-131">Resource Owner Password Credentials Grant</span></span>
    - <span data-ttu-id="b023d-132">Octroi des informations d’identification client</span><span class="sxs-lookup"><span data-stu-id="b023d-132">Client Credentials Grant</span></span>
- <span data-ttu-id="b023d-133">Création d’un serveur de ressources qui est protégé par un jeton d’accès.</span><span class="sxs-lookup"><span data-stu-id="b023d-133">Creating a resource server which is protected by an access token.</span></span>
- <span data-ttu-id="b023d-134">Création des clients OAuth 2.0.</span><span class="sxs-lookup"><span data-stu-id="b023d-134">Creating OAuth 2.0 clients.</span></span>

<a id="prerequisites"></a>
## <a name="prerequisites"></a><span data-ttu-id="b023d-135">Prérequis</span><span class="sxs-lookup"><span data-stu-id="b023d-135">Prerequisites</span></span>

- <span data-ttu-id="b023d-136">[Visual Studio 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-editions) ou gratuit [Visual Studio Express 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-express), comme indiqué dans **Versions logicielles** en haut de la page.</span><span class="sxs-lookup"><span data-stu-id="b023d-136">[Visual Studio 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-editions) or the free [Visual Studio Express 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-express), as indicated in **Software Versions** at the top of the page.</span></span>
- <span data-ttu-id="b023d-137">Vous êtes familiarisé avec OWIN.</span><span class="sxs-lookup"><span data-stu-id="b023d-137">Familiarity with OWIN.</span></span> <span data-ttu-id="b023d-138">Consultez [mise en route avec le projet Katana](https://msdn.microsoft.com/magazine/dn451439.aspx) et [Nouveautés OWIN et Katana](index.md).</span><span class="sxs-lookup"><span data-stu-id="b023d-138">See [Getting Started with the Katana Project](https://msdn.microsoft.com/magazine/dn451439.aspx) and [What's new in OWIN and Katana](index.md).</span></span>
- <span data-ttu-id="b023d-139">Vous êtes familiarisé avec [OAuth](http://tools.ietf.org/html/rfc6749) terminologie, y compris [rôles](http://tools.ietf.org/html/rfc6749#section-1.1), [flux du protocole](http://tools.ietf.org/html/rfc6749#section-1.2), et [octroi d’autorisation](http://tools.ietf.org/html/rfc6749#section-1.3).</span><span class="sxs-lookup"><span data-stu-id="b023d-139">Familiarity with [OAuth](http://tools.ietf.org/html/rfc6749) terminology, including [Roles](http://tools.ietf.org/html/rfc6749#section-1.1), [Protocol Flow](http://tools.ietf.org/html/rfc6749#section-1.2), and [Authorization Grant](http://tools.ietf.org/html/rfc6749#section-1.3).</span></span> <span data-ttu-id="b023d-140">[Présentation de OAuth 2.0](http://tools.ietf.org/html/rfc6749#section-1) constitue une bonne introduction.</span><span class="sxs-lookup"><span data-stu-id="b023d-140">[OAuth 2.0 introduction](http://tools.ietf.org/html/rfc6749#section-1) provides a good introduction.</span></span>

## <a name="create-an-authorization-server"></a><span data-ttu-id="b023d-141">Créer un serveur d’autorisation</span><span class="sxs-lookup"><span data-stu-id="b023d-141">Create an Authorization Server</span></span>

<span data-ttu-id="b023d-142">Dans ce didacticiel, nous sera esquisse à peu près comment utiliser [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) et ASP.NET MVC pour créer un serveur d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="b023d-142">In this tutorial, we will roughly sketch out how to use [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) and ASP.NET MVC to create an authorization server.</span></span> <span data-ttu-id="b023d-143">Nous espérons bientôt fournir un téléchargement de l’exemple terminée, comme ce didacticiel n’inclut pas de chaque étape.</span><span class="sxs-lookup"><span data-stu-id="b023d-143">We hope to soon provide a download for the completed sample, as this tutorial does not include each step.</span></span> <span data-ttu-id="b023d-144">Commencez par créer une application web vide nommée *AuthorizationServer* et installer les packages suivants :</span><span class="sxs-lookup"><span data-stu-id="b023d-144">First, create an empty web app named *AuthorizationServer* and install the following packages:</span></span>

- <span data-ttu-id="b023d-145">Microsoft.AspNet.Mvc</span><span class="sxs-lookup"><span data-stu-id="b023d-145">Microsoft.AspNet.Mvc</span></span>
- <span data-ttu-id="b023d-146">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="b023d-146">Microsoft.Owin.Host.SystemWeb</span></span>
- <span data-ttu-id="b023d-147">Microsoft.Owin.Security.OAuth</span><span class="sxs-lookup"><span data-stu-id="b023d-147">Microsoft.Owin.Security.OAuth</span></span>
- <span data-ttu-id="b023d-148">Microsoft.Owin.Security.Cookies</span><span class="sxs-lookup"><span data-stu-id="b023d-148">Microsoft.Owin.Security.Cookies</span></span>
- <span data-ttu-id="b023d-149">Microsoft.Owin.Security.Google (ou toute autre connexion sociale package tels que Microsoft.Owin.Security.Facebook)</span><span class="sxs-lookup"><span data-stu-id="b023d-149">Microsoft.Owin.Security.Google (Or any other social login package such as Microsoft.Owin.Security.Facebook)</span></span>

<span data-ttu-id="b023d-150">Ajouter un [classe de démarrage OWIN](owin-startup-class-detection.md) sous le dossier racine du projet nommé *démarrage*.</span><span class="sxs-lookup"><span data-stu-id="b023d-150">Add an [OWIN Startup class](owin-startup-class-detection.md) under the project root folder named *Startup*.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample1.cs?highlight=8)]

<span data-ttu-id="b023d-151">Créer un *application\_Démarrer* dossier.</span><span class="sxs-lookup"><span data-stu-id="b023d-151">Create an *App\_Start* folder.</span></span> <span data-ttu-id="b023d-152">Sélectionnez le *application\_Démarrer* dossier et utilisez Maj + Alt + A pour ajouter la version téléchargée de la *AuthorizationServer\App\_Start\Startup.Auth.cs* fichier.</span><span class="sxs-lookup"><span data-stu-id="b023d-152">Select the *App\_Start* folder and use Shift+Alt+A to add the downloaded version of the *AuthorizationServer\App\_Start\Startup.Auth.cs* file.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample2.cs)]

<span data-ttu-id="b023d-153">Le code ci-dessus permet les cookies et l’authentification Google, qui sont utilisés par le serveur d’autorisation lui-même pour gérer les comptes de connexion/externe de l’application.</span><span class="sxs-lookup"><span data-stu-id="b023d-153">The code above enables application/external sign in cookies and Google authentication, which are used by authorization server itself to manage accounts.</span></span>

<span data-ttu-id="b023d-154">Le `UseOAuthAuthorizationServer` méthode d’extension est l’installation du serveur d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="b023d-154">The `UseOAuthAuthorizationServer` extension method is to setup the authorization server.</span></span> <span data-ttu-id="b023d-155">Les options d’installation sont :</span><span class="sxs-lookup"><span data-stu-id="b023d-155">The setup options are:</span></span>

- <span data-ttu-id="b023d-156">`AuthorizeEndpointPath`: Le chemin d’accès de la demande où les applications clientes redirigeront l’agent utilisateur afin d’obtenir les utilisateurs de consentement pour émettre un jeton ou du code.</span><span class="sxs-lookup"><span data-stu-id="b023d-156">`AuthorizeEndpointPath`: The request path where client applications will redirect the user-agent in order to obtain the users consent to issue a token or code.</span></span> <span data-ttu-id="b023d-157">Il doit commencer par une barre oblique, par exemple, «`/Authorize`».</span><span class="sxs-lookup"><span data-stu-id="b023d-157">It must begin with a leading slash, for example, "`/Authorize`".</span></span>
- <span data-ttu-id="b023d-158">`TokenEndpointPath`: Les applications clientes de chemin d’accès demande communiquent directement pour obtenir le jeton d’accès.</span><span class="sxs-lookup"><span data-stu-id="b023d-158">`TokenEndpointPath`: The request path client applications directly communicate to obtain the access token.</span></span> <span data-ttu-id="b023d-159">Il doit commencer par une barre oblique, par exemple « /Token ».</span><span class="sxs-lookup"><span data-stu-id="b023d-159">It must begin with a leading slash, like "/Token".</span></span> <span data-ttu-id="b023d-160">Si le client est émis une [client\_secret](http://tools.ietf.org/html/rfc6749#appendix-A.2), il doit être fourni pour ce point de terminaison.</span><span class="sxs-lookup"><span data-stu-id="b023d-160">If the client is issued a [client\_secret](http://tools.ietf.org/html/rfc6749#appendix-A.2), it must be provided to this endpoint.</span></span>
- <span data-ttu-id="b023d-161">`ApplicationCanDisplayErrors`: La valeur `true` si l’application web veut générer une page d’erreur personnalisée pour les erreurs de validation client de `/Authorize` point de terminaison.</span><span class="sxs-lookup"><span data-stu-id="b023d-161">`ApplicationCanDisplayErrors`: Set to `true` if the web application wants to generate a custom error page for the client validation errors on `/Authorize` endpoint.</span></span> <span data-ttu-id="b023d-162">Cela est nécessaire uniquement pour les cas où le navigateur n’est pas redirigé vers l’application cliente, par exemple, lorsque le `client_id` ou `redirect_uri` sont incorrectes.</span><span class="sxs-lookup"><span data-stu-id="b023d-162">This is only needed for cases where the browser is not redirected back to the client application, for example, when the `client_id` or `redirect_uri` are incorrect.</span></span> <span data-ttu-id="b023d-163">Le `/Authorize` point de terminaison doit s’attendre à voir « oauth. Erreur «, « oauth. ErrorDescription » et « oauth. Propriétés de ErrorUri » sont ajoutées à l’environnement OWIN.</span><span class="sxs-lookup"><span data-stu-id="b023d-163">The `/Authorize` endpoint should expect to see the "oauth.Error", "oauth.ErrorDescription", and "oauth.ErrorUri" properties are added to the OWIN environment.</span></span> 

    > [!NOTE]
    > <span data-ttu-id="b023d-164">Si ce n’est pas le cas, la valeur est true, le serveur d’autorisation retourne une page d’erreurs par défaut avec les détails de l’erreur.</span><span class="sxs-lookup"><span data-stu-id="b023d-164">If not true, the authorization server will return a default error page with the error details.</span></span>
- <span data-ttu-id="b023d-165">`AllowInsecureHttp`: True pour autoriser l’autoriser et demandes de jetons pour arriver sur des adresses URI HTTP et pour autoriser entrant `redirect_uri` autoriser les paramètres de la demande d’avoir des adresses URI HTTP.</span><span class="sxs-lookup"><span data-stu-id="b023d-165">`AllowInsecureHttp`: True to allow authorize and token requests to arrive on HTTP URI addresses, and to allow incoming `redirect_uri` authorize request parameters to have HTTP URI addresses.</span></span> 

    > [!WARNING]
    > <span data-ttu-id="b023d-166">Sécurité - Il s’agit pour le développement.</span><span class="sxs-lookup"><span data-stu-id="b023d-166">Security - This is for development only.</span></span>
- <span data-ttu-id="b023d-167">`Provider`: L’objet fourni par l’application pour traiter les événements déclenchés par l’intergiciel (middleware) serveur d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="b023d-167">`Provider`: The object provided by the application to process events raised by the Authorization Server middleware.</span></span> <span data-ttu-id="b023d-168">L’application peut implémenter l’interface entièrement, ou il peut créer une instance de `OAuthAuthorizationServerProvider` et attribuer des délégués nécessaires pour les flux OAuth prend en charge par ce serveur.</span><span class="sxs-lookup"><span data-stu-id="b023d-168">The application may implement the interface fully, or it may create an instance of `OAuthAuthorizationServerProvider` and assign delegates necessary for the OAuth flows this server supports.</span></span>
- <span data-ttu-id="b023d-169">`AuthorizationCodeProvider`: Génère un code d’autorisation d’usage unique pour revenir à l’application cliente.</span><span class="sxs-lookup"><span data-stu-id="b023d-169">`AuthorizationCodeProvider`: Produces a single-use authorization code to return to the client application.</span></span> <span data-ttu-id="b023d-170">Sécurisation de l’application pour le serveur OAuth soit **doit** fournir une instance de `AuthorizationCodeProvider` où le jeton produit par le `OnCreate/OnCreateAsync` événement est considéré comme valide pour un seul appel à `OnReceive/OnReceiveAsync`.</span><span class="sxs-lookup"><span data-stu-id="b023d-170">For the OAuth server to be secure the application **MUST** provide an instance for `AuthorizationCodeProvider` where the token produced by the `OnCreate/OnCreateAsync` event is considered valid for only one call to `OnReceive/OnReceiveAsync`.</span></span>
- <span data-ttu-id="b023d-171">`RefreshTokenProvider`: Génère un jeton d’actualisation qui peut être utilisé pour générer un nouveau jeton d’accès si nécessaire.</span><span class="sxs-lookup"><span data-stu-id="b023d-171">`RefreshTokenProvider`: Produces a refresh token which may be used to produce a new access token when needed.</span></span> <span data-ttu-id="b023d-172">Si non fourni le serveur d’autorisation ne retourne pas les jetons d’actualisation à partir de la `/Token` point de terminaison.</span><span class="sxs-lookup"><span data-stu-id="b023d-172">If not provided the authorization server will not return refresh tokens from the `/Token` endpoint.</span></span>

## <a name="account-management"></a><span data-ttu-id="b023d-173">Gestion des comptes</span><span class="sxs-lookup"><span data-stu-id="b023d-173">Account Management</span></span>

<span data-ttu-id="b023d-174">OAuth ne tient pas compte où et comment gérer les informations de votre compte d’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="b023d-174">OAuth doesn't care where or how you manage your user account information.</span></span> <span data-ttu-id="b023d-175">Il a [ASP.NET Identity](../../../identity/index.md) qui en est responsable.</span><span class="sxs-lookup"><span data-stu-id="b023d-175">It's [ASP.NET Identity](../../../identity/index.md) which is responsible for it.</span></span> <span data-ttu-id="b023d-176">Dans ce didacticiel, nous simplifier le code de gestion de compte et assurez-vous que cet utilisateur peut ouvrir une session à l’aide de l’intergiciel OWIN cookie.</span><span class="sxs-lookup"><span data-stu-id="b023d-176">In this tutorial, we will simplify the account management code and just make sure that user can login using OWIN cookie middleware.</span></span> <span data-ttu-id="b023d-177">Voici le code exemple simplifié pour la `AccountController`:</span><span class="sxs-lookup"><span data-stu-id="b023d-177">Here is the simplified sample code for the `AccountController`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample3.cs)]

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample4.cs?highlight=1)]

<span data-ttu-id="b023d-178">`ValidateClientRedirectUri` est utilisé pour valider le client avec son URL de redirection inscrite.</span><span class="sxs-lookup"><span data-stu-id="b023d-178">`ValidateClientRedirectUri` is used to validate the client with its registered redirect URL.</span></span> <span data-ttu-id="b023d-179">`ValidateClientAuthentication` vérifie l’en-tête du schéma de base et le corps de formulaire pour obtenir des informations d’identification du client.</span><span class="sxs-lookup"><span data-stu-id="b023d-179">`ValidateClientAuthentication` checks the basic scheme header and form body to get the client's credentials.</span></span>

<span data-ttu-id="b023d-180">La page de connexion est indiquée ci-dessous :</span><span class="sxs-lookup"><span data-stu-id="b023d-180">The login page is shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image1.png)

<span data-ttu-id="b023d-181">Passez en revue OAuth 2 de l’IETF [octroi d’un Code d’autorisation](http://tools.ietf.org/html/rfc6749#section-4.1) section maintenant.</span><span class="sxs-lookup"><span data-stu-id="b023d-181">Review the IETF's OAuth 2 [Authorization Code Grant](http://tools.ietf.org/html/rfc6749#section-4.1) section now.</span></span> 

<span data-ttu-id="b023d-182">**Fournisseur** (dans le tableau ci-dessous) est [OAuthAuthorizationServerOptions](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserveroptions(v=vs.111).aspx). Fournisseur, qui est de type `OAuthAuthorizationServerProvider`, qui contient tous les événements de serveur OAuth.</span><span class="sxs-lookup"><span data-stu-id="b023d-182">**Provider** (in the table below) is [OAuthAuthorizationServerOptions](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserveroptions(v=vs.111).aspx).Provider, which is of type `OAuthAuthorizationServerProvider`, which contains all OAuth server events.</span></span> 

| <span data-ttu-id="b023d-183">Étapes du flux à partir de la section d’octroi d’un Code d’autorisation</span><span class="sxs-lookup"><span data-stu-id="b023d-183">Flow steps from Authorization Code Grant section</span></span> | <span data-ttu-id="b023d-184">Téléchargement de l’exemple effectue ces étapes avec :</span><span class="sxs-lookup"><span data-stu-id="b023d-184">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="b023d-185">(A) le client lance le flux en dirigeant l’agent utilisateur du propriétaire de la ressource pour le point de terminaison d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="b023d-185">(A) The client initiates the flow by directing the resource owner's user-agent to the authorization endpoint.</span></span> <span data-ttu-id="b023d-186">Le client inclut son identificateur de client, étendue demandée, état local et un URI de redirection à laquelle le serveur d’autorisation envoie à l’agent de l’utilisateur une fois que l’accès est accordé (ou refusé).</span><span class="sxs-lookup"><span data-stu-id="b023d-186">The client includes its client identifier, requested scope, local state, and a redirection URI to which the authorization server will send the user-agent back once access is granted (or denied).</span></span> | <span data-ttu-id="b023d-187">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span><span class="sxs-lookup"><span data-stu-id="b023d-187">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span></span> |
|  |  |
| <span data-ttu-id="b023d-188">(B) le serveur d’autorisation authentifie le propriétaire de la ressource (via l’agent utilisateur) et établit si le propriétaire de la ressource autorise ou refuse la demande d’accès du client.</span><span class="sxs-lookup"><span data-stu-id="b023d-188">(B) The authorization server authenticates the resource owner (via the user-agent) and establishes whether the resource owner grants or denies the client's access request.</span></span> | <span data-ttu-id="b023d-189">**&lt;Si l’utilisateur accorde l’accès&gt;**  Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="b023d-189">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="b023d-190">(C) en supposant que le propriétaire de la ressource accorde l’accès, le serveur d’autorisation redirige l’agent utilisateur vers le client à l’aide de la redirection de l’URI fourni plus haut (dans la demande ou lors de l’inscription du client).</span><span class="sxs-lookup"><span data-stu-id="b023d-190">(C) Assuming the resource owner grants access, the authorization server redirects the user-agent back to the client using the redirection URI provided earlier (in the request or during client registration).</span></span> <span data-ttu-id="b023d-191">...</span><span class="sxs-lookup"><span data-stu-id="b023d-191">...</span></span> |  |
|  |  |
| <span data-ttu-id="b023d-192">(D), le client demande un jeton d’accès à partir du point de terminaison de jeton du serveur d’autorisation en incluant le code d’autorisation à l’étape précédente.</span><span class="sxs-lookup"><span data-stu-id="b023d-192">(D) The client requests an access token from the authorization server's token endpoint by including the authorization code received in the previous step.</span></span> <span data-ttu-id="b023d-193">Lors de la demande, le client s’authentifie auprès du serveur d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="b023d-193">When making the request, the client authenticates with the authorization server.</span></span> <span data-ttu-id="b023d-194">Le client inclut l’URI utilisé pour obtenir le code d’autorisation pour la vérification de redirection.</span><span class="sxs-lookup"><span data-stu-id="b023d-194">The client includes the redirection URI used to obtain the authorization code for verification.</span></span> | <span data-ttu-id="b023d-195">Provider.MatchEndpoint Provider.ValidateClientAuthentication AuthorizationCodeProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantAuthorizationCode Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="b023d-195">Provider.MatchEndpoint Provider.ValidateClientAuthentication AuthorizationCodeProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantAuthorizationCode Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |

<span data-ttu-id="b023d-196">Un exemple d’implémentation pour `AuthorizationCodeProvider.CreateAsync` et `ReceiveAsync` pour contrôler la création et la validation du code d’autorisation est indiqué ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="b023d-196">A sample implementation for `AuthorizationCodeProvider.CreateAsync` and `ReceiveAsync` to control the creation and validation of authorization code is shown below.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample5.cs)]

<span data-ttu-id="b023d-197">Le code ci-dessus utilise un dictionnaire simultané en mémoire stockage du ticket de code et de l’identité et la restauration de l’identité après avoir reçu le code.</span><span class="sxs-lookup"><span data-stu-id="b023d-197">The code above uses an in-memory concurrent dictionary to store the code and identity ticket and restore the identity after receiving the code.</span></span> <span data-ttu-id="b023d-198">Dans une application réelle, il serait remplacé par un magasin de données persistantes.</span><span class="sxs-lookup"><span data-stu-id="b023d-198">In a real application, it would be replaced by a persistent data store.</span></span> <span data-ttu-id="b023d-199">Il est le point de terminaison d’autorisation du propriétaire des ressources accorder l’accès au client.</span><span class="sxs-lookup"><span data-stu-id="b023d-199">The authorization endpoint is for the resource owner to grant access to the client.</span></span> <span data-ttu-id="b023d-200">En règle générale, il a besoin d’une interface utilisateur pour autoriser l’utilisateur à cliquer sur un bouton et confirmer l’allocation.</span><span class="sxs-lookup"><span data-stu-id="b023d-200">Usually, it needs a user interface to allow the user to click a button and confirm the grant.</span></span> <span data-ttu-id="b023d-201">Intergiciel (middleware) OWIN OAuth permet au code d’application gérer le point de terminaison d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="b023d-201">OWIN OAuth middleware allows application code to handle the authorization endpoint.</span></span> <span data-ttu-id="b023d-202">Dans notre exemple d’application, nous utilisons un contrôleur MVC appelé `OAuthController` pour le manipuler.</span><span class="sxs-lookup"><span data-stu-id="b023d-202">In our sample app, we use an MVC controller called `OAuthController` to handle it.</span></span> <span data-ttu-id="b023d-203">Voici un exemple d’implémentation :</span><span class="sxs-lookup"><span data-stu-id="b023d-203">Here is the sample implementation:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample6.cs?highlight=15)]

<span data-ttu-id="b023d-204">Le `Authorize` action vérifie d’abord si l’utilisateur a ouvert une session le serveur d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="b023d-204">The `Authorize` action will first check if the user has logged in to the authorization server.</span></span> <span data-ttu-id="b023d-205">Si ce n’est pas le cas, l’intergiciel (middleware) d’authentification vérifie l’appelant de s’authentifier en utilisant le cookie « Application » et redirige vers la page de connexion.</span><span class="sxs-lookup"><span data-stu-id="b023d-205">If not, the authentication middleware challenges the caller to authenticate using the "Application" cookie and redirects to the login page.</span></span> <span data-ttu-id="b023d-206">(Voir le code en surbrillance ci-dessus). Si l’utilisateur s’est connecté, il doit rendre la vue d’autoriser, comme indiqué ci-dessous :</span><span class="sxs-lookup"><span data-stu-id="b023d-206">(See highlighted code above.) If user has logged in, it will render the Authorize view, as shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image2.png)

<span data-ttu-id="b023d-207">Si le **Grant** bouton est sélectionné, le `Authorize` action va créer un nouveau identité de « Support » et connectez-vous avec elle.</span><span class="sxs-lookup"><span data-stu-id="b023d-207">If the **Grant** button is selected, the `Authorize` action will create a new "Bearer" identity and sign in with it.</span></span> <span data-ttu-id="b023d-208">Il déclenche le serveur d’autorisation pour générer un jeton de support et l’envoyer au client avec la charge utile JSON.</span><span class="sxs-lookup"><span data-stu-id="b023d-208">It will trigger the authorization server to generate a bearer token and send it back to the client with JSON payload.</span></span> 

### <a name="implicit-grant"></a><span data-ttu-id="b023d-209">Implicit Grant</span><span class="sxs-lookup"><span data-stu-id="b023d-209">Implicit Grant</span></span>

<span data-ttu-id="b023d-210">Faire OAuth 2 de l’IETF [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) section maintenant.</span><span class="sxs-lookup"><span data-stu-id="b023d-210">Refer to the IETF's OAuth 2 [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) section now.</span></span>

 <span data-ttu-id="b023d-211">Le [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) flux indiqué dans la Figure 4 est le flux et OAuth OWIN de mappage qui le suit intergiciel (middleware).</span><span class="sxs-lookup"><span data-stu-id="b023d-211">The [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) flow shown in Figure 4 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>  

| <span data-ttu-id="b023d-212">Étapes du flux à partir de la section de Implicit Grant</span><span class="sxs-lookup"><span data-stu-id="b023d-212">Flow steps from Implicit Grant section</span></span> | <span data-ttu-id="b023d-213">Téléchargement de l’exemple effectue ces étapes avec :</span><span class="sxs-lookup"><span data-stu-id="b023d-213">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="b023d-214">(A) le client lance le flux en dirigeant l’agent utilisateur du propriétaire de la ressource pour le point de terminaison d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="b023d-214">(A) The client initiates the flow by directing the resource owner's user-agent to the authorization endpoint.</span></span> <span data-ttu-id="b023d-215">Le client inclut son identificateur de client, étendue demandée, état local et un URI de redirection à laquelle le serveur d’autorisation envoie à l’agent de l’utilisateur une fois que l’accès est accordé (ou refusé).</span><span class="sxs-lookup"><span data-stu-id="b023d-215">The client includes its client identifier, requested scope, local state, and a redirection URI to which the authorization server will send the user-agent back once access is granted (or denied).</span></span> | <span data-ttu-id="b023d-216">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span><span class="sxs-lookup"><span data-stu-id="b023d-216">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span></span> |
|  |  |
| <span data-ttu-id="b023d-217">(B) le serveur d’autorisation authentifie le propriétaire de la ressource (via l’agent utilisateur) et établit si le propriétaire de la ressource autorise ou refuse la demande d’accès du client.</span><span class="sxs-lookup"><span data-stu-id="b023d-217">(B) The authorization server authenticates the resource owner (via the user-agent) and establishes whether the resource owner grants or denies the client's access request.</span></span> | <span data-ttu-id="b023d-218">**&lt;Si l’utilisateur accorde l’accès&gt;**  Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="b023d-218">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="b023d-219">(C) en supposant que le propriétaire de la ressource accorde l’accès, le serveur d’autorisation redirige l’agent utilisateur vers le client à l’aide de la redirection de l’URI fourni plus haut (dans la demande ou lors de l’inscription du client).</span><span class="sxs-lookup"><span data-stu-id="b023d-219">(C) Assuming the resource owner grants access, the authorization server redirects the user-agent back to the client using the redirection URI provided earlier (in the request or during client registration).</span></span> <span data-ttu-id="b023d-220">...</span><span class="sxs-lookup"><span data-stu-id="b023d-220">...</span></span> |  |
|  |  |
| <span data-ttu-id="b023d-221">(D), le client demande un jeton d’accès à partir du point de terminaison de jeton du serveur d’autorisation en incluant le code d’autorisation à l’étape précédente.</span><span class="sxs-lookup"><span data-stu-id="b023d-221">(D) The client requests an access token from the authorization server's token endpoint by including the authorization code received in the previous step.</span></span> <span data-ttu-id="b023d-222">Lors de la demande, le client s’authentifie auprès du serveur d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="b023d-222">When making the request, the client authenticates with the authorization server.</span></span> <span data-ttu-id="b023d-223">Le client inclut l’URI utilisé pour obtenir le code d’autorisation pour la vérification de redirection.</span><span class="sxs-lookup"><span data-stu-id="b023d-223">The client includes the redirection URI used to obtain the authorization code for verification.</span></span> |  |

<span data-ttu-id="b023d-224">Étant donné que nous avons déjà implémenté le point de terminaison d’autorisation (`OAuthController.Authorize` action) pour l’octroi d’un code d’autorisation, il active automatiquement également les flux implicites.</span><span class="sxs-lookup"><span data-stu-id="b023d-224">Since we already implemented the authorization endpoint (`OAuthController.Authorize` action) for authorization code grant, it automatically enables implicit flow as well.</span></span> <span data-ttu-id="b023d-225">Remarque : `Provider.ValidateClientRedirectUri` est utilisé pour valider l’ID de client avec son URL de redirection, qui protège le flux d’octroi implicite d’envoyer l’accès au jeton à des clients ([attaque de Man-in-the-middle](https://www.owasp.org/index.php/Man-in-the-middle_attack)).</span><span class="sxs-lookup"><span data-stu-id="b023d-225">Note: `Provider.ValidateClientRedirectUri` is used to validate the client ID with its redirection URL, which protects the implicit grant flow from sending the access token to malicious clients ([Man-in-the-middle attack](https://www.owasp.org/index.php/Man-in-the-middle_attack)).</span></span>

### <a name="resource-owner-password-credentials-grant"></a><span data-ttu-id="b023d-226">Informations d’identification de mot de passe de propriétaire de la ressource Grant</span><span class="sxs-lookup"><span data-stu-id="b023d-226">Resource Owner Password Credentials Grant</span></span>

<span data-ttu-id="b023d-227">Faire OAuth 2 de l’IETF [octroi d’informations d’identification de mot de passe de propriétaire de ressource](http://tools.ietf.org/html/rfc6749#section-4.3) section maintenant.</span><span class="sxs-lookup"><span data-stu-id="b023d-227">Refer to the IETF's OAuth 2 [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) section now.</span></span>

 <span data-ttu-id="b023d-228">Le [octroi d’informations d’identification de mot de passe de propriétaire de ressource](http://tools.ietf.org/html/rfc6749#section-4.3) flux indiqué dans la Figure 5 est le flux et OAuth OWIN de mappage qui le suit intergiciel (middleware).</span><span class="sxs-lookup"><span data-stu-id="b023d-228">The [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) flow shown in Figure 5 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>  

| <span data-ttu-id="b023d-229">Étapes du flux à partir de la section de ressources propriétaire du mot de passe informations d’identification Grant</span><span class="sxs-lookup"><span data-stu-id="b023d-229">Flow steps from Resource Owner Password Credentials Grant section</span></span> | <span data-ttu-id="b023d-230">Téléchargement de l’exemple effectue ces étapes avec :</span><span class="sxs-lookup"><span data-stu-id="b023d-230">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="b023d-231">Le propriétaire de la ressource fournit au client avec son nom d’utilisateur et un mot de passe.</span><span class="sxs-lookup"><span data-stu-id="b023d-231">(A) The resource owner provides the client with its username and password.</span></span> |  |
|  |  |
| <span data-ttu-id="b023d-232">(B) le client demande un jeton d’accès à partir du point de terminaison de jeton du serveur d’autorisation en incluant les informations d’identification provenance du propriétaire de la ressource.</span><span class="sxs-lookup"><span data-stu-id="b023d-232">(B) The client requests an access token from the authorization server's token endpoint by including the credentials received from the resource owner.</span></span> <span data-ttu-id="b023d-233">Lors de la demande, le client s’authentifie auprès du serveur d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="b023d-233">When making the request, the client authenticates with the authorization server.</span></span> | <span data-ttu-id="b023d-234">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantResourceOwnerCredentials Provider.TokenEndpoint AccessToken Provider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="b023d-234">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantResourceOwnerCredentials Provider.TokenEndpoint AccessToken Provider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="b023d-235">(C) le serveur d’autorisation authentifie le client et valide les informations d’identification du propriétaire de la ressource et s’il est valide, émet un jeton d’accès.</span><span class="sxs-lookup"><span data-stu-id="b023d-235">(C) The authorization server authenticates the client and validates the resource owner credentials, and if valid, issues an access token.</span></span> |  |

<span data-ttu-id="b023d-236">Voici l’exemple d’implémentation pour `Provider.GrantResourceOwnerCredentials`:</span><span class="sxs-lookup"><span data-stu-id="b023d-236">Here is the sample implementation for `Provider.GrantResourceOwnerCredentials`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample7.cs)]

> [!NOTE]
> <span data-ttu-id="b023d-237">Le code ci-dessus est destiné à présenter cette section du didacticiel et ne doit pas être utilisé dans la sécurité ou les applications de production.</span><span class="sxs-lookup"><span data-stu-id="b023d-237">The code above is intended to explain this section of the tutorial and should not be used in secure or production apps.</span></span> <span data-ttu-id="b023d-238">Il ne vérifie pas les informations d’identification des propriétaires de ressources.</span><span class="sxs-lookup"><span data-stu-id="b023d-238">It does not check the resource owners credentials.</span></span> <span data-ttu-id="b023d-239">Il suppose que chaque information d’identification n’est valide et qu’il crée une nouvelle identité pour celle-ci.</span><span class="sxs-lookup"><span data-stu-id="b023d-239">It assumes every credential is valid and creates a new identity for it.</span></span> <span data-ttu-id="b023d-240">La nouvelle identité sera utilisée pour générer le jeton d’accès et le jeton d’actualisation.</span><span class="sxs-lookup"><span data-stu-id="b023d-240">The new identity will be used to generate the access token and refresh token.</span></span> <span data-ttu-id="b023d-241">Remplacez le code par votre propre code de gestion de compte sécurisé.</span><span class="sxs-lookup"><span data-stu-id="b023d-241">Please replace the code with your own secure account management code.</span></span>


### <a name="client-credentials-grant"></a><span data-ttu-id="b023d-242">Octroi des informations d’identification client</span><span class="sxs-lookup"><span data-stu-id="b023d-242">Client Credentials Grant</span></span>

<span data-ttu-id="b023d-243">Faire OAuth 2 de l’IETF [octroi des informations d’identification du Client](http://tools.ietf.org/html/rfc6749#section-4.4) section maintenant.</span><span class="sxs-lookup"><span data-stu-id="b023d-243">Refer to the IETF's OAuth 2 [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) section now.</span></span>

 <span data-ttu-id="b023d-244">Le [octroi des informations d’identification du Client](http://tools.ietf.org/html/rfc6749#section-4.4) flux indiqué dans la Figure 6 est le flux et OAuth OWIN de mappage qui le suit intergiciel (middleware).</span><span class="sxs-lookup"><span data-stu-id="b023d-244">The [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) flow shown in Figure 6 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>  

| <span data-ttu-id="b023d-245">Étapes du flux à partir de la section d’octroi des informations d’identification du Client</span><span class="sxs-lookup"><span data-stu-id="b023d-245">Flow steps from Client Credentials Grant section</span></span> | <span data-ttu-id="b023d-246">Téléchargement de l’exemple effectue ces étapes avec :</span><span class="sxs-lookup"><span data-stu-id="b023d-246">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="b023d-247">(A) le client s’authentifie auprès du serveur d’autorisation et demande un jeton d’accès du point de terminaison de jeton.</span><span class="sxs-lookup"><span data-stu-id="b023d-247">(A) The client authenticates with the authorization server and requests an access token from the token endpoint.</span></span> | <span data-ttu-id="b023d-248">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantClientCredentials Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="b023d-248">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantClientCredentials Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="b023d-249">(B) le serveur d’autorisation authentifie le client et s’il est valide, émet un jeton d’accès.</span><span class="sxs-lookup"><span data-stu-id="b023d-249">(B) The authorization server authenticates the client, and if valid, issues an access token.</span></span> |  |

<span data-ttu-id="b023d-250">Voici l’exemple d’implémentation pour `Provider.GrantClientCredentials`:</span><span class="sxs-lookup"><span data-stu-id="b023d-250">Here is the sample implementation for `Provider.GrantClientCredentials`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample8.cs)]

> [!NOTE]
> <span data-ttu-id="b023d-251">Le code ci-dessus est destiné à présenter cette section du didacticiel et ne doit pas être utilisé dans la sécurité ou les applications de production.</span><span class="sxs-lookup"><span data-stu-id="b023d-251">The code above is intended to explain this section of the tutorial and should not be used in secure or production apps.</span></span> <span data-ttu-id="b023d-252">Remplacez le code par votre propre code de gestion de client sécurisé.</span><span class="sxs-lookup"><span data-stu-id="b023d-252">Please replace the code with your own secure client management code.</span></span>


### <a name="refresh-token"></a><span data-ttu-id="b023d-253">Jeton d’actualisation</span><span class="sxs-lookup"><span data-stu-id="b023d-253">Refresh Token</span></span>

<span data-ttu-id="b023d-254">Faire OAuth 2 de l’IETF [jeton d’actualisation](http://tools.ietf.org/html/rfc6749#section-1.5) section maintenant.</span><span class="sxs-lookup"><span data-stu-id="b023d-254">Refer to the IETF's OAuth 2 [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) section now.</span></span>

 <span data-ttu-id="b023d-255">Le [jeton d’actualisation](http://tools.ietf.org/html/rfc6749#section-1.5) flux indiqué dans la Figure 2 est le flux et OAuth OWIN de mappage qui le suit intergiciel (middleware).</span><span class="sxs-lookup"><span data-stu-id="b023d-255">The [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) flow shown in Figure 2 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>  

| <span data-ttu-id="b023d-256">Étapes du flux à partir de la section d’octroi des informations d’identification du Client</span><span class="sxs-lookup"><span data-stu-id="b023d-256">Flow steps from Client Credentials Grant section</span></span> | <span data-ttu-id="b023d-257">Téléchargement de l’exemple effectue ces étapes avec :</span><span class="sxs-lookup"><span data-stu-id="b023d-257">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="b023d-258">(G), le client demande un nouveau jeton d’accès par authentification avec le serveur d’autorisation et de présenter le jeton d’actualisation.</span><span class="sxs-lookup"><span data-stu-id="b023d-258">(G) The client requests a new access token by authenticating with the authorization server and presenting the refresh token.</span></span> <span data-ttu-id="b023d-259">Les conditions d’authentification client sont basées sur le type de client et sur les stratégies de serveur d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="b023d-259">The client authentication requirements are based on the client type and on the authorization server policies.</span></span> | <span data-ttu-id="b023d-260">Provider.MatchEndpoint Provider.ValidateClientAuthentication RefreshTokenProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantRefreshToken Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="b023d-260">Provider.MatchEndpoint Provider.ValidateClientAuthentication RefreshTokenProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantRefreshToken Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="b023d-261">(H) du serveur d’autorisation authentifie le client valide le jeton d’actualisation et s’il est valide, émet un jeton d’accès (et, éventuellement, un nouveau jeton d’actualisation).</span><span class="sxs-lookup"><span data-stu-id="b023d-261">(H) The authorization server authenticates the client and validates the refresh token, and if valid, issues a new access token (and, optionally, a new refresh token).</span></span> |  |

<span data-ttu-id="b023d-262">Voici l’exemple d’implémentation pour `Provider.GrantRefreshToken`:</span><span class="sxs-lookup"><span data-stu-id="b023d-262">Here is the sample implementation for `Provider.GrantRefreshToken`:</span></span> 

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample9.cs)]

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample10.cs)]

## <a name="create-a-resource-server-which-is-protected-by-access-token"></a><span data-ttu-id="b023d-263">Créer un serveur de ressources qui est protégé par le jeton d’accès</span><span class="sxs-lookup"><span data-stu-id="b023d-263">Create a Resource Server which is protected by Access Token</span></span>

<span data-ttu-id="b023d-264">Créer un projet d’application web vide et installez suivants des packages dans le projet :</span><span class="sxs-lookup"><span data-stu-id="b023d-264">Create an empty web app project and install following packages in the project:</span></span>

- <span data-ttu-id="b023d-265">Microsoft.AspNet.WebApi.Owin</span><span class="sxs-lookup"><span data-stu-id="b023d-265">Microsoft.AspNet.WebApi.Owin</span></span>
- <span data-ttu-id="b023d-266">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="b023d-266">Microsoft.Owin.Host.SystemWeb</span></span>
- <span data-ttu-id="b023d-267">Microsoft.Owin.Security.OAuth</span><span class="sxs-lookup"><span data-stu-id="b023d-267">Microsoft.Owin.Security.OAuth</span></span>

<span data-ttu-id="b023d-268">Créer une classe de démarrage et de configurer l’authentification et l’API Web.</span><span class="sxs-lookup"><span data-stu-id="b023d-268">Create a startup class and configure authentication and Web API.</span></span> <span data-ttu-id="b023d-269">Consultez *AuthorizationServer\ResourceServer\Startup.cs* dans le téléchargement de l’exemple.</span><span class="sxs-lookup"><span data-stu-id="b023d-269">See *AuthorizationServer\ResourceServer\Startup.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample11.cs)]

<span data-ttu-id="b023d-270">Consultez *AuthorizationServer\ResourceServer\App\_Start\Startup.Auth.cs* dans le téléchargement de l’exemple.</span><span class="sxs-lookup"><span data-stu-id="b023d-270">See *AuthorizationServer\ResourceServer\App\_Start\Startup.Auth.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample12.cs)]

<span data-ttu-id="b023d-271">Consultez *AuthorizationServer\ResourceServer\App\_Start\Startup.WebApi.cs* dans le téléchargement de l’exemple.</span><span class="sxs-lookup"><span data-stu-id="b023d-271">See *AuthorizationServer\ResourceServer\App\_Start\Startup.WebApi.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample13.cs)]

- <span data-ttu-id="b023d-272">`UseCors` méthode autorise les CORS pour tous les domaines.</span><span class="sxs-lookup"><span data-stu-id="b023d-272">`UseCors` method allows CORS for all domains.</span></span>
- <span data-ttu-id="b023d-273">`UseOAuthBearerAuthentication` méthode permet d’intergiciel d’authentification du jeton de support OAuth qui recevra et valider le jeton de support à partir de l’en-tête d’autorisation dans la demande.</span><span class="sxs-lookup"><span data-stu-id="b023d-273">`UseOAuthBearerAuthentication` method enables OAuth bearer token authentication middleware which will receive and validate bearer token from authorization header in the request.</span></span>
- <span data-ttu-id="b023d-274">`Config.SuppressDefaultHostAuthenticaiton` Supprime la valeur par défaut hôte principal authentifié à partir de l’application, par conséquent, toutes les demandes seront anonymes après cet appel.</span><span class="sxs-lookup"><span data-stu-id="b023d-274">`Config.SuppressDefaultHostAuthenticaiton` suppresses default host authenticated principal from the app, therefore all requests will be anonymous after this call.</span></span>
- <span data-ttu-id="b023d-275">`HostAuthenticationFilter` Active l’authentification pour le type d’authentification.</span><span class="sxs-lookup"><span data-stu-id="b023d-275">`HostAuthenticationFilter` enables authentication just for the specified authentication type.</span></span> <span data-ttu-id="b023d-276">Dans ce cas, il est de type d’authentification de support.</span><span class="sxs-lookup"><span data-stu-id="b023d-276">In this case, it's bearer authentication type.</span></span>

<span data-ttu-id="b023d-277">Pour illustrer l’identité authentifiée, nous créons un ApiController pour générer des revendications de l’utilisateur actuel.</span><span class="sxs-lookup"><span data-stu-id="b023d-277">In order to demonstrate the authenticated identity, we create an ApiController to output current user's claims.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample14.cs)]

<span data-ttu-id="b023d-278">Si le serveur d’autorisation et le serveur de ressources ne sont pas sur le même ordinateur, l’intergiciel (middleware) OAuth utilise les clés d’ordinateur différents pour chiffrer et déchiffrer le jeton d’accès de support.</span><span class="sxs-lookup"><span data-stu-id="b023d-278">If the authorization server and the resource server are not on the same computer, the OAuth middleware will use the different machine keys to encrypt and decrypt bearer access token.</span></span> <span data-ttu-id="b023d-279">Afin de partager la même clé privée entre les deux projets, nous ajoutons la même `machinekey` paramètre dans les deux *web.config* fichiers.</span><span class="sxs-lookup"><span data-stu-id="b023d-279">In order to share the same private key between both projects, we add the same `machinekey` setting in both *web.config* files.</span></span>

[!code-xml[Main](owin-oauth-20-authorization-server/samples/sample15.xml?highlight=8-10)]

## <a name="create-oauth-20-clients"></a><span data-ttu-id="b023d-280">Créer des Clients OAuth 2.0</span><span class="sxs-lookup"><span data-stu-id="b023d-280">Create OAuth 2.0 Clients</span></span>

 <span data-ttu-id="b023d-281">Nous utilisons le [DotNetOpenAuth.OAuth2.Client](http://www.nuget.org/packages/DotNetOpenAuth.OAuth2.Client) package NuGet pour simplifier le code client.</span><span class="sxs-lookup"><span data-stu-id="b023d-281">We use the [DotNetOpenAuth.OAuth2.Client](http://www.nuget.org/packages/DotNetOpenAuth.OAuth2.Client) NuGet package to simplify the client code.</span></span>

### <a name="authorization-code-grant-client"></a><span data-ttu-id="b023d-282">Client d’octroi de Code d’autorisation</span><span class="sxs-lookup"><span data-stu-id="b023d-282">Authorization Code Grant Client</span></span>

 <span data-ttu-id="b023d-283">Ce client est une application MVC.</span><span class="sxs-lookup"><span data-stu-id="b023d-283">This client is an MVC application.</span></span> <span data-ttu-id="b023d-284">Il déclenche un flux d’octroi de code d’autorisation pour obtenir l’accès au jeton à partir du serveur principal.</span><span class="sxs-lookup"><span data-stu-id="b023d-284">It will trigger an authorization code grant flow to get the access token from backend.</span></span> <span data-ttu-id="b023d-285">Elle comporte une seule page comme indiqué ci-dessous :</span><span class="sxs-lookup"><span data-stu-id="b023d-285">It has a single page as shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image3.png)

- <span data-ttu-id="b023d-286">Le **Authorize** bouton redirige navigateur vers le serveur d’autorisation pour notifier le propriétaire de la ressource à accorder l’accès à ce client.</span><span class="sxs-lookup"><span data-stu-id="b023d-286">The **Authorize** button will redirect browser to the authorization server to notify the resource owner to grant access to this client.</span></span>
- <span data-ttu-id="b023d-287">Le **Actualiser** bouton obtenez un nouveau jeton d’accès et un jeton d’actualisation à l’aide de l’actualisation en cours jeton.</span><span class="sxs-lookup"><span data-stu-id="b023d-287">The **Refresh** button will get a new access token and refresh token using the current refresh token.</span></span>
- <span data-ttu-id="b023d-288">Le **accès protégé ressource API** bouton appellera le serveur de ressources pour obtenir des données de revendications de l’utilisateur actuel et les afficher sur la page.</span><span class="sxs-lookup"><span data-stu-id="b023d-288">The **Access Protected Resource API** button will call the resource server to get current user's claims data and show them on the page.</span></span>

<span data-ttu-id="b023d-289">Voici l’exemple de code de la `HomeController` du client.</span><span class="sxs-lookup"><span data-stu-id="b023d-289">Here is the sample code of the `HomeController` of the client.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample16.cs)]

<span data-ttu-id="b023d-290">`DotNetOpenAuth` nécessite SSL par défaut.</span><span class="sxs-lookup"><span data-stu-id="b023d-290">`DotNetOpenAuth` requires SSL by default.</span></span> <span data-ttu-id="b023d-291">Étant donné que notre démonstration à l’aide de HTTP, vous devez ajouter suivant dans le fichier de configuration :</span><span class="sxs-lookup"><span data-stu-id="b023d-291">Since our demo is using HTTP, you need to add following setting in the config file:</span></span>

[!code-xml[Main](owin-oauth-20-authorization-server/samples/sample17.xml?highlight=4-6)]

> [!WARNING]
> <span data-ttu-id="b023d-292">Sécurité - jamais désactiver SSL dans une application de production.</span><span class="sxs-lookup"><span data-stu-id="b023d-292">Security - Never disable SSL in a production app.</span></span> <span data-ttu-id="b023d-293">Vos informations d’identification de connexion sont désormais envoyées en texte clair sur le réseau.</span><span class="sxs-lookup"><span data-stu-id="b023d-293">Your login credentials are now being sent in clear-text across the wire.</span></span> <span data-ttu-id="b023d-294">Le code ci-dessus est juste pour le débogage local exemple et l’exploration.</span><span class="sxs-lookup"><span data-stu-id="b023d-294">The code above is just for local sample debugging and exploration.</span></span>


### <a name="implicit-grant-client"></a><span data-ttu-id="b023d-295">Client d’octroi implicite</span><span class="sxs-lookup"><span data-stu-id="b023d-295">Implicit Grant Client</span></span>

<span data-ttu-id="b023d-296">Ce client utilise JavaScript pour :</span><span class="sxs-lookup"><span data-stu-id="b023d-296">This client is using JavaScript to:</span></span>

1. <span data-ttu-id="b023d-297">Ouvrez une nouvelle fenêtre et rediriger vers le point de terminaison authorize du serveur d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="b023d-297">Open a new window and redirect to the authorize endpoint of the Authorization Server.</span></span>
2. <span data-ttu-id="b023d-298">Obtenir le jeton d’accès à partir des fragments d’URL lorsqu’il redirige précédent.</span><span class="sxs-lookup"><span data-stu-id="b023d-298">Get the access token from URL fragments when it redirects back.</span></span>

<span data-ttu-id="b023d-299">L’illustration suivante montre ce processus :</span><span class="sxs-lookup"><span data-stu-id="b023d-299">The following image shows this process:</span></span>

![](owin-oauth-20-authorization-server/_static/image4.png)

<span data-ttu-id="b023d-300">Le client doit avoir deux pages : une pour la page d’accueil et l’autre pour le rappel. Voici l’exemple de code JavaScript de code se trouve dans le *Index.cshtml* fichier :</span><span class="sxs-lookup"><span data-stu-id="b023d-300">The client should have two pages: one for home page and the other for callback.Here is the sample JavaScript code found in the *Index.cshtml* file:</span></span>

[!code-cshtml[Main](owin-oauth-20-authorization-server/samples/sample18.cshtml)]

<span data-ttu-id="b023d-301">Voici le rappel de la gestion du code dans *SignIn.cshtml* fichier :</span><span class="sxs-lookup"><span data-stu-id="b023d-301">Here is the callback handling code in *SignIn.cshtml* file:</span></span>

[!code-cshtml[Main](owin-oauth-20-authorization-server/samples/sample19.cshtml)]

> [!NOTE]
> <span data-ttu-id="b023d-302">Une meilleure pratique consiste à déplacer le code JavaScript dans un fichier externe et incorporer pas avec le balisage Razor.</span><span class="sxs-lookup"><span data-stu-id="b023d-302">A best practice is to move the JavaScript to an external file and not embed it with the Razor markup.</span></span> <span data-ttu-id="b023d-303">Pour que cet exemple reste simple, qu’elles ont été combinées.</span><span class="sxs-lookup"><span data-stu-id="b023d-303">To keep this sample simple, they have been combined.</span></span>


### <a name="resource-owner-password-credentials-grant-client"></a><span data-ttu-id="b023d-304">Mot de passe de propriétaire de la ressource d’informations d’identification de Client de Grant</span><span class="sxs-lookup"><span data-stu-id="b023d-304">Resource Owner Password Credentials Grant Client</span></span>

<span data-ttu-id="b023d-305">Nous utilise une application console à la démonstration de ce client.</span><span class="sxs-lookup"><span data-stu-id="b023d-305">We uses a console app to demo this client.</span></span> <span data-ttu-id="b023d-306">Voici le code :</span><span class="sxs-lookup"><span data-stu-id="b023d-306">Here is the code:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample20.cs)]

### <a name="client-credentials-grant-client"></a><span data-ttu-id="b023d-307">Client de l’octroi des informations d’identification client</span><span class="sxs-lookup"><span data-stu-id="b023d-307">Client Credentials Grant Client</span></span>

<span data-ttu-id="b023d-308">Comme pour l’allocation de ressources propriétaire du mot de passe informations d’identification, code d’application console est ici :</span><span class="sxs-lookup"><span data-stu-id="b023d-308">Similar to the Resource Owner Password Credentials Grant, here is console app code:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample21.cs)]
