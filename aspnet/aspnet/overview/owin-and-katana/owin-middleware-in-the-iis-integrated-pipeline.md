---
uid: aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline
title: Intergiciel OWIN dans IIS intégré pipeline | Documents Microsoft
author: Praburaj
description: Cet article explique comment exécuter les composants d’intergiciel (middleware) OWIN (OMCs) dans le pipeline intégré IIS, et comment définir l’événement de pipeline un OMC s’exécute sur. Tu devrais...
ms.author: aspnetcontent
manager: wpickett
ms.date: 11/07/2013
ms.topic: article
ms.assetid: d031c021-33c2-45a5-bf9f-98f8fa78c2ab
ms.technology: ''
ms.prod: .net-framework
msc.legacyurl: /aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline
msc.type: authoredcontent
ms.openlocfilehash: 5df70c80084a32c5f61ac9288c8cdbfaaa47f124
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 04/06/2018
---
<a name="owin-middleware-in-the-iis-integrated-pipeline"></a><span data-ttu-id="69f8b-104">Intergiciel OWIN dans le pipeline intégré IIS</span><span class="sxs-lookup"><span data-stu-id="69f8b-104">OWIN Middleware in the IIS integrated pipeline</span></span>
====================
<span data-ttu-id="69f8b-105">par [Praburaj Thiagarajan](https://github.com/Praburaj), [Rick Anderson](https://github.com/Rick-Anderson)</span><span class="sxs-lookup"><span data-stu-id="69f8b-105">by [Praburaj Thiagarajan](https://github.com/Praburaj), [Rick Anderson](https://github.com/Rick-Anderson)</span></span>

> <span data-ttu-id="69f8b-106">Cet article explique comment exécuter les composants d’intergiciel (middleware) OWIN (OMCs) dans le pipeline intégré IIS, et comment définir l’événement de pipeline un OMC s’exécute sur.</span><span class="sxs-lookup"><span data-stu-id="69f8b-106">This article shows how to run OWIN middleware Components (OMCs) in the IIS integrated pipeline, and how to set the pipeline event an OMC runs on.</span></span> <span data-ttu-id="69f8b-107">Vous devez passer en revue [une vue d’ensemble du projet Katana](an-overview-of-project-katana.md) et [détection de classe de démarrage OWIN](owin-startup-class-detection.md) avant la lecture de ce didacticiel.</span><span class="sxs-lookup"><span data-stu-id="69f8b-107">You should review [An Overview of Project Katana](an-overview-of-project-katana.md) and [OWIN Startup Class Detection](owin-startup-class-detection.md) before reading this tutorial.</span></span> <span data-ttu-id="69f8b-108">Ce didacticiel a été rédigé par Rick Anderson ( [ @RickAndMSFT ](https://twitter.com/#!/RickAndMSFT) ), Chris Ross Praburaj Thiagarajan et Howard Dierking ( [ @howard \_dierking](https://twitter.com/howard_dierking) ).</span><span class="sxs-lookup"><span data-stu-id="69f8b-108">This tutorial was written by Rick Anderson ( [@RickAndMSFT](https://twitter.com/#!/RickAndMSFT) ), Chris Ross, Praburaj Thiagarajan, and Howard Dierking ( [@howard\_dierking](https://twitter.com/howard_dierking) ).</span></span>


<span data-ttu-id="69f8b-109">Bien que [OWIN](an-overview-of-project-katana.md) composants d’intergiciel (middleware) (OMCs) sont principalement conçus pour s’exécuter dans un pipeline indépendant du serveur, il est possible d’exécuter un OMC dans le pipeline intégré IIS ainsi (**en mode classique est *pas* pris en charge**).</span><span class="sxs-lookup"><span data-stu-id="69f8b-109">Although [OWIN](an-overview-of-project-katana.md) middleware components (OMCs) are primarily designed to run in a server-agnostic pipeline, it is possible to run an OMC in the IIS integrated pipeline as well (**classic mode is *not* supported**).</span></span> <span data-ttu-id="69f8b-110">Un OMC peut être défini pour travailler dans le pipeline intégré IIS en installant le package suivant à partir de la Console Gestionnaire de Package (PMC) :</span><span class="sxs-lookup"><span data-stu-id="69f8b-110">An OMC can be made to work in the IIS integrated pipeline by installing the following package from the Package Manager Console (PMC):</span></span>

[!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample1.cmd)]

<span data-ttu-id="69f8b-111">Cela signifie que toutes les infrastructures d’application, y compris ceux qui ne sont pas encore en mesure d’exécuter en dehors d’IIS et System.Web, peuvent tirer parti des composants d’intergiciel (middleware) OWIN existants.</span><span class="sxs-lookup"><span data-stu-id="69f8b-111">This means that all application frameworks, even those that are not yet able to run outside of IIS and System.Web, can benefit from existing OWIN middleware components.</span></span> 

> [!NOTE]
> <span data-ttu-id="69f8b-112">Tous les `Microsoft.Owin.Security.*` packages expédition avec le nouveau système d’identité dans Visual Studio 2013 (par exemple : Cookies Account Microsoft, Google, Facebook, Twitter, [jetons de support](http://self-issued.info/docs/draft-ietf-oauth-v2-bearer.html), OAuth, serveur d’autorisation, JSON, Azure Active Directory, Active Directory federation services) sont créés en tant que OMCs et peuvent être utilisé dans les scénarios auto-hébergés et hébergés dans IIS.</span><span class="sxs-lookup"><span data-stu-id="69f8b-112">All of the `Microsoft.Owin.Security.*` packages shipping with the new Identity System in Visual Studio 2013 (for example: Cookies, Microsoft Account, Google, Facebook, Twitter, [Bearer Token](http://self-issued.info/docs/draft-ietf-oauth-v2-bearer.html), OAuth, Authorization server, JWT, Azure Active directory, and Active directory federation services) are authored as OMCs, and can be used in both self-hosted and IIS-hosted scenarios.</span></span>

## <a name="how-owin-middleware-executes-in-the-iis-integrated-pipeline"></a><span data-ttu-id="69f8b-113">Comment intergiciel (middleware) OWIN s’exécute dans le Pipeline intégré IIS</span><span class="sxs-lookup"><span data-stu-id="69f8b-113">How OWIN Middleware Executes in the IIS Integrated Pipeline</span></span>

<span data-ttu-id="69f8b-114">Pour les applications de console OWIN, le pipeline d’application générée à l’aide du [configuration de démarrage](owin-startup-class-detection.md) est définie par l’ordre les composants sont ajoutés à l’aide de la `IAppBuilder.Use` (méthode).</span><span class="sxs-lookup"><span data-stu-id="69f8b-114">For OWIN console applications, the application pipeline built using the [startup configuration](owin-startup-class-detection.md) is set by the order the components are added using the `IAppBuilder.Use` method.</span></span> <span data-ttu-id="69f8b-115">Autrement dit, le pipeline OWIN dans le [Katana](an-overview-of-project-katana.md) runtime traitera OMCs dans l’ordre qu’ils ont été inscrits à l’aide de `IAppBuilder.Use`.</span><span class="sxs-lookup"><span data-stu-id="69f8b-115">That is, the OWIN pipeline in the [Katana](an-overview-of-project-katana.md) runtime will process OMCs in the order they were registered using `IAppBuilder.Use`.</span></span> <span data-ttu-id="69f8b-116">Dans le pipeline intégré IIS, le pipeline de requête se compose de [HttpModules](https://msdn.microsoft.com/library/ms178468(v=vs.85).aspx) abonné à un ensemble prédéfini des événements de pipeline, tel que [BeginRequest](https://msdn.microsoft.com/library/system.web.httpapplication.beginrequest.aspx), [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx), [AuthorizeRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authorizerequest.aspx), etc.</span><span class="sxs-lookup"><span data-stu-id="69f8b-116">In the IIS integrated pipeline the request pipeline consists of [HttpModules](https://msdn.microsoft.com/library/ms178468(v=vs.85).aspx) subscribed to a pre-defined set of the pipeline events such as [BeginRequest](https://msdn.microsoft.com/library/system.web.httpapplication.beginrequest.aspx), [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx), [AuthorizeRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authorizerequest.aspx), etc.</span></span>

<span data-ttu-id="69f8b-117">Si nous comparer un OMC à celle d’un [HttpModule](https://msdn.microsoft.com/library/zec9k340(v=vs.85).aspx) dans le monde d’ASP.NET, un OMC doit être inscrit à l’événement correct de pipeline prédéfinies.</span><span class="sxs-lookup"><span data-stu-id="69f8b-117">If we compare an OMC to that of an [HttpModule](https://msdn.microsoft.com/library/zec9k340(v=vs.85).aspx) in the ASP.NET world, an OMC must be registered to the correct pre-defined pipeline event.</span></span> <span data-ttu-id="69f8b-118">Par exemple, HttpModule `MyModule` sera invoquée lorsqu’une requête arrive la [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx) étape du pipeline :</span><span class="sxs-lookup"><span data-stu-id="69f8b-118">For example, the HttpModule `MyModule` will get invoked when a request comes to the [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx) stage in the pipeline:</span></span>

[!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample2.cs?highlight=10)]

<span data-ttu-id="69f8b-119">Dans l’ordre pour un OMC devant être inclus dans cette même sur des événements, l’exécution de l’organisation, la [Katana](an-overview-of-project-katana.md) code du runtime parcourt la [configuration de démarrage](owin-startup-class-detection.md) et s’abonne à chacun des composants d’intergiciel (middleware) à un événements du pipeline intégré.</span><span class="sxs-lookup"><span data-stu-id="69f8b-119">In order for an OMC to participate in this same, event-based execution ordering, the [Katana](an-overview-of-project-katana.md) runtime code scans through the [startup configuration](owin-startup-class-detection.md) and subscribes each of the middleware components to an integrated pipeline event.</span></span> <span data-ttu-id="69f8b-120">Par exemple, le code suivant OMC et l’inscription permet de vous permet de voir l’enregistrement d’événements par défaut des composants d’intergiciel (middleware).</span><span class="sxs-lookup"><span data-stu-id="69f8b-120">For example, the following OMC and registration code enables you to see the default event registration of middleware components.</span></span> <span data-ttu-id="69f8b-121">(Pour plus d’instructions sur la création d’une classe de démarrage OWIN, consultez [détection de classe de démarrage OWIN](owin-startup-class-detection.md).)</span><span class="sxs-lookup"><span data-stu-id="69f8b-121">(For more detailed instructions on creating an OWIN startup class, see [OWIN Startup Class Detection](owin-startup-class-detection.md).)</span></span>

1. <span data-ttu-id="69f8b-122">Créez un projet d’application web vide et nommez-la **owin2**.</span><span class="sxs-lookup"><span data-stu-id="69f8b-122">Create an empty web application project and name it **owin2**.</span></span>
2. <span data-ttu-id="69f8b-123">À partir de Package Manager Console (PMC), exécutez la commande suivante :</span><span class="sxs-lookup"><span data-stu-id="69f8b-123">From the Package Manager Console (PMC), run the following command:</span></span> 

    [!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample3.cmd)]
3. <span data-ttu-id="69f8b-124">Ajouter un `OWIN Startup Class` et nommez-le `Startup`.</span><span class="sxs-lookup"><span data-stu-id="69f8b-124">Add an `OWIN Startup Class` and name it `Startup`.</span></span> <span data-ttu-id="69f8b-125">Remplacez le code généré par le code suivant (les modifications sont mises en surbrillance) :</span><span class="sxs-lookup"><span data-stu-id="69f8b-125">Replace the generated code with the following (the changes are highlighted):</span></span>  

    [!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample4.cs?highlight=5-7,15-36)]
4. <span data-ttu-id="69f8b-126">Appuyez sur F5 pour exécuter l’application.</span><span class="sxs-lookup"><span data-stu-id="69f8b-126">Hit F5 to run the app.</span></span>

<span data-ttu-id="69f8b-127">La configuration de démarrage définit un pipeline avec les composants d’intergiciel (middleware) trois, les deux premières affichant des informations de diagnostic et la dernière réponse à des événements (et en affichant des informations de diagnostic).</span><span class="sxs-lookup"><span data-stu-id="69f8b-127">The Startup configuration sets up a pipeline with three middleware components, the first two displaying diagnostic information and the last one responding to events (and also displaying diagnostic information).</span></span> <span data-ttu-id="69f8b-128">Le `PrintCurrentIntegratedPipelineStage` méthode affiche l’événement de pipeline intégré appelé cet intergiciel (middleware) et un message.</span><span class="sxs-lookup"><span data-stu-id="69f8b-128">The `PrintCurrentIntegratedPipelineStage` method displays the integrated pipeline event this middleware is invoked on and a message.</span></span> <span data-ttu-id="69f8b-129">Les fenêtres de sortie affiche les informations suivantes :</span><span class="sxs-lookup"><span data-stu-id="69f8b-129">The output windows displays the following:</span></span>

[!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample5.cmd)]

<span data-ttu-id="69f8b-130">Le runtime Katana mappés chacun des composants d’intergiciel (middleware) OWIN pour [PreExecuteRequestHandler](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx) par défaut, ce qui correspond à l’événement de pipeline IIS [PreRequestHandlerExecute](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx).</span><span class="sxs-lookup"><span data-stu-id="69f8b-130">The Katana runtime mapped each of the OWIN middleware components to [PreExecuteRequestHandler](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx) by default, which corresponds to the IIS pipeline event [PreRequestHandlerExecute](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx).</span></span>

## <a name="stage-markers"></a><span data-ttu-id="69f8b-131">Marqueurs d’étape</span><span class="sxs-lookup"><span data-stu-id="69f8b-131">Stage Markers</span></span>

<span data-ttu-id="69f8b-132">Vous pouvez marquer OMCs à exécuter à plusieurs étapes du pipeline à l’aide de la `IAppBuilder UseStageMarker()` méthode d’extension.</span><span class="sxs-lookup"><span data-stu-id="69f8b-132">You can mark OMCs to execute at specific stages of the pipeline by using the `IAppBuilder UseStageMarker()` extension method.</span></span> <span data-ttu-id="69f8b-133">Pour exécuter un ensemble de composants d’intergiciel (middleware) au cours d’une étape spécifique, insérez un marqueur d’étape juste après le dernier composant est l’ensemble lors de l’inscription.</span><span class="sxs-lookup"><span data-stu-id="69f8b-133">To run a set of middleware components during a particular stage, insert a stage marker right after the last component is the set during registration.</span></span> <span data-ttu-id="69f8b-134">Il existe des règles sur l’étape du pipeline à laquelle vous pouvez exécuter intergiciel (middleware) et les composants de la commande doivent exécuter (les règles sont expliqués plus loin dans ce didacticiel).</span><span class="sxs-lookup"><span data-stu-id="69f8b-134">There are rules on which stage of the pipeline you can execute middleware and the order components must run (The rules are explained later in the tutorial).</span></span> <span data-ttu-id="69f8b-135">Ajouter le `UseStageMarker` méthode à la `Configuration` de code comme indiqué ci-dessous :</span><span class="sxs-lookup"><span data-stu-id="69f8b-135">Add the `UseStageMarker` method to the `Configuration` code as shown below:</span></span>

[!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample6.cs?highlight=13,19)]

<span data-ttu-id="69f8b-136">Le `app.UseStageMarker(PipelineStage.Authenticate)` appel configure tous les composants d’intergiciel (middleware) précédemment inscrites (dans ce cas, les deux composants de diagnostic) pour s’exécuter sur l’étape d’authentification du pipeline.</span><span class="sxs-lookup"><span data-stu-id="69f8b-136">The `app.UseStageMarker(PipelineStage.Authenticate)` call configures all the previously registered middleware components (in this case, our two diagnostic components) to run on the authentication stage of the pipeline.</span></span> <span data-ttu-id="69f8b-137">Le dernier composant d’intergiciel (middleware) (qui affiche des diagnostics et répond aux demandes) s’exécutera sur le `ResolveCache` stade (le [ResolveRequestCache](https://msdn.microsoft.com/library/system.web.httpapplication.resolverequestcache.aspx) événement).</span><span class="sxs-lookup"><span data-stu-id="69f8b-137">The last middleware component (which displays diagnostics and responds to requests) will run on the `ResolveCache` stage (the [ResolveRequestCache](https://msdn.microsoft.com/library/system.web.httpapplication.resolverequestcache.aspx) event).</span></span>

<span data-ttu-id="69f8b-138">Appuyez sur F5 pour exécuter l’application. La fenêtre Sortie affiche les informations suivantes :</span><span class="sxs-lookup"><span data-stu-id="69f8b-138">Hit F5 to run the app.The output window shows the following:</span></span>

[!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample7.cmd)]

## <a name="stage-marker-rules"></a><span data-ttu-id="69f8b-139">Règles de marqueur d’étape</span><span class="sxs-lookup"><span data-stu-id="69f8b-139">Stage Marker Rules</span></span>

<span data-ttu-id="69f8b-140">Composants d’intergiciel (middleware) Owin (OMC) peuvent être configurés pour exécuter les événements d’étape de pipeline OWIN suivant :</span><span class="sxs-lookup"><span data-stu-id="69f8b-140">Owin middleware components (OMC) can be configured to run at the following OWIN pipeline stage events:</span></span>

[!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample8.cs)]

1. <span data-ttu-id="69f8b-141">Par défaut, OMCs s’exécutent sur le dernier événement (`PreHandlerExecute`).</span><span class="sxs-lookup"><span data-stu-id="69f8b-141">By default, OMCs run at the last event (`PreHandlerExecute`).</span></span> <span data-ttu-id="69f8b-142">C’est pourquoi notre premier exemple de code affiche « PreExecuteRequestHandler ».</span><span class="sxs-lookup"><span data-stu-id="69f8b-142">That's why our first example code displayed "PreExecuteRequestHandler".</span></span>
2. <span data-ttu-id="69f8b-143">Vous pouvez utiliser l’un `app.UseStageMarker` méthode pour inscrire un OMC pour s’exécuter plus tôt, à n’importe quelle étape du pipeline OWIN répertoriées dans le `PipelineStage` enum.</span><span class="sxs-lookup"><span data-stu-id="69f8b-143">You can use the a `app.UseStageMarker` method to register a OMC to run earlier, at any stage of the OWIN pipeline listed in the `PipelineStage` enum.</span></span>
3. <span data-ttu-id="69f8b-144">Le pipeline OWIN et le pipeline d’IIS est triée, par conséquent, les appels à `app.UseStageMarker` doit être dans l’ordre.</span><span class="sxs-lookup"><span data-stu-id="69f8b-144">The OWIN pipeline and the IIS pipeline is ordered, therefore calls to `app.UseStageMarker` must be in order.</span></span> <span data-ttu-id="69f8b-145">Impossible de définir le Gestionnaire d’événements à un événement qui précède le dernier événement inscrit auprès de `app.UseStageMarker`.</span><span class="sxs-lookup"><span data-stu-id="69f8b-145">You cannot set the event handler to an event that precedes the last event registered with to `app.UseStageMarker`.</span></span> <span data-ttu-id="69f8b-146">Par exemple, *après* appel :</span><span class="sxs-lookup"><span data-stu-id="69f8b-146">For example, *after* calling:</span></span>

    [!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample9.cmd)]

   <span data-ttu-id="69f8b-147">les appels à `app.UseStageMarker` passage `Authenticate` ou `PostAuthenticate` ne sera pas pris en compte et aucune exception n’est levée.</span><span class="sxs-lookup"><span data-stu-id="69f8b-147">calls to `app.UseStageMarker` passing `Authenticate` or `PostAuthenticate` will not be honored, and no exception will be thrown.</span></span> <span data-ttu-id="69f8b-148">OMCs s’exécutent à la dernière phase, ce qui par défaut est `PreHandlerExecute`.</span><span class="sxs-lookup"><span data-stu-id="69f8b-148">OMCs run at the latest stage, which by default is `PreHandlerExecute`.</span></span> <span data-ttu-id="69f8b-149">Les marqueurs d’étape sont utilisés pour les rendre à exécuter plus tôt.</span><span class="sxs-lookup"><span data-stu-id="69f8b-149">The stage markers are used to make them to run earlier.</span></span> <span data-ttu-id="69f8b-150">Si vous spécifiez les marqueurs d’étape en désordre, nous arrondir au marqueur antérieur.</span><span class="sxs-lookup"><span data-stu-id="69f8b-150">If you specify stage markers out of order, we round to the earlier marker.</span></span> <span data-ttu-id="69f8b-151">En d’autres termes, l’ajout d’un marqueur d’étape indique « Exécuter après le stade X ».</span><span class="sxs-lookup"><span data-stu-id="69f8b-151">In other words, adding a stage marker says "Run no later than stage X".</span></span> <span data-ttu-id="69f8b-152">Exécution de OMC sur le marqueur d’étape plus tôt ajouté après ces derniers dans le pipeline OWIN.</span><span class="sxs-lookup"><span data-stu-id="69f8b-152">OMC's run at the earliest stage marker added after them in the OWIN pipeline.</span></span>
4. <span data-ttu-id="69f8b-153">La première étape d’appels à `app.UseStageMarker` wins.</span><span class="sxs-lookup"><span data-stu-id="69f8b-153">The earliest stage of calls to `app.UseStageMarker` wins.</span></span> <span data-ttu-id="69f8b-154">Par exemple, si vous changez l’ordre des `app.UseStageMarker` appels à partir de l’exemple précédent :</span><span class="sxs-lookup"><span data-stu-id="69f8b-154">For example, if you switch the order of `app.UseStageMarker` calls from our previous example:</span></span>

    [!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample10.cs?highlight=13,19)]

   <span data-ttu-id="69f8b-155">Affiche la fenêtre Sortie :</span><span class="sxs-lookup"><span data-stu-id="69f8b-155">The output window will display:</span></span> 

    [!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample11.cmd)]

   <span data-ttu-id="69f8b-156">Les OMCs tous s’exécuter dans le `AuthenticateRequest` à l’étape, car la dernière OMC enregistré avec le `Authenticate` événement et le `Authenticate` événement précède tous les autres événements.</span><span class="sxs-lookup"><span data-stu-id="69f8b-156">The OMCs all run in the `AuthenticateRequest` stage, because the last OMC registered with the `Authenticate` event, and the `Authenticate` event precedes all other events.</span></span>
