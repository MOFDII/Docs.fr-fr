---
uid: identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity
title: Compte de Confirmation et récupération de mot de passe avec l’identité de ASP.NET (c#) | Documents Microsoft
author: HaoK
description: Avant d’entamer ce didacticiel, que vous devez d’abord terminer créer sécurisée application web ASP.NET MVC 5 avec se connectent, réinitialisation de confirmation et le mot de passe par courrier électronique. Ce didacticiel...
ms.author: aspnetcontent
manager: wpickett
ms.date: 03/26/2015
ms.topic: article
ms.assetid: 8d54180d-f826-4df7-b503-7debf5ed9fb3
ms.technology: ''
ms.prod: .net-framework
msc.legacyurl: /identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: 0167388cf6b488b72ca36f583a7794690dbf9900
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 04/06/2018
---
<a name="account-confirmation-and-password-recovery-with-aspnet-identity-c"></a><span data-ttu-id="f4244-104">Confirmation du compte et la récupération de mot de passe avec l’identité de ASP.NET (c#)</span><span class="sxs-lookup"><span data-stu-id="f4244-104">Account Confirmation and Password Recovery with ASP.NET Identity (C#)</span></span>
====================
<span data-ttu-id="f4244-105">par [arts martiaux de Hao](https://github.com/HaoK), [Pranav Rastogi](https://github.com/rustd), [Rick Anderson](https://github.com/Rick-Anderson), [Suhas Joshi](https://github.com/suhasj)</span><span class="sxs-lookup"><span data-stu-id="f4244-105">by [Hao Kung](https://github.com/HaoK), [Pranav Rastogi](https://github.com/rustd), [Rick Anderson](https://github.com/Rick-Anderson), [Suhas Joshi](https://github.com/suhasj)</span></span>

> <span data-ttu-id="f4244-106">Avant d’entamer ce didacticiel vous devez d’abord terminer [créer une application de web ASP.NET MVC 5 sécurisée avec se connectent, réinitialisation de confirmation et le mot de passe de messagerie](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md).</span><span class="sxs-lookup"><span data-stu-id="f4244-106">Before doing this tutorial you should first complete [Create a secure ASP.NET MVC 5 web app with log in, email confirmation and password reset](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md).</span></span> <span data-ttu-id="f4244-107">Ce didacticiel contient plus de détails et vous montrent comment paramétrer la messagerie électronique de confirmation du compte local et de permettre aux utilisateurs de réinitialiser leur mot de passe oublié dans ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="f4244-107">This tutorial contains more details and will show you how to set up email for local account confirmation and allow users to reset their forgotten password in ASP.NET Identity.</span></span> <span data-ttu-id="f4244-108">Cet article a été rédigé par Rick Anderson ([@RickAndMSFT](https://twitter.com/#!/RickAndMSFT)), Pranav Rastogi ([@rustd](https://twitter.com/rustd)), arts martiaux de Hao et Suhas Joshi.</span><span class="sxs-lookup"><span data-stu-id="f4244-108">This article was written by Rick Anderson ([@RickAndMSFT](https://twitter.com/#!/RickAndMSFT)), Pranav Rastogi ([@rustd](https://twitter.com/rustd)), Hao Kung, and Suhas Joshi.</span></span> <span data-ttu-id="f4244-109">L’exemple de NuGet a été écrit principalement par arts martiaux de Hao.</span><span class="sxs-lookup"><span data-stu-id="f4244-109">The NuGet sample was written primarily by Hao Kung.</span></span>


<span data-ttu-id="f4244-110">Un compte d’utilisateur local nécessite l’utilisateur de créer un mot de passe pour le compte et ce mot de passe est stocké (en toute sécurité) dans l’application web.</span><span class="sxs-lookup"><span data-stu-id="f4244-110">A local user account requires the user to create a password for the account, and that password is stored (securely) in the web app.</span></span> <span data-ttu-id="f4244-111">ASP.NET Identity prend également en charge les comptes sociales, qui ne nécessitent pas l’utilisateur de créer un mot de passe pour l’application.</span><span class="sxs-lookup"><span data-stu-id="f4244-111">ASP.NET Identity also supports social accounts, which don't require the user to create a password for the app.</span></span> <span data-ttu-id="f4244-112">[Comptes sociaux](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) un tiers (par exemple, Google, Twitter, Facebook ou Microsoft) permet d’authentifier les utilisateurs.</span><span class="sxs-lookup"><span data-stu-id="f4244-112">[Social accounts](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) use a third party (such as Google, Twitter, Facebook or Microsoft) to authenticate users.</span></span> <span data-ttu-id="f4244-113">Cette rubrique couvre les sujets suivants :</span><span class="sxs-lookup"><span data-stu-id="f4244-113">This topic covers the following:</span></span>

- <span data-ttu-id="f4244-114">[Créer une application ASP.NET MVC](#createMvc) et Explorer les fonctionnalités d’identité ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="f4244-114">[Create an ASP.NET MVC app](#createMvc) and explore ASP.NET Identity features.</span></span>
- [<span data-ttu-id="f4244-115">Création de l’exemple d’identité</span><span class="sxs-lookup"><span data-stu-id="f4244-115">Building the Identity sample</span></span>](#build)
- [<span data-ttu-id="f4244-116">Configurer la confirmation par courrier électronique</span><span class="sxs-lookup"><span data-stu-id="f4244-116">Set up email confirmation</span></span>](#email)

<span data-ttu-id="f4244-117">Nouveaux utilisateurs inscrivent leurs alias de messagerie électronique, ce qui crée un compte local.</span><span class="sxs-lookup"><span data-stu-id="f4244-117">New users register their email alias, which creates a local account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image1.png)

<span data-ttu-id="f4244-118">En cliquant sur le bouton Enregistrer envoie un message électronique de confirmation qui contient un jeton de validation sur leur adresse e-mail.</span><span class="sxs-lookup"><span data-stu-id="f4244-118">Clicking the Register button sends a confirmation email containing a validation token to their email address.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image2.png)

<span data-ttu-id="f4244-119">L’utilisateur reçoit un message électronique avec un jeton de confirmation pour leur compte.</span><span class="sxs-lookup"><span data-stu-id="f4244-119">The user is sent an email with a confirmation token for their account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image3.png)

<span data-ttu-id="f4244-120">En cliquant sur le lien confirme le compte.</span><span class="sxs-lookup"><span data-stu-id="f4244-120">Clicking the link confirms the account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image4.png)

<a id="passwordReset"></a>

## <a name="password-recoveryreset"></a><span data-ttu-id="f4244-121">Récupération/réinitialisation de mot de passe</span><span class="sxs-lookup"><span data-stu-id="f4244-121">Password recovery/reset</span></span>

<span data-ttu-id="f4244-122">Les utilisateurs locaux qui oublient leur mot de passe peuvent avoir un jeton de sécurité envoyé à son compte de messagerie, ce qui leur permet de réinitialiser leur mot de passe.</span><span class="sxs-lookup"><span data-stu-id="f4244-122">Local users who forget their password can have a security token sent to their email account, enabling them to reset their password.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image5.png)  
  
<span data-ttu-id="f4244-123">L’utilisateur recevra bientôt un message électronique contenant un lien leur permettant de réinitialiser leur mot de passe.</span><span class="sxs-lookup"><span data-stu-id="f4244-123">The user will soon get an email with a link allowing them to reset their password.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image6.png)  
<span data-ttu-id="f4244-124">En cliquant sur le lien mène à la page de réinitialisation.</span><span class="sxs-lookup"><span data-stu-id="f4244-124">Clicking the link will take them to the Reset page.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image7.png)  
  
<span data-ttu-id="f4244-125">En cliquant sur le **réinitialiser** bouton pour confirmer le mot de passe a été réinitialisé.</span><span class="sxs-lookup"><span data-stu-id="f4244-125">Clicking the **Reset** button will confirm the password has been reset.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image8.png)

<a id="createMvc"></a>

## <a name="create-an-aspnet-web-app"></a><span data-ttu-id="f4244-126">Créer une application Web ASP.NET</span><span class="sxs-lookup"><span data-stu-id="f4244-126">Create an ASP.NET Web app</span></span>

<span data-ttu-id="f4244-127">Commencez par installer et exécuter [Visual Studio Express 2013 pour le Web](https://go.microsoft.com/fwlink/?LinkId=299058) ou [Visual Studio 2013](https://go.microsoft.com/fwlink/?LinkId=306566).</span><span class="sxs-lookup"><span data-stu-id="f4244-127">Start by installing and running [Visual Studio Express 2013 for Web](https://go.microsoft.com/fwlink/?LinkId=299058) or [Visual Studio 2013](https://go.microsoft.com/fwlink/?LinkId=306566).</span></span> <span data-ttu-id="f4244-128">Installation de Visual Studio [2013 Update 2](https://go.microsoft.com/fwlink/?LinkId=390521) ou une version ultérieure.</span><span class="sxs-lookup"><span data-stu-id="f4244-128">Install Visual Studio [2013 Update 2](https://go.microsoft.com/fwlink/?LinkId=390521) or higher.</span></span>

> [!NOTE]
> <span data-ttu-id="f4244-129">Avertissement : Vous devez installer Visual Studio [2013 Update 2](https://go.microsoft.com/fwlink/?LinkId=390521) pour effectuer ce didacticiel.</span><span class="sxs-lookup"><span data-stu-id="f4244-129">Warning: You must install Visual Studio [2013 Update 2](https://go.microsoft.com/fwlink/?LinkId=390521) to complete this tutorial.</span></span>


1. <span data-ttu-id="f4244-130">Créez un projet Web ASP.NET et sélectionnez le modèle MVC.</span><span class="sxs-lookup"><span data-stu-id="f4244-130">Create a new ASP.NET Web project and select the MVC template.</span></span> <span data-ttu-id="f4244-131">Web Forms prend également en charge ASP.NET Identity, afin que vous pouvez suivre des étapes similaires dans une application de formulaires web.</span><span class="sxs-lookup"><span data-stu-id="f4244-131">Web Forms also supports ASP.NET Identity, so you could follow similar steps in a web forms app.</span></span>
2. <span data-ttu-id="f4244-132">Laissez l’authentification par défaut en tant que **comptes d’utilisateur individuels**.</span><span class="sxs-lookup"><span data-stu-id="f4244-132">Leave the default authentication as **Individual User Accounts**.</span></span>
3. <span data-ttu-id="f4244-133">Exécuter l’application, cliquez sur le **inscrire** lier et inscrire un utilisateur.</span><span class="sxs-lookup"><span data-stu-id="f4244-133">Run the app, click the **Register** link and register a user.</span></span> <span data-ttu-id="f4244-134">À ce stade, la seule validation de l’adresse de messagerie est avec le [[EmailAddress]](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx) attribut.</span><span class="sxs-lookup"><span data-stu-id="f4244-134">At this point, the only validation on the email is with the [[EmailAddress]](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx) attribute.</span></span>
4. <span data-ttu-id="f4244-135">Dans l’Explorateur de serveurs, accédez à **données Connections\DefaultConnection\Tables\AspNetUsers**avec le bouton droit sur et sélectionnez **ouvrir la définition de la table**.</span><span class="sxs-lookup"><span data-stu-id="f4244-135">In Server Explorer, navigate to **Data Connections\DefaultConnection\Tables\AspNetUsers**, right click and select **Open table definition**.</span></span>

    <span data-ttu-id="f4244-136">L’illustration suivante montre le `AspNetUsers` schéma :</span><span class="sxs-lookup"><span data-stu-id="f4244-136">The following image shows the `AspNetUsers` schema:</span></span>

    ![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image9.png)
5. <span data-ttu-id="f4244-137">Cliquez avec le bouton droit sur le **AspNetUsers** de table et sélectionnez **afficher les données de Table**.</span><span class="sxs-lookup"><span data-stu-id="f4244-137">Right click on the **AspNetUsers** table and select **Show Table Data**.</span></span>  
  
    ![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image10.png)  
  
   <span data-ttu-id="f4244-138">À ce stade l’adresse de messagerie n’a pas été confirmé.</span><span class="sxs-lookup"><span data-stu-id="f4244-138">At this point the email has not been confirmed.</span></span>

<span data-ttu-id="f4244-139">Le magasin de données par défaut pour ASP.NET Identity est Entity Framework, mais vous pouvez le configurer pour utiliser d’autres magasins de données et ajouter des champs supplémentaires.</span><span class="sxs-lookup"><span data-stu-id="f4244-139">The default data store for ASP.NET Identity is Entity Framework, but you can configure it to use other data stores and to add additional fields.</span></span> <span data-ttu-id="f4244-140">Consultez [des ressources supplémentaires](#addRes) section à la fin de ce didacticiel.</span><span class="sxs-lookup"><span data-stu-id="f4244-140">See [Additional Resources](#addRes) section at the end of this tutorial.</span></span>

<span data-ttu-id="f4244-141">Le [classe de démarrage OWIN](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) ( *Startup.cs* ) est appelée lorsque l’application démarre et appelle le `ConfigureAuth` méthode dans *application\_Start\Startup.Auth.cs*, qui configure le pipeline OWIN et initialise l’identité ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="f4244-141">The [OWIN startup class](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) ( *Startup.cs* ) is called when the app starts and invokes the `ConfigureAuth` method in *App\_Start\Startup.Auth.cs*, which configures the OWIN pipeline and initializes ASP.NET Identity.</span></span> <span data-ttu-id="f4244-142">Examinez le `ConfigureAuth` (méthode).</span><span class="sxs-lookup"><span data-stu-id="f4244-142">Examine the `ConfigureAuth` method.</span></span> <span data-ttu-id="f4244-143">Chaque `CreatePerOwinContext` appel enregistre un rappel (enregistré dans le `OwinContext`) qui sera appelé une fois par demande pour créer une instance du type spécifié.</span><span class="sxs-lookup"><span data-stu-id="f4244-143">Each `CreatePerOwinContext` call registers a callback (saved in the `OwinContext`) that will be called once per request to create an instance of the specified type.</span></span> <span data-ttu-id="f4244-144">Vous pouvez définir un point d’arrêt dans le constructeur et `Create` de chaque type (méthode) (`ApplicationDbContext, ApplicationUserManager`) et vérifier qu’ils sont appelés à chaque demande.</span><span class="sxs-lookup"><span data-stu-id="f4244-144">You can set a break point in the constructor and `Create` method of each type (`ApplicationDbContext, ApplicationUserManager`) and verify they are called on each request.</span></span> <span data-ttu-id="f4244-145">Une instance de `ApplicationDbContext` et `ApplicationUserManager` est stocké dans le contexte OWIN, qui est accessible dans l’ensemble de l’application.</span><span class="sxs-lookup"><span data-stu-id="f4244-145">A instance of `ApplicationDbContext` and `ApplicationUserManager` is stored in the OWIN context, which can be accessed throughout the application.</span></span> <span data-ttu-id="f4244-146">ASP.NET Identity raccorde le pipeline OWIN via l’intergiciel (middleware) du cookie.</span><span class="sxs-lookup"><span data-stu-id="f4244-146">ASP.NET Identity hooks into the OWIN pipeline through cookie middleware.</span></span> <span data-ttu-id="f4244-147">Pour plus d’informations, consultez [par la gestion des demandes de durée de vie pour la classe UserManager dans ASP.NET Identity](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx).</span><span class="sxs-lookup"><span data-stu-id="f4244-147">For more information, see [Per request lifetime management for UserManager class in ASP.NET Identity](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx).</span></span>

<span data-ttu-id="f4244-148">Lorsque vous modifiez votre profil de sécurité, un nouvel horodatage de sécurité est généré et stocké dans le `SecurityStamp` champ le *AspNetUsers* table.</span><span class="sxs-lookup"><span data-stu-id="f4244-148">When you change your security profile, a new security stamp is generated and stored in the `SecurityStamp` field of the *AspNetUsers* table.</span></span> <span data-ttu-id="f4244-149">Notez que le `SecurityStamp` champ est différent à partir du cookie de sécurité.</span><span class="sxs-lookup"><span data-stu-id="f4244-149">Note, the `SecurityStamp` field is different from the security cookie.</span></span> <span data-ttu-id="f4244-150">Le cookie de sécurité n’est pas stocké dans le `AspNetUsers` table (ou ailleurs dans la base de données d’identité).</span><span class="sxs-lookup"><span data-stu-id="f4244-150">The security cookie is not stored in the `AspNetUsers` table (or anywhere else in the Identity DB).</span></span> <span data-ttu-id="f4244-151">Le jeton de cookie de sécurité est auto-signé à l’aide de [DPAPI](https://msdn.microsoft.com/library/system.security.cryptography.protecteddata.aspx) et est créé avec le `UserId, SecurityStamp` et les informations d’heure d’expiration.</span><span class="sxs-lookup"><span data-stu-id="f4244-151">The security cookie token is self-signed using [DPAPI](https://msdn.microsoft.com/library/system.security.cryptography.protecteddata.aspx) and is created with the `UserId, SecurityStamp` and expiration time information.</span></span>

<span data-ttu-id="f4244-152">Le middleware du cookie vérifie le cookie à chaque demande.</span><span class="sxs-lookup"><span data-stu-id="f4244-152">The cookie middleware checks the cookie on each request.</span></span> <span data-ttu-id="f4244-153">Le `SecurityStampValidator` méthode dans le `Startup` classe accède à la base de données et vérifie périodiquement, de tampon de sécurité tel que spécifié par le `validateInterval`.</span><span class="sxs-lookup"><span data-stu-id="f4244-153">The `SecurityStampValidator` method in the `Startup` class hits the DB and checks security stamp periodically, as specified with the `validateInterval`.</span></span> <span data-ttu-id="f4244-154">Cela se produit uniquement toutes les 30 minutes (dans notre exemple), sauf si vous modifiez votre profil de sécurité.</span><span class="sxs-lookup"><span data-stu-id="f4244-154">This only happens every 30 minutes (in our sample) unless you change your security profile.</span></span> <span data-ttu-id="f4244-155">L’intervalle de 30 minutes a été choisi pour réduire les allers-retours vers la base de données.</span><span class="sxs-lookup"><span data-stu-id="f4244-155">The 30 minute interval was chosen to minimize trips to the database.</span></span> <span data-ttu-id="f4244-156">Voir mon [didacticiel d’authentification à deux facteurs](index.md) pour plus d’informations.</span><span class="sxs-lookup"><span data-stu-id="f4244-156">See my [two-factor authentication tutorial](index.md) for more details.</span></span>

<span data-ttu-id="f4244-157">Par les commentaires dans le code, le `UseCookieAuthentication` méthode prend en charge l’authentification de cookie.</span><span class="sxs-lookup"><span data-stu-id="f4244-157">Per the comments in the code, the `UseCookieAuthentication` method supports cookie authentication.</span></span> <span data-ttu-id="f4244-158">Le `SecurityStamp` code de champ et associé fournit une couche supplémentaire de sécurité à votre application, lorsque vous modifiez votre mot de passe, vous serez connecté hors du navigateur que vous êtes connecté.</span><span class="sxs-lookup"><span data-stu-id="f4244-158">The `SecurityStamp` field and associated code provides an extra layer of security to your app, when you change your password, you will be logged out of the browser you logged in with.</span></span> <span data-ttu-id="f4244-159">Le `SecurityStampValidator.OnValidateIdentity` méthode permet de valider le jeton de sécurité lorsque l’utilisateur se connecte, l’application qui est utilisée lorsque vous modifiez un mot de passe ou utilisez la connexion externe.</span><span class="sxs-lookup"><span data-stu-id="f4244-159">The `SecurityStampValidator.OnValidateIdentity` method enables the app to validate the security token when the user logs in, which is used when you change a password or use the external login.</span></span> <span data-ttu-id="f4244-160">Cela est nécessaire pour s’assurer que les jetons (cookies) générés avec l’ancien mot de passe sont invalidés.</span><span class="sxs-lookup"><span data-stu-id="f4244-160">This is needed to ensure that any tokens (cookies) generated with the old password are invalidated.</span></span> <span data-ttu-id="f4244-161">Dans l’exemple de projet, si vous modifiez le mot de passe utilisateurs, puis un nouveau jeton est généré pour l’utilisateur, des jetons précédentes sont invalidées et `SecurityStamp` est mis à jour.</span><span class="sxs-lookup"><span data-stu-id="f4244-161">In the sample project, if you change the users password then a new token is generated for the user, any previous tokens are invalidated and the `SecurityStamp` field is updated.</span></span>

<span data-ttu-id="f4244-162">Le système d’identité vous autorise à configurer votre application, lorsque le profil de sécurité des utilisateurs change (par exemple, lorsque l’utilisateur modifie son mot de passe ou les modifications associé les nom de connexion (par exemple de Facebook, Google, compte Microsoft, etc.), l’utilisateur est connecté en dehors de toutes les instances du navigateur.</span><span class="sxs-lookup"><span data-stu-id="f4244-162">The Identity system allow you to configure your app so when the users security profile changes (for example, when the user changes their password or changes associated login (such as from Facebook, Google, Microsoft account, etc.), the user is logged out of all browser instances.</span></span> <span data-ttu-id="f4244-163">Par exemple, l’image ci-dessous montre les [déconnexion unique exemple](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt) application, ce qui permet à l’utilisateur pour vous déconnecter de toutes les instances du navigateur (dans ce cas, Internet Explorer, Firefox et Chrome) en cliquant sur un bouton.</span><span class="sxs-lookup"><span data-stu-id="f4244-163">For example, the image below shows the [Single signout sample](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt) app, which allows the user to sign out of all browser instances (in this case, IE, Firefox and Chrome) by clicking one button.</span></span> <span data-ttu-id="f4244-164">Vous pouvez également l’exemple vous permet d’enregistrer uniquement en dehors d’une instance du navigateur spécifique.</span><span class="sxs-lookup"><span data-stu-id="f4244-164">Alternatively, the sample allows you to only log out of a specific browser instance.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image11.png)

<span data-ttu-id="f4244-165">Le [déconnexion unique exemple](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt) application montre comment ASP.NET Identity vous permet de régénérer le jeton de sécurité.</span><span class="sxs-lookup"><span data-stu-id="f4244-165">The [Single signout sample](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt) app shows how ASP.NET Identity allows you to regenerate the security token.</span></span> <span data-ttu-id="f4244-166">Cela est nécessaire pour s’assurer que les jetons (cookies) générés avec l’ancien mot de passe sont invalidés.</span><span class="sxs-lookup"><span data-stu-id="f4244-166">This is needed to ensure that any tokens (cookies) generated with the old password are invalidated.</span></span> <span data-ttu-id="f4244-167">Cette fonctionnalité fournit une couche supplémentaire de sécurité à votre application ; Lorsque vous modifiez votre mot de passe, vous allez être déconnecté d’où vous vous êtes connecté à cette application.</span><span class="sxs-lookup"><span data-stu-id="f4244-167">This feature provides an extra layer of security to your application; when you change your password, you will be logged out where you have logged into this application.</span></span>

<span data-ttu-id="f4244-168">Le *application\_Start\IdentityConfig.cs* fichier contient le `ApplicationUserManager`, `EmailService` et `SmsService` classes.</span><span class="sxs-lookup"><span data-stu-id="f4244-168">The *App\_Start\IdentityConfig.cs* file contains the `ApplicationUserManager`, `EmailService` and `SmsService` classes.</span></span> <span data-ttu-id="f4244-169">Le `EmailService` et `SmsService` classes chaque implémentent la `IIdentityMessageService` interface contient les méthodes courantes de chaque classe pour configurer la messagerie électronique et SMS.</span><span class="sxs-lookup"><span data-stu-id="f4244-169">The `EmailService` and `SmsService` classes each implement the `IIdentityMessageService` interface, so you have common methods in each class to configure email and SMS.</span></span> <span data-ttu-id="f4244-170">Bien que ce didacticiel montre uniquement comment ajouter la notification par courrier électronique via [SendGrid](http://sendgrid.com/), vous pouvez envoyer un e-mail à l’aide de SMTP et autres mécanismes.</span><span class="sxs-lookup"><span data-stu-id="f4244-170">Although this tutorial only shows how to add email notification through [SendGrid](http://sendgrid.com/), you can send email using SMTP and other mechanisms.</span></span>

<span data-ttu-id="f4244-171">Le `Startup` classe contient également la maquette pour ajouter des connexions sociale (Facebook, Twitter, etc.), consultez mon didacticiel [MVC 5 application Facebook, Twitter, LinkedIn et d’authentification Google OAuth2](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) pour plus d’informations.</span><span class="sxs-lookup"><span data-stu-id="f4244-171">The `Startup` class also contains boiler plate to add social logins (Facebook, Twitter, etc.), see my tutorial [MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) for more info.</span></span>

<span data-ttu-id="f4244-172">Examinez le `ApplicationUserManager` (classe), qui contient les informations d’identité utilisateur et configure les fonctionnalités suivantes :</span><span class="sxs-lookup"><span data-stu-id="f4244-172">Examine the `ApplicationUserManager` class, which contains the users identity information and configures the following features:</span></span>

- <span data-ttu-id="f4244-173">Exigences de force du mot de passe.</span><span class="sxs-lookup"><span data-stu-id="f4244-173">Password strength requirements.</span></span>
- <span data-ttu-id="f4244-174">Utilisateur verrouillage (tentatives et l’heure).</span><span class="sxs-lookup"><span data-stu-id="f4244-174">User lock out (attempts and time).</span></span>
- <span data-ttu-id="f4244-175">Authentification à deux facteurs (2FA).</span><span class="sxs-lookup"><span data-stu-id="f4244-175">Two-factor authentication (2FA).</span></span> <span data-ttu-id="f4244-176">Je vais aborder 2FA et SMS dans un autre didacticiel.</span><span class="sxs-lookup"><span data-stu-id="f4244-176">I'll cover 2FA and SMS in another tutorial.</span></span>
- <span data-ttu-id="f4244-177">Raccorder le courrier électronique et les services SMS.</span><span class="sxs-lookup"><span data-stu-id="f4244-177">Hooking up the email and SMS services.</span></span> <span data-ttu-id="f4244-178">(Je vais aborder SMS dans un autre didacticiel).</span><span class="sxs-lookup"><span data-stu-id="f4244-178">(I'll cover SMS in another tutorial).</span></span>

<span data-ttu-id="f4244-179">Le `ApplicationUserManager` classe est dérivée de l’objet générique `UserManager<ApplicationUser>` classe.</span><span class="sxs-lookup"><span data-stu-id="f4244-179">The `ApplicationUserManager` class derives from the generic `UserManager<ApplicationUser>` class.</span></span> <span data-ttu-id="f4244-180">`ApplicationUser` dérive de [IdentityUser](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework.identityuser.aspx).</span><span class="sxs-lookup"><span data-stu-id="f4244-180">`ApplicationUser` derives from [IdentityUser](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework.identityuser.aspx).</span></span> <span data-ttu-id="f4244-181">`IdentityUser` dérive de l’objet générique `IdentityUser` classe :</span><span class="sxs-lookup"><span data-stu-id="f4244-181">`IdentityUser` derives from the generic `IdentityUser` class:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample1.cs)]

<span data-ttu-id="f4244-182">Les propriétés ci-dessus coïncident avec les propriétés de le `AspNetUsers` tableau, ci-dessus.</span><span class="sxs-lookup"><span data-stu-id="f4244-182">The properties above coincide with the properties in the `AspNetUsers` table, shown above.</span></span>

<span data-ttu-id="f4244-183">Les arguments génériques sur `IUser` vous permettent de dériver une classe à l’aide de différents types pour la clé primaire.</span><span class="sxs-lookup"><span data-stu-id="f4244-183">Generic arguments on `IUser` enable you to derive a class using different types for the primary key.</span></span> <span data-ttu-id="f4244-184">Consultez le [ChangePK](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/ChangePK/readme.txt) exemple qui montre comment modifier la clé primaire à partir de la chaîne en int ou GUID.</span><span class="sxs-lookup"><span data-stu-id="f4244-184">See the [ChangePK](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/ChangePK/readme.txt) sample which shows how to change the primary key from string to int or GUID.</span></span>

### <a name="applicationuser"></a><span data-ttu-id="f4244-185">ApplicationUser</span><span class="sxs-lookup"><span data-stu-id="f4244-185">ApplicationUser</span></span>

<span data-ttu-id="f4244-186">`ApplicationUser` (`public class ApplicationUserManager : UserManager<ApplicationUser>`) est défini dans *Models\IdentityModels.cs* en tant que :</span><span class="sxs-lookup"><span data-stu-id="f4244-186">`ApplicationUser` (`public class ApplicationUserManager : UserManager<ApplicationUser>`) is defined in *Models\IdentityModels.cs* as:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample2.cs?highlight=8-9)]

<span data-ttu-id="f4244-187">Le code en surbrillance ci-dessus génère une [ClaimsIdentity](https://msdn.microsoft.com/library/system.security.claims.claimsidentity.aspx).</span><span class="sxs-lookup"><span data-stu-id="f4244-187">The highlighted code above generates a [ClaimsIdentity](https://msdn.microsoft.com/library/system.security.claims.claimsidentity.aspx).</span></span> <span data-ttu-id="f4244-188">Identité ASP.NET et authentification de Cookie OWIN basée sur les revendications, par conséquent, le framework requiert que l’application pour générer un `ClaimsIdentity` pour l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="f4244-188">ASP.NET Identity and OWIN Cookie Authentication are claims-based, therefore the framework requires the app to generate a `ClaimsIdentity` for the user.</span></span> <span data-ttu-id="f4244-189">`ClaimsIdentity` contient des informations sur toutes les revendications pour l’utilisateur, telles que le nom d’utilisateur, l’âge et les rôles de l’utilisateur appartient.</span><span class="sxs-lookup"><span data-stu-id="f4244-189">`ClaimsIdentity` has information about all the claims for the user, such as the user's name, age and what roles the user belongs to.</span></span> <span data-ttu-id="f4244-190">Vous pouvez également ajouter plusieurs revendications de l’utilisateur à ce stade.</span><span class="sxs-lookup"><span data-stu-id="f4244-190">You can also add more claims for the user at this stage.</span></span>

<span data-ttu-id="f4244-191">OWIN `AuthenticationManager.SignIn` méthode passe dans le `ClaimsIdentity` et se connecte l’utilisateur :</span><span class="sxs-lookup"><span data-stu-id="f4244-191">The OWIN `AuthenticationManager.SignIn` method passes in the `ClaimsIdentity` and signs in the user:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample3.cs?highlight=4-6)]

<span data-ttu-id="f4244-192">[Application MVC est 5 avec Facebook, Twitter, LinkedIn et d’authentification Google OAuth2](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) montre comment vous pouvez ajouter des propriétés supplémentaires pour la `ApplicationUser` classe.</span><span class="sxs-lookup"><span data-stu-id="f4244-192">[MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) shows how you can add additional properties to the `ApplicationUser` class.</span></span>

## <a name="email-confirmation"></a><span data-ttu-id="f4244-193">E-mail de confirmation</span><span class="sxs-lookup"><span data-stu-id="f4244-193">Email confirmation</span></span>

<span data-ttu-id="f4244-194">Il est judicieux de confirmer l’adresse de messagerie un nouvel utilisateur auprès de vérifier qu’ils n’empruntent pas une autre personne (autrement dit, ils n’ont pas inscrit avec par quelqu'un d’autre adresse de messagerie).</span><span class="sxs-lookup"><span data-stu-id="f4244-194">It's a good idea to confirm the email a new user register with to verify they are not impersonating someone else (that is, they haven't registered with someone else's email).</span></span> <span data-ttu-id="f4244-195">Supposons que vous aviez un forum de discussion, vous pouvez empêcher `"bob@example.com"` lors de l’inscription en tant que `"joe@contoso.com"`.</span><span class="sxs-lookup"><span data-stu-id="f4244-195">Suppose you had a discussion forum, you would want to prevent `"bob@example.com"` from registering as `"joe@contoso.com"`.</span></span> <span data-ttu-id="f4244-196">Sans la confirmation par courrier électronique, `"joe@contoso.com"` Impossible d’obtenir le courrier indésirable à partir de votre application.</span><span class="sxs-lookup"><span data-stu-id="f4244-196">Without email confirmation, `"joe@contoso.com"` could get unwanted email from your app.</span></span> <span data-ttu-id="f4244-197">Supposons que Bob accidentellement inscrit en tant que `"bib@example.com"` et vous n’aviez pas remarqué, il ne serait pas en mesure d’utiliser le mot de passe de récupération, car l’application n’a pas son e-mail valable.</span><span class="sxs-lookup"><span data-stu-id="f4244-197">Suppose Bob accidently registered as `"bib@example.com"` and hadn't noticed it, he wouldn't be able to use password recover because the app doesn't have his correct email.</span></span> <span data-ttu-id="f4244-198">E-mail de confirmation offre uniquement une protection limitée de robots et ne fournit la protection à partir des expéditeurs déterminés, ils ont plusieurs alias de messagerie de travail qu’ils peuvent utiliser pour enregistrer. Dans l’exemple ci-dessous, l’utilisateur ne pourra plus être modifier leur mot de passe jusqu'à ce que leur compte a été confirmé (en fonction de celles-ci en cliquant sur un lien de confirmation reçu sur le compte de messagerie qu’ils utilisent.) Vous pouvez appliquer ce flux de travail à d’autres scénarios, par exemple envoyer un lien pour confirmer et réinitialiser le mot de passe sur les nouveaux comptes créés par l’administrateur, des e-mails de l’utilisateur lorsqu’ils ont modifié leur profil et ainsi de suite.</span><span class="sxs-lookup"><span data-stu-id="f4244-198">Email confirmation provides only limited protection from bots and doesn't provide protection from determined spammers, they have many working email aliases they can use to register.In the sample below, the user won't be able to change their password until their account has been confirmed (by them clicking on a confirmation link received on the email account they registered with.) You can apply this work flow to other scenarios, for example sending a link to confirm and reset the password on new accounts created by the administrator, sending the user an email when they have changed their profile and so on.</span></span> <span data-ttu-id="f4244-199">En règle générale, vous souhaitez empêcher les nouveaux utilisateurs à partir de la validation des données à votre site web avant qu’ils ont été confirmées par courrier électronique, un message texte ou un autre mécanisme.</span><span class="sxs-lookup"><span data-stu-id="f4244-199">You generally want to prevent new users from posting any data to your web site before they have been confirmed by email, a SMS text message or another mechanism.</span></span> <a id="build"></a>

## <a name="building-a-more-complete-sample"></a><span data-ttu-id="f4244-200">Création d’un exemple plus complet</span><span class="sxs-lookup"><span data-stu-id="f4244-200">Building a more complete sample</span></span>

<span data-ttu-id="f4244-201">Dans cette section, vous utiliserez NuGet pour télécharger un exemple plus complet que nous travaillons avec.</span><span class="sxs-lookup"><span data-stu-id="f4244-201">In this section, you'll use NuGet to download a more complete sample we will work with.</span></span>

1. <span data-ttu-id="f4244-202">Créer un nouveau ***vide*** projet Web ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="f4244-202">Create a new ***empty*** ASP.NET Web project.</span></span>
2. <span data-ttu-id="f4244-203">Dans la Console du Gestionnaire de Package, entrez ce qui suit les commandes suivantes :</span><span class="sxs-lookup"><span data-stu-id="f4244-203">In the Package Manager Console, enter the following the following commands:</span></span> 

    [!code-console[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample4.cmd)]

   <span data-ttu-id="f4244-204">Dans ce didacticiel, nous allons utiliser [SendGrid](http://sendgrid.com/) pour envoyer un courrier électronique.</span><span class="sxs-lookup"><span data-stu-id="f4244-204">In this tutorial, we'll use [SendGrid](http://sendgrid.com/) to send email.</span></span> <span data-ttu-id="f4244-205">Le `Identity.Samples` package installe le code que nous travaillerons avec.</span><span class="sxs-lookup"><span data-stu-id="f4244-205">The `Identity.Samples` package installs the code we will be working with.</span></span>
3. <span data-ttu-id="f4244-206">Définir le [projet pour utiliser SSL](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).</span><span class="sxs-lookup"><span data-stu-id="f4244-206">Set the [project to use SSL](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).</span></span>
4. <span data-ttu-id="f4244-207">La création du compte local de test en exécutant l’application, en cliquant sur le **inscrire** la liaison et la validation de l’écran d’enregistrement.</span><span class="sxs-lookup"><span data-stu-id="f4244-207">Test local account creation by running the app, clicking on the **Register** link, and posting the registration form.</span></span>
5. <span data-ttu-id="f4244-208">Cliquez sur le lien de la messagerie de démonstration, qui simule l’e-mail de confirmation.</span><span class="sxs-lookup"><span data-stu-id="f4244-208">Click the demo email link, which simulates email confirmation.</span></span>
6. <span data-ttu-id="f4244-209">Supprimer le code de confirmation de lien démonstration par courrier électronique à partir de l’exemple (le `ViewBag.Link` code dans le contrôleur de compte.</span><span class="sxs-lookup"><span data-stu-id="f4244-209">Remove the demo email link confirmation code from the sample (The `ViewBag.Link` code in the account controller.</span></span> <span data-ttu-id="f4244-210">Consultez le `DisplayEmail` et `ForgotPasswordConfirmation` les méthodes d’action et des vues razor).</span><span class="sxs-lookup"><span data-stu-id="f4244-210">See the `DisplayEmail` and `ForgotPasswordConfirmation` action methods and razor views ).</span></span>

> [!NOTE]
> <span data-ttu-id="f4244-211">Avertissement : Si vous modifiez les paramètres de sécurité dans cet exemple, les applications de production devrez subir un audit de sécurité qui appelle explicitement les modifications apportées.</span><span class="sxs-lookup"><span data-stu-id="f4244-211">Warning: If you change any of the security settings in this sample, productions apps will need to undergo a security audit that explicitly calls the changes made.</span></span>


## <a name="examine-the-code-in-appstartidentityconfigcs"></a><span data-ttu-id="f4244-212">Examinez le code dans l’application\_Start\IdentityConfig.cs</span><span class="sxs-lookup"><span data-stu-id="f4244-212">Examine the code in App\_Start\IdentityConfig.cs</span></span>

<span data-ttu-id="f4244-213">L’exemple montre comment créer un compte et l’ajouter à la *Admin* rôle.</span><span class="sxs-lookup"><span data-stu-id="f4244-213">The sample shows how to create an account and add it to the *Admin* role.</span></span> <span data-ttu-id="f4244-214">Vous devez remplacer le courrier électronique dans l’exemple avec le message électronique que vous utiliserez pour le compte d’administrateur.</span><span class="sxs-lookup"><span data-stu-id="f4244-214">You should replace the email in the sample with the email you will be using for the admin account.</span></span> <span data-ttu-id="f4244-215">Le moyen le plus simple pour créer un compte d’administrateur est par programmation dans le `Seed` (méthode).</span><span class="sxs-lookup"><span data-stu-id="f4244-215">The easiest way right now to create an administrator account is programmatically in the `Seed` method.</span></span> <span data-ttu-id="f4244-216">Nous espérons que d’avoir à l’avenir un outil qui vous permet de créer et administrer des utilisateurs et des rôles.</span><span class="sxs-lookup"><span data-stu-id="f4244-216">We hope to have a tool in the future that will allow you to create and administer users and roles.</span></span> <span data-ttu-id="f4244-217">L’exemple de code vous permettent de créer et gérer des utilisateurs et des rôles, mais vous devez avoir un compte d’administrateurs pour exécuter les rôles et les pages d’administration de l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="f4244-217">The sample code does let you create and manage users and roles, but you must first have an administrators account to run the roles and user admin pages.</span></span> <span data-ttu-id="f4244-218">Dans cet exemple, le compte d’administrateur est créé lors de l’amorçage de la base de données.</span><span class="sxs-lookup"><span data-stu-id="f4244-218">In this sample, the admin account is created when the DB is seeded.</span></span>

<span data-ttu-id="f4244-219">Remplacez le mot de passe et le nom à un compte dans lequel vous pouvez recevoir des notifications par courrier électronique.</span><span class="sxs-lookup"><span data-stu-id="f4244-219">Change the password and change the name to an account where you can receive email notifications.</span></span>

> [!WARNING]
> <span data-ttu-id="f4244-220">Sécurité - magasin jamais des données sensibles dans votre code source.</span><span class="sxs-lookup"><span data-stu-id="f4244-220">Security - Never store sensitive data in your source code.</span></span>

<span data-ttu-id="f4244-221">Comme mentionné précédemment, le `app.CreatePerOwinContext` appel dans la classe de démarrage ajoute des rappels pour les `Create` méthode l’application base de données contenus, manager et le rôle Gestionnaire de classes d’utilisateurs.</span><span class="sxs-lookup"><span data-stu-id="f4244-221">As mentioned previously, the `app.CreatePerOwinContext` call in the startup class adds callbacks to the `Create` method of the app DB content, user manager and role manger classes.</span></span> <span data-ttu-id="f4244-222">Appels de pipeline OWIN le `Create` méthode sur ces classes pour chaque demande et stocke le contexte pour chaque classe.</span><span class="sxs-lookup"><span data-stu-id="f4244-222">The OWIN pipeline calls the `Create` method on these classes for each request and stores the context for each class.</span></span> <span data-ttu-id="f4244-223">Le contrôleur de compte expose le Gestionnaire des utilisateurs à partir du contexte HTTP (qui contient le contexte OWIN) :</span><span class="sxs-lookup"><span data-stu-id="f4244-223">The account controller exposes the user manager from the HTTP context (which contains the OWIN context):</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample5.cs)]

<span data-ttu-id="f4244-224">Lorsqu’un utilisateur s’inscrit à un compte local, le `HTTP Post Register` méthode est appelée :</span><span class="sxs-lookup"><span data-stu-id="f4244-224">When a user registers a local account, the `HTTP Post Register` method is called:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample6.cs)]

<span data-ttu-id="f4244-225">Le code ci-dessus utilise les données du modèle pour créer un nouveau compte d’utilisateur à l’aide de la messagerie et le mot de passe entré.</span><span class="sxs-lookup"><span data-stu-id="f4244-225">The code above uses the model data to create a new user account using the email and password entered.</span></span> <span data-ttu-id="f4244-226">Si l’alias de messagerie se trouve dans le magasin de données, la création du compte échoue et le formulaire s’affiche à nouveau.</span><span class="sxs-lookup"><span data-stu-id="f4244-226">If the email alias is in the data store, account creation fails and the form is displayed again.</span></span> <span data-ttu-id="f4244-227">Le `GenerateEmailConfirmationTokenAsync` méthode crée un jeton de confirmation sécurisé et le stocke dans le magasin de données d’identité ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="f4244-227">The `GenerateEmailConfirmationTokenAsync` method creates a secure confirmation token and stores it in the ASP.NET Identity data store.</span></span> <span data-ttu-id="f4244-228">Le [Url.Action](https://msdn.microsoft.com/library/dd505232(v=vs.118).aspx) méthode crée un lien contenant le `UserId` et le jeton de confirmation.</span><span class="sxs-lookup"><span data-stu-id="f4244-228">The [Url.Action](https://msdn.microsoft.com/library/dd505232(v=vs.118).aspx) method creates a link containing the `UserId` and confirmation token.</span></span> <span data-ttu-id="f4244-229">Ce lien est envoyé par courrier électronique à l’utilisateur, l’utilisateur peut cliquer sur le lien dans leur application de messagerie pour confirmer son compte.</span><span class="sxs-lookup"><span data-stu-id="f4244-229">This link is then emailed to the user, the user can click on the link in their email app to confirm their account.</span></span>

<a id="email"></a>

## <a name="set-up-email-confirmation"></a><span data-ttu-id="f4244-230">Configurer la confirmation par courrier électronique</span><span class="sxs-lookup"><span data-stu-id="f4244-230">Set up email confirmation</span></span>

<span data-ttu-id="f4244-231">Accédez à la [page d’inscription Azure SendGrid](https://azure.microsoft.com/gallery/store/sendgrid/sendgrid-azure/) et enregistrer le compte gratuit.</span><span class="sxs-lookup"><span data-stu-id="f4244-231">Go to the [Azure SendGrid sign up page](https://azure.microsoft.com/gallery/store/sendgrid/sendgrid-azure/) and register for free account.</span></span> <span data-ttu-id="f4244-232">Ajoutez un code similaire à ce qui suit pour configurer SendGrid :</span><span class="sxs-lookup"><span data-stu-id="f4244-232">Add code similar to the following to configure SendGrid:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample7.cs?highlight=5)]

> [!NOTE]
> <span data-ttu-id="f4244-233">Souvent, les clients de messagerie acceptent uniquement les messages de texte (sans HTML).</span><span class="sxs-lookup"><span data-stu-id="f4244-233">Email clients frequently accept only text messages (no HTML).</span></span> <span data-ttu-id="f4244-234">Vous devez fournir le message texte et HTML.</span><span class="sxs-lookup"><span data-stu-id="f4244-234">You should provide the message in text and HTML.</span></span> <span data-ttu-id="f4244-235">Dans l’exemple SendGrid ci-dessus, cela est effectué avec la `myMessage.Text` et `myMessage.Html` code ci-dessus.</span><span class="sxs-lookup"><span data-stu-id="f4244-235">In the SendGrid sample above, this is done with the `myMessage.Text` and `myMessage.Html` code shown above.</span></span>


<span data-ttu-id="f4244-236">Le code suivant montre comment envoyer par courrier électronique en utilisant le [MailMessage](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx) classe where `message.Body` retourne uniquement le lien.</span><span class="sxs-lookup"><span data-stu-id="f4244-236">The following code shows how to send email using the [MailMessage](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx) class where `message.Body` returns only the link.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample8.cs)]

> [!WARNING]
> <span data-ttu-id="f4244-237">Sécurité - magasin jamais des données sensibles dans votre code source.</span><span class="sxs-lookup"><span data-stu-id="f4244-237">Security - Never store sensitive data in your source code.</span></span> <span data-ttu-id="f4244-238">Le compte et les informations d’identification sont stockées dans l’appSetting.</span><span class="sxs-lookup"><span data-stu-id="f4244-238">The account and credentials are stored in the appSetting.</span></span> <span data-ttu-id="f4244-239">Sur Azure, vous pouvez stocker en toute sécurité des ces valeurs sur le **[configurer](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)** onglet dans le portail Azure.</span><span class="sxs-lookup"><span data-stu-id="f4244-239">On Azure, you can securely store these values on the **[Configure](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)** tab in the Azure portal.</span></span> <span data-ttu-id="f4244-240">Consultez [meilleures pratiques pour le déploiement des mots de passe et autres données sensibles sur ASP.NET et Azure](best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure.md).</span><span class="sxs-lookup"><span data-stu-id="f4244-240">See [Best practices for deploying passwords and other sensitive data to ASP.NET and Azure](best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure.md).</span></span>


<span data-ttu-id="f4244-241">Entrez vos informations d’identification SendGrid, exécuter l’application, inscrire auprès d’un alias de messagerie pouvez cliquer sur le lien de confirmation dans votre adresse de messagerie.</span><span class="sxs-lookup"><span data-stu-id="f4244-241">Enter your SendGrid credentials, run the app, register with an email alias can click the confirm link in your email.</span></span> <span data-ttu-id="f4244-242">Pour savoir comment procéder avec votre [Outlook.com](http://outlook.com) le compte de messagerie, consultez de John Atten [Configuration SMTP c# pour l’hôte SMTP de Outlook.Com](http://typecastexception.com/post/2013/12/20/C-SMTP-Configuration-for-OutlookCom-SMTP-Host.aspx) et son[ASP.NET Identity 2.0 : Validation de compte et l’autorisation de deux facteurs](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) valide.</span><span class="sxs-lookup"><span data-stu-id="f4244-242">To see how to do this with your [Outlook.com](http://outlook.com) email account, see John Atten's [C# SMTP Configuration for Outlook.Com SMTP Host](http://typecastexception.com/post/2013/12/20/C-SMTP-Configuration-for-OutlookCom-SMTP-Host.aspx) and his[ASP.NET Identity 2.0: Setting Up Account Validation and Two-Factor Authorization](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) posts.</span></span>

<span data-ttu-id="f4244-243">Une fois qu’un utilisateur clique sur le **inscrire** bouton, un message électronique de confirmation qui contient un jeton de validation est envoyé à son adresse de messagerie.</span><span class="sxs-lookup"><span data-stu-id="f4244-243">Once a user clicks the **Register** button a confirmation email containing a validation token is sent to their email address.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image12.png)

<span data-ttu-id="f4244-244">L’utilisateur reçoit un message électronique avec un jeton de confirmation pour leur compte.</span><span class="sxs-lookup"><span data-stu-id="f4244-244">The user is sent an email with a confirmation token for their account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image13.png)

## <a name="examine-the-code"></a><span data-ttu-id="f4244-245">Examinez le code</span><span class="sxs-lookup"><span data-stu-id="f4244-245">Examine the code</span></span>

<span data-ttu-id="f4244-246">Le code suivant montre la méthode `POST ForgotPassword`.</span><span class="sxs-lookup"><span data-stu-id="f4244-246">The following code shows the `POST ForgotPassword` method.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample9.cs)]

<span data-ttu-id="f4244-247">La méthode échoue sans avertissement si l’e-mail de l’utilisateur n’a pas été confirmé.</span><span class="sxs-lookup"><span data-stu-id="f4244-247">The method fails silently if the user email has not been confirmed.</span></span> <span data-ttu-id="f4244-248">Si une erreur a été validée pour une adresse de messagerie non valide, les utilisateurs malveillants peuvent utiliser ces informations pour rechercher l’ID d’utilisateur valide (alias de messagerie) aux attaques.</span><span class="sxs-lookup"><span data-stu-id="f4244-248">If an error was posted for an invalid email address, malicious users could use that information to find valid userId (email aliases) to attack.</span></span>

<span data-ttu-id="f4244-249">Le code suivant illustre la `ConfirmEmail` méthode dans le contrôleur de compte qui est appelé lorsque l’utilisateur clique sur le lien de confirmation dans le message électronique envoyé à :</span><span class="sxs-lookup"><span data-stu-id="f4244-249">The following code shows the `ConfirmEmail` method in the account controller that is called when the user clicks the confirmation link in the email sent to them:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample10.cs)]

<span data-ttu-id="f4244-250">Une fois qu’un jeton de mot de passe oublié a été utilisé, elle est invalidée.</span><span class="sxs-lookup"><span data-stu-id="f4244-250">Once a forgotten password token has been used, it's invalidated.</span></span> <span data-ttu-id="f4244-251">Le changement de code suivant dans le `Create` (méthode) (dans le *application\_Start\IdentityConfig.cs* fichier) définit les jetons doit expirer dans 3 heures.</span><span class="sxs-lookup"><span data-stu-id="f4244-251">The following code change in the `Create` method (in the *App\_Start\IdentityConfig.cs* file) sets the tokens to expire in 3 hours.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample11.cs?highlight=6-8)]

<span data-ttu-id="f4244-252">Avec le code ci-dessus, le mot de passe oublié et les jetons de confirmation par courrier électronique va expirer dans 3 heures.</span><span class="sxs-lookup"><span data-stu-id="f4244-252">With the code above, the forgotten password and the email confirmation tokens will expire in 3 hours.</span></span> <span data-ttu-id="f4244-253">La valeur par défaut `TokenLifespan` est un jour.</span><span class="sxs-lookup"><span data-stu-id="f4244-253">The default `TokenLifespan` is one day.</span></span>

<span data-ttu-id="f4244-254">Le code suivant illustre la méthode de confirmation de courrier électronique :</span><span class="sxs-lookup"><span data-stu-id="f4244-254">The following code shows the email confirmation method:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample12.cs)]

 <span data-ttu-id="f4244-255">Pour sécuriser davantage votre application, ASP.NET Identity prend en charge l’authentification à deux facteurs (2FA).</span><span class="sxs-lookup"><span data-stu-id="f4244-255">To make your app more secure, ASP.NET Identity supports Two-Factor authentication (2FA).</span></span> <span data-ttu-id="f4244-256">Consultez [ASP.NET Identity 2.0 : configuration de la Validation du compte et l’autorisation de deux facteurs](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) par John Atten.</span><span class="sxs-lookup"><span data-stu-id="f4244-256">See [ASP.NET Identity 2.0: Setting Up Account Validation and Two-Factor Authorization](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) by John Atten.</span></span> <span data-ttu-id="f4244-257">Bien que vous pouvez définir le verrouillage de compte sur les échecs de tentatives de mot de passe de connexion, cette approche rend votre connexion susceptibles d’être [DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack) verrouillages.</span><span class="sxs-lookup"><span data-stu-id="f4244-257">Although you can set account lockout on login password attempt failures, that approach makes your login susceptible to [DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack) lockouts.</span></span> <span data-ttu-id="f4244-258">Nous vous recommandons de qu'utiliser le verrouillage de compte uniquement avec 2FA.</span><span class="sxs-lookup"><span data-stu-id="f4244-258">We recommend you use account lockout only with 2FA.</span></span>  
<a id="addRes"></a>

## <a name="additional-resources"></a><span data-ttu-id="f4244-259">Ressources supplémentaires</span><span class="sxs-lookup"><span data-stu-id="f4244-259">Additional Resources</span></span>

- [<span data-ttu-id="f4244-260">Vue d’ensemble des fournisseurs de stockage personnalisés pour ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="f4244-260">Overview of Custom Storage Providers for ASP.NET Identity</span></span>](../extensibility/overview-of-custom-storage-providers-for-aspnet-identity.md)
- <span data-ttu-id="f4244-261">[Application MVC est 5 avec Facebook, Twitter, LinkedIn et d’authentification Google OAuth2](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) montre également comment ajouter des informations de profil à la table des utilisateurs.</span><span class="sxs-lookup"><span data-stu-id="f4244-261">[MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) also shows how to add profile information to the users table.</span></span>
- <span data-ttu-id="f4244-262">[ASP.NET MVC et identité 2.0 : comprendre les aspects fondamentaux](http://typecastexception.com/post/2014/04/20/ASPNET-MVC-and-Identity-20-Understanding-the-Basics.aspx) par John Atten.</span><span class="sxs-lookup"><span data-stu-id="f4244-262">[ASP.NET MVC and Identity 2.0: Understanding the Basics](http://typecastexception.com/post/2014/04/20/ASPNET-MVC-and-Identity-20-Understanding-the-Basics.aspx) by John Atten.</span></span>
- [<span data-ttu-id="f4244-263">Introduction à ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="f4244-263">Introduction to ASP.NET Identity</span></span>](../getting-started/introduction-to-aspnet-identity.md)
- <span data-ttu-id="f4244-264">[Annonce de la version RTM d’ASP.NET Identity 2.0.0](https://blogs.msdn.com/b/webdev/archive/2014/03/20/test-announcing-rtm-of-asp-net-identity-2-0-0.aspx) par Pranav Rastogi.</span><span class="sxs-lookup"><span data-stu-id="f4244-264">[Announcing RTM of ASP.NET Identity 2.0.0](https://blogs.msdn.com/b/webdev/archive/2014/03/20/test-announcing-rtm-of-asp-net-identity-2-0-0.aspx) by Pranav Rastogi.</span></span>
