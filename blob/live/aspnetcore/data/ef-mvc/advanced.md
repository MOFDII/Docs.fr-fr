---
title: "ASP.NET Core MVC avec EF Core - avancée - 10 sur 10"
author: tdykstra
description: "Ce didacticiel présente des rubriques qui sont utiles à connaître lorsque vous dépassent les principes de base du développement d’applications web ASP.NET qui utilisent Entity Framework Core."
ms.author: tdykstra
manager: wpickett
ms.date: 03/15/2017
ms.topic: get-started-article
ms.technology: aspnet
ms.prod: asp.net-core
uid: data/ef-mvc/advanced
ms.openlocfilehash: ea83e5b17df80e5615dda49335247340d1cfb016
ms.sourcegitcommit: 3e303620a125325bb9abd4b2d315c106fb8c47fd
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/19/2018
---
# <a name="advanced-topics---ef-core-with-aspnet-core-mvc-tutorial-10-of-10"></a><span data-ttu-id="17f23-103">Rubriques avancées - Core EF avec le didacticiel d’ASP.NET MVC de base (10 10)</span><span class="sxs-lookup"><span data-stu-id="17f23-103">Advanced topics - EF Core with ASP.NET Core MVC tutorial (10 of 10)</span></span>

<span data-ttu-id="17f23-104">Par [Tom Dykstra](https://github.com/tdykstra) et [Rick Anderson](https://twitter.com/RickAndMSFT)</span><span class="sxs-lookup"><span data-stu-id="17f23-104">By [Tom Dykstra](https://github.com/tdykstra) and [Rick Anderson](https://twitter.com/RickAndMSFT)</span></span>

<span data-ttu-id="17f23-105">L’exemple d’application web Contoso University montre comment créer des applications web ASP.NET MVC de base à l’aide d’Entity Framework Core et Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="17f23-105">The Contoso University sample web application demonstrates how to create ASP.NET Core MVC web applications using Entity Framework Core and Visual Studio.</span></span> <span data-ttu-id="17f23-106">Pour plus d’informations sur la série de didacticiels, consultez [le premier didacticiel de la série](intro.md).</span><span class="sxs-lookup"><span data-stu-id="17f23-106">For information about the tutorial series, see [the first tutorial in the series](intro.md).</span></span>

<span data-ttu-id="17f23-107">Dans le didacticiel précédent, vous implémenté l’héritage table par hiérarchie.</span><span class="sxs-lookup"><span data-stu-id="17f23-107">In the previous tutorial, you implemented table-per-hierarchy inheritance.</span></span> <span data-ttu-id="17f23-108">Ce didacticiel présente des rubriques qui sont utiles à connaître lorsque vous dépassent les principes de base du développement d’applications web ASP.NET Core qui utilisent Entity Framework Core.</span><span class="sxs-lookup"><span data-stu-id="17f23-108">This tutorial introduces several topics that are useful to be aware of when you go beyond the basics of developing ASP.NET Core web applications that use Entity Framework Core.</span></span>

## <a name="raw-sql-queries"></a><span data-ttu-id="17f23-109">Requêtes SQL brut</span><span class="sxs-lookup"><span data-stu-id="17f23-109">Raw SQL Queries</span></span>

<span data-ttu-id="17f23-110">Un des avantages de l’utilisation d’Entity Framework est qu’elle évite de lier votre code trop près d’une méthode particulière du stockage des données.</span><span class="sxs-lookup"><span data-stu-id="17f23-110">One of the advantages of using the Entity Framework is that it avoids tying your code too closely to a particular method of storing data.</span></span> <span data-ttu-id="17f23-111">Cela en générant des requêtes et commandes SQL pour vous, ce qui vous évite de les écrire.</span><span class="sxs-lookup"><span data-stu-id="17f23-111">It does this by generating SQL queries and commands for you, which also frees you from having to write them yourself.</span></span> <span data-ttu-id="17f23-112">Mais il existe des scénarios exceptionnelles lorsque vous avez besoin exécuter des requêtes SQL spécifiques que vous avez créé manuellement.</span><span class="sxs-lookup"><span data-stu-id="17f23-112">But there are exceptional scenarios when you need to run specific SQL queries that you have manually created.</span></span> <span data-ttu-id="17f23-113">Pour ces scénarios, l’API de premier Code Entity Framework comprend les méthodes qui vous permettent de transmettre des commandes SQL directement à la base de données.</span><span class="sxs-lookup"><span data-stu-id="17f23-113">For these scenarios, the Entity Framework Code First API includes methods that enable you to pass SQL commands directly to the database.</span></span> <span data-ttu-id="17f23-114">Vous disposez des options suivantes dans EF Core 1.0 :</span><span class="sxs-lookup"><span data-stu-id="17f23-114">You have the following options in EF Core 1.0:</span></span>

* <span data-ttu-id="17f23-115">Utilisez la `DbSet.FromSql` méthode pour les requêtes qui retournent des types d’entités.</span><span class="sxs-lookup"><span data-stu-id="17f23-115">Use the `DbSet.FromSql` method for queries that return entity types.</span></span> <span data-ttu-id="17f23-116">Les objets retournés doivent être du type attendu par le `DbSet` objet et elles sont suivies automatiquement par le contexte de base de données, sauf si vous [désactiver le suivi des](crud.md#no-tracking-queries).</span><span class="sxs-lookup"><span data-stu-id="17f23-116">The returned objects must be of the type expected by the `DbSet` object, and they are automatically tracked by the database context unless you [turn tracking off](crud.md#no-tracking-queries).</span></span>

* <span data-ttu-id="17f23-117">Utilisez le `Database.ExecuteSqlCommand` pour les commandes de requête non.</span><span class="sxs-lookup"><span data-stu-id="17f23-117">Use the `Database.ExecuteSqlCommand` for non-query commands.</span></span>

<span data-ttu-id="17f23-118">Si vous avez besoin exécuter une requête qui retourne des types qui ne sont pas des entités, vous pouvez utiliser ADO.NET avec la connexion de base de données fournie par EF.</span><span class="sxs-lookup"><span data-stu-id="17f23-118">If you need to run a query that returns types that aren't entities, you can use ADO.NET with the database connection provided by EF.</span></span> <span data-ttu-id="17f23-119">Les données renvoyées n’est pas suivies par le contexte de la base de données, même si vous utilisez cette méthode pour récupérer des types d’entités.</span><span class="sxs-lookup"><span data-stu-id="17f23-119">The returned data isn't tracked by the database context, even if you use this method to retrieve entity types.</span></span>

<span data-ttu-id="17f23-120">Comme étant toujours true lorsque vous exécutez des commandes SQL dans une application web, vous devez prendre des précautions pour protéger votre site contre les attaques par injection SQL.</span><span class="sxs-lookup"><span data-stu-id="17f23-120">As is always true when you execute SQL commands in a web application, you must take precautions to protect your site against SQL injection attacks.</span></span> <span data-ttu-id="17f23-121">Une manière de procéder consiste à utiliser des requêtes paramétrables pour vous assurer que les chaînes soumis par une page web ne peut pas être interprétées comme des commandes SQL.</span><span class="sxs-lookup"><span data-stu-id="17f23-121">One way to do that is to use parameterized queries to make sure that strings submitted by a web page can't be interpreted as SQL commands.</span></span> <span data-ttu-id="17f23-122">Dans ce didacticiel, vous utiliserez des requêtes paramétrables lors de l’intégration de l’entrée d’utilisateur dans une requête.</span><span class="sxs-lookup"><span data-stu-id="17f23-122">In this tutorial you'll use parameterized queries when integrating user input into a query.</span></span>

## <a name="call-a-query-that-returns-entities"></a><span data-ttu-id="17f23-123">Appeler une requête qui retourne des entités</span><span class="sxs-lookup"><span data-stu-id="17f23-123">Call a query that returns entities</span></span>

<span data-ttu-id="17f23-124">Le `DbSet<TEntity>` classe fournit une méthode que vous pouvez utiliser pour exécuter une requête qui retourne une entité de type `TEntity`.</span><span class="sxs-lookup"><span data-stu-id="17f23-124">The `DbSet<TEntity>` class provides a method that you can use to execute a query that returns an entity of type `TEntity`.</span></span> <span data-ttu-id="17f23-125">Pour voir comment cela fonctionne vous allez modifier le code dans la `Details` méthode du contrôleur de service.</span><span class="sxs-lookup"><span data-stu-id="17f23-125">To see how this works you'll change the code in the `Details` method of the Department controller.</span></span>

<span data-ttu-id="17f23-126">Dans *DepartmentsController.cs*, dans le `Details` (méthode), remplacez le code qui Récupère un service avec un `FromSql` appel de méthode, comme indiqué dans le code en surbrillance suivant :</span><span class="sxs-lookup"><span data-stu-id="17f23-126">In *DepartmentsController.cs*, in the `Details` method, replace the code that retrieves a department with a `FromSql` method call, as shown in the following highlighted code:</span></span>

[!code-csharp[Main](intro/samples/cu/Controllers/DepartmentsController.cs?name=snippet_RawSQL&highlight=8,9,10,13)]

<span data-ttu-id="17f23-127">Pour vérifier que le nouveau code fonctionne correctement, sélectionnez le **départements** onglet, puis **détails** pour un des services.</span><span class="sxs-lookup"><span data-stu-id="17f23-127">To verify that the new code works correctly, select the **Departments** tab and then **Details** for one of the departments.</span></span>

![Informations relatives au service](advanced/_static/department-details.png)

## <a name="call-a-query-that-returns-other-types"></a><span data-ttu-id="17f23-129">Appeler une requête qui retourne les autres types</span><span class="sxs-lookup"><span data-stu-id="17f23-129">Call a query that returns other types</span></span>

<span data-ttu-id="17f23-130">Précédemment, vous avez créé une grille des statistiques de student pour la page à propos montrant le nombre d’élèves pour chaque date d’inscription.</span><span class="sxs-lookup"><span data-stu-id="17f23-130">Earlier you created a student statistics grid for the About page that showed the number of students for each enrollment date.</span></span> <span data-ttu-id="17f23-131">Vous avez obtenu les données du jeu d’entités étudiants (`_context.Students`) et utilisé LINQ pour projeter les résultats dans une liste de `EnrollmentDateGroup` afficher les objets de modèle.</span><span class="sxs-lookup"><span data-stu-id="17f23-131">You got the data from the Students entity set (`_context.Students`) and used LINQ to project the results into a list of `EnrollmentDateGroup` view model objects.</span></span> <span data-ttu-id="17f23-132">Supposons que vous souhaitez écrire le code SQL elle-même plutôt qu’à l’aide de LINQ.</span><span class="sxs-lookup"><span data-stu-id="17f23-132">Suppose you want to write the SQL itself rather than using LINQ.</span></span> <span data-ttu-id="17f23-133">Pour que vous avez besoin exécuter une requête SQL, qui retourne une valeur autre que les objets d’entité.</span><span class="sxs-lookup"><span data-stu-id="17f23-133">To do that you need to run a SQL query that returns something other than entity objects.</span></span> <span data-ttu-id="17f23-134">Dans EF Core 1.0, une faire consiste à écrire du code ADO.NET et d’obtenir la connexion de base de données à partir de EF.</span><span class="sxs-lookup"><span data-stu-id="17f23-134">In EF Core 1.0, one way to do that is write ADO.NET code and get the database connection from EF.</span></span>

<span data-ttu-id="17f23-135">Dans *HomeController.cs*, remplacez le `About` méthode avec le code suivant :</span><span class="sxs-lookup"><span data-stu-id="17f23-135">In *HomeController.cs*, replace the `About` method with the following code:</span></span>

[!code-csharp[Main](intro/samples/cu/Controllers/HomeController.cs?name=snippet_UseRawSQL&highlight=3-32)]

<span data-ttu-id="17f23-136">Ajouter un à l’aide de déclaration :</span><span class="sxs-lookup"><span data-stu-id="17f23-136">Add a using statement:</span></span>

[!code-csharp[Main](intro/samples/cu/Controllers/HomeController.cs?name=snippet_Usings2)]

<span data-ttu-id="17f23-137">Exécutez l’application et accédez à la page à propos de.</span><span class="sxs-lookup"><span data-stu-id="17f23-137">Run the app and go to the About page.</span></span> <span data-ttu-id="17f23-138">Il affiche les mêmes données qu’auparavant.</span><span class="sxs-lookup"><span data-stu-id="17f23-138">It displays the same data it did before.</span></span>

![Sur la page](advanced/_static/about.png)

## <a name="call-an-update-query"></a><span data-ttu-id="17f23-140">Appeler une requête de mise à jour</span><span class="sxs-lookup"><span data-stu-id="17f23-140">Call an update query</span></span>

<span data-ttu-id="17f23-141">Supposons que les administrateurs de Contoso University effectuer des modifications globales dans la base de données, telles que la modification du nombre de crédits pour chaque cours.</span><span class="sxs-lookup"><span data-stu-id="17f23-141">Suppose Contoso University administrators want to perform global changes in the database, such as changing the number of credits for every course.</span></span> <span data-ttu-id="17f23-142">Si l’université comporte un grand nombre des cours, il est inefficace pour les extraire sous la forme d’entités et les modifier individuellement.</span><span class="sxs-lookup"><span data-stu-id="17f23-142">If the university has a large number of courses, it would be inefficient to retrieve them all as entities and change them individually.</span></span> <span data-ttu-id="17f23-143">Dans cette section, vous allez implémenter une page web qui permet à l’utilisateur spécifier un facteur permettant de modifier le nombre de crédits pour tous les cours, et vous devez apporter la modification en exécutant une instruction SQL UPDATE.</span><span class="sxs-lookup"><span data-stu-id="17f23-143">In this section you'll implement a web page that enables the user to specify a factor by which to change the number of credits for all courses, and you'll make the change by executing a SQL UPDATE statement.</span></span> <span data-ttu-id="17f23-144">La page web doit ressembler à l’illustration suivante :</span><span class="sxs-lookup"><span data-stu-id="17f23-144">The web page will look like the following illustration:</span></span>

![Page des crédits du cours de mise à jour](advanced/_static/update-credits.png)

<span data-ttu-id="17f23-146">Dans *CoursesContoller.cs*, ajouter des méthodes de UpdateCourseCredits pour HttpGet et HttpPost :</span><span class="sxs-lookup"><span data-stu-id="17f23-146">In *CoursesContoller.cs*, add UpdateCourseCredits methods for HttpGet and HttpPost:</span></span>

[!code-csharp[Main](intro/samples/cu/Controllers/CoursesController.cs?name=snippet_UpdateGet)]

[!code-csharp[Main](intro/samples/cu/Controllers/CoursesController.cs?name=snippet_UpdatePost)]

<span data-ttu-id="17f23-147">Lorsque le contrôleur traite une demande de HttpGet, rien n’est retourné dans `ViewData["RowsAffected"]`, et la vue affiche une zone de texte vide et un bouton d’envoi, comme indiqué dans l’illustration précédente.</span><span class="sxs-lookup"><span data-stu-id="17f23-147">When the controller processes an HttpGet request, nothing is returned in `ViewData["RowsAffected"]`, and the view displays an empty text box and a submit button, as shown in the preceding illustration.</span></span>

<span data-ttu-id="17f23-148">Lorsque le **mise à jour** bouton, la méthode HttpPost est appelée et multiplicateur a la valeur entrée dans la zone de texte.</span><span class="sxs-lookup"><span data-stu-id="17f23-148">When the **Update** button is clicked, the HttpPost method is called, and multiplier has the value entered in the text box.</span></span> <span data-ttu-id="17f23-149">Le code exécute ensuite l’instruction SQL qui met à jour des cours et retourne le nombre de lignes affectées à la vue dans `ViewData`.</span><span class="sxs-lookup"><span data-stu-id="17f23-149">The code then executes the SQL that updates courses and returns the number of affected rows to the view in `ViewData`.</span></span> <span data-ttu-id="17f23-150">Lorsque la vue obtient un `RowsAffected` valeur, elle affiche le nombre de lignes mises à jour.</span><span class="sxs-lookup"><span data-stu-id="17f23-150">When the view gets a `RowsAffected` value, it displays the number of rows updated.</span></span>

<span data-ttu-id="17f23-151">Dans **l’Explorateur de solutions**, avec le bouton droit le *vues/cours* dossier, puis cliquez sur **Ajouter > nouvel élément**.</span><span class="sxs-lookup"><span data-stu-id="17f23-151">In **Solution Explorer**, right-click the *Views/Courses* folder, and then click **Add > New Item**.</span></span>

<span data-ttu-id="17f23-152">Dans le **ajouter un nouvel élément** boîte de dialogue, cliquez sur **ASP.NET** sous **installé** dans le volet gauche, cliquez sur **Page de vue MVC**et le nom de la nouvelle vue  *UpdateCourseCredits.cshtml*.</span><span class="sxs-lookup"><span data-stu-id="17f23-152">In the **Add New Item** dialog, click **ASP.NET** under **Installed** in the left pane, click **MVC View Page**, and name the new view *UpdateCourseCredits.cshtml*.</span></span>

<span data-ttu-id="17f23-153">Dans *Views/Courses/UpdateCourseCredits.cshtml*, remplacez le code de modèle par le code suivant :</span><span class="sxs-lookup"><span data-stu-id="17f23-153">In *Views/Courses/UpdateCourseCredits.cshtml*, replace the template code with the following code:</span></span>

[!code-html[Main](intro/samples/cu/Views/Courses/UpdateCourseCredits.cshtml)]

<span data-ttu-id="17f23-154">Exécuter la `UpdateCourseCredits` méthode en sélectionnant le **cours** onglet, puis en ajoutant « / UpdateCourseCredits » à la fin de l’URL dans la barre d’adresses du navigateur (par exemple : `http://localhost:5813/Courses/UpdateCourseCredits`).</span><span class="sxs-lookup"><span data-stu-id="17f23-154">Run the `UpdateCourseCredits` method by selecting the **Courses** tab, then adding "/UpdateCourseCredits" to the end of the URL in the browser's address bar (for example: `http://localhost:5813/Courses/UpdateCourseCredits`).</span></span> <span data-ttu-id="17f23-155">Entrez un nombre dans la zone de texte :</span><span class="sxs-lookup"><span data-stu-id="17f23-155">Enter a number in the text box:</span></span>

![Page des crédits du cours de mise à jour](advanced/_static/update-credits.png)

<span data-ttu-id="17f23-157">Cliquez sur **Mettre à jour**.</span><span class="sxs-lookup"><span data-stu-id="17f23-157">Click **Update**.</span></span> <span data-ttu-id="17f23-158">Vous voyez le nombre de lignes affectées :</span><span class="sxs-lookup"><span data-stu-id="17f23-158">You see the number of rows affected:</span></span>

![Mise à jour cours crédits page lignes affectées](advanced/_static/update-credits-rows-affected.png)

<span data-ttu-id="17f23-160">Cliquez sur **retour à la liste** pour afficher la liste des cours avec la modification du numéro de crédits.</span><span class="sxs-lookup"><span data-stu-id="17f23-160">Click **Back to List** to see the list of courses with the revised number of credits.</span></span>

<span data-ttu-id="17f23-161">Notez que le code de production assureriez qui met à jour toujours des données valides.</span><span class="sxs-lookup"><span data-stu-id="17f23-161">Note that production code would ensure that updates always result in valid data.</span></span> <span data-ttu-id="17f23-162">Le code simplifié indiqué ici peut multipliez le nombre de crédits suffisamment de numéros supérieurs à 5.</span><span class="sxs-lookup"><span data-stu-id="17f23-162">The simplified code shown here could multiply the number of credits enough to result in numbers greater than 5.</span></span> <span data-ttu-id="17f23-163">(Le `Credits` propriété a un `[Range(0, 5)]` attribut.) La requête de mise à jour fonctionne, mais les données non valides peuvent provoquer des résultats inattendus dans d’autres parties du système qui supposent que le nombre de crédits est inférieur ou égal à 5.</span><span class="sxs-lookup"><span data-stu-id="17f23-163">(The `Credits` property has a `[Range(0, 5)]` attribute.) The update query would work but the invalid data could cause unexpected results in other parts of the system that assume the number of credits is 5 or less.</span></span>

<span data-ttu-id="17f23-164">Pour plus d’informations sur les requêtes SQL brutes, consultez [des requêtes SQL brutes](https://docs.microsoft.com/ef/core/querying/raw-sql).</span><span class="sxs-lookup"><span data-stu-id="17f23-164">For more information about raw SQL queries, see [Raw SQL Queries](https://docs.microsoft.com/ef/core/querying/raw-sql).</span></span>

## <a name="examine-sql-sent-to-the-database"></a><span data-ttu-id="17f23-165">Examinez SQL envoyée à la base de données</span><span class="sxs-lookup"><span data-stu-id="17f23-165">Examine SQL sent to the database</span></span>

<span data-ttu-id="17f23-166">Il est parfois utile de pouvoir voir les requêtes SQL réelles qui sont envoyées à la base de données.</span><span class="sxs-lookup"><span data-stu-id="17f23-166">Sometimes it's helpful to be able to see the actual SQL queries that are sent to the database.</span></span> <span data-ttu-id="17f23-167">Fonctionnalité de journalisation intégrés pour ASP.NET Core est utilisée automatiquement par EF Core d’écrire des journaux qui contiennent le code SQL pour les requêtes et les mises à jour.</span><span class="sxs-lookup"><span data-stu-id="17f23-167">Built-in logging functionality for ASP.NET Core is automatically used by EF Core to write logs that contain the SQL for queries and updates.</span></span> <span data-ttu-id="17f23-168">Dans cette section, vous verrez des exemples de journalisation SQL.</span><span class="sxs-lookup"><span data-stu-id="17f23-168">In this section you'll see some examples of SQL logging.</span></span>

<span data-ttu-id="17f23-169">Ouvrez *StudentsController.cs* et dans le `Details` méthode définie un point d’arrêt sur la `if (student == null)` instruction.</span><span class="sxs-lookup"><span data-stu-id="17f23-169">Open *StudentsController.cs* and in the `Details` method set a breakpoint on the `if (student == null)` statement.</span></span>

<span data-ttu-id="17f23-170">Exécuter l’application en mode débogage et accédez à la page des détails pour un étudiant.</span><span class="sxs-lookup"><span data-stu-id="17f23-170">Run the app in debug mode, and go to the Details page for a student.</span></span>

<span data-ttu-id="17f23-171">Accédez à la **sortie** de sortie de fenêtre affichant le débogage et que la requête :</span><span class="sxs-lookup"><span data-stu-id="17f23-171">Go to the **Output** window showing debug output, and you see the query:</span></span>

```
Microsoft.EntityFrameworkCore.Database.Command:Information: Executed DbCommand (56ms) [Parameters=[@__id_0='?'], CommandType='Text', CommandTimeout='30']
SELECT TOP(2) [s].[ID], [s].[Discriminator], [s].[FirstName], [s].[LastName], [s].[EnrollmentDate]
FROM [Person] AS [s]
WHERE ([s].[Discriminator] = N'Student') AND ([s].[ID] = @__id_0)
ORDER BY [s].[ID]
Microsoft.EntityFrameworkCore.Database.Command:Information: Executed DbCommand (122ms) [Parameters=[@__id_0='?'], CommandType='Text', CommandTimeout='30']
SELECT [s.Enrollments].[EnrollmentID], [s.Enrollments].[CourseID], [s.Enrollments].[Grade], [s.Enrollments].[StudentID], [e.Course].[CourseID], [e.Course].[Credits], [e.Course].[DepartmentID], [e.Course].[Title]
FROM [Enrollment] AS [s.Enrollments]
INNER JOIN [Course] AS [e.Course] ON [s.Enrollments].[CourseID] = [e.Course].[CourseID]
INNER JOIN (
    SELECT TOP(1) [s0].[ID]
    FROM [Person] AS [s0]
    WHERE ([s0].[Discriminator] = N'Student') AND ([s0].[ID] = @__id_0)
    ORDER BY [s0].[ID]
) AS [t] ON [s.Enrollments].[StudentID] = [t].[ID]
ORDER BY [t].[ID]
```

<span data-ttu-id="17f23-172">Vous remarquerez que quelque chose ici qui peut vous surprendre : l’instruction SQL sélectionne des lignes jusqu'à 2 (`TOP(2)`) à partir de la table Person.</span><span class="sxs-lookup"><span data-stu-id="17f23-172">You'll notice something here that might surprise you: the SQL selects up to 2 rows (`TOP(2)`) from the Person table.</span></span> <span data-ttu-id="17f23-173">Le `SingleOrDefaultAsync` méthode ne résout pas 1 ligne sur le serveur.</span><span class="sxs-lookup"><span data-stu-id="17f23-173">The `SingleOrDefaultAsync` method doesn't resolve to 1 row on the server.</span></span> <span data-ttu-id="17f23-174">Voici pourquoi :</span><span class="sxs-lookup"><span data-stu-id="17f23-174">Here's why:</span></span>

* <span data-ttu-id="17f23-175">Si la requête retourne plusieurs lignes, la méthode retourne la valeur null.</span><span class="sxs-lookup"><span data-stu-id="17f23-175">If the query would return multiple rows, the method returns null.</span></span>
* <span data-ttu-id="17f23-176">Pour déterminer si la requête retourne plusieurs lignes, EF a besoin de vérifier si elle retourne au moins 2.</span><span class="sxs-lookup"><span data-stu-id="17f23-176">To determine whether the query would return multiple rows, EF has to check if it returns at least 2.</span></span>

<span data-ttu-id="17f23-177">Notez que vous ne devez utiliser le mode débogage et s’arrêter à un point d’arrêt pour obtenir la sortie de journalisation dans le **sortie** fenêtre.</span><span class="sxs-lookup"><span data-stu-id="17f23-177">Note that you don't have to use debug mode and stop at a breakpoint to get logging output in the **Output** window.</span></span> <span data-ttu-id="17f23-178">Il est simplement un moyen pratique pour arrêter la journalisation au niveau où que vous souhaitez consulter la sortie.</span><span class="sxs-lookup"><span data-stu-id="17f23-178">It's just a convenient way to stop the logging at the point you want to look at the output.</span></span> <span data-ttu-id="17f23-179">Si vous ne le faire, l’enregistrement se poursuit et vous devez revenir en arrière pour rechercher les parties qui que vous intéresse.</span><span class="sxs-lookup"><span data-stu-id="17f23-179">If you don't do that, logging continues and you have to scroll back to find the parts you're interested in.</span></span>

## <a name="repository-and-unit-of-work-patterns"></a><span data-ttu-id="17f23-180">Espace de stockage et une unité de travail modèles</span><span class="sxs-lookup"><span data-stu-id="17f23-180">Repository and unit of work patterns</span></span>

<span data-ttu-id="17f23-181">De nombreux développeurs écrire du code pour implémenter le référentiel et une unité de travail modèles comme un wrapper autour du code qui fonctionne avec Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="17f23-181">Many developers write code to implement the repository and unit of work patterns as a wrapper around code that works with the Entity Framework.</span></span> <span data-ttu-id="17f23-182">Ces modèles sont destinés à créer une couche d’abstraction entre la couche d’accès aux données et la couche de logique métier d’une application.</span><span class="sxs-lookup"><span data-stu-id="17f23-182">These patterns are intended to create an abstraction layer between the data access layer and the business logic layer of an application.</span></span> <span data-ttu-id="17f23-183">Implémentation de ces modèles peut permettre d’isoler votre application des modifications dans le magasin de données et peuvent faciliter le test unitaire automatisé ou développement piloté par test (TDD).</span><span class="sxs-lookup"><span data-stu-id="17f23-183">Implementing these patterns can help insulate your application from changes in the data store and can facilitate automated unit testing or test-driven development (TDD).</span></span> <span data-ttu-id="17f23-184">Toutefois, l’écriture de code supplémentaire pour implémenter ces modèles n’est pas toujours le meilleur choix pour les applications qui utilisent EF, pour plusieurs raisons :</span><span class="sxs-lookup"><span data-stu-id="17f23-184">However, writing additional code to implement these patterns is not always the best choice for applications that use EF, for several reasons:</span></span>

* <span data-ttu-id="17f23-185">La classe de contexte EF lui-même isole votre code à partir du code spécifique au magasin de données.</span><span class="sxs-lookup"><span data-stu-id="17f23-185">The EF context class itself insulates your code from data-store-specific code.</span></span>

* <span data-ttu-id="17f23-186">La classe de contexte EF peut agir comme une classe de l’unité de travail de base de données mises à jour de procéder à l’aide de EF.</span><span class="sxs-lookup"><span data-stu-id="17f23-186">The EF context class can act as a unit-of-work class for database updates that you do using EF.</span></span>

* <span data-ttu-id="17f23-187">EF inclut des fonctionnalités pour l’implémentation de TDD sans écrire de code de référentiel.</span><span class="sxs-lookup"><span data-stu-id="17f23-187">EF includes features for implementing TDD without writing repository code.</span></span>

<span data-ttu-id="17f23-188">Pour plus d’informations sur la façon d’implémenter le référentiel et une unité de travail des modèles, consultez [la version d’Entity Framework 5 de cette série de didacticiels](https://docs.microsoft.com/aspnet/mvc/overview/older-versions/getting-started-with-ef-5-using-mvc-4/implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application).</span><span class="sxs-lookup"><span data-stu-id="17f23-188">For information about how to implement the repository and unit of work patterns, see [the Entity Framework 5 version of this tutorial series](https://docs.microsoft.com/aspnet/mvc/overview/older-versions/getting-started-with-ef-5-using-mvc-4/implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application).</span></span>

<span data-ttu-id="17f23-189">Entity Framework Core implémente un fournisseur de base de données en mémoire qui peut être utilisé pour le test.</span><span class="sxs-lookup"><span data-stu-id="17f23-189">Entity Framework Core implements an in-memory database provider that can be used for testing.</span></span> <span data-ttu-id="17f23-190">Pour plus d’informations, consultez [test avec InMemory](https://docs.microsoft.com/ef/core/miscellaneous/testing/in-memory).</span><span class="sxs-lookup"><span data-stu-id="17f23-190">For more information, see [Testing with InMemory](https://docs.microsoft.com/ef/core/miscellaneous/testing/in-memory).</span></span>

## <a name="automatic-change-detection"></a><span data-ttu-id="17f23-191">Détection des modifications automatique</span><span class="sxs-lookup"><span data-stu-id="17f23-191">Automatic change detection</span></span>

<span data-ttu-id="17f23-192">Entity Framework détermine la manière dont une entité a changé (et par conséquent les mises à jour doivent être envoyées à la base de données) en comparant les valeurs en cours d’une entité avec les valeurs d’origine.</span><span class="sxs-lookup"><span data-stu-id="17f23-192">The Entity Framework determines how an entity has changed (and therefore which updates need to be sent to the database) by comparing the current values of an entity with the original values.</span></span> <span data-ttu-id="17f23-193">Les valeurs d’origine sont stockées lorsque l’entité est interrogée ou attachée.</span><span class="sxs-lookup"><span data-stu-id="17f23-193">The original values are stored when the entity is queried or attached.</span></span> <span data-ttu-id="17f23-194">Certaines des méthodes qui provoquent la détection des modifications automatique sont les suivants :</span><span class="sxs-lookup"><span data-stu-id="17f23-194">Some of the methods that cause automatic change detection are the following:</span></span>

* <span data-ttu-id="17f23-195">DbContext.SaveChanges</span><span class="sxs-lookup"><span data-stu-id="17f23-195">DbContext.SaveChanges</span></span>

* <span data-ttu-id="17f23-196">DbContext.Entry</span><span class="sxs-lookup"><span data-stu-id="17f23-196">DbContext.Entry</span></span>

* <span data-ttu-id="17f23-197">ChangeTracker.Entries</span><span class="sxs-lookup"><span data-stu-id="17f23-197">ChangeTracker.Entries</span></span>

<span data-ttu-id="17f23-198">Si vous effectuez le suivi d’un grand nombre d’entités et que vous appelez l’une de ces méthodes plusieurs fois dans une boucle, vous pouvez obtenir des améliorations significatives des performances en activant temporairement désactiver la détection de modification automatique à l’aide du `ChangeTracker.AutoDetectChangesEnabled` propriété.</span><span class="sxs-lookup"><span data-stu-id="17f23-198">If you're tracking a large number of entities and you call one of these methods many times in a loop, you might get significant performance improvements by temporarily turning off automatic change detection using the `ChangeTracker.AutoDetectChangesEnabled` property.</span></span> <span data-ttu-id="17f23-199">Exemple :</span><span class="sxs-lookup"><span data-stu-id="17f23-199">For example:</span></span>

```csharp
_context.ChangeTracker.AutoDetectChangesEnabled = false;
```

## <a name="entity-framework-core-source-code-and-development-plans"></a><span data-ttu-id="17f23-200">Entity Framework Core source code et le développement des plans</span><span class="sxs-lookup"><span data-stu-id="17f23-200">Entity Framework Core source code and development plans</span></span>

<span data-ttu-id="17f23-201">Le code source pour Entity Framework Core est disponible à l’adresse [https://github.com/aspnet/EntityFrameworkCore](https://github.com/aspnet/EntityFrameworkCore).</span><span class="sxs-lookup"><span data-stu-id="17f23-201">The source code for Entity Framework Core is available at [https://github.com/aspnet/EntityFrameworkCore](https://github.com/aspnet/EntityFrameworkCore).</span></span> <span data-ttu-id="17f23-202">En plus de code source, vous pouvez obtenir les builds nocturnes, suivi des problèmes, spécifications de fonctionnalités, concevoir des notes de réunion, [la feuille de route pour le développement futur](https://github.com/aspnet/EntityFrameworkCore/wiki/Roadmap)et bien plus encore.</span><span class="sxs-lookup"><span data-stu-id="17f23-202">Besides source code, you can get nightly builds, issue tracking, feature specs, design meeting notes, [the roadmap for future development](https://github.com/aspnet/EntityFrameworkCore/wiki/Roadmap), and more.</span></span> <span data-ttu-id="17f23-203">Vous pouvez signaler des bogues, et vous pouvez contribuer à vos propres améliorations au code source EF.</span><span class="sxs-lookup"><span data-stu-id="17f23-203">You can file bugs, and you can contribute your own enhancements to the EF source code.</span></span>

<span data-ttu-id="17f23-204">Bien que le code source est ouvert, Entity Framework Core est entièrement pris en charge comme un produit Microsoft.</span><span class="sxs-lookup"><span data-stu-id="17f23-204">Although the source code is open, Entity Framework Core is fully supported as a Microsoft product.</span></span> <span data-ttu-id="17f23-205">L’équipe Microsoft Entity Framework conserve le contrôle sur lequel les contributions sont acceptées et teste toutes les modifications du code pour garantir la qualité de chaque version.</span><span class="sxs-lookup"><span data-stu-id="17f23-205">The Microsoft Entity Framework team keeps control over which contributions are accepted and tests all code changes to ensure the quality of each release.</span></span>

## <a name="reverse-engineer-from-existing-database"></a><span data-ttu-id="17f23-206">L’ingénierie à rebours à partir de la base de données existante</span><span class="sxs-lookup"><span data-stu-id="17f23-206">Reverse engineer from existing database</span></span>

<span data-ttu-id="17f23-207">Pour rétroconcevoir un modèle de données, y compris les classes d’entité à partir de la base de données existante, utilisez la [scaffold-dbcontext](https://docs.microsoft.com/ef/core/miscellaneous/cli/powershell#scaffold-dbcontext) commande.</span><span class="sxs-lookup"><span data-stu-id="17f23-207">To reverse engineer a data model including entity classes from an existing database, use the [scaffold-dbcontext](https://docs.microsoft.com/ef/core/miscellaneous/cli/powershell#scaffold-dbcontext) command.</span></span> <span data-ttu-id="17f23-208">Consultez le [didacticiel de mise en route](https://docs.microsoft.com/ef/core/get-started/aspnetcore/existing-db).</span><span class="sxs-lookup"><span data-stu-id="17f23-208">See the [getting-started tutorial](https://docs.microsoft.com/ef/core/get-started/aspnetcore/existing-db).</span></span>

<a id="dynamic-linq"></a>
## <a name="use-dynamic-linq-to-simplify-sort-selection-code"></a><span data-ttu-id="17f23-209">Permet de simplifier le code de sélection de tri LINQ dynamique</span><span class="sxs-lookup"><span data-stu-id="17f23-209">Use dynamic LINQ to simplify sort selection code</span></span>

<span data-ttu-id="17f23-210">Le [troisième didacticiel de cette série](sort-filter-page.md) montre comment écrire du code LINQ en codage en dur des noms de colonnes dans un `switch` instruction.</span><span class="sxs-lookup"><span data-stu-id="17f23-210">The [third tutorial in this series](sort-filter-page.md) shows how to write LINQ code by hard-coding column names in a `switch` statement.</span></span> <span data-ttu-id="17f23-211">Avec deux colonnes sélectionnables, cela fonctionne correctement, mais si vous avez de nombreuses colonnes le code pourrait verbose.</span><span class="sxs-lookup"><span data-stu-id="17f23-211">With two columns to choose from, this works fine, but if you have many columns the code could get verbose.</span></span> <span data-ttu-id="17f23-212">Pour résoudre ce problème, vous pouvez utiliser la `EF.Property` méthode pour spécifier le nom de la propriété sous forme de chaîne.</span><span class="sxs-lookup"><span data-stu-id="17f23-212">To solve that problem, you can use the `EF.Property` method to specify the name of the property as a string.</span></span> <span data-ttu-id="17f23-213">Pour tester cette approche, vous devez remplacer le `Index` méthode dans le `StudentsController` par le code suivant.</span><span class="sxs-lookup"><span data-stu-id="17f23-213">To try out this approach, replace the `Index` method in the `StudentsController` with the following code.</span></span>

[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DynamicLinq)]

## <a name="next-steps"></a><span data-ttu-id="17f23-214">Étapes suivantes</span><span class="sxs-lookup"><span data-stu-id="17f23-214">Next steps</span></span>

<span data-ttu-id="17f23-215">Cette étape termine cette série de didacticiels sur l’utilisation de l’Entity Framework Core dans une application ASP.NET MVC.</span><span class="sxs-lookup"><span data-stu-id="17f23-215">This completes this series of tutorials on using the Entity Framework Core in an ASP.NET MVC application.</span></span>

<span data-ttu-id="17f23-216">Pour plus d’informations sur EF Core, consultez la [documentation d’Entity Framework Core](https://docs.microsoft.com/ef/core).</span><span class="sxs-lookup"><span data-stu-id="17f23-216">For more information about EF Core, see the [Entity Framework Core documentation](https://docs.microsoft.com/ef/core).</span></span> <span data-ttu-id="17f23-217">Un livre est également disponible : [Entity Framework Core en Action](https://www.manning.com/books/entity-framework-core-in-action).</span><span class="sxs-lookup"><span data-stu-id="17f23-217">A book is also available: [Entity Framework Core in Action](https://www.manning.com/books/entity-framework-core-in-action).</span></span>

<span data-ttu-id="17f23-218">Pour plus d’informations sur la façon de déployer une application web, consultez [hôte et déployer](xref:host-and-deploy/index).</span><span class="sxs-lookup"><span data-stu-id="17f23-218">For information on how to deploy a web app, see [Host and deploy](xref:host-and-deploy/index).</span></span>

<span data-ttu-id="17f23-219">Pour plus d’informations sur les autres rubriques relatives à ASP.NET MVC de base, telles que l’authentification et l’autorisation, consultez le [documentation d’ASP.NET Core](https://docs.microsoft.com/aspnet/core/).</span><span class="sxs-lookup"><span data-stu-id="17f23-219">For information about other topics related to ASP.NET Core MVC, such as authentication and authorization, see the [ASP.NET Core documentation](https://docs.microsoft.com/aspnet/core/).</span></span>

## <a name="acknowledgments"></a><span data-ttu-id="17f23-220">Accusés de réception</span><span class="sxs-lookup"><span data-stu-id="17f23-220">Acknowledgments</span></span>

<span data-ttu-id="17f23-221">Tom Dykstra et Rick Anderson (twitter @RickAndMSFT) a écrit ce didacticiel.</span><span class="sxs-lookup"><span data-stu-id="17f23-221">Tom Dykstra and Rick Anderson (twitter @RickAndMSFT) wrote this tutorial.</span></span> <span data-ttu-id="17f23-222">Rowan Miller, Diego Vega et autres membres de l’équipe d’Entity Framework assistée avec les révisions du code et a aidé à déboguer les problèmes posés par pendant que nous avons écrire du code pour les didacticiels.</span><span class="sxs-lookup"><span data-stu-id="17f23-222">Rowan Miller, Diego Vega, and other members of the Entity Framework team assisted with code reviews and helped debug issues that arose while we were writing code for the tutorials.</span></span>

## <a name="common-errors"></a><span data-ttu-id="17f23-223">Erreurs courantes</span><span class="sxs-lookup"><span data-stu-id="17f23-223">Common errors</span></span>  

### <a name="contosouniversitydll-used-by-another-process"></a><span data-ttu-id="17f23-224">ContosoUniversity.dll utilisé par un autre processus</span><span class="sxs-lookup"><span data-stu-id="17f23-224">ContosoUniversity.dll used by another process</span></span>

<span data-ttu-id="17f23-225">Message d’erreur :</span><span class="sxs-lookup"><span data-stu-id="17f23-225">Error message:</span></span>

> <span data-ttu-id="17f23-226">Impossible d’ouvrir '... bin\Debug\netcoreapp1.0\ContosoUniversity.dll' en écriture--' le processus ne peut pas accéder au fichier '... \bin\Debug\netcoreapp1.0\ContosoUniversity.dll', car il est utilisé par un autre processus.</span><span class="sxs-lookup"><span data-stu-id="17f23-226">Cannot open '...bin\Debug\netcoreapp1.0\ContosoUniversity.dll' for writing -- 'The process cannot access the file '...\bin\Debug\netcoreapp1.0\ContosoUniversity.dll' because it is being used by another process.</span></span>

<span data-ttu-id="17f23-227">Solution :</span><span class="sxs-lookup"><span data-stu-id="17f23-227">Solution:</span></span>

<span data-ttu-id="17f23-228">Arrêter le site dans IIS Express.</span><span class="sxs-lookup"><span data-stu-id="17f23-228">Stop the site in IIS Express.</span></span> <span data-ttu-id="17f23-229">Accédez à la barre des tâches Windows, recherchez IIS Express et cliquez sur son icône, sélectionnez le site de l’Université de Contoso, puis cliquez sur **arrêter un Site**.</span><span class="sxs-lookup"><span data-stu-id="17f23-229">Go to the Windows System Tray, find IIS Express and right-click its icon, select the Contoso University site, and then click **Stop Site**.</span></span>

### <a name="migration-scaffolded-with-no-code-in-up-and-down-methods"></a><span data-ttu-id="17f23-230">Migration structurée sans code de haut et bas de méthodes</span><span class="sxs-lookup"><span data-stu-id="17f23-230">Migration scaffolded with no code in Up and Down methods</span></span>

<span data-ttu-id="17f23-231">Cause possible :</span><span class="sxs-lookup"><span data-stu-id="17f23-231">Possible cause:</span></span>

<span data-ttu-id="17f23-232">Les commandes CLI d’EF n’automatiquement fermer et enregistrer des fichiers de code.</span><span class="sxs-lookup"><span data-stu-id="17f23-232">The EF CLI commands don't automatically close and save code files.</span></span> <span data-ttu-id="17f23-233">Si vous avez apporté des modifications lorsque vous exécutez le `migrations add` EF ne trouve pas les modifications de la commande.</span><span class="sxs-lookup"><span data-stu-id="17f23-233">If you have unsaved changes when you run the `migrations add` command, EF won't find your changes.</span></span>

<span data-ttu-id="17f23-234">Solution :</span><span class="sxs-lookup"><span data-stu-id="17f23-234">Solution:</span></span>

<span data-ttu-id="17f23-235">Exécutez le `migrations remove` de commande, enregistrez vos modifications du code et réexécuter le `migrations add` commande.</span><span class="sxs-lookup"><span data-stu-id="17f23-235">Run the `migrations remove` command, save your code changes and rerun the `migrations add` command.</span></span>

### <a name="errors-while-running-database-update"></a><span data-ttu-id="17f23-236">Erreurs lors de la mise à jour de base de données en cours d’exécution</span><span class="sxs-lookup"><span data-stu-id="17f23-236">Errors while running database update</span></span>

<span data-ttu-id="17f23-237">Il est possible d’obtenir d’autres erreurs lorsque des modifications de schéma dans une base de données qui comporte déjà des données.</span><span class="sxs-lookup"><span data-stu-id="17f23-237">It's possible to get other errors when making schema changes in a database that has existing data.</span></span> <span data-ttu-id="17f23-238">Si vous obtenez des erreurs de migration que vous ne pouvez pas résoudre, vous pouvez modifier le nom de la base de données dans la chaîne de connexion ou supprimer la base de données.</span><span class="sxs-lookup"><span data-stu-id="17f23-238">If you get migration errors you can't resolve, you can either change the database name in the connection string or delete the database.</span></span> <span data-ttu-id="17f23-239">Avec une base de données, il n’existe pas de données à migrer, et la commande de mise à jour de la base de données est beaucoup plus susceptible de se terminer sans erreur.</span><span class="sxs-lookup"><span data-stu-id="17f23-239">With a new database, there is no data to migrate, and the update-database command is much more likely to complete without errors.</span></span>

<span data-ttu-id="17f23-240">L’approche la plus simple consiste à renommer la base de données *appsettings.json*.</span><span class="sxs-lookup"><span data-stu-id="17f23-240">The simplest approach is to rename the database in *appsettings.json*.</span></span> <span data-ttu-id="17f23-241">La prochaine fois que vous exécutez `database update`, une base de données sera créée.</span><span class="sxs-lookup"><span data-stu-id="17f23-241">The next time you run `database update`, a new database will be created.</span></span>

<span data-ttu-id="17f23-242">Pour supprimer une base de données SSOX, avec le bouton droit de la base de données, cliquez sur **supprimer**, puis, dans le **supprimer la base de données** boîte de dialogue Sélectionnez **fermer les connexions existantes** sur  **OK**.</span><span class="sxs-lookup"><span data-stu-id="17f23-242">To delete a database in SSOX, right-click the database, click **Delete**, and then in the **Delete Database** dialog box select **Close existing connections** and click **OK**.</span></span>

<span data-ttu-id="17f23-243">Pour supprimer une base de données à l’aide de l’interface CLI, exécutez le `database drop` commande CLI :</span><span class="sxs-lookup"><span data-stu-id="17f23-243">To delete a database by using the CLI, run the `database drop` CLI command:</span></span>

```console
dotnet ef database drop
```

### <a name="error-locating-sql-server-instance"></a><span data-ttu-id="17f23-244">Instance SQL Server recherche d’erreur</span><span class="sxs-lookup"><span data-stu-id="17f23-244">Error locating SQL Server instance</span></span>

<span data-ttu-id="17f23-245">Message d’erreur :</span><span class="sxs-lookup"><span data-stu-id="17f23-245">Error Message:</span></span>

> <span data-ttu-id="17f23-246">Une erreur liée au réseau ou d’instance spécifique s’est produite lors de l’établissement d’une connexion à SQL Server.</span><span class="sxs-lookup"><span data-stu-id="17f23-246">A network-related or instance-specific error occurred while establishing a connection to SQL Server.</span></span> <span data-ttu-id="17f23-247">Le serveur est introuvable ou n’est pas accessible.</span><span class="sxs-lookup"><span data-stu-id="17f23-247">The server was not found or was not accessible.</span></span> <span data-ttu-id="17f23-248">Vérifiez que le nom de l’instance est correct et que SQL Server est configuré pour autoriser les connexions distantes.</span><span class="sxs-lookup"><span data-stu-id="17f23-248">Verify that the instance name is correct and that SQL Server is configured to allow remote connections.</span></span> <span data-ttu-id="17f23-249">(fournisseur : Interfaces réseau SQL, erreur : 26 - erreur serveur/de l’Instance spécifiée de localisation)</span><span class="sxs-lookup"><span data-stu-id="17f23-249">(provider: SQL Network Interfaces, error: 26 - Error Locating Server/Instance Specified)</span></span>

<span data-ttu-id="17f23-250">Solution :</span><span class="sxs-lookup"><span data-stu-id="17f23-250">Solution:</span></span>

<span data-ttu-id="17f23-251">Vérifiez la chaîne de connexion.</span><span class="sxs-lookup"><span data-stu-id="17f23-251">Check the connection string.</span></span> <span data-ttu-id="17f23-252">Si vous avez supprimé manuellement des fichiers de la base de données, modifiez le nom de la base de données dans la chaîne de construction pour recommencer avec une nouvelle base de données.</span><span class="sxs-lookup"><span data-stu-id="17f23-252">If you have manually deleted the database file, change the name of the database in the construction string to start over with a new database.</span></span>

>[!div class="step-by-step"]
[<span data-ttu-id="17f23-253">Précédent</span><span class="sxs-lookup"><span data-stu-id="17f23-253">Previous</span></span>](inheritance.md)
